import{X as $t,a as Zt}from"./index-DpNoTeGf.js";function te(_t,Ft){for(var Dt=0;Dt<Ft.length;Dt++){const yt=Ft[Dt];if(typeof yt!="string"&&!Array.isArray(yt)){for(const dt in yt)if(dt!=="default"&&!(dt in _t)){const Rt=Object.getOwnPropertyDescriptor(yt,dt);Rt&&Object.defineProperty(_t,dt,Rt.get?Rt:{enumerable:!0,get:()=>yt[dt]})}}}return Object.freeze(Object.defineProperty(_t,Symbol.toStringTag,{value:"Module"}))}var Kt={exports:{}};(function(_t,Ft){typeof window<"u"&&function(Dt,yt){_t.exports=yt()}($t,()=>(()=>{var Dt={"./src/config.ts":(j,x,S)=>{S.r(x),S.d(x,{enableStreamingMode:()=>t,hlsDefaultConfig:()=>s,mergeConfig:()=>u});var F=S("./src/controller/abr-controller.ts"),D=S("./src/controller/audio-stream-controller.ts"),P=S("./src/controller/audio-track-controller.ts"),I=S("./src/controller/subtitle-stream-controller.ts"),_=S("./src/controller/subtitle-track-controller.ts"),b=S("./src/controller/buffer-controller.ts"),k=S("./src/controller/timeline-controller.ts"),A=S("./src/controller/cap-level-controller.ts"),T=S("./src/controller/fps-controller.ts"),E=S("./src/controller/eme-controller.ts"),h=S("./src/controller/cmcd-controller.ts"),m=S("./src/utils/xhr-loader.ts"),v=S("./src/utils/fetch-loader.ts"),r=S("./src/utils/cues.ts"),d=S("./src/utils/mediakeys-helper.ts"),n=S("./src/utils/logger.ts");function i(){return i=Object.assign?Object.assign.bind():function(l){for(var p=1;p<arguments.length;p++){var c=arguments[p];for(var L in c)Object.prototype.hasOwnProperty.call(c,L)&&(l[L]=c[L])}return l},i.apply(this,arguments)}function y(l,p){var c=Object.keys(l);if(Object.getOwnPropertySymbols){var L=Object.getOwnPropertySymbols(l);p&&(L=L.filter(function(R){return Object.getOwnPropertyDescriptor(l,R).enumerable})),c.push.apply(c,L)}return c}function o(l){for(var p=1;p<arguments.length;p++){var c=arguments[p]!=null?arguments[p]:{};p%2?y(Object(c),!0).forEach(function(L){a(l,L,c[L])}):Object.getOwnPropertyDescriptors?Object.defineProperties(l,Object.getOwnPropertyDescriptors(c)):y(Object(c)).forEach(function(L){Object.defineProperty(l,L,Object.getOwnPropertyDescriptor(c,L))})}return l}function a(l,p,c){return p=g(p),p in l?Object.defineProperty(l,p,{value:c,enumerable:!0,configurable:!0,writable:!0}):l[p]=c,l}function g(l){var p=f(l,"string");return typeof p=="symbol"?p:String(p)}function f(l,p){if(typeof l!="object"||l===null)return l;var c=l[Symbol.toPrimitive];if(c!==void 0){var L=c.call(l,p);if(typeof L!="object")return L;throw new TypeError("@@toPrimitive must return a primitive value.")}return(p==="string"?String:Number)(l)}var s=o(o({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:m.default,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:F.default,bufferController:b.default,capLevelController:A.default,fpsController:T.default,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:d.requestMediaKeySystemAccess,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0},e()),{},{subtitleStreamController:I.SubtitleStreamController,subtitleTrackController:_.default,timelineController:k.TimelineController,audioStreamController:D.default,audioTrackController:P.default,emeController:E.default,cmcdController:h.default});function e(){return{cueHandler:r.default,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function u(l,p){if((p.liveSyncDurationCount||p.liveMaxLatencyDurationCount)&&(p.liveSyncDuration||p.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(p.liveMaxLatencyDurationCount!==void 0&&(p.liveSyncDurationCount===void 0||p.liveMaxLatencyDurationCount<=p.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(p.liveMaxLatencyDuration!==void 0&&(p.liveSyncDuration===void 0||p.liveMaxLatencyDuration<=p.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');return i({},l,p)}function t(l){var p=l.loader;if(p!==v.default&&p!==m.default)n.logger.log("[config]: Custom loader detected, cannot enable progressive streaming"),l.progressive=!1;else{var c=(0,v.fetchSupported)();c&&(l.loader=v.default,l.progressive=!0,l.enableSoftwareAES=!0,n.logger.log("[config]: Progressive streaming enabled, using FetchLoader"))}}},"./src/controller/abr-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>m});var F=S("./src/polyfills/number.ts"),D=S("./src/utils/ewma-bandwidth-estimator.ts"),P=S("./src/events.ts"),I=S("./src/errors.ts"),_=S("./src/types/loader.ts"),b=S("./src/utils/logger.ts");function k(v,r){for(var d=0;d<r.length;d++){var n=r[d];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(v,T(n.key),n)}}function A(v,r,d){return r&&k(v.prototype,r),Object.defineProperty(v,"prototype",{writable:!1}),v}function T(v){var r=E(v,"string");return typeof r=="symbol"?r:String(r)}function E(v,r){if(typeof v!="object"||v===null)return v;var d=v[Symbol.toPrimitive];if(d!==void 0){var n=d.call(v,r);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(v)}var h=function(){function v(d){this.hls=void 0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=void 0,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=d;var n=d.config;this.bwEstimator=new D.default(n.abrEwmaSlowVoD,n.abrEwmaFastVoD,n.abrEwmaDefaultEstimate),this.registerListeners()}var r=v.prototype;return r.registerListeners=function(){var d=this.hls;d.on(P.Events.FRAG_LOADING,this.onFragLoading,this),d.on(P.Events.FRAG_LOADED,this.onFragLoaded,this),d.on(P.Events.FRAG_BUFFERED,this.onFragBuffered,this),d.on(P.Events.LEVEL_LOADED,this.onLevelLoaded,this),d.on(P.Events.ERROR,this.onError,this)},r.unregisterListeners=function(){var d=this.hls;d.off(P.Events.FRAG_LOADING,this.onFragLoading,this),d.off(P.Events.FRAG_LOADED,this.onFragLoaded,this),d.off(P.Events.FRAG_BUFFERED,this.onFragBuffered,this),d.off(P.Events.LEVEL_LOADED,this.onLevelLoaded,this),d.off(P.Events.ERROR,this.onError,this)},r.destroy=function(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null},r.onFragLoading=function(d,n){var i=n.frag;if(i.type===_.PlaylistLevelType.MAIN&&!this.timer){var y;this.fragCurrent=i,this.partCurrent=(y=n.part)!=null?y:null,this.timer=self.setInterval(this.onCheck,100)}},r.onLevelLoaded=function(d,n){var i=this.hls.config;n.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)},r._abandonRulesCheck=function(){var d=this.fragCurrent,n=this.partCurrent,i=this.hls,y=i.autoLevelEnabled,o=i.media;if(!(!d||!o)){var a=n?n.stats:d.stats,g=n?n.duration:d.duration;if(a.aborted||a.loaded&&a.loaded===a.total||d.level===0){this.clearTimer(),this._nextAutoLevel=-1;return}if(!(!y||o.paused||!o.playbackRate||!o.readyState)){var f=i.mainForwardBufferInfo;if(f!==null){var s=performance.now()-a.loading.start,e=Math.abs(o.playbackRate);if(!(s<=500*g/e)){var u=a.loaded&&a.loading.first,t=this.bwEstimator.getEstimate(),l=i.levels,p=i.minAutoLevel,c=l[d.level],L=a.total||Math.max(a.loaded,Math.round(g*c.maxBitrate/8)),R=u?a.loaded*1e3/s:0,w=R?(L-a.loaded)/R:L*8/t,O=f.len/e;if(!(w<=O)){var C=Number.POSITIVE_INFINITY,M;for(M=d.level-1;M>p;M--){var N=l[M].maxBitrate;if(C=R?g*N/(8*.8*R):g*N/t,C<O)break}C>=w||(b.logger.warn("Fragment "+d.sn+(n?" part "+n.index:"")+" of level "+d.level+" is loading too slowly and will cause an underbuffer; aborting and switching to level "+M+`
      Current BW estimate: `+((0,F.isFiniteNumber)(t)?(t/1024).toFixed(3):"Unknown")+` Kb/s
      Estimated load time for current fragment: `+w.toFixed(3)+` s
      Estimated load time for the next fragment: `+C.toFixed(3)+` s
      Time to underbuffer: `+O.toFixed(3)+" s"),i.nextLoadLevel=M,u&&this.bwEstimator.sample(s,a.loaded),this.clearTimer(),(d.loader||d.keyLoader)&&(this.fragCurrent=this.partCurrent=null,d.abortRequests()),i.trigger(P.Events.FRAG_LOAD_EMERGENCY_ABORTED,{frag:d,part:n,stats:a}))}}}}}},r.onFragLoaded=function(d,n){var i=n.frag,y=n.part;if(i.type===_.PlaylistLevelType.MAIN&&(0,F.isFiniteNumber)(i.sn)){var o=y?y.stats:i.stats,a=y?y.duration:i.duration;if(this.clearTimer(),this.lastLoadedFragLevel=i.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var g=this.hls.levels[i.level],f=(g.loaded?g.loaded.bytes:0)+o.loaded,s=(g.loaded?g.loaded.duration:0)+a;g.loaded={bytes:f,duration:s},g.realBitrate=Math.round(8*f/s)}if(i.bitrateTest){var e={stats:o,frag:i,part:y,id:i.type};this.onFragBuffered(P.Events.FRAG_BUFFERED,e)}}},r.onFragBuffered=function(d,n){var i=n.frag,y=n.part,o=y?y.stats:i.stats;if(!o.aborted&&!(i.type!==_.PlaylistLevelType.MAIN||i.sn==="initSegment")){var a=o.parsing.end-o.loading.start;this.bwEstimator.sample(a,o.loaded),o.bwEstimate=this.bwEstimator.getEstimate(),i.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}},r.onError=function(d,n){var i;if(((i=n.frag)===null||i===void 0?void 0:i.type)===_.PlaylistLevelType.MAIN){if(n.type===I.ErrorTypes.KEY_SYSTEM_ERROR){this.clearTimer();return}switch(n.details){case I.ErrorDetails.FRAG_LOAD_ERROR:case I.ErrorDetails.FRAG_LOAD_TIMEOUT:case I.ErrorDetails.KEY_LOAD_ERROR:case I.ErrorDetails.KEY_LOAD_TIMEOUT:this.clearTimer();break}}},r.clearTimer=function(){self.clearInterval(this.timer),this.timer=void 0},r.getNextABRAutoLevel=function(){var d=this.fragCurrent,n=this.partCurrent,i=this.hls,y=i.maxAutoLevel,o=i.config,a=i.minAutoLevel,g=i.media,f=n?n.duration:d?d.duration:0,s=g&&g.playbackRate!==0?Math.abs(g.playbackRate):1,e=this.bwEstimator?this.bwEstimator.getEstimate():o.abrEwmaDefaultEstimate,u=i.mainForwardBufferInfo,t=(u?u.len:0)/s,l=this.findBestLevel(e,a,y,t,o.abrBandWidthFactor,o.abrBandWidthUpFactor);if(l>=0)return l;b.logger.trace((t?"rebuffering expected":"buffer is empty")+", finding optimal quality level");var p=f?Math.min(f,o.maxStarvationDelay):o.maxStarvationDelay,c=o.abrBandWidthFactor,L=o.abrBandWidthUpFactor;if(!t){var R=this.bitrateTestDelay;if(R){var w=f?Math.min(f,o.maxLoadingDelay):o.maxLoadingDelay;p=w-R,b.logger.trace("bitrate test took "+Math.round(1e3*R)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*p)+" ms"),c=L=1}}return l=this.findBestLevel(e,a,y,t+p,c,L),Math.max(l,0)},r.findBestLevel=function(d,n,i,y,o,a){for(var g,f=this.fragCurrent,s=this.partCurrent,e=this.lastLoadedFragLevel,u=this.hls.levels,t=u[e],l=!!(t!=null&&(g=t.details)!==null&&g!==void 0&&g.live),p=t==null?void 0:t.codecSet,c=s?s.duration:f?f.duration:0,L=i;L>=n;L--){var R=u[L];if(!(!R||p&&R.codecSet!==p)){var w=R.details,O=(s?w==null?void 0:w.partTarget:w==null?void 0:w.averagetargetduration)||c,C=void 0;L<=e?C=o*d:C=a*d;var M=u[L].maxBitrate,N=M*O/C;if(b.logger.trace("level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: "+L+"/"+Math.round(C)+"/"+M+"/"+O+"/"+y+"/"+N),C>M&&(N===0||!(0,F.isFiniteNumber)(N)||l&&!this.bitrateTestDelay||N<y))return L}}return-1},A(v,[{key:"nextAutoLevel",get:function(){var d=this._nextAutoLevel,n=this.bwEstimator;if(d!==-1&&!n.canEstimate())return d;var i=this.getNextABRAutoLevel();return d!==-1&&this.hls.levels[i].loadError?d:(d!==-1&&(i=Math.min(d,i)),i)},set:function(d){this._nextAutoLevel=d}}]),v}();const m=h},"./src/controller/audio-stream-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>a});var F=S("./src/polyfills/number.ts"),D=S("./src/controller/base-stream-controller.ts"),P=S("./src/events.ts"),I=S("./src/utils/buffer-helper.ts"),_=S("./src/controller/fragment-tracker.ts"),b=S("./src/types/level.ts"),k=S("./src/types/loader.ts"),A=S("./src/loader/fragment.ts"),T=S("./src/demux/chunk-cache.ts"),E=S("./src/demux/transmuxer-interface.ts"),h=S("./src/types/transmuxer.ts"),m=S("./src/controller/fragment-finders.ts"),v=S("./src/utils/discontinuities.ts"),r=S("./src/errors.ts");function d(){return d=Object.assign?Object.assign.bind():function(g){for(var f=1;f<arguments.length;f++){var s=arguments[f];for(var e in s)Object.prototype.hasOwnProperty.call(s,e)&&(g[e]=s[e])}return g},d.apply(this,arguments)}function n(g,f){g.prototype=Object.create(f.prototype),g.prototype.constructor=g,i(g,f)}function i(g,f){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(s,e){return s.__proto__=e,s},i(g,f)}var y=100,o=function(g){n(f,g);function f(e,u,t){var l;return l=g.call(this,e,u,t,"[audio-stream-controller]")||this,l.videoBuffer=null,l.videoTrackCC=-1,l.waitingVideoCC=-1,l.audioSwitch=!1,l.trackId=-1,l.waitingData=null,l.mainDetails=null,l.bufferFlushed=!1,l.cachedTrackLoadedData=null,l._registerListeners(),l}var s=f.prototype;return s.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},s._registerListeners=function(){var e=this.hls;e.on(P.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(P.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(P.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(P.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(P.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(P.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(P.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(P.Events.ERROR,this.onError,this),e.on(P.Events.BUFFER_RESET,this.onBufferReset,this),e.on(P.Events.BUFFER_CREATED,this.onBufferCreated,this),e.on(P.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(P.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(P.Events.FRAG_BUFFERED,this.onFragBuffered,this)},s._unregisterListeners=function(){var e=this.hls;e.off(P.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(P.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(P.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(P.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(P.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(P.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(P.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(P.Events.ERROR,this.onError,this),e.off(P.Events.BUFFER_RESET,this.onBufferReset,this),e.off(P.Events.BUFFER_CREATED,this.onBufferCreated,this),e.off(P.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(P.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(P.Events.FRAG_BUFFERED,this.onFragBuffered,this)},s.onInitPtsFound=function(e,u){var t=u.frag,l=u.id,p=u.initPTS;if(l==="main"){var c=t.cc;this.initPTS[t.cc]=p,this.log("InitPTS for cc: "+c+" found from main: "+p),this.videoTrackCC=c,this.state===D.State.WAITING_INIT_PTS&&this.tick()}},s.startLoad=function(e){if(!this.levels){this.startPosition=e,this.state=D.State.STOPPED;return}var u=this.lastCurrentTime;this.stopLoad(),this.setInterval(y),this.fragLoadError=0,u>0&&e===-1?(this.log("Override startPosition with lastCurrentTime @"+u.toFixed(3)),e=u,this.state=D.State.IDLE):(this.loadedmetadata=!1,this.state=D.State.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()},s.doTick=function(){switch(this.state){case D.State.IDLE:this.doTickIdle();break;case D.State.WAITING_TRACK:{var e,u=this.levels,t=this.trackId,l=u==null||(e=u[t])===null||e===void 0?void 0:e.details;if(l){if(this.waitForCdnTuneIn(l))break;this.state=D.State.WAITING_INIT_PTS}break}case D.State.FRAG_LOADING_WAITING_RETRY:{var p,c=performance.now(),L=this.retryDate;(!L||c>=L||(p=this.media)!==null&&p!==void 0&&p.seeking)&&(this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.trackId),this.state=D.State.IDLE);break}case D.State.WAITING_INIT_PTS:{var R=this.waitingData;if(R){var w=R.frag,O=R.part,C=R.cache,M=R.complete;if(this.initPTS[w.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=D.State.FRAG_LOADING;var N=C.flush(),U={frag:w,part:O,payload:N,networkDetails:null};this._handleFragmentLoadProgress(U),M&&g.prototype._handleFragmentLoadComplete.call(this,U)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log("Waiting fragment cc ("+w.cc+") cancelled because video is at cc "+this.videoTrackCC),this.clearWaitingFragment();else{var B=this.getLoadPosition(),G=I.BufferHelper.bufferInfo(this.mediaBuffer,B,this.config.maxBufferHole),K=(0,m.fragmentWithinToleranceTest)(G.end,this.config.maxFragLookUpTolerance,w);K<0&&(this.log("Waiting fragment cc ("+w.cc+") @ "+w.start+" cancelled because another fragment at "+G.end+" is needed"),this.clearWaitingFragment())}}else this.state=D.State.IDLE}}this.onTickEnd()},s.clearWaitingFragment=function(){var e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=D.State.IDLE)},s.resetLoadingState=function(){this.clearWaitingFragment(),g.prototype.resetLoadingState.call(this)},s.onTickEnd=function(){var e=this.media;!e||!e.readyState||(this.lastCurrentTime=e.currentTime)},s.doTickIdle=function(){var e=this.hls,u=this.levels,t=this.media,l=this.trackId,p=e.config;if(!(!u||!u[l])&&!(!t&&(this.startFragRequested||!p.startFragPrefetch))){var c=u[l],L=c.details;if(!L||L.live&&this.levelLastLoaded!==l||this.waitForCdnTuneIn(L)){this.state=D.State.WAITING_TRACK;return}var R=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&R&&(this.bufferFlushed=!1,this.afterBufferFlushed(R,A.ElementaryStreamTypes.AUDIO,k.PlaylistLevelType.AUDIO));var w=this.getFwdBufferInfo(R,k.PlaylistLevelType.AUDIO);if(w!==null){var O=this.audioSwitch;if(!O&&this._streamEnded(w,L)){e.trigger(P.Events.BUFFER_EOS,{type:"audio"}),this.state=D.State.ENDED;return}var C=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,k.PlaylistLevelType.MAIN),M=w.len,N=this.getMaxBufferLength(C==null?void 0:C.len);if(!(M>=N&&!O)){var U=L.fragments,B=U[0].start,G=w.end;if(O&&t){var K=this.getLoadPosition();G=K,L.PTSKnown&&K<B&&(w.end>B||w.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),t.currentTime=B+.05)}if(!(C&&G>C.end+L.targetduration)&&!((!C||!C.len)&&w.len)){var Y=this.getNextFragment(G,L);if(!Y){this.bufferFlushed=!0;return}this.loadFragment(Y,L,G)}}}}},s.getMaxBufferLength=function(e){var u=g.prototype.getMaxBufferLength.call(this);return e?Math.max(u,e):u},s.onMediaDetaching=function(){this.videoBuffer=null,g.prototype.onMediaDetaching.call(this)},s.onAudioTracksUpdated=function(e,u){var t=u.audioTracks;this.resetTransmuxer(),this.levels=t.map(function(l){return new b.Level(l)})},s.onAudioTrackSwitching=function(e,u){var t=!!u.url;this.trackId=u.id;var l=this.fragCurrent;l&&l.abortRequests(),this.fragCurrent=null,this.clearWaitingFragment(),t?this.setInterval(y):this.resetTransmuxer(),t?(this.audioSwitch=!0,this.state=D.State.IDLE):this.state=D.State.STOPPED,this.tick()},s.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1},s.onLevelLoaded=function(e,u){this.mainDetails=u.details,this.cachedTrackLoadedData!==null&&(this.hls.trigger(P.Events.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)},s.onAudioTrackLoaded=function(e,u){var t;if(this.mainDetails==null){this.cachedTrackLoadedData=u;return}var l=this.levels,p=u.details,c=u.id;if(!l){this.warn("Audio tracks were reset while loading level "+c);return}this.log("Track "+c+" loaded ["+p.startSN+","+p.endSN+"],duration:"+p.totalduration);var L=l[c],R=0;if(p.live||(t=L.details)!==null&&t!==void 0&&t.live){var w=this.mainDetails;if(p.fragments[0]||(p.deltaUpdateFailed=!0),p.deltaUpdateFailed||!w)return;!L.details&&p.hasProgramDateTime&&w.hasProgramDateTime?((0,v.alignMediaPlaylistByPDT)(p,w),R=p.fragments[0].start):R=this.alignPlaylists(p,L.details)}L.details=p,this.levelLastLoaded=c,!this.startFragRequested&&(this.mainDetails||!p.live)&&this.setStartPosition(L.details,R),this.state===D.State.WAITING_TRACK&&!this.waitForCdnTuneIn(p)&&(this.state=D.State.IDLE),this.tick()},s._handleFragmentLoadProgress=function(e){var u,t=e.frag,l=e.part,p=e.payload,c=this.config,L=this.trackId,R=this.levels;if(!R){this.warn("Audio tracks were reset while fragment load was in progress. Fragment "+t.sn+" of level "+t.level+" will not be buffered");return}var w=R[L];console.assert(w,"Audio track is defined on fragment load progress");var O=w.details;console.assert(O,"Audio track details are defined on fragment load progress");var C=c.defaultAudioCodec||w.audioCodec||"mp4a.40.2",M=this.transmuxer;M||(M=this.transmuxer=new E.default(this.hls,k.PlaylistLevelType.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));var N=this.initPTS[t.cc],U=(u=t.initSegment)===null||u===void 0?void 0:u.data;if(N!==void 0){var B=!1,G=l?l.index:-1,K=G!==-1,Y=new h.ChunkMetadata(t.level,t.sn,t.stats.chunkCount,p.byteLength,G,K);M.push(p,U,C,"",t,l,O.totalduration,B,Y,N)}else{this.log("Unknown video PTS for cc "+t.cc+", waiting for video PTS before demuxing audio frag "+t.sn+" of ["+O.startSN+" ,"+O.endSN+"],track "+L);var q=this.waitingData=this.waitingData||{frag:t,part:l,cache:new T.default,complete:!1},H=q.cache;H.push(new Uint8Array(p)),this.waitingVideoCC=this.videoTrackCC,this.state=D.State.WAITING_INIT_PTS}},s._handleFragmentLoadComplete=function(e){if(this.waitingData){this.waitingData.complete=!0;return}g.prototype._handleFragmentLoadComplete.call(this,e)},s.onBufferReset=function(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1},s.onBufferCreated=function(e,u){var t=u.tracks.audio;t&&(this.mediaBuffer=t.buffer||null),u.tracks.video&&(this.videoBuffer=u.tracks.video.buffer||null)},s.onFragBuffered=function(e,u){var t=u.frag,l=u.part;if(t.type!==k.PlaylistLevelType.AUDIO){if(!this.loadedmetadata&&t.type===k.PlaylistLevelType.MAIN){var p;(p=this.videoBuffer||this.media)!==null&&p!==void 0&&p.buffered.length&&(this.loadedmetadata=!0)}return}if(this.fragContextChanged(t)){this.warn("Fragment "+t.sn+(l?" p: "+l.index:"")+" of level "+t.level+" finished buffering, but was aborted. state: "+this.state+", audioSwitch: "+this.audioSwitch);return}t.sn!=="initSegment"&&(this.fragPrevious=t,this.audioSwitch&&(this.audioSwitch=!1,this.hls.trigger(P.Events.AUDIO_TRACK_SWITCHED,{id:this.trackId}))),this.fragBufferedComplete(t,l)},s.onError=function(e,u){if(u.type===r.ErrorTypes.KEY_SYSTEM_ERROR){this.onFragmentOrKeyLoadError(k.PlaylistLevelType.AUDIO,u);return}switch(u.details){case r.ErrorDetails.FRAG_LOAD_ERROR:case r.ErrorDetails.FRAG_LOAD_TIMEOUT:case r.ErrorDetails.FRAG_PARSING_ERROR:case r.ErrorDetails.KEY_LOAD_ERROR:case r.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(k.PlaylistLevelType.AUDIO,u);break;case r.ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case r.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:this.state!==D.State.ERROR&&this.state!==D.State.STOPPED&&(this.state=u.fatal?D.State.ERROR:D.State.IDLE,this.warn(u.details+" while loading frag, switching to "+this.state+" state"));break;case r.ErrorDetails.BUFFER_FULL_ERROR:if(u.parent==="audio"&&(this.state===D.State.PARSING||this.state===D.State.PARSED)){var t=!0,l=this.getFwdBufferInfo(this.mediaBuffer,k.PlaylistLevelType.AUDIO);l&&l.len>.5&&(t=!this.reduceMaxBufferLength(l.len)),t&&(this.warn("Buffer full error also media.currentTime is not buffered, flush audio buffer"),this.fragCurrent=null,g.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.resetLoadingState()}break}},s.onBufferFlushed=function(e,u){var t=u.type;t===A.ElementaryStreamTypes.AUDIO&&(this.bufferFlushed=!0,this.state===D.State.ENDED&&(this.state=D.State.IDLE))},s._handleTransmuxComplete=function(e){var u,t="audio",l=this.hls,p=e.remuxResult,c=e.chunkMeta,L=this.getCurrentContext(c);if(!L){this.warn("The loading context changed while buffering fragment "+c.sn+" of level "+c.level+". This chunk will not be buffered."),this.resetStartWhenNotLoaded(c.level);return}var R=L.frag,w=L.part,O=L.level.details,C=p.audio,M=p.text,N=p.id3,U=p.initSegment;if(!(this.fragContextChanged(R)||!O)){if(this.state=D.State.PARSING,this.audioSwitch&&C&&this.completeAudioSwitch(),U!=null&&U.tracks&&(this._bufferInitSegment(U.tracks,R,c),l.trigger(P.Events.FRAG_PARSING_INIT_SEGMENT,{frag:R,id:t,tracks:U.tracks})),C){var B=C.startPTS,G=C.endPTS,K=C.startDTS,Y=C.endDTS;w&&(w.elementaryStreams[A.ElementaryStreamTypes.AUDIO]={startPTS:B,endPTS:G,startDTS:K,endDTS:Y}),R.setElementaryStreamInfo(A.ElementaryStreamTypes.AUDIO,B,G,K,Y),this.bufferFragmentData(C,R,w,c)}if(N!=null&&(u=N.samples)!==null&&u!==void 0&&u.length){var q=d({id:t,frag:R,details:O},N);l.trigger(P.Events.FRAG_PARSING_METADATA,q)}if(M){var H=d({id:t,frag:R,details:O},M);l.trigger(P.Events.FRAG_PARSING_USERDATA,H)}}},s._bufferInitSegment=function(e,u,t){if(this.state===D.State.PARSING){e.video&&delete e.video;var l=e.audio;if(l){l.levelCodec=l.codec,l.id="audio",this.log("Init audio buffer, container:"+l.container+", codecs[parsed]=["+l.codec+"]"),this.hls.trigger(P.Events.BUFFER_CODECS,e);var p=l.initSegment;if(p!=null&&p.byteLength){var c={type:"audio",frag:u,part:null,chunkMeta:t,parent:u.type,data:p};this.hls.trigger(P.Events.BUFFER_APPENDING,c)}this.tick()}}},s.loadFragment=function(e,u,t){var l=this.fragmentTracker.getState(e);this.fragCurrent=e,(this.audioSwitch||l===_.FragmentState.NOT_LOADED||l===_.FragmentState.PARTIAL)&&(e.sn==="initSegment"?this._loadInitSegment(e,u):u.live&&!(0,F.isFiniteNumber)(this.initPTS[e.cc])?(this.log("Waiting for video PTS in continuity counter "+e.cc+" of live stream before loading audio fragment "+e.sn+" of level "+this.trackId),this.state=D.State.WAITING_INIT_PTS):(this.startFragRequested=!0,g.prototype.loadFragment.call(this,e,u,t)))},s.completeAudioSwitch=function(){var e=this.hls,u=this.media,t=this.trackId;u&&(this.log("Switching audio track : flushing all audio"),g.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.audioSwitch=!1,e.trigger(P.Events.AUDIO_TRACK_SWITCHED,{id:t})},f}(D.default);const a=o},"./src/controller/audio-track-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>m});var F=S("./src/events.ts"),D=S("./src/errors.ts"),P=S("./src/controller/base-playlist-controller.ts"),I=S("./src/types/loader.ts");function _(v,r){for(var d=0;d<r.length;d++){var n=r[d];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(v,k(n.key),n)}}function b(v,r,d){return r&&_(v.prototype,r),Object.defineProperty(v,"prototype",{writable:!1}),v}function k(v){var r=A(v,"string");return typeof r=="symbol"?r:String(r)}function A(v,r){if(typeof v!="object"||v===null)return v;var d=v[Symbol.toPrimitive];if(d!==void 0){var n=d.call(v,r);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(v)}function T(v,r){v.prototype=Object.create(r.prototype),v.prototype.constructor=v,E(v,r)}function E(v,r){return E=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(d,n){return d.__proto__=n,d},E(v,r)}var h=function(v){T(r,v);function r(n){var i;return i=v.call(this,n,"[audio-track-controller]")||this,i.tracks=[],i.groupId=null,i.tracksInGroup=[],i.trackId=-1,i.trackName="",i.selectDefaultTrack=!0,i.registerListeners(),i}var d=r.prototype;return d.registerListeners=function(){var n=this.hls;n.on(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.on(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),n.on(F.Events.LEVEL_LOADING,this.onLevelLoading,this),n.on(F.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),n.on(F.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),n.on(F.Events.ERROR,this.onError,this)},d.unregisterListeners=function(){var n=this.hls;n.off(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.off(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),n.off(F.Events.LEVEL_LOADING,this.onLevelLoading,this),n.off(F.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),n.off(F.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),n.off(F.Events.ERROR,this.onError,this)},d.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,v.prototype.destroy.call(this)},d.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.trackName="",this.selectDefaultTrack=!0},d.onManifestParsed=function(n,i){this.tracks=i.audioTracks||[]},d.onAudioTrackLoaded=function(n,i){var y=i.id,o=i.details,a=this.tracksInGroup[y];if(!a){this.warn("Invalid audio track id "+y);return}var g=a.details;a.details=i.details,this.log("audioTrack "+y+" loaded ["+o.startSN+"-"+o.endSN+"]"),y===this.trackId&&(this.retryCount=0,this.playlistLoaded(y,i,g))},d.onLevelLoading=function(n,i){this.switchLevel(i.level)},d.onLevelSwitching=function(n,i){this.switchLevel(i.level)},d.switchLevel=function(n){var i=this.hls.levels[n];if(i!=null&&i.audioGroupIds){var y=i.audioGroupIds[i.urlId];if(this.groupId!==y){this.groupId=y;var o=this.tracks.filter(function(g){return!y||g.groupId===y});this.selectDefaultTrack&&!o.some(function(g){return g.default})&&(this.selectDefaultTrack=!1),this.tracksInGroup=o;var a={audioTracks:o};this.log("Updating audio tracks, "+o.length+' track(s) found in "'+y+'" group-id'),this.hls.trigger(F.Events.AUDIO_TRACKS_UPDATED,a),this.selectInitialTrack()}}},d.onError=function(n,i){v.prototype.onError.call(this,n,i),!(i.fatal||!i.context)&&i.context.type===I.PlaylistContextType.AUDIO_TRACK&&i.context.id===this.trackId&&i.context.groupId===this.groupId&&this.retryLoadingOrFail(i)},d.setAudioTrack=function(n){var i=this.tracksInGroup;if(n<0||n>=i.length){this.warn("Invalid id passed to audio-track controller");return}this.clearTimer();var y=i[this.trackId];this.log("Now switching to audio-track index "+n);var o=i[n],a=o.id,g=o.groupId,f=g===void 0?"":g,s=o.name,e=o.type,u=o.url;if(this.trackId=n,this.trackName=s,this.selectDefaultTrack=!1,this.hls.trigger(F.Events.AUDIO_TRACK_SWITCHING,{id:a,groupId:f,name:s,type:e,url:u}),!(o.details&&!o.details.live)){var t=this.switchParams(o.url,y==null?void 0:y.details);this.loadPlaylist(t)}},d.selectInitialTrack=function(){var n=this.tracksInGroup;console.assert(n.length,"Initial audio track should be selected when tracks are known");var i=this.trackName,y=this.findTrackId(i)||this.findTrackId();y!==-1?this.setAudioTrack(y):(this.warn("No track found for running audio group-ID: "+this.groupId),this.hls.trigger(F.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal:!0}))},d.findTrackId=function(n){for(var i=this.tracksInGroup,y=0;y<i.length;y++){var o=i[y];if((!this.selectDefaultTrack||o.default)&&(!n||n===o.name))return o.id}return-1},d.loadPlaylist=function(n){v.prototype.loadPlaylist.call(this);var i=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(i)){var y=i.id,o=i.groupId,a=i.url;if(n)try{a=n.addDirectives(a)}catch(g){this.warn("Could not construct new URL with HLS Delivery Directives: "+g)}this.log("loading audio-track playlist for id: "+y),this.clearTimer(),this.hls.trigger(F.Events.AUDIO_TRACK_LOADING,{url:a,id:y,groupId:o,deliveryDirectives:n||null})}},b(r,[{key:"audioTracks",get:function(){return this.tracksInGroup}},{key:"audioTrack",get:function(){return this.trackId},set:function(n){this.selectDefaultTrack=!1,this.setAudioTrack(n)}}]),r}(P.default);const m=h},"./src/controller/base-playlist-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>_});var F=S("./src/types/level.ts"),D=S("./src/controller/level-helper.ts"),P=S("./src/utils/logger.ts"),I=S("./src/errors.ts"),_=function(){function b(A,T){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.retryCount=0,this.log=void 0,this.warn=void 0,this.log=P.logger.log.bind(P.logger,T+":"),this.warn=P.logger.warn.bind(P.logger,T+":"),this.hls=A}var k=b.prototype;return k.destroy=function(){this.clearTimer(),this.hls=this.log=this.warn=null},k.onError=function(A,T){T.fatal&&(T.type===I.ErrorTypes.NETWORK_ERROR||T.type===I.ErrorTypes.KEY_SYSTEM_ERROR)&&this.stopLoad()},k.clearTimer=function(){clearTimeout(this.timer),this.timer=-1},k.startLoad=function(){this.canLoad=!0,this.retryCount=0,this.requestScheduled=-1,this.loadPlaylist()},k.stopLoad=function(){this.canLoad=!1,this.clearTimer()},k.switchParams=function(A,T){var E=T==null?void 0:T.renditionReports;if(E)for(var h=0;h<E.length;h++){var m=E[h],v=void 0;try{v=new self.URL(m.URI,T.url).href}catch(i){P.logger.warn("Could not construct new URL for Rendition Report: "+i),v=m.URI||""}if(v===A.slice(-v.length)){var r=parseInt(m["LAST-MSN"])||(T==null?void 0:T.lastPartSn),d=parseInt(m["LAST-PART"])||(T==null?void 0:T.lastPartIndex);if(this.hls.config.lowLatencyMode){var n=Math.min(T.age-T.partTarget,T.targetduration);d>=0&&n>T.partTarget&&(d+=1)}return new F.HlsUrlParameters(r,d>=0?d:void 0,F.HlsSkip.No)}}},k.loadPlaylist=function(A){this.requestScheduled===-1&&(this.requestScheduled=self.performance.now())},k.shouldLoadTrack=function(A){return this.canLoad&&A&&!!A.url&&(!A.details||A.details.live)},k.playlistLoaded=function(A,T,E){var h=this,m=T.details,v=T.stats,r=self.performance.now(),d=v.loading.first?Math.max(0,r-v.loading.first):0;if(m.advancedDateTime=Date.now()-d,m.live||E!=null&&E.live){if(m.reloaded(E),E&&this.log("live playlist "+A+" "+(m.advanced?"REFRESHED "+m.lastPartSn+"-"+m.lastPartIndex:"MISSED")),E&&m.fragments.length>0&&(0,D.mergeDetails)(E,m),!this.canLoad||!m.live)return;var n,i=void 0,y=void 0;if(m.canBlockReload&&m.endSN&&m.advanced){var o=this.hls.config.lowLatencyMode,a=m.lastPartSn,g=m.endSN,f=m.lastPartIndex,s=f!==-1,e=a===g,u=o?0:f;s?(i=e?g+1:a,y=e?u:f+1):i=g+1;var t=m.age,l=t+m.ageHeader,p=Math.min(l-m.partTarget,m.targetduration*1.5);if(p>0){if(E&&p>E.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+E.tuneInGoal+" to: "+p+" with playlist age: "+m.age),p=0;else{var c=Math.floor(p/m.targetduration);if(i+=c,y!==void 0){var L=Math.round(p%m.targetduration/m.partTarget);y+=L}this.log("CDN Tune-in age: "+m.ageHeader+"s last advanced "+t.toFixed(2)+"s goal: "+p+" skip sn "+c+" to part "+y)}m.tuneInGoal=p}if(n=this.getDeliveryDirectives(m,T.deliveryDirectives,i,y),o||!e){this.loadPlaylist(n);return}}else n=this.getDeliveryDirectives(m,T.deliveryDirectives,i,y);var R=this.hls.mainForwardBufferInfo,w=R?R.end-R.len:0,O=(m.edge-w)*1e3,C=(0,D.computeReloadInterval)(m,O);m.updated?r>this.requestScheduled+C&&(this.requestScheduled=v.loading.start):this.requestScheduled=-1,i!==void 0&&m.canBlockReload?this.requestScheduled=v.loading.first+C-(m.partTarget*1e3||1e3):this.requestScheduled=(this.requestScheduled===-1?r:this.requestScheduled)+C;var M=this.requestScheduled-r;M=Math.max(0,M),this.log("reload live playlist "+A+" in "+Math.round(M)+" ms"),this.timer=self.setTimeout(function(){return h.loadPlaylist(n)},M)}else this.clearTimer()},k.getDeliveryDirectives=function(A,T,E,h){var m=(0,F.getSkipValue)(A,E);return T!=null&&T.skip&&A.deltaUpdateFailed&&(E=T.msn,h=T.part,m=F.HlsSkip.No),new F.HlsUrlParameters(E,h,m)},k.retryLoadingOrFail=function(A){var T=this,E=this.hls.config,h=this.retryCount<E.levelLoadingMaxRetry;if(h){var m;if(this.requestScheduled=-1,this.retryCount++,A.details.indexOf("LoadTimeOut")>-1&&(m=A.context)!==null&&m!==void 0&&m.deliveryDirectives)this.warn("retry playlist loading #"+this.retryCount+' after "'+A.details+'"'),this.loadPlaylist();else{var v=Math.min(Math.pow(2,this.retryCount)*E.levelLoadingRetryDelay,E.levelLoadingMaxRetryTimeout);this.timer=self.setTimeout(function(){return T.loadPlaylist()},v),this.warn("retry playlist loading #"+this.retryCount+" in "+v+' ms after "'+A.details+'"')}}else this.warn('cannot recover from error "'+A.details+'"'),this.clearTimer(),A.fatal=!0;return h},b}()},"./src/controller/base-stream-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{State:()=>e,default:()=>u});var F=S("./src/polyfills/number.ts"),D=S("./src/task-loop.ts"),P=S("./src/controller/fragment-tracker.ts"),I=S("./src/utils/buffer-helper.ts"),_=S("./src/utils/logger.ts"),b=S("./src/events.ts"),k=S("./src/errors.ts"),A=S("./src/types/transmuxer.ts"),T=S("./src/utils/mp4-tools.ts"),E=S("./src/utils/discontinuities.ts"),h=S("./src/controller/fragment-finders.ts"),m=S("./src/controller/level-helper.ts"),v=S("./src/loader/fragment-loader.ts"),r=S("./src/crypt/decrypter.ts"),d=S("./src/utils/time-ranges.ts"),n=S("./src/types/loader.ts");function i(t,l){for(var p=0;p<l.length;p++){var c=l[p];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(t,o(c.key),c)}}function y(t,l,p){return l&&i(t.prototype,l),Object.defineProperty(t,"prototype",{writable:!1}),t}function o(t){var l=a(t,"string");return typeof l=="symbol"?l:String(l)}function a(t,l){if(typeof t!="object"||t===null)return t;var p=t[Symbol.toPrimitive];if(p!==void 0){var c=p.call(t,l);if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}function g(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function f(t,l){t.prototype=Object.create(l.prototype),t.prototype.constructor=t,s(t,l)}function s(t,l){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(p,c){return p.__proto__=c,p},s(t,l)}var e={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},u=function(t){f(l,t);function l(c,L,R,w){var O;return O=t.call(this)||this,O.hls=void 0,O.fragPrevious=null,O.fragCurrent=null,O.fragmentTracker=void 0,O.transmuxer=null,O._state=e.STOPPED,O.media=null,O.mediaBuffer=null,O.config=void 0,O.bitrateTest=!1,O.lastCurrentTime=0,O.nextLoadPosition=0,O.startPosition=0,O.loadedmetadata=!1,O.fragLoadError=0,O.retryDate=0,O.levels=null,O.fragmentLoader=void 0,O.keyLoader=void 0,O.levelLastLoaded=null,O.startFragRequested=!1,O.decrypter=void 0,O.initPTS=[],O.onvseeking=null,O.onvended=null,O.logPrefix="",O.log=void 0,O.warn=void 0,O.logPrefix=w,O.log=_.logger.log.bind(_.logger,w+":"),O.warn=_.logger.warn.bind(_.logger,w+":"),O.hls=c,O.fragmentLoader=new v.default(c.config),O.keyLoader=R,O.fragmentTracker=L,O.config=c.config,O.decrypter=new r.default(c.config),c.on(b.Events.LEVEL_SWITCHING,O.onLevelSwitching,g(O)),O}var p=l.prototype;return p.doTick=function(){this.onTickEnd()},p.onTickEnd=function(){},p.startLoad=function(c){},p.stopLoad=function(){this.fragmentLoader.abort(),this.keyLoader.abort();var c=this.fragCurrent;c&&(c.abortRequests(),this.fragmentTracker.removeFragment(c)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=e.STOPPED},p._streamEnded=function(c,L){if(L.live||c.nextStart||!c.end||!this.media)return!1;var R=L.partList;if(R!=null&&R.length){var w=R[R.length-1],O=I.BufferHelper.isBuffered(this.media,w.start+w.duration/2);return O}var C=L.fragments[L.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(C)},p.getLevelDetails=function(){if(this.levels&&this.levelLastLoaded!==null){var c;return(c=this.levels[this.levelLastLoaded])===null||c===void 0?void 0:c.details}},p.onMediaAttached=function(c,L){var R=this.media=this.mediaBuffer=L.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),R.addEventListener("seeking",this.onvseeking),R.addEventListener("ended",this.onvended);var w=this.config;this.levels&&w.autoStartLoad&&this.state===e.STOPPED&&this.startLoad(w.startPosition)},p.onMediaDetaching=function(){var c=this.media;c!=null&&c.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),c&&this.onvseeking&&this.onvended&&(c.removeEventListener("seeking",this.onvseeking),c.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()},p.onMediaSeeking=function(){var c=this.config,L=this.fragCurrent,R=this.media,w=this.mediaBuffer,O=this.state,C=R?R.currentTime:0,M=I.BufferHelper.bufferInfo(w||R,C,c.maxBufferHole);if(this.log("media seeking to "+((0,F.isFiniteNumber)(C)?C.toFixed(3):C)+", state: "+O),this.state===e.ENDED)this.resetLoadingState();else if(L){var N=c.maxFragLookUpTolerance,U=L.start-N,B=L.start+L.duration+N;if(!M.len||B<M.start||U>M.end){var G=C>B;(C<U||G)&&(G&&L.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),L.abortRequests()),this.resetLoadingState())}}R&&(this.lastCurrentTime=C),!this.loadedmetadata&&!M.len&&(this.nextLoadPosition=this.startPosition=C),this.tickImmediate()},p.onMediaEnded=function(){this.startPosition=this.lastCurrentTime=0},p.onLevelSwitching=function(c,L){this.fragLoadError=0},p.onHandlerDestroying=function(){this.stopLoad(),t.prototype.onHandlerDestroying.call(this)},p.onHandlerDestroyed=function(){this.state=e.STOPPED,this.hls.off(b.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,t.prototype.onHandlerDestroyed.call(this)},p.loadFragment=function(c,L,R){this._loadFragForPlayback(c,L,R)},p._loadFragForPlayback=function(c,L,R){var w=this,O=function(C){if(w.fragContextChanged(c)){w.warn("Fragment "+c.sn+(C.part?" p: "+C.part.index:"")+" of level "+c.level+" was dropped during download."),w.fragmentTracker.removeFragment(c);return}c.stats.chunkCount++,w._handleFragmentLoadProgress(C)};this._doFragLoad(c,L,R,O).then(function(C){if(C){w.fragLoadError=0;var M=w.state;if(w.fragContextChanged(c)){(M===e.FRAG_LOADING||!w.fragCurrent&&M===e.PARSING)&&(w.fragmentTracker.removeFragment(c),w.state=e.IDLE);return}"payload"in C&&(w.log("Loaded fragment "+c.sn+" of level "+c.level),w.hls.trigger(b.Events.FRAG_LOADED,C)),w._handleFragmentLoadComplete(C)}}).catch(function(C){w.state===e.STOPPED||w.state===e.ERROR||(w.warn(C),w.resetFragmentLoading(c))})},p.flushMainBuffer=function(c,L,R){if(R===void 0&&(R=null),!!(c-L)){var w={startOffset:c,endOffset:L,type:R};this.fragLoadError=0,this.hls.trigger(b.Events.BUFFER_FLUSHING,w)}},p._loadInitSegment=function(c,L){var R=this;this._doFragLoad(c,L).then(function(w){if(!w||R.fragContextChanged(c)||!R.levels)throw new Error("init load aborted");return w}).then(function(w){var O=R.hls,C=w.payload,M=c.decryptdata;if(C&&C.byteLength>0&&M&&M.key&&M.iv&&M.method==="AES-128"){var N=self.performance.now();return R.decrypter.decrypt(new Uint8Array(C),M.key.buffer,M.iv.buffer).then(function(U){var B=self.performance.now();return O.trigger(b.Events.FRAG_DECRYPTED,{frag:c,payload:U,stats:{tstart:N,tdecrypt:B}}),w.payload=U,w})}return w}).then(function(w){var O=R.fragCurrent,C=R.hls,M=R.levels;if(!M)throw new Error("init load aborted, missing levels");var N=M[c.level].details;console.assert(N,"Level details are defined when init segment is loaded");var U=c.stats;R.state=e.IDLE,R.fragLoadError=0,c.data=new Uint8Array(w.payload),U.parsing.start=U.buffering.start=self.performance.now(),U.parsing.end=U.buffering.end=self.performance.now(),w.frag===O&&C.trigger(b.Events.FRAG_BUFFERED,{stats:U,frag:O,part:null,id:c.type}),R.tick()}).catch(function(w){R.state===e.STOPPED||R.state===e.ERROR||(R.warn(w),R.resetFragmentLoading(c))})},p.fragContextChanged=function(c){var L=this.fragCurrent;return!c||!L||c.level!==L.level||c.sn!==L.sn||c.urlId!==L.urlId},p.fragBufferedComplete=function(c,L){var R,w,O,C,M=this.mediaBuffer?this.mediaBuffer:this.media;this.log("Buffered "+c.type+" sn: "+c.sn+(L?" part: "+L.index:"")+" of "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+c.level+" (frag:["+((R=c.startPTS)!=null?R:NaN).toFixed(3)+"-"+((w=c.endPTS)!=null?w:NaN).toFixed(3)+"] > buffer:"+(M?d.default.toString(I.BufferHelper.getBuffered(M)):"(detached)")+")"),this.state=e.IDLE,M&&(!this.loadedmetadata&&c.type==n.PlaylistLevelType.MAIN&&M.buffered.length&&((O=this.fragCurrent)===null||O===void 0?void 0:O.sn)===((C=this.fragPrevious)===null||C===void 0?void 0:C.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())},p.seekToStartPos=function(){},p._handleFragmentLoadComplete=function(c){var L=this.transmuxer;if(L){var R=c.frag,w=c.part,O=c.partsLoaded,C=!O||O.length===0||O.some(function(N){return!N}),M=new A.ChunkMetadata(R.level,R.sn,R.stats.chunkCount+1,0,w?w.index:-1,!C);L.flush(M)}},p._handleFragmentLoadProgress=function(c){},p._doFragLoad=function(c,L,R,w){var O,C=this;if(R===void 0&&(R=null),!this.levels)throw new Error("frag load aborted, missing levels");var M=null;if(c.encrypted&&!((O=c.decryptdata)!==null&&O!==void 0&&O.key)?(this.log("Loading key for "+c.sn+" of ["+L.startSN+"-"+L.endSN+"], "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+c.level),this.state=e.KEY_LOADING,this.fragCurrent=c,M=this.keyLoader.load(c).then(function(K){if(!C.fragContextChanged(K.frag))return C.hls.trigger(b.Events.KEY_LOADED,K),C.state===e.KEY_LOADING&&(C.state=e.IDLE),K}),this.hls.trigger(b.Events.KEY_LOADING,{frag:c}),this.throwIfFragContextChanged("KEY_LOADING")):!c.encrypted&&L.encryptedFragments.length&&this.keyLoader.loadClear(c,L.encryptedFragments),R=Math.max(c.start,R||0),this.config.lowLatencyMode&&L){var N=L.partList;if(N&&w){R>c.end&&L.fragmentHint&&(c=L.fragmentHint);var U=this.getNextPart(N,c,R);if(U>-1){var B=N[U];return this.log("Loading part sn: "+c.sn+" p: "+B.index+" cc: "+c.cc+" of playlist ["+L.startSN+"-"+L.endSN+"] parts [0-"+U+"-"+(N.length-1)+"] "+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+c.level+", target: "+parseFloat(R.toFixed(3))),this.nextLoadPosition=B.start+B.duration,this.state=e.FRAG_LOADING,this.hls.trigger(b.Events.FRAG_LOADING,{frag:c,part:N[U],targetBufferTime:R}),this.throwIfFragContextChanged("FRAG_LOADING parts"),M?M.then(function(K){return!K||C.fragContextChanged(K.frag)?null:C.doFragPartsLoad(c,N,U,w)}).catch(function(K){return C.handleFragLoadError(K)}):this.doFragPartsLoad(c,N,U,w).catch(function(K){return C.handleFragLoadError(K)})}else if(!c.url||this.loadedEndOfParts(N,R))return Promise.resolve(null)}}this.log("Loading fragment "+c.sn+" cc: "+c.cc+" "+(L?"of ["+L.startSN+"-"+L.endSN+"] ":"")+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+c.level+", target: "+parseFloat(R.toFixed(3))),(0,F.isFiniteNumber)(c.sn)&&!this.bitrateTest&&(this.nextLoadPosition=c.start+c.duration),this.state=e.FRAG_LOADING,this.hls.trigger(b.Events.FRAG_LOADING,{frag:c,targetBufferTime:R}),this.throwIfFragContextChanged("FRAG_LOADING");var G=this.config.progressive;return G&&M?M.then(function(K){return!K||C.fragContextChanged(K==null?void 0:K.frag)?null:C.fragmentLoader.load(c,w)}).catch(function(K){return C.handleFragLoadError(K)}):Promise.all([this.fragmentLoader.load(c,G?w:void 0),M]).then(function(K){var Y=K[0];return!G&&Y&&w&&w(Y),Y}).catch(function(K){return C.handleFragLoadError(K)})},p.throwIfFragContextChanged=function(c){if(this.fragCurrent===null)throw new Error("frag load aborted, context changed in "+c)},p.doFragPartsLoad=function(c,L,R,w){var O=this;return new Promise(function(C,M){var N=[],U=function B(G){var K=L[G];O.fragmentLoader.loadPart(c,K,w).then(function(Y){N[K.index]=Y;var q=Y.part;O.hls.trigger(b.Events.FRAG_LOADED,Y);var H=L[G+1];if(H&&H.fragment===c)B(G+1);else return C({frag:c,part:q,partsLoaded:N})}).catch(M)};U(R)})},p.handleFragLoadError=function(c){if("data"in c){var L=c.data;c.data&&L.details===k.ErrorDetails.INTERNAL_ABORTED?this.handleFragLoadAborted(L.frag,L.part):this.hls.trigger(b.Events.ERROR,L)}else this.hls.trigger(b.Events.ERROR,{type:k.ErrorTypes.OTHER_ERROR,details:k.ErrorDetails.INTERNAL_EXCEPTION,err:c,fatal:!0});return null},p._handleTransmuxerFlush=function(c){var L=this.getCurrentContext(c);if(!L||this.state!==e.PARSING){!this.fragCurrent&&this.state!==e.STOPPED&&this.state!==e.ERROR&&(this.state=e.IDLE);return}var R=L.frag,w=L.part,O=L.level,C=self.performance.now();R.stats.parsing.end=C,w&&(w.stats.parsing.end=C),this.updateLevelTiming(R,w,O,c.partial)},p.getCurrentContext=function(c){var L=this.levels,R=c.level,w=c.sn,O=c.part;if(!L||!L[R])return this.warn("Levels object was unset while buffering fragment "+w+" of level "+R+". The current chunk will not be buffered."),null;var C=L[R],M=O>-1?(0,m.getPartWith)(C,w,O):null,N=M?M.fragment:(0,m.getFragmentWithSN)(C,w,this.fragCurrent);return N?{frag:N,part:M,level:C}:null},p.bufferFragmentData=function(c,L,R,w){if(!(!c||this.state!==e.PARSING)){var O=c.data1,C=c.data2,M=O;if(O&&C&&(M=(0,T.appendUint8Array)(O,C)),!(!M||!M.length)){var N={type:c.type,frag:L,part:R,chunkMeta:w,parent:L.type,data:M};this.hls.trigger(b.Events.BUFFER_APPENDING,N),c.dropped&&c.independent&&!R&&this.flushBufferGap(L)}}},p.flushBufferGap=function(c){var L=this.media;if(L){if(!I.BufferHelper.isBuffered(L,L.currentTime)){this.flushMainBuffer(0,c.start);return}var R=L.currentTime,w=I.BufferHelper.bufferInfo(L,R,0),O=c.duration,C=Math.min(this.config.maxFragLookUpTolerance*2,O*.25),M=Math.max(Math.min(c.start-C,w.end-C),R+C);c.start-M>C&&this.flushMainBuffer(M,c.start)}},p.getFwdBufferInfo=function(c,L){var R=this.config,w=this.getLoadPosition();if(!(0,F.isFiniteNumber)(w))return null;var O=I.BufferHelper.bufferInfo(c,w,R.maxBufferHole);if(O.len===0&&O.nextStart!==void 0){var C=this.fragmentTracker.getBufferedFrag(w,L);if(C&&O.nextStart<C.end)return I.BufferHelper.bufferInfo(c,w,Math.max(O.nextStart,R.maxBufferHole))}return O},p.getMaxBufferLength=function(c){var L=this.config,R;return c?R=Math.max(8*L.maxBufferSize/c,L.maxBufferLength):R=L.maxBufferLength,Math.min(R,L.maxMaxBufferLength)},p.reduceMaxBufferLength=function(c){var L=this.config,R=c||L.maxBufferLength;return L.maxMaxBufferLength>=R?(L.maxMaxBufferLength/=2,this.warn("Reduce max buffer length to "+L.maxMaxBufferLength+"s"),!0):!1},p.getNextFragment=function(c,L){var R=L.fragments,w=R.length;if(!w)return null;var O=this.config,C=R[0].start,M;if(L.live){var N=O.initialLiveManifestSize;if(w<N)return this.warn("Not enough fragments to start playback (have: "+w+", need: "+N+")"),null;!L.PTSKnown&&!this.startFragRequested&&this.startPosition===-1&&(M=this.getInitialLiveFragment(L,R),this.startPosition=M?this.hls.liveSyncPosition||M.start:c)}else c<=C&&(M=R[0]);if(!M){var U=O.lowLatencyMode?L.partEnd:L.fragmentEnd;M=this.getFragmentAtPosition(c,U,L)}return this.mapToInitFragWhenRequired(M)},p.mapToInitFragWhenRequired=function(c){return c!=null&&c.initSegment&&!(c!=null&&c.initSegment.data)&&!this.bitrateTest?c.initSegment:c},p.getNextPart=function(c,L,R){for(var w=-1,O=!1,C=!0,M=0,N=c.length;M<N;M++){var U=c[M];if(C=C&&!U.independent,w>-1&&R<U.start)break;var B=U.loaded;B?w=-1:(O||U.independent||C)&&U.fragment===L&&(w=M),O=B}return w},p.loadedEndOfParts=function(c,L){var R=c[c.length-1];return R&&L>R.start&&R.loaded},p.getInitialLiveFragment=function(c,L){var R=this.fragPrevious,w=null;if(R){if(c.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+R.programDateTime),w=(0,h.findFragmentByPDT)(L,R.endProgramDateTime,this.config.maxFragLookUpTolerance)),!w){var O=R.sn+1;if(O>=c.startSN&&O<=c.endSN){var C=L[O-c.startSN];R.cc===C.cc&&(w=C,this.log("Live playlist, switching playlist, load frag with next SN: "+w.sn))}w||(w=(0,h.findFragWithCC)(L,R.cc),w&&this.log("Live playlist, switching playlist, load frag with same CC: "+w.sn))}}else{var M=this.hls.liveSyncPosition;M!==null&&(w=this.getFragmentAtPosition(M,this.bitrateTest?c.fragmentEnd:c.edge,c))}return w},p.getFragmentAtPosition=function(c,L,R){var w=this.config,O=this.fragPrevious,C=R.fragments,M=R.endSN,N=R.fragmentHint,U=w.maxFragLookUpTolerance,B=!!(w.lowLatencyMode&&R.partList&&N);B&&N&&!this.bitrateTest&&(C=C.concat(N),M=N.sn);var G;if(c<L){var K=c>L-U?0:U;G=(0,h.findFragmentByPTS)(O,C,c,K)}else G=C[C.length-1];if(G){var Y=G.sn-R.startSN;if(this.fragmentTracker.getState(G)===P.FragmentState.OK&&(O=G),O&&G.sn===O.sn&&!B){var q=O&&G.level===O.level;if(q){var H=C[Y+1];G.sn<M&&this.fragmentTracker.getState(H)!==P.FragmentState.OK?(this.log("SN "+G.sn+" just loaded, load next one: "+H.sn),G=H):G=null}}}return G},p.synchronizeToLiveEdge=function(c){var L=this.config,R=this.media;if(R){var w=this.hls.liveSyncPosition,O=R.currentTime,C=c.fragments[0].start,M=c.edge,N=O>=C-L.maxFragLookUpTolerance&&O<=M;if(w!==null&&R.duration>w&&(O<w||!N)){var U=L.liveMaxLatencyDuration!==void 0?L.liveMaxLatencyDuration:L.liveMaxLatencyDurationCount*c.targetduration;(!N&&R.readyState<4||O<M-U)&&(this.loadedmetadata||(this.nextLoadPosition=w),R.readyState&&(this.warn("Playback: "+O.toFixed(3)+" is located too far from the end of live sliding playlist: "+M+", reset currentTime to : "+w.toFixed(3)),R.currentTime=w))}}},p.alignPlaylists=function(c,L){var R=this.levels,w=this.levelLastLoaded,O=this.fragPrevious,C=w!==null?R[w]:null,M=c.fragments.length;if(!M)return this.warn("No fragments in live playlist"),0;var N=c.fragments[0].start,U=!L,B=c.alignedSliding&&(0,F.isFiniteNumber)(N);if(U||!B&&!N){(0,E.alignStream)(O,C,c);var G=c.fragments[0].start;return this.log("Live playlist sliding: "+G.toFixed(2)+" start-sn: "+(L?L.startSN:"na")+"->"+c.startSN+" prev-sn: "+(O?O.sn:"na")+" fragments: "+M),G}return N},p.waitForCdnTuneIn=function(c){var L=3;return c.live&&c.canBlockReload&&c.partTarget&&c.tuneInGoal>Math.max(c.partHoldBack,c.partTarget*L)},p.setStartPosition=function(c,L){var R=this.startPosition;if(R<L&&(R=-1),R===-1||this.lastCurrentTime===-1){var w=c.startTimeOffset;(0,F.isFiniteNumber)(w)?(R=L+w,w<0&&(R+=c.totalduration),R=Math.min(Math.max(L,R),L+c.totalduration),this.log("Start time offset "+w+" found in playlist, adjust startPosition to "+R),this.startPosition=R):c.live?R=this.hls.liveSyncPosition||L:this.startPosition=R=0,this.lastCurrentTime=R}this.nextLoadPosition=R},p.getLoadPosition=function(){var c=this.media,L=0;return this.loadedmetadata&&c?L=c.currentTime:this.nextLoadPosition&&(L=this.nextLoadPosition),L},p.handleFragLoadAborted=function(c,L){this.transmuxer&&c.sn!=="initSegment"&&c.stats.aborted&&(this.warn("Fragment "+c.sn+(L?" part"+L.index:"")+" of level "+c.level+" was aborted"),this.resetFragmentLoading(c))},p.resetFragmentLoading=function(c){(!this.fragCurrent||!this.fragContextChanged(c)&&this.state!==e.FRAG_LOADING_WAITING_RETRY)&&(this.state=e.IDLE)},p.onFragmentOrKeyLoadError=function(c,L){if(L.fatal){this.stopLoad(),this.state=e.ERROR;return}var R=this.config;if(L.chunkMeta){var w=this.getCurrentContext(L.chunkMeta);w&&(L.frag=w.frag,L.levelRetry=!0,this.fragLoadError=R.fragLoadingMaxRetry)}var O=L.frag;if(!(!O||O.type!==c)){var C=this.fragCurrent;if(console.assert(C&&O.sn===C.sn&&O.level===C.level&&O.urlId===C.urlId,"Frag load error must match current frag to retry"),this.fragLoadError+1<=R.fragLoadingMaxRetry){this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition);var M=Math.min(Math.pow(2,this.fragLoadError)*R.fragLoadingRetryDelay,R.fragLoadingMaxRetryTimeout);this.warn("Fragment "+O.sn+" of "+c+" "+O.level+" failed to load, retrying in "+M+"ms"),this.retryDate=self.performance.now()+M,this.fragLoadError++,this.state=e.FRAG_LOADING_WAITING_RETRY}else L.levelRetry?(c===n.PlaylistLevelType.AUDIO&&(this.fragCurrent=null),this.fragLoadError=0,this.state=e.IDLE):(_.logger.error(L.details+" reaches max retry, redispatch as fatal ..."),L.fatal=!0,this.hls.stopLoad(),this.state=e.ERROR)}},p.afterBufferFlushed=function(c,L,R){if(c){var w=I.BufferHelper.getBuffered(c);this.fragmentTracker.detectEvictedFragments(L,w,R),this.state===e.ENDED&&this.resetLoadingState()}},p.resetLoadingState=function(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=e.IDLE},p.resetStartWhenNotLoaded=function(c){if(!this.loadedmetadata){this.startFragRequested=!1;var L=this.levels?this.levels[c].details:null;L!=null&&L.live?(this.startPosition=-1,this.setStartPosition(L,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}},p.updateLevelTiming=function(c,L,R,w){var O=this,C=R.details;console.assert(!!C,"level.details must be defined");var M=Object.keys(c.elementaryStreams).reduce(function(N,U){var B=c.elementaryStreams[U];if(B){var G=B.endPTS-B.startPTS;if(G<=0)return O.warn("Could not parse fragment "+c.sn+" "+U+" duration reliably ("+G+")"),N||!1;var K=w?0:(0,m.updateFragPTSDTS)(C,c,B.startPTS,B.endPTS,B.startDTS,B.endDTS);return O.hls.trigger(b.Events.LEVEL_PTS_UPDATED,{details:C,level:R,drift:K,type:U,frag:c,start:B.startPTS,end:B.endPTS}),!0}return N},!1);M||(this.warn("Found no media in fragment "+c.sn+" of level "+R.id+" resetting transmuxer to fallback to playlist timing"),this.resetTransmuxer()),this.state=e.PARSED,this.hls.trigger(b.Events.FRAG_PARSED,{frag:c,part:L})},p.resetTransmuxer=function(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)},y(l,[{key:"state",get:function(){return this._state},set:function(c){var L=this._state;L!==c&&(this._state=c,this.log(L+"->"+c))}}]),l}(D.default)},"./src/controller/buffer-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>h});var F=S("./src/polyfills/number.ts"),D=S("./src/events.ts"),P=S("./src/utils/logger.ts"),I=S("./src/errors.ts"),_=S("./src/utils/buffer-helper.ts"),b=S("./src/utils/mediasource-helper.ts"),k=S("./src/loader/fragment.ts"),A=S("./src/controller/buffer-operation-queue.ts"),T=(0,b.getMediaSource)(),E=/([ha]vc.)(?:\.[^.,]+)+/,h=function(){function m(r){var d=this;this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=function(){var n=d.media,i=d.mediaSource;P.logger.log("[buffer-controller]: Media source opened"),n&&(n.removeEventListener("emptied",d._onMediaEmptied),d.updateMediaElementDuration(),d.hls.trigger(D.Events.MEDIA_ATTACHED,{media:n})),i&&i.removeEventListener("sourceopen",d._onMediaSourceOpen),d.checkPendingTracks()},this._onMediaSourceClose=function(){P.logger.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=function(){P.logger.log("[buffer-controller]: Media source ended")},this._onMediaEmptied=function(){var n=d.media,i=d._objectUrl;n&&n.src!==i&&P.logger.error("Media element src was set while attaching MediaSource ("+i+" > "+n.src+")")},this.hls=r,this._initSourceBuffer(),this.registerListeners()}var v=m.prototype;return v.hasSourceTypes=function(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0},v.destroy=function(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null},v.registerListeners=function(){var r=this.hls;r.on(D.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),r.on(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),r.on(D.Events.MANIFEST_PARSED,this.onManifestParsed,this),r.on(D.Events.BUFFER_RESET,this.onBufferReset,this),r.on(D.Events.BUFFER_APPENDING,this.onBufferAppending,this),r.on(D.Events.BUFFER_CODECS,this.onBufferCodecs,this),r.on(D.Events.BUFFER_EOS,this.onBufferEos,this),r.on(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),r.on(D.Events.LEVEL_UPDATED,this.onLevelUpdated,this),r.on(D.Events.FRAG_PARSED,this.onFragParsed,this),r.on(D.Events.FRAG_CHANGED,this.onFragChanged,this)},v.unregisterListeners=function(){var r=this.hls;r.off(D.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),r.off(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),r.off(D.Events.MANIFEST_PARSED,this.onManifestParsed,this),r.off(D.Events.BUFFER_RESET,this.onBufferReset,this),r.off(D.Events.BUFFER_APPENDING,this.onBufferAppending,this),r.off(D.Events.BUFFER_CODECS,this.onBufferCodecs,this),r.off(D.Events.BUFFER_EOS,this.onBufferEos,this),r.off(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),r.off(D.Events.LEVEL_UPDATED,this.onLevelUpdated,this),r.off(D.Events.FRAG_PARSED,this.onFragParsed,this),r.off(D.Events.FRAG_CHANGED,this.onFragChanged,this)},v._initSourceBuffer=function(){this.sourceBuffer={},this.operationQueue=new A.default(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.lastMpegAudioChunk=null},v.onManifestParsed=function(r,d){var n=2;(d.audio&&!d.video||!d.altAudio)&&(n=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=n,this.details=null,P.logger.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")},v.onMediaAttaching=function(r,d){var n=this.media=d.media;if(n&&T){var i=this.mediaSource=new T;i.addEventListener("sourceopen",this._onMediaSourceOpen),i.addEventListener("sourceended",this._onMediaSourceEnded),i.addEventListener("sourceclose",this._onMediaSourceClose),n.src=self.URL.createObjectURL(i),this._objectUrl=n.src,n.addEventListener("emptied",this._onMediaEmptied)}},v.onMediaDetaching=function(){var r=this.media,d=this.mediaSource,n=this._objectUrl;if(d){if(P.logger.log("[buffer-controller]: media source detaching"),d.readyState==="open")try{d.endOfStream()}catch(i){P.logger.warn("[buffer-controller]: onMediaDetaching: "+i.message+" while calling endOfStream")}this.onBufferReset(),d.removeEventListener("sourceopen",this._onMediaSourceOpen),d.removeEventListener("sourceended",this._onMediaSourceEnded),d.removeEventListener("sourceclose",this._onMediaSourceClose),r&&(r.removeEventListener("emptied",this._onMediaEmptied),n&&self.URL.revokeObjectURL(n),r.src===n?(r.removeAttribute("src"),r.load()):P.logger.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(D.Events.MEDIA_DETACHED,void 0)},v.onBufferReset=function(){var r=this;this.getSourceBufferTypes().forEach(function(d){var n=r.sourceBuffer[d];try{n&&(r.removeBufferListeners(d),r.mediaSource&&r.mediaSource.removeSourceBuffer(n),r.sourceBuffer[d]=void 0)}catch(i){P.logger.warn("[buffer-controller]: Failed to reset the "+d+" buffer",i)}}),this._initSourceBuffer()},v.onBufferCodecs=function(r,d){var n=this,i=this.getSourceBufferTypes().length;Object.keys(d).forEach(function(y){if(i){var o=n.tracks[y];if(o&&typeof o.buffer.changeType=="function"){var a=d[y],g=a.id,f=a.codec,s=a.levelCodec,e=a.container,u=a.metadata,t=(o.levelCodec||o.codec).replace(E,"$1"),l=(s||f).replace(E,"$1");if(t!==l){var p=e+";codecs="+(s||f);n.appendChangeType(y,p),P.logger.log("[buffer-controller]: switching codec "+t+" to "+l),n.tracks[y]={buffer:o.buffer,codec:f,container:e,levelCodec:s,metadata:u,id:g}}}}else n.pendingTracks[y]=d[y]}),!i&&(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks())},v.appendChangeType=function(r,d){var n=this,i=this.operationQueue,y={execute:function(){var o=n.sourceBuffer[r];o&&(P.logger.log("[buffer-controller]: changing "+r+" sourceBuffer type to "+d),o.changeType(d)),i.shiftAndExecuteNext(r)},onStart:function(){},onComplete:function(){},onError:function(o){P.logger.warn("[buffer-controller]: Failed to change "+r+" SourceBuffer type",o)}};i.append(y,r)},v.onBufferAppending=function(r,d){var n=this,i=this.hls,y=this.operationQueue,o=this.tracks,a=d.data,g=d.type,f=d.frag,s=d.part,e=d.chunkMeta,u=e.buffering[g],t=self.performance.now();u.start=t;var l=f.stats.buffering,p=s?s.stats.buffering:null;l.start===0&&(l.start=t),p&&p.start===0&&(p.start=t);var c=o.audio,L=!1;g==="audio"&&(c==null?void 0:c.container)==="audio/mpeg"&&(L=!this.lastMpegAudioChunk||e.id===1||this.lastMpegAudioChunk.sn!==e.sn,this.lastMpegAudioChunk=e);var R=f.start,w={execute:function(){if(u.executeStart=self.performance.now(),L){var O=n.sourceBuffer[g];if(O){var C=R-O.timestampOffset;Math.abs(C)>=.1&&(P.logger.log("[buffer-controller]: Updating audio SourceBuffer timestampOffset to "+R+" (delta: "+C+") sn: "+f.sn+")"),O.timestampOffset=R)}}n.appendExecutor(a,g)},onStart:function(){},onComplete:function(){var O=self.performance.now();u.executeEnd=u.end=O,l.first===0&&(l.first=O),p&&p.first===0&&(p.first=O);var C=n.sourceBuffer,M={};for(var N in C)M[N]=_.BufferHelper.getBuffered(C[N]);n.appendError=0,n.hls.trigger(D.Events.BUFFER_APPENDED,{type:g,frag:f,part:s,chunkMeta:e,parent:f.type,timeRanges:M})},onError:function(O){P.logger.error("[buffer-controller]: Error encountered while trying to append to the "+g+" SourceBuffer",O);var C={type:I.ErrorTypes.MEDIA_ERROR,parent:f.type,details:I.ErrorDetails.BUFFER_APPEND_ERROR,err:O,fatal:!1};O.code===DOMException.QUOTA_EXCEEDED_ERR?C.details=I.ErrorDetails.BUFFER_FULL_ERROR:(n.appendError++,C.details=I.ErrorDetails.BUFFER_APPEND_ERROR,n.appendError>i.config.appendErrorMaxRetry&&(P.logger.error("[buffer-controller]: Failed "+i.config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),C.fatal=!0,i.stopLoad())),i.trigger(D.Events.ERROR,C)}};y.append(w,g)},v.onBufferFlushing=function(r,d){var n=this,i=this.operationQueue,y=function(o){return{execute:n.removeExecutor.bind(n,o,d.startOffset,d.endOffset),onStart:function(){},onComplete:function(){n.hls.trigger(D.Events.BUFFER_FLUSHED,{type:o})},onError:function(a){P.logger.warn("[buffer-controller]: Failed to remove from "+o+" SourceBuffer",a)}}};d.type?i.append(y(d.type),d.type):this.getSourceBufferTypes().forEach(function(o){i.append(y(o),o)})},v.onFragParsed=function(r,d){var n=this,i=d.frag,y=d.part,o=[],a=y?y.elementaryStreams:i.elementaryStreams;a[k.ElementaryStreamTypes.AUDIOVIDEO]?o.push("audiovideo"):(a[k.ElementaryStreamTypes.AUDIO]&&o.push("audio"),a[k.ElementaryStreamTypes.VIDEO]&&o.push("video"));var g=function(){var f=self.performance.now();i.stats.buffering.end=f,y&&(y.stats.buffering.end=f);var s=y?y.stats:i.stats;n.hls.trigger(D.Events.FRAG_BUFFERED,{frag:i,part:y,stats:s,id:i.type})};o.length===0&&P.logger.warn("Fragments must have at least one ElementaryStreamType set. type: "+i.type+" level: "+i.level+" sn: "+i.sn),this.blockBuffers(g,o)},v.onFragChanged=function(r,d){this.flushBackBuffer()},v.onBufferEos=function(r,d){var n=this,i=this.getSourceBufferTypes().reduce(function(y,o){var a=n.sourceBuffer[o];return a&&(!d.type||d.type===o)&&(a.ending=!0,a.ended||(a.ended=!0,P.logger.log("[buffer-controller]: "+o+" sourceBuffer now EOS"))),y&&!!(!a||a.ended)},!0);i&&(P.logger.log("[buffer-controller]: Queueing mediaSource.endOfStream()"),this.blockBuffers(function(){n.getSourceBufferTypes().forEach(function(o){var a=n.sourceBuffer[o];a&&(a.ending=!1)});var y=n.mediaSource;if(!y||y.readyState!=="open"){y&&P.logger.info("[buffer-controller]: Could not call mediaSource.endOfStream(). mediaSource.readyState: "+y.readyState);return}P.logger.log("[buffer-controller]: Calling mediaSource.endOfStream()"),y.endOfStream()}))},v.onLevelUpdated=function(r,d){var n=d.details;n.fragments.length&&(this.details=n,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())},v.flushBackBuffer=function(){var r=this.hls,d=this.details,n=this.media,i=this.sourceBuffer;if(!(!n||d===null)){var y=this.getSourceBufferTypes();if(y.length){var o=d.live&&r.config.liveBackBufferLength!==null?r.config.liveBackBufferLength:r.config.backBufferLength;if(!(!(0,F.isFiniteNumber)(o)||o<0)){var a=n.currentTime,g=d.levelTargetDuration,f=Math.max(o,g),s=Math.floor(a/g)*g-f;y.forEach(function(e){var u=i[e];if(u){var t=_.BufferHelper.getBuffered(u);if(t.length>0&&s>t.start(0)){if(r.trigger(D.Events.BACK_BUFFER_REACHED,{bufferEnd:s}),d.live)r.trigger(D.Events.LIVE_BACK_BUFFER_REACHED,{bufferEnd:s});else if(u.ended&&t.end(t.length-1)-a<g*2){P.logger.info("[buffer-controller]: Cannot flush "+e+" back buffer while SourceBuffer is in ended state");return}r.trigger(D.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:s,type:e})}}})}}}},v.updateMediaElementDuration=function(){if(!(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")){var r=this.details,d=this.hls,n=this.media,i=this.mediaSource,y=r.fragments[0].start+r.totalduration,o=n.duration,a=(0,F.isFiniteNumber)(i.duration)?i.duration:0;r.live&&d.config.liveDurationInfinity?(P.logger.log("[buffer-controller]: Media Source duration is set to Infinity"),i.duration=1/0,this.updateSeekableRange(r)):(y>a&&y>o||!(0,F.isFiniteNumber)(o))&&(P.logger.log("[buffer-controller]: Updating Media Source duration to "+y.toFixed(3)),i.duration=y)}},v.updateSeekableRange=function(r){var d=this.mediaSource,n=r.fragments,i=n.length;if(i&&r.live&&d!==null&&d!==void 0&&d.setLiveSeekableRange){var y=Math.max(0,n[0].start),o=Math.max(y,y+r.totalduration);d.setLiveSeekableRange(y,o)}},v.checkPendingTracks=function(){var r=this.bufferCodecEventsExpected,d=this.operationQueue,n=this.pendingTracks,i=Object.keys(n).length;if(i&&!r||i===2){this.createSourceBuffers(n),this.pendingTracks={};var y=this.getSourceBufferTypes();if(y.length===0){this.hls.trigger(D.Events.ERROR,{type:I.ErrorTypes.MEDIA_ERROR,details:I.ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:"could not create source buffer for media codec(s)"});return}y.forEach(function(o){d.executeNext(o)})}},v.createSourceBuffers=function(r){var d=this.sourceBuffer,n=this.mediaSource;if(!n)throw Error("createSourceBuffers called when mediaSource was null");var i=0;for(var y in r)if(!d[y]){var o=r[y];if(!o)throw Error("source buffer exists for track "+y+", however track does not");var a=o.levelCodec||o.codec,g=o.container+";codecs="+a;P.logger.log("[buffer-controller]: creating sourceBuffer("+g+")");try{var f=d[y]=n.addSourceBuffer(g),s=y;this.addBufferListener(s,"updatestart",this._onSBUpdateStart),this.addBufferListener(s,"updateend",this._onSBUpdateEnd),this.addBufferListener(s,"error",this._onSBUpdateError),this.tracks[y]={buffer:f,codec:a,container:o.container,levelCodec:o.levelCodec,metadata:o.metadata,id:o.id},i++}catch(e){P.logger.error("[buffer-controller]: error while trying to add sourceBuffer: "+e.message),this.hls.trigger(D.Events.ERROR,{type:I.ErrorTypes.MEDIA_ERROR,details:I.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,mimeType:g})}}i&&this.hls.trigger(D.Events.BUFFER_CREATED,{tracks:this.tracks})},v._onSBUpdateStart=function(r){var d=this.operationQueue,n=d.current(r);n.onStart()},v._onSBUpdateEnd=function(r){var d=this.operationQueue,n=d.current(r);n.onComplete(),d.shiftAndExecuteNext(r)},v._onSBUpdateError=function(r,d){P.logger.error("[buffer-controller]: "+r+" SourceBuffer error",d),this.hls.trigger(D.Events.ERROR,{type:I.ErrorTypes.MEDIA_ERROR,details:I.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1});var n=this.operationQueue.current(r);n&&n.onError(d)},v.removeExecutor=function(r,d,n){var i=this.media,y=this.mediaSource,o=this.operationQueue,a=this.sourceBuffer,g=a[r];if(!i||!y||!g){P.logger.warn("[buffer-controller]: Attempting to remove from the "+r+" SourceBuffer, but it does not exist"),o.shiftAndExecuteNext(r);return}var f=(0,F.isFiniteNumber)(i.duration)?i.duration:1/0,s=(0,F.isFiniteNumber)(y.duration)?y.duration:1/0,e=Math.max(0,d),u=Math.min(n,f,s);u>e&&!g.ending?(g.ended=!1,P.logger.log("[buffer-controller]: Removing ["+e+","+u+"] from the "+r+" SourceBuffer"),console.assert(!g.updating,r+" sourceBuffer must not be updating"),g.remove(e,u)):o.shiftAndExecuteNext(r)},v.appendExecutor=function(r,d){var n=this.operationQueue,i=this.sourceBuffer,y=i[d];if(!y){P.logger.warn("[buffer-controller]: Attempting to append to the "+d+" SourceBuffer, but it does not exist"),n.shiftAndExecuteNext(d);return}y.ended=!1,console.assert(!y.updating,d+" sourceBuffer must not be updating"),y.appendBuffer(r)},v.blockBuffers=function(r,d){var n=this;if(d===void 0&&(d=this.getSourceBufferTypes()),!d.length){P.logger.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(r);return}var i=this.operationQueue,y=d.map(function(o){return i.appendBlocker(o)});Promise.all(y).then(function(){r(),d.forEach(function(o){var a=n.sourceBuffer[o];(!a||!a.updating)&&i.shiftAndExecuteNext(o)})})},v.getSourceBufferTypes=function(){return Object.keys(this.sourceBuffer)},v.addBufferListener=function(r,d,n){var i=this.sourceBuffer[r];if(i){var y=n.bind(this,r);this.listeners[r].push({event:d,listener:y}),i.addEventListener(d,y)}},v.removeBufferListeners=function(r){var d=this.sourceBuffer[r];d&&this.listeners[r].forEach(function(n){d.removeEventListener(n.event,n.listener)})},m}()},"./src/controller/buffer-operation-queue.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>D});var F=S("./src/utils/logger.ts"),D=function(){function P(_){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=_}var I=P.prototype;return I.append=function(_,b){var k=this.queues[b];k.push(_),k.length===1&&this.buffers[b]&&this.executeNext(b)},I.insertAbort=function(_,b){var k=this.queues[b];k.unshift(_),this.executeNext(b)},I.appendBlocker=function(_){var b,k=new Promise(function(T){b=T}),A={execute:b,onStart:function(){},onComplete:function(){},onError:function(){}};return this.append(A,_),k},I.executeNext=function(_){var b=this.buffers,k=this.queues,A=b[_],T=k[_];if(T.length){var E=T[0];try{E.execute()}catch(h){F.logger.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),E.onError(h),(!A||!A.updating)&&(T.shift(),this.executeNext(_))}}},I.shiftAndExecuteNext=function(_){this.queues[_].shift(),this.executeNext(_)},I.current=function(_){return this.queues[_][0]},P}()},"./src/controller/cap-level-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>k});var F=S("./src/events.ts");function D(A,T){for(var E=0;E<T.length;E++){var h=T[E];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(A,I(h.key),h)}}function P(A,T,E){return T&&D(A.prototype,T),Object.defineProperty(A,"prototype",{writable:!1}),A}function I(A){var T=_(A,"string");return typeof T=="symbol"?T:String(T)}function _(A,T){if(typeof A!="object"||A===null)return A;var E=A[Symbol.toPrimitive];if(E!==void 0){var h=E.call(A,T);if(typeof h!="object")return h;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(A)}var b=function(){function A(E){this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.hls=void 0,this.streamController=void 0,this.clientRect=void 0,this.hls=E,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var T=A.prototype;return T.setStreamController=function(E){this.streamController=E},T.destroy=function(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},T.registerListeners=function(){var E=this.hls;E.on(F.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),E.on(F.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),E.on(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),E.on(F.Events.BUFFER_CODECS,this.onBufferCodecs,this),E.on(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},T.unregisterListener=function(){var E=this.hls;E.off(F.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),E.off(F.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),E.off(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),E.off(F.Events.BUFFER_CODECS,this.onBufferCodecs,this),E.off(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},T.onFpsDropLevelCapping=function(E,h){A.isLevelAllowed(h.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(h.droppedLevel)},T.onMediaAttaching=function(E,h){this.media=h.media instanceof HTMLVideoElement?h.media:null,this.clientRect=null},T.onManifestParsed=function(E,h){var m=this.hls;this.restrictedLevels=[],this.firstLevel=h.firstLevel,m.config.capLevelToPlayerSize&&h.video&&this.startCapping()},T.onBufferCodecs=function(E,h){var m=this.hls;m.config.capLevelToPlayerSize&&h.video&&this.startCapping()},T.onMediaDetaching=function(){this.stopCapping()},T.detectPlayerSize=function(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){var E=this.hls.levels;if(E.length){var h=this.hls;h.autoLevelCapping=this.getMaxLevel(E.length-1),h.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=h.autoLevelCapping}}},T.getMaxLevel=function(E){var h=this,m=this.hls.levels;if(!m.length)return-1;var v=m.filter(function(r,d){return A.isLevelAllowed(d,h.restrictedLevels)&&d<=E});return this.clientRect=null,A.getMaxLevelByMediaSize(v,this.mediaWidth,this.mediaHeight)},T.startCapping=function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},T.stopCapping=function(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)},T.getDimensions=function(){if(this.clientRect)return this.clientRect;var E=this.media,h={width:0,height:0};if(E){var m=E.getBoundingClientRect();h.width=m.width,h.height=m.height,!h.width&&!h.height&&(h.width=m.right-m.left||E.width||0,h.height=m.bottom-m.top||E.height||0)}return this.clientRect=h,h},A.isLevelAllowed=function(E,h){return h===void 0&&(h=[]),h.indexOf(E)===-1},A.getMaxLevelByMediaSize=function(E,h,m){if(!E||!E.length)return-1;for(var v=function(i,y){return y?i.width!==y.width||i.height!==y.height:!0},r=E.length-1,d=0;d<E.length;d+=1){var n=E[d];if((n.width>=h||n.height>=m)&&v(n,E[d+1])){r=d;break}}return r},P(A,[{key:"mediaWidth",get:function(){return this.getDimensions().width*this.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*this.contentScaleFactor}},{key:"contentScaleFactor",get:function(){var E=1;if(!this.hls.config.ignoreDevicePixelRatio)try{E=self.devicePixelRatio}catch{}return E}}]),A}();const k=b},"./src/controller/cmcd-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>v});var F=S("./src/events.ts"),D=S("./src/types/cmcd.ts"),P=S("./src/utils/buffer-helper.ts"),I=S("./src/utils/logger.ts");function _(r,d){for(var n=0;n<d.length;n++){var i=d[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,k(i.key),i)}}function b(r,d,n){return d&&_(r.prototype,d),Object.defineProperty(r,"prototype",{writable:!1}),r}function k(r){var d=A(r,"string");return typeof d=="symbol"?d:String(d)}function A(r,d){if(typeof r!="object"||r===null)return r;var n=r[Symbol.toPrimitive];if(n!==void 0){var i=n.call(r,d);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(r)}function T(r,d){var n=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(n)return(n=n.call(r)).next.bind(n);if(Array.isArray(r)||(n=E(r))||d){n&&(r=n);var i=0;return function(){return i>=r.length?{done:!0}:{done:!1,value:r[i++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function E(r,d){if(r){if(typeof r=="string")return h(r,d);var n=Object.prototype.toString.call(r).slice(8,-1);if(n==="Object"&&r.constructor&&(n=r.constructor.name),n==="Map"||n==="Set")return Array.from(r);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return h(r,d)}}function h(r,d){(d==null||d>r.length)&&(d=r.length);for(var n=0,i=new Array(d);n<d;n++)i[n]=r[n];return i}function m(){return m=Object.assign?Object.assign.bind():function(r){for(var d=1;d<arguments.length;d++){var n=arguments[d];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])}return r},m.apply(this,arguments)}var v=function(){function r(n){var i=this;this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=function(){i.initialized&&(i.starved=!0),i.buffering=!0},this.onPlaying=function(){i.initialized||(i.initialized=!0),i.buffering=!1},this.applyPlaylistData=function(a){try{i.apply(a,{ot:D.CMCDObjectType.MANIFEST,su:!i.initialized})}catch(g){I.logger.warn("Could not generate manifest CMCD data.",g)}},this.applyFragmentData=function(a){try{var g=a.frag,f=i.hls.levels[g.level],s=i.getObjectType(g),e={d:g.duration*1e3,ot:s};(s===D.CMCDObjectType.VIDEO||s===D.CMCDObjectType.AUDIO||s==D.CMCDObjectType.MUXED)&&(e.br=f.bitrate/1e3,e.tb=i.getTopBandwidth(s)/1e3,e.bl=i.getBufferLength(s)),i.apply(a,e)}catch(u){I.logger.warn("Could not generate segment CMCD data.",u)}},this.hls=n;var y=this.config=n.config,o=y.cmcd;o!=null&&(y.pLoader=this.createPlaylistLoader(),y.fLoader=this.createFragmentLoader(),this.sid=o.sessionId||r.uuid(),this.cid=o.contentId,this.useHeaders=o.useHeaders===!0,this.registerListeners())}var d=r.prototype;return d.registerListeners=function(){var n=this.hls;n.on(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),n.on(F.Events.MEDIA_DETACHED,this.onMediaDetached,this),n.on(F.Events.BUFFER_CREATED,this.onBufferCreated,this)},d.unregisterListeners=function(){var n=this.hls;n.off(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),n.off(F.Events.MEDIA_DETACHED,this.onMediaDetached,this),n.off(F.Events.BUFFER_CREATED,this.onBufferCreated,this),this.onMediaDetached()},d.destroy=function(){this.unregisterListeners(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null},d.onMediaAttached=function(n,i){this.media=i.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)},d.onMediaDetached=function(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)},d.onBufferCreated=function(n,i){var y,o;this.audioBuffer=(y=i.tracks.audio)===null||y===void 0?void 0:y.buffer,this.videoBuffer=(o=i.tracks.video)===null||o===void 0?void 0:o.buffer},d.createData=function(){var n;return{v:D.CMCDVersion,sf:D.CMCDStreamingFormat.HLS,sid:this.sid,cid:this.cid,pr:(n=this.media)===null||n===void 0?void 0:n.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}},d.apply=function(n,i){i===void 0&&(i={}),m(i,this.createData());var y=i.ot===D.CMCDObjectType.INIT||i.ot===D.CMCDObjectType.VIDEO||i.ot===D.CMCDObjectType.MUXED;if(this.starved&&y&&(i.bs=!0,i.su=!0,this.starved=!1),i.su==null&&(i.su=this.buffering),this.useHeaders){var o=r.toHeaders(i);if(!Object.keys(o).length)return;n.headers||(n.headers={}),m(n.headers,o)}else{var a=r.toQuery(i);if(!a)return;n.url=r.appendQueryToUri(n.url,a)}},d.getObjectType=function(n){var i=n.type;if(i==="subtitle")return D.CMCDObjectType.TIMED_TEXT;if(n.sn==="initSegment")return D.CMCDObjectType.INIT;if(i==="audio")return D.CMCDObjectType.AUDIO;if(i==="main")return this.hls.audioTracks.length?D.CMCDObjectType.VIDEO:D.CMCDObjectType.MUXED},d.getTopBandwidth=function(n){var i=0,y,o=this.hls;if(n===D.CMCDObjectType.AUDIO)y=o.audioTracks;else{var a=o.maxAutoLevel,g=a>-1?a+1:o.levels.length;y=o.levels.slice(0,g)}for(var f=T(y),s;!(s=f()).done;){var e=s.value;e.bitrate>i&&(i=e.bitrate)}return i>0?i:NaN},d.getBufferLength=function(n){var i=this.hls.media,y=n===D.CMCDObjectType.AUDIO?this.audioBuffer:this.videoBuffer;if(!y||!i)return NaN;var o=P.BufferHelper.bufferInfo(y,i.currentTime,this.config.maxBufferHole);return o.len*1e3},d.createPlaylistLoader=function(){var n=this.config.pLoader,i=this.applyPlaylistData,y=n||this.config.loader;return function(){function o(g){this.loader=void 0,this.loader=new y(g)}var a=o.prototype;return a.destroy=function(){this.loader.destroy()},a.abort=function(){this.loader.abort()},a.load=function(g,f,s){i(g),this.loader.load(g,f,s)},b(o,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}]),o}()},d.createFragmentLoader=function(){var n=this.config.fLoader,i=this.applyFragmentData,y=n||this.config.loader;return function(){function o(g){this.loader=void 0,this.loader=new y(g)}var a=o.prototype;return a.destroy=function(){this.loader.destroy()},a.abort=function(){this.loader.abort()},a.load=function(g,f,s){i(g),this.loader.load(g,f,s)},b(o,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}]),o}()},r.uuid=function(){var n=URL.createObjectURL(new Blob),i=n.toString();return URL.revokeObjectURL(n),i.slice(i.lastIndexOf("/")+1)},r.serialize=function(n){for(var i=[],y=function(R){return!Number.isNaN(R)&&R!=null&&R!==""&&R!==!1},o=function(R){return Math.round(R)},a=function(R){return o(R/100)*100},g=function(R){return encodeURIComponent(R)},f={br:o,d:o,bl:a,dl:a,mtp:a,nor:g,rtp:a,tb:o},s=Object.keys(n||{}).sort(),e=T(s),u;!(u=e()).done;){var t=u.value,l=n[t];if(y(l)&&!(t==="v"&&l===1)&&!(t=="pr"&&l===1)){var p=f[t];p&&(l=p(l));var c=typeof l,L=void 0;t==="ot"||t==="sf"||t==="st"?L=t+"="+l:c==="boolean"?L=t:c==="number"?L=t+"="+l:L=t+"="+JSON.stringify(l),i.push(L)}}return i.join(",")},r.toHeaders=function(n){for(var i=Object.keys(n),y={},o=["Object","Request","Session","Status"],a=[{},{},{},{}],g={br:0,d:0,ot:0,tb:0,bl:1,dl:1,mtp:1,nor:1,nrr:1,su:1,cid:2,pr:2,sf:2,sid:2,st:2,v:2,bs:3,rtp:3},f=0,s=i;f<s.length;f++){var e=s[f],u=g[e]!=null?g[e]:1;a[u][e]=n[e]}for(var t=0;t<a.length;t++){var l=r.serialize(a[t]);l&&(y["CMCD-"+o[t]]=l)}return y},r.toQuery=function(n){return"CMCD="+encodeURIComponent(r.serialize(n))},r.appendQueryToUri=function(n,i){if(!i)return n;var y=n.includes("?")?"&":"?";return""+n+y+i},r}()},"./src/controller/eme-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>s});var F=S("./src/events.ts"),D=S("./src/errors.ts"),P=S("./src/utils/logger.ts"),I=S("./src/utils/mediakeys-helper.ts"),_=S("./src/utils/keysystem-util.ts"),b=S("./src/utils/numeric-encoding-utils.ts"),k=S("./src/loader/level-key.ts"),A=S("./src/utils/hex.ts"),T=S("./src/utils/mp4-tools.ts"),E=S("./node_modules/eventemitter3/index.js"),h=S.n(E);function m(e,u){e.prototype=Object.create(u.prototype),e.prototype.constructor=e,i(e,u)}function v(e){var u=typeof Map=="function"?new Map:void 0;return v=function(t){if(t===null||!n(t))return t;if(typeof t!="function")throw new TypeError("Super expression must either be null or a function");if(typeof u<"u"){if(u.has(t))return u.get(t);u.set(t,l)}function l(){return r(t,arguments,y(this).constructor)}return l.prototype=Object.create(t.prototype,{constructor:{value:l,enumerable:!1,writable:!0,configurable:!0}}),i(l,t)},v(e)}function r(e,u,t){return d()?r=Reflect.construct.bind():r=function(l,p,c){var L=[null];L.push.apply(L,p);var R=Function.bind.apply(l,L),w=new R;return c&&i(w,c.prototype),w},r.apply(null,arguments)}function d(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function n(e){return Function.toString.call(e).indexOf("[native code]")!==-1}function i(e,u){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,l){return t.__proto__=l,t},i(e,u)}function y(e){return y=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(u){return u.__proto__||Object.getPrototypeOf(u)},y(e)}var o=3,a="[eme]",g=function(){function e(t){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=e.CDMCleanupPromise?[e.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=P.logger.debug.bind(P.logger,a),this.log=P.logger.log.bind(P.logger,a),this.warn=P.logger.warn.bind(P.logger,a),this.error=P.logger.error.bind(P.logger,a),this.hls=t,this.config=t.config,this.registerListeners()}var u=e.prototype;return u.destroy=function(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null},u.registerListeners=function(){this.hls.on(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(F.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(F.Events.MANIFEST_LOADED,this.onManifestLoaded,this)},u.unregisterListeners=function(){this.hls.off(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(F.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(F.Events.MANIFEST_LOADED,this.onManifestLoaded,this)},u.getLicenseServerUrl=function(t){var l=this.config,p=l.drmSystems,c=l.widevineLicenseUrl,L=p[t];if(L)return L.licenseUrl;if(t===I.KeySystems.WIDEVINE&&c)return c;throw new Error('no license server URL configured for key-system "'+t+'"')},u.getServerCertificateUrl=function(t){var l=this.config.drmSystems,p=l[t];if(p)return p.serverCertificateUrl;this.log('No Server Certificate in config.drmSystems["'+t+'"]')},u.attemptKeySystemAccess=function(t){var l=this,p=this.hls.levels,c=function(w,O,C){return!!w&&C.indexOf(w)===O},L=p.map(function(w){return w.audioCodec}).filter(c),R=p.map(function(w){return w.videoCodec}).filter(c);return L.length+R.length===0&&R.push("avc1.42e01e"),new Promise(function(w,O){var C=function M(N){var U=N.shift();l.getMediaKeysPromise(U,L,R).then(function(B){return w({keySystem:U,mediaKeys:B})}).catch(function(B){N.length?M(N):B instanceof f?O(B):O(new f({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_NO_ACCESS,error:B,fatal:!0},B.message))})};C(t)})},u.requestMediaKeySystemAccess=function(t,l){var p=this.config.requestMediaKeySystemAccessFunc;if(typeof p!="function"){var c="Configured requestMediaKeySystemAccess is not a function "+p;return I.requestMediaKeySystemAccess===null&&self.location.protocol==="http:"&&(c="navigator.requestMediaKeySystemAccess is not available over insecure protocol "+location.protocol),Promise.reject(new Error(c))}return p(t,l)},u.getMediaKeysPromise=function(t,l,p){var c=this,L=(0,I.getSupportedMediaKeySystemConfigurations)(t,l,p,this.config.drmSystemOptions),R=this.keySystemAccessPromises[t],w=R==null?void 0:R.keySystemAccess;if(!w){this.log('Requesting encrypted media "'+t+'" key-system access with config: '+JSON.stringify(L)),w=this.requestMediaKeySystemAccess(t,L);var O=this.keySystemAccessPromises[t]={keySystemAccess:w};return w.catch(function(C){c.log('Failed to obtain access to key-system "'+t+'": '+C)}),w.then(function(C){c.log('Access for key-system "'+C.keySystem+'" obtained');var M=c.fetchServerCertificate(t);return c.log('Create media-keys for "'+t+'"'),O.mediaKeys=C.createMediaKeys().then(function(N){return c.log('Media-keys created for "'+t+'"'),M.then(function(U){return U?c.setMediaKeysServerCertificate(N,t,U):N})}),O.mediaKeys.catch(function(N){c.error('Failed to create media-keys for "'+t+'"}: '+N)}),O.mediaKeys})}return w.then(function(){return R.mediaKeys})},u.createMediaKeySessionContext=function(t){var l=t.decryptdata,p=t.keySystem,c=t.mediaKeys;console.assert(!!c,"mediaKeys is defined"),this.log('Creating key-system session "'+p+'" keyId: '+A.default.hexDump(l.keyId||[]));var L=c.createSession(),R={decryptdata:l,keySystem:p,mediaKeys:c,mediaKeysSession:L,keyStatus:"status-pending"};return this.mediaKeySessions.push(R),R},u.renewKeySession=function(t){var l=t.decryptdata;if(l.pssh){var p=this.createMediaKeySessionContext(t),c=this.getKeyIdString(l),L="cenc";this.keyIdToKeySessionPromise[c]=this.generateRequestWithPreferredKeySession(p,L,l.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(t)},u.getKeyIdString=function(t){if(!t)throw new Error("Could not read keyId of undefined decryptdata");if(t.keyId===null)throw new Error("keyId is null");return A.default.hexDump(t.keyId)},u.updateKeySession=function(t,l){var p,c=t.mediaKeysSession;return this.log('Updating key-session "'+c.sessionId+'" for keyID '+A.default.hexDump(((p=t.decryptdata)===null||p===void 0?void 0:p.keyId)||[])+`
      } (data length: `+(l&&l.byteLength)+")"),c.update(l)},u.selectKeySystemFormat=function(t){var l=Object.keys(t.levelkeys||{});return this.keyFormatPromise||(this.log("Selecting key-system from fragment (sn: "+t.sn+" "+t.type+": "+t.level+") key formats "+l.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(l)),this.keyFormatPromise},u.getKeyFormatPromise=function(t){var l=this;return new Promise(function(p,c){var L=(0,I.getKeySystemsForConfig)(l.config),R=t.map(I.keySystemFormatToKeySystemDomain).filter(function(w){return!!w&&L.indexOf(w)!==-1});return l.getKeySystemSelectionPromise(R).then(function(w){var O=w.keySystem,C=(0,I.keySystemDomainToKeySystemFormat)(O);C?p(C):c(new Error('Unable to find format for key-system "'+O+'"'))}).catch(c)})},u.loadKey=function(t){var l=this,p=t.keyInfo.decryptdata,c=this.getKeyIdString(p),L="(keyId: "+c+' format: "'+p.keyFormat+'" method: '+p.method+" uri: "+p.uri+")";this.log("Starting session for key "+L);var R=this.keyIdToKeySessionPromise[c];return R||(R=this.keyIdToKeySessionPromise[c]=this.getKeySystemForKeyPromise(p).then(function(w){var O=w.keySystem,C=w.mediaKeys;return l.throwIfDestroyed(),l.log("Handle encrypted media sn: "+t.frag.sn+" "+t.frag.type+": "+t.frag.level+" using key "+L),l.attemptSetMediaKeys(O,C).then(function(){l.throwIfDestroyed();var M=l.createMediaKeySessionContext({keySystem:O,mediaKeys:C,decryptdata:p}),N="cenc";return l.generateRequestWithPreferredKeySession(M,N,p.pssh,"playlist-key")})}),R.catch(function(w){return l.handleError(w)})),R},u.throwIfDestroyed=function(t){if(!this.hls)throw new Error("invalid state")},u.handleError=function(t){this.hls&&(this.error(t.message),t instanceof f?this.hls.trigger(F.Events.ERROR,t.data):this.hls.trigger(F.Events.ERROR,{type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_NO_KEYS,error:t,fatal:!0}))},u.getKeySystemForKeyPromise=function(t){var l=this.getKeyIdString(t),p=this.keyIdToKeySessionPromise[l];if(!p){var c=(0,I.keySystemFormatToKeySystemDomain)(t.keyFormat),L=c?[c]:(0,I.getKeySystemsForConfig)(this.config);return this.attemptKeySystemAccess(L)}return p},u.getKeySystemSelectionPromise=function(t){if(t.length||(t=(0,I.getKeySystemsForConfig)(this.config)),t.length===0)throw new f({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},"Missing key-system license configuration options "+JSON.stringify({drmSystems:this.config.drmSystems}));return this.attemptKeySystemAccess(t)},u._onMediaEncrypted=function(t){var l=this,p=t.initDataType,c=t.initData;if(this.debug('"'+t.type+'" event: init data type: "'+p+'"'),c!==null){var L,R;if(p==="sinf"&&this.config.drmSystems[I.KeySystems.FAIRPLAY]){var w=(0,T.bin2str)(new Uint8Array(c));try{var O=(0,b.base64Decode)(JSON.parse(w).sinf),C=(0,T.parseSinf)(new Uint8Array(O));if(!C)return;L=C.subarray(8,24),R=I.KeySystems.FAIRPLAY}catch{this.warn('Failed to parse sinf "encrypted" event message initData');return}}else{var M=(0,T.parsePssh)(c);if(M===null)return;M.version===0&&M.systemId===I.KeySystemIds.WIDEVINE&&M.data&&(L=M.data.subarray(8,24)),R=(0,I.keySystemIdToKeySystemDomain)(M.systemId)}if(!(!R||!L)){for(var N=A.default.hexDump(L),U=this.keyIdToKeySessionPromise,B=this.mediaKeySessions,G=U[N],K=function(H){var V=B[H],z=V.decryptdata;if(z.pssh||!z.keyId)return"continue";var X=A.default.hexDump(z.keyId);if(N===X||z.uri.replace(/-/g,"").indexOf(N)!==-1)return G=U[X],delete U[X],z.pssh=new Uint8Array(c),z.keyId=L,G=U[N]=G.then(function(){return l.generateRequestWithPreferredKeySession(V,p,c,"encrypted-event-key-match")}),"break"},Y=0;Y<B.length;Y++){var q=K(Y);if(q!=="continue"&&q==="break")break}G||(G=U[N]=this.getKeySystemSelectionPromise([R]).then(function(H){var V,z=H.keySystem,X=H.mediaKeys;l.throwIfDestroyed();var W=new k.LevelKey("ISO-23001-7",N,(V=(0,I.keySystemDomainToKeySystemFormat)(z))!=null?V:"");return W.pssh=new Uint8Array(c),W.keyId=L,l.attemptSetMediaKeys(z,X).then(function(){l.throwIfDestroyed();var Q=l.createMediaKeySessionContext({decryptdata:W,keySystem:z,mediaKeys:X});return l.generateRequestWithPreferredKeySession(Q,p,c,"encrypted-event-no-match")})})),G.catch(function(H){return l.handleError(H)})}}},u._onWaitingForKey=function(t){this.log('"'+t.type+'" event')},u.attemptSetMediaKeys=function(t,l){var p=this,c=this.setMediaKeysQueue.slice();this.log('Setting media-keys for "'+t+'"');var L=Promise.all(c).then(function(){if(!p.media)throw new Error("Attempted to set mediaKeys without media element attached");return p.media.setMediaKeys(l)});return this.setMediaKeysQueue.push(L),L.then(function(){p.log('Media-keys set for "'+t+'"'),c.push(L),p.setMediaKeysQueue=p.setMediaKeysQueue.filter(function(R){return c.indexOf(R)===-1})})},u.generateRequestWithPreferredKeySession=function(t,l,p,c){var L,R,w=this,O=(L=this.config.drmSystems)===null||L===void 0||(R=L[t.keySystem])===null||R===void 0?void 0:R.generateRequest;if(O)try{var C=O.call(this.hls,l,p,t);if(!C)throw new Error("Invalid response from configured generateRequest filter");l=C.initDataType,p=t.decryptdata.pssh=C.initData?new Uint8Array(C.initData):null}catch(G){var M;if(this.warn(G.message),(M=this.hls)!==null&&M!==void 0&&M.config.debug)throw G}if(p===null)return this.log('Skipping key-session request for "'+c+'" (no initData)'),Promise.resolve(t);var N=this.getKeyIdString(t.decryptdata);this.log('Generating key-session request for "'+c+'": '+N+" (init data type: "+l+" length: "+(p?p.byteLength:null)+")");var U=new(h());t.mediaKeysSession.onmessage=function(G){var K=t.mediaKeysSession;if(!K){U.emit("error",new Error("invalid state"));return}var Y=G.messageType,q=G.message;w.log('"'+Y+'" message event for session "'+K.sessionId+'" message size: '+q.byteLength),Y==="license-request"||Y==="license-renewal"?w.renewLicense(t,q).catch(function(H){w.handleError(H),U.emit("error",H)}):Y==="license-release"?t.keySystem===I.KeySystems.FAIRPLAY&&(w.updateKeySession(t,(0,_.strToUtf8array)("acknowledged")),w.removeSession(t)):w.warn('unhandled media key message type "'+Y+'"')},t.mediaKeysSession.onkeystatuseschange=function(G){var K=t.mediaKeysSession;if(!K){U.emit("error",new Error("invalid state"));return}w.onKeyStatusChange(t);var Y=t.keyStatus;U.emit("keyStatus",Y),Y==="expired"&&(w.warn(t.keySystem+" expired for key "+N),w.renewKeySession(t))};var B=new Promise(function(G,K){U.on("error",K),U.on("keyStatus",function(Y){Y.startsWith("usable")?G():Y==="output-restricted"?K(new f({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):Y==="internal-error"?K(new f({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},'key status changed to "'+Y+'"')):Y==="expired"?K(new Error("key expired while generating request")):w.warn('unhandled key status change "'+Y+'"')})});return t.mediaKeysSession.generateRequest(l,p).then(function(){var G;w.log('Request generated for key-session "'+((G=t.mediaKeysSession)===null||G===void 0?void 0:G.sessionId)+'" keyId: '+N)}).catch(function(G){throw new f({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_NO_SESSION,error:G,fatal:!1},"Error generating key-session request: "+G)}).then(function(){return B}).catch(function(G){throw U.removeAllListeners(),w.removeSession(t),G}).then(function(){return U.removeAllListeners(),t})},u.onKeyStatusChange=function(t){var l=this;t.mediaKeysSession.keyStatuses.forEach(function(p,c){l.log('key status change "'+p+'" for keyStatuses keyId: '+A.default.hexDump("buffer"in c?new Uint8Array(c.buffer,c.byteOffset,c.byteLength):new Uint8Array(c))+" session keyId: "+A.default.hexDump(new Uint8Array(t.decryptdata.keyId||[]))+" uri: "+t.decryptdata.uri),t.keyStatus=p})},u.fetchServerCertificate=function(t){var l=this;return new Promise(function(p,c){var L=l.getServerCertificateUrl(t);if(!L)return p();l.log('Fetching serverCertificate for "'+t+'"');var R=new XMLHttpRequest;R.open("GET",L,!0),R.responseType="arraybuffer",R.onreadystatechange=function(){R.readyState===XMLHttpRequest.DONE&&(R.status===200?p(R.response):c(new f({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:R},'"'+t+'" certificate request XHR failed ('+L+"). Status: "+R.status+" ("+R.statusText+")")))},R.send()})},u.setMediaKeysServerCertificate=function(t,l,p){var c=this;return new Promise(function(L,R){t.setServerCertificate(p).then(function(w){c.log("setServerCertificate "+(w?"success":"not supported by CDM")+" ("+(p==null?void 0:p.byteLength)+') on "'+l+'"'),L(t)}).catch(function(w){R(new f({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:w,fatal:!0},w.message))})})},u.renewLicense=function(t,l){var p=this;return this.requestLicense(t,new Uint8Array(l)).then(function(c){return p.updateKeySession(t,new Uint8Array(c)).catch(function(L){throw new f({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:L,fatal:!0},L.message)})})},u.setupLicenseXHR=function(t,l,p,c){var L=this,R=this.config.licenseXhrSetup;return R?Promise.resolve().then(function(){if(!p.decryptdata)throw new Error("Key removed");return R.call(L.hls,t,l,p,c)}).catch(function(w){if(!p.decryptdata)throw w;return t.open("POST",l,!0),R.call(L.hls,t,l,p,c)}).then(function(w){t.readyState||t.open("POST",l,!0);var O=w||c;return{xhr:t,licenseChallenge:O}}):(t.open("POST",l,!0),Promise.resolve({xhr:t,licenseChallenge:c}))},u.requestLicense=function(t,l){var p=this;return new Promise(function(c,L){var R=p.getLicenseServerUrl(t.keySystem);p.log("Sending license request to URL: "+R);var w=new XMLHttpRequest;w.responseType="arraybuffer",w.onreadystatechange=function(){if(!p.hls||!t.mediaKeysSession)return L(new Error("invalid state"));if(w.readyState===4)if(w.status===200){p._requestLicenseFailureCount=0;var O=w.response;p.log("License received "+(O instanceof ArrayBuffer?O.byteLength:O));var C=p.config.licenseResponseCallback;if(C)try{O=C.call(p.hls,w,R,t)}catch(N){p.error(N)}c(O)}else if(p._requestLicenseFailureCount++,p._requestLicenseFailureCount>o||w.status>=400&&w.status<500)L(new f({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:w},"License Request XHR failed ("+R+"). Status: "+w.status+" ("+w.statusText+")"));else{var M=o-p._requestLicenseFailureCount+1;p.warn("Retrying license request, "+M+" attempts left"),p.requestLicense(t,l).then(c,L)}},t.licenseXhr&&t.licenseXhr.readyState!==XMLHttpRequest.DONE&&t.licenseXhr.abort(),t.licenseXhr=w,p.setupLicenseXHR(w,R,t,l).then(function(O){var C=O.xhr,M=O.licenseChallenge;C.send(M)})})},u.onMediaAttached=function(t,l){if(this.config.emeEnabled){var p=l.media;this.media=p,p.addEventListener("encrypted",this.onMediaEncrypted),p.addEventListener("waitingforkey",this.onWaitingForKey)}},u.onMediaDetached=function(){var t=this,l=this.media,p=this.mediaKeySessions;l&&(l.removeEventListener("encrypted",this.onMediaEncrypted),l.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},k.LevelKey.clearKeyUriToKeyIdMap();var c=p.length;e.CDMCleanupPromise=Promise.all(p.map(function(L){return t.removeSession(L)}).concat(l==null?void 0:l.setMediaKeys(null).catch(function(L){t.log("Could not clear media keys: "+L+". media.src: "+(l==null?void 0:l.src))}))).then(function(){c&&(t.log("finished closing key sessions and clearing media keys"),p.length=0)}).catch(function(L){t.log("Could not close sessions and clear media keys: "+L+". media.src: "+(l==null?void 0:l.src))})},u.onManifestLoaded=function(t,l){var p=l.sessionKeys;if(!(!p||!this.config.emeEnabled)&&!this.keyFormatPromise){var c=p.reduce(function(L,R){return L.indexOf(R.keyFormat)===-1&&L.push(R.keyFormat),L},[]);this.log("Selecting key-system from session-keys "+c.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(c)}},u.removeSession=function(t){var l=this,p=t.mediaKeysSession,c=t.licenseXhr;if(p){this.log("Remove licenses and keys and close session "+p.sessionId),p.onmessage=null,p.onkeystatuseschange=null,c&&c.readyState!==XMLHttpRequest.DONE&&c.abort(),t.mediaKeysSession=t.decryptdata=t.licenseXhr=void 0;var L=this.mediaKeySessions.indexOf(t);return L>-1&&this.mediaKeySessions.splice(L,1),p.remove().catch(function(R){l.log("Could not remove session: "+R)}).then(function(){return p.close()}).catch(function(R){l.log("Could not close session: "+R)})}},e}();g.CDMCleanupPromise=void 0;var f=function(e){m(u,e);function u(t,l){var p;return p=e.call(this,l)||this,p.data=void 0,p.data=t,t.err=t.error,p}return u}(v(Error));const s=g},"./src/controller/fps-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>I});var F=S("./src/events.ts"),D=S("./src/utils/logger.ts"),P=function(){function _(k){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=k,this.registerListeners()}var b=_.prototype;return b.setStreamController=function(k){this.streamController=k},b.registerListeners=function(){this.hls.on(F.Events.MEDIA_ATTACHING,this.onMediaAttaching,this)},b.unregisterListeners=function(){this.hls.off(F.Events.MEDIA_ATTACHING,this.onMediaAttaching)},b.destroy=function(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null},b.onMediaAttaching=function(k,A){var T=this.hls.config;if(T.capLevelOnFPSDrop){var E=A.media instanceof self.HTMLVideoElement?A.media:null;this.media=E,E&&typeof E.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),T.fpsDroppedMonitoringPeriod)}},b.checkFPS=function(k,A,T){var E=performance.now();if(A){if(this.lastTime){var h=E-this.lastTime,m=T-this.lastDroppedFrames,v=A-this.lastDecodedFrames,r=1e3*m/h,d=this.hls;if(d.trigger(F.Events.FPS_DROP,{currentDropped:m,currentDecoded:v,totalDroppedFrames:T}),r>0&&m>d.config.fpsDroppedMonitoringThreshold*v){var n=d.currentLevel;D.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+n),n>0&&(d.autoLevelCapping===-1||d.autoLevelCapping>=n)&&(n=n-1,d.trigger(F.Events.FPS_DROP_LEVEL_CAPPING,{level:n,droppedLevel:d.currentLevel}),d.autoLevelCapping=n,this.streamController.nextLevelSwitch())}}this.lastTime=E,this.lastDroppedFrames=T,this.lastDecodedFrames=A}},b.checkFPSInterval=function(){var k=this.media;if(k)if(this.isVideoPlaybackQualityAvailable){var A=k.getVideoPlaybackQuality();this.checkFPS(k,A.totalVideoFrames,A.droppedVideoFrames)}else this.checkFPS(k,k.webkitDecodedFrameCount,k.webkitDroppedFrameCount)},_}();const I=P},"./src/controller/fragment-finders.ts":(j,x,S)=>{S.r(x),S.d(x,{findFragWithCC:()=>k,findFragmentByPDT:()=>P,findFragmentByPTS:()=>I,fragmentWithinToleranceTest:()=>_,pdtWithinToleranceTest:()=>b});var F=S("./src/polyfills/number.ts"),D=S("./src/utils/binary-search.ts");function P(A,T,E){if(T===null||!Array.isArray(A)||!A.length||!(0,F.isFiniteNumber)(T))return null;var h=A[0].programDateTime;if(T<(h||0))return null;var m=A[A.length-1].endProgramDateTime;if(T>=(m||0))return null;E=E||0;for(var v=0;v<A.length;++v){var r=A[v];if(b(T,E,r))return r}return null}function I(A,T,E,h){E===void 0&&(E=0),h===void 0&&(h=0);var m=null;if(A?m=T[A.sn-T[0].sn+1]||null:E===0&&T[0].start===0&&(m=T[0]),m&&_(E,h,m)===0)return m;var v=D.default.search(T,_.bind(null,E,h));return v&&(v!==A||!m)?v:m}function _(A,T,E){if(A===void 0&&(A=0),T===void 0&&(T=0),E.start<=A&&E.start+E.duration>A)return 0;var h=Math.min(T,E.duration+(E.deltaPTS?E.deltaPTS:0));return E.start+E.duration-h<=A?1:E.start-h>A&&E.start?-1:0}function b(A,T,E){var h=Math.min(T,E.duration+(E.deltaPTS?E.deltaPTS:0))*1e3,m=E.endProgramDateTime||0;return m-h>A}function k(A,T){return D.default.search(A,function(E){return E.cc<T?1:E.cc>T?-1:0})}},"./src/controller/fragment-tracker.ts":(j,x,S)=>{S.r(x),S.d(x,{FragmentState:()=>P,FragmentTracker:()=>I});var F=S("./src/events.ts"),D=S("./src/types/loader.ts"),P;(function(k){k.NOT_LOADED="NOT_LOADED",k.APPENDING="APPENDING",k.PARTIAL="PARTIAL",k.OK="OK"})(P||(P={}));var I=function(){function k(T){this.activeFragment=null,this.activeParts=null,this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hls=T,this._registerListeners()}var A=k.prototype;return A._registerListeners=function(){var T=this.hls;T.on(F.Events.BUFFER_APPENDED,this.onBufferAppended,this),T.on(F.Events.FRAG_BUFFERED,this.onFragBuffered,this),T.on(F.Events.FRAG_LOADED,this.onFragLoaded,this)},A._unregisterListeners=function(){var T=this.hls;T.off(F.Events.BUFFER_APPENDED,this.onBufferAppended,this),T.off(F.Events.FRAG_BUFFERED,this.onFragBuffered,this),T.off(F.Events.FRAG_LOADED,this.onFragLoaded,this)},A.destroy=function(){this._unregisterListeners(),this.fragments=this.endListFragments=this.timeRanges=this.activeFragment=this.activeParts=null},A.getAppendedFrag=function(T,E){if(E===D.PlaylistLevelType.MAIN){var h=this.activeFragment,m=this.activeParts;if(!h)return null;if(m)for(var v=m.length;v--;){var r=m[v],d=r?r.end:h.appendedPTS;if(r.start<=T&&d!==void 0&&T<=d)return v>9&&(this.activeParts=m.slice(v-9)),r}else if(h.start<=T&&h.appendedPTS!==void 0&&T<=h.appendedPTS)return h}return this.getBufferedFrag(T,E)},A.getBufferedFrag=function(T,E){for(var h=this.fragments,m=Object.keys(h),v=m.length;v--;){var r=h[m[v]];if((r==null?void 0:r.body.type)===E&&r.buffered){var d=r.body;if(d.start<=T&&T<=d.end)return d}}return null},A.detectEvictedFragments=function(T,E,h){var m=this;this.timeRanges&&(this.timeRanges[T]=E),Object.keys(this.fragments).forEach(function(v){var r=m.fragments[v];if(r){if(!r.buffered&&!r.loaded){r.body.type===h&&m.removeFragment(r.body);return}var d=r.range[T];d&&d.time.some(function(n){var i=!m.isTimeBuffered(n.startPTS,n.endPTS,E);return i&&m.removeFragment(r.body),i})}})},A.detectPartialFragments=function(T){var E=this,h=this.timeRanges,m=T.frag,v=T.part;if(!(!h||m.sn==="initSegment")){var r=b(m),d=this.fragments[r];d&&(Object.keys(h).forEach(function(n){var i=m.elementaryStreams[n];if(i){var y=h[n],o=v!==null||i.partial===!0;d.range[n]=E.getBufferedTimes(m,v,o,y)}}),d.loaded=null,Object.keys(d.range).length?(d.buffered=!0,d.body.endList&&(this.endListFragments[d.body.type]=d)):this.removeFragment(d.body))}},A.fragBuffered=function(T){var E=b(T),h=this.fragments[E];h&&(h.loaded=null,h.buffered=!0)},A.getBufferedTimes=function(T,E,h,m){for(var v={time:[],partial:h},r=E?E.start:T.start,d=E?E.end:T.end,n=T.minEndPTS||d,i=T.maxStartPTS||r,y=0;y<m.length;y++){var o=m.start(y)-this.bufferPadding,a=m.end(y)+this.bufferPadding;if(i>=o&&n<=a){v.time.push({startPTS:Math.max(r,m.start(y)),endPTS:Math.min(d,m.end(y))});break}else if(r<a&&d>o)v.partial=!0,v.time.push({startPTS:Math.max(r,m.start(y)),endPTS:Math.min(d,m.end(y))});else if(d<=o)break}return v},A.getPartialFragment=function(T){var E=null,h,m,v,r=0,d=this.bufferPadding,n=this.fragments;return Object.keys(n).forEach(function(i){var y=n[i];y&&_(y)&&(m=y.body.start-d,v=y.body.end+d,T>=m&&T<=v&&(h=Math.min(T-m,v-T),r<=h&&(E=y.body,r=h)))}),E},A.isEndListAppended=function(T){var E=this.endListFragments[T];return E!==void 0&&(E.buffered||_(E))},A.getState=function(T){var E=b(T),h=this.fragments[E];return h?h.buffered?_(h)?P.PARTIAL:P.OK:P.APPENDING:P.NOT_LOADED},A.isTimeBuffered=function(T,E,h){for(var m,v,r=0;r<h.length;r++){if(m=h.start(r)-this.bufferPadding,v=h.end(r)+this.bufferPadding,T>=m&&E<=v)return!0;if(E<=m)return!1}return!1},A.onFragLoaded=function(T,E){var h=E.frag,m=E.part;if(!(h.sn==="initSegment"||h.bitrateTest||m)){var v=b(h);this.fragments[v]={body:h,loaded:E,buffered:!1,range:Object.create(null)}}},A.onBufferAppended=function(T,E){var h=this,m=E.frag,v=E.part,r=E.timeRanges;if(m.type===D.PlaylistLevelType.MAIN)if(this.activeFragment!==m&&(this.activeFragment=m,m.appendedPTS=void 0),v){var d=this.activeParts;d||(this.activeParts=d=[]),d.push(v)}else this.activeParts=null;this.timeRanges=r,Object.keys(r).forEach(function(n){var i=r[n];if(h.detectEvictedFragments(n,i),!v&&m.type===D.PlaylistLevelType.MAIN){var y=m.elementaryStreams[n];if(!y)return;for(var o=0;o<i.length;o++){var a=i.end(o);a<=y.endPTS&&a>y.startPTS?m.appendedPTS=Math.max(a,m.appendedPTS||0):m.appendedPTS=y.endPTS}}})},A.onFragBuffered=function(T,E){this.detectPartialFragments(E)},A.hasFragment=function(T){var E=b(T);return!!this.fragments[E]},A.removeFragmentsInRange=function(T,E,h){var m=this;Object.keys(this.fragments).forEach(function(v){var r=m.fragments[v];if(r&&r.buffered){var d=r.body;d.type===h&&d.start<E&&d.end>T&&m.removeFragment(d)}})},A.removeFragment=function(T){var E=b(T);T.stats.loaded=0,T.clearElementaryStreamInfo(),T.appendedPTS=void 0,delete this.fragments[E],T.endList&&delete this.endListFragments[T.type]},A.removeAllFragments=function(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activeFragment=null,this.activeParts=null},k}();function _(k){var A,T;return k.buffered&&(((A=k.range.video)===null||A===void 0?void 0:A.partial)||((T=k.range.audio)===null||T===void 0?void 0:T.partial))}function b(k){return k.type+"_"+k.level+"_"+k.urlId+"_"+k.sn}},"./src/controller/gap-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{MAX_START_GAP_JUMP:()=>b,SKIP_BUFFER_HOLE_STEP_SECONDS:()=>k,SKIP_BUFFER_RANGE_START:()=>A,STALL_MINIMUM_DURATION_MS:()=>_,default:()=>T});var F=S("./src/utils/buffer-helper.ts"),D=S("./src/errors.ts"),P=S("./src/events.ts"),I=S("./src/utils/logger.ts"),_=250,b=2,k=.1,A=.05,T=function(){function E(m,v,r,d){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=m,this.media=v,this.fragmentTracker=r,this.hls=d}var h=E.prototype;return h.destroy=function(){this.media=null,this.hls=this.fragmentTracker=null},h.poll=function(m,v){var r=this.config,d=this.media,n=this.stalled;if(d!==null){var i=d.currentTime,y=d.seeking,o=this.seeking&&!y,a=!this.seeking&&y;if(this.seeking=y,i!==m){if(this.moved=!0,n!==null){if(this.stallReported){var g=self.performance.now()-n;I.logger.warn("playback not stuck anymore @"+i+", after "+Math.round(g)+"ms"),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if((a||o)&&(this.stalled=null),!(d.paused&&!y||d.ended||d.playbackRate===0||!F.BufferHelper.getBuffered(d).length)){var f=F.BufferHelper.bufferInfo(d,i,0),s=f.len>0,e=f.nextStart||0;if(!(!s&&!e)){if(y){var u=f.len>b,t=!e||v&&v.start<=i||e-i>b&&!this.fragmentTracker.getPartialFragment(i);if(u||t)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var l,p=Math.max(e,f.start||0)-i,c=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,L=c==null||(l=c.details)===null||l===void 0?void 0:l.live,R=L?c.details.targetduration*2:b;if(p>0&&p<=R){this._trySkipBufferHole(null);return}}var w=self.performance.now();if(n===null){this.stalled=w;return}var O=w-n;if(!(!y&&O>=_&&(this._reportStall(f),!this.media))){var C=F.BufferHelper.bufferInfo(d,i,r.maxBufferHole);this._tryFixBufferStall(C,O)}}}}},h._tryFixBufferStall=function(m,v){var r=this.config,d=this.fragmentTracker,n=this.media;if(n!==null){var i=n.currentTime,y=d.getPartialFragment(i);if(y){var o=this._trySkipBufferHole(y);if(o||!this.media)return}m.len>r.maxBufferHole&&v>r.highBufferWatchdogPeriod*1e3&&(I.logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}},h._reportStall=function(m){var v=this.hls,r=this.media,d=this.stallReported;!d&&r&&(this.stallReported=!0,I.logger.warn("Playback stalling at @"+r.currentTime+" due to low buffer ("+JSON.stringify(m)+")"),v.trigger(P.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:m.len}))},h._trySkipBufferHole=function(m){var v=this.config,r=this.hls,d=this.media;if(d===null)return 0;for(var n=d.currentTime,i=0,y=F.BufferHelper.getBuffered(d),o=0;o<y.length;o++){var a=y.start(o);if(n+v.maxBufferHole>=i&&n<a){var g=Math.max(a+A,d.currentTime+k);return I.logger.warn("skipping hole, adjusting currentTime from "+n+" to "+g),this.moved=!0,this.stalled=null,d.currentTime=g,m&&r.trigger(P.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:"fragment loaded with buffer holes, seeking from "+n+" to "+g,frag:m}),g}i=y.end(o)}return 0},h._tryNudgeBuffer=function(){var m=this.config,v=this.hls,r=this.media,d=this.nudgeRetry;if(r!==null){var n=r.currentTime;if(this.nudgeRetry++,d<m.nudgeMaxRetry){var i=n+(d+1)*m.nudgeOffset;I.logger.warn("Nudging 'currentTime' from "+n+" to "+i),r.currentTime=i,v.trigger(P.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:!1})}else I.logger.error("Playhead still not moving while enough data buffered @"+n+" after "+m.nudgeMaxRetry+" nudges"),v.trigger(P.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!0})}},E}()},"./src/controller/id3-track-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>v});var F=S("./src/polyfills/number.ts"),D=S("./src/events.ts"),P=S("./src/utils/texttrack-utils.ts"),I=S("./src/demux/id3.ts"),_=S("./src/loader/date-range.ts"),b=S("./src/types/demuxer.ts"),k=.25;function A(){return self.WebKitDataCue||self.VTTCue||self.TextTrackCue}var T=function(){var r=A();try{new r(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY}();function E(r,d){return r.getTime()/1e3-d}function h(r){return Uint8Array.from(r.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}var m=function(){function r(n){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=n,this._registerListeners()}var d=r.prototype;return d.destroy=function(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null},d._registerListeners=function(){var n=this.hls;n.on(D.Events.MEDIA_ATTACHED,this.onMediaAttached,this),n.on(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.on(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.on(D.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),n.on(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),n.on(D.Events.LEVEL_UPDATED,this.onLevelUpdated,this)},d._unregisterListeners=function(){var n=this.hls;n.off(D.Events.MEDIA_ATTACHED,this.onMediaAttached,this),n.off(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.off(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.off(D.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),n.off(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),n.off(D.Events.LEVEL_UPDATED,this.onLevelUpdated,this)},d.onMediaAttached=function(n,i){this.media=i.media},d.onMediaDetaching=function(){this.id3Track&&((0,P.clearCurrentCues)(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})},d.onManifestLoading=function(){this.dateRangeCuesAppended={}},d.createTrack=function(n){var i=this.getID3Track(n.textTracks);return i.mode="hidden",i},d.getID3Track=function(n){if(this.media){for(var i=0;i<n.length;i++){var y=n[i];if(y.kind==="metadata"&&y.label==="id3")return(0,P.sendAddTrackEvent)(y,this.media),y}return this.media.addTextTrack("metadata","id3")}},d.onFragParsingMetadata=function(n,i){if(this.media){var y=this.hls.config,o=y.enableEmsgMetadataCues,a=y.enableID3MetadataCues;if(!(!o&&!a)){var g=i.samples;this.id3Track||(this.id3Track=this.createTrack(this.media));for(var f=A(),s=0;s<g.length;s++){var e=g[s].type;if(!(e===b.MetadataSchema.emsg&&!o||!a)){var u=I.getID3Frames(g[s].data);if(u){var t=g[s].pts,l=t+g[s].duration;l>T&&(l=T);var p=l-t;p<=0&&(l=t+k);for(var c=0;c<u.length;c++){var L=u[c];if(!I.isTimeStampFrame(L)){this.updateId3CueEnds(t);var R=new f(t,l,"");R.value=L,e&&(R.type=e),this.id3Track.addCue(R)}}}}}}}},d.updateId3CueEnds=function(n){var i,y=(i=this.id3Track)===null||i===void 0?void 0:i.cues;if(y)for(var o=y.length;o--;){var a=y[o];a.startTime<n&&a.endTime===T&&(a.endTime=n)}},d.onBufferFlushing=function(n,i){var y=i.startOffset,o=i.endOffset,a=i.type,g=this.id3Track,f=this.hls;if(f){var s=f.config,e=s.enableEmsgMetadataCues,u=s.enableID3MetadataCues;if(g&&(e||u)){var t;a==="audio"?t=function(l){return l.type===b.MetadataSchema.audioId3&&u}:a==="video"?t=function(l){return l.type===b.MetadataSchema.emsg&&e}:t=function(l){return l.type===b.MetadataSchema.audioId3&&u||l.type===b.MetadataSchema.emsg&&e},(0,P.removeCuesInRange)(g,y,o,t)}}},d.onLevelUpdated=function(n,i){var y=this,o=i.details;if(!(!this.media||!o.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)){var a=this.dateRangeCuesAppended,g=this.id3Track,f=o.dateRanges,s=Object.keys(f);if(g)for(var e=Object.keys(a).filter(function(w){return!s.includes(w)}),u=function(w){var O=e[w];Object.keys(a[O].cues).forEach(function(C){g.removeCue(a[O].cues[C])}),delete a[O]},t=e.length;t--;)u(t);var l=o.fragments[o.fragments.length-1];if(!(s.length===0||!(0,F.isFiniteNumber)(l==null?void 0:l.programDateTime))){this.id3Track||(this.id3Track=this.createTrack(this.media));for(var p=l.programDateTime/1e3-l.start,c=A(),L=function(w){var O=s[w],C=f[O],M=a[O],N=(M==null?void 0:M.cues)||{},U=(M==null?void 0:M.durationKnown)||!1,B=E(C.startDate,p),G=T,K=C.endDate;if(K)G=E(K,p),U=!0;else if(C.endOnNext&&!U){var Y=s.reduce(function(W,Q){var J=f[Q];return J.class===C.class&&J.id!==Q&&J.startDate>C.startDate&&W.push(J),W},[]).sort(function(W,Q){return W.startDate.getTime()-Q.startDate.getTime()})[0];Y&&(G=E(Y.startDate,p),U=!0)}for(var q=Object.keys(C.attr),H=0;H<q.length;H++){var V=q[H];if(!(V===_.DateRangeAttribute.ID||V===_.DateRangeAttribute.CLASS||V===_.DateRangeAttribute.START_DATE||V===_.DateRangeAttribute.DURATION||V===_.DateRangeAttribute.END_DATE||V===_.DateRangeAttribute.END_ON_NEXT)){var z=N[V];if(z)U&&!M.durationKnown&&(z.endTime=G);else{var X=C.attr[V];z=new c(B,G,""),(V===_.DateRangeAttribute.SCTE35_OUT||V===_.DateRangeAttribute.SCTE35_IN)&&(X=h(X)),z.value={key:V,data:X},z.type=b.MetadataSchema.dateRange,y.id3Track.addCue(z),N[V]=z}}}a[O]={cues:N,dateRange:C,durationKnown:U}},R=0;R<s.length;R++)L(R)}}},r}();const v=m},"./src/controller/latency-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>A});var F=S("./src/errors.ts"),D=S("./src/events.ts"),P=S("./src/utils/logger.ts");function I(T,E){for(var h=0;h<E.length;h++){var m=E[h];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(T,b(m.key),m)}}function _(T,E,h){return E&&I(T.prototype,E),Object.defineProperty(T,"prototype",{writable:!1}),T}function b(T){var E=k(T,"string");return typeof E=="symbol"?E:String(E)}function k(T,E){if(typeof T!="object"||T===null)return T;var h=T[Symbol.toPrimitive];if(h!==void 0){var m=h.call(T,E);if(typeof m!="object")return m;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(T)}var A=function(){function T(h){var m=this;this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=function(){return m.timeupdate()},this.hls=h,this.config=h.config,this.registerListeners()}var E=T.prototype;return E.destroy=function(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null},E.registerListeners=function(){this.hls.on(D.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(D.Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(D.Events.ERROR,this.onError,this)},E.unregisterListeners=function(){this.hls.off(D.Events.MEDIA_ATTACHED,this.onMediaAttached),this.hls.off(D.Events.MEDIA_DETACHING,this.onMediaDetaching),this.hls.off(D.Events.MANIFEST_LOADING,this.onManifestLoading),this.hls.off(D.Events.LEVEL_UPDATED,this.onLevelUpdated),this.hls.off(D.Events.ERROR,this.onError)},E.onMediaAttached=function(h,m){this.media=m.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)},E.onMediaDetaching=function(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)},E.onManifestLoading=function(){this.levelDetails=null,this._latency=null,this.stallCount=0},E.onLevelUpdated=function(h,m){var v=m.details;this.levelDetails=v,v.advanced&&this.timeupdate(),!v.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)},E.onError=function(h,m){m.details===F.ErrorDetails.BUFFER_STALLED_ERROR&&(this.stallCount++,P.logger.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))},E.timeupdate=function(){var h=this.media,m=this.levelDetails;if(!(!h||!m)){this.currentTime=h.currentTime;var v=this.computeLatency();if(v!==null){this._latency=v;var r=this.config,d=r.lowLatencyMode,n=r.maxLiveSyncPlaybackRate;if(!(!d||n===1)){var i=this.targetLatency;if(i!==null){var y=v-i,o=Math.min(this.maxLatency,i+m.targetduration),a=y<o;if(m.live&&a&&y>.05&&this.forwardBufferLength>1){var g=Math.min(2,Math.max(1,n)),f=Math.round(2/(1+Math.exp(-.75*y-this.edgeStalled))*20)/20;h.playbackRate=Math.min(g,Math.max(1,f))}else h.playbackRate!==1&&h.playbackRate!==0&&(h.playbackRate=1)}}}}},E.estimateLiveEdge=function(){var h=this.levelDetails;return h===null?null:h.edge+h.age},E.computeLatency=function(){var h=this.estimateLiveEdge();return h===null?null:h-this.currentTime},_(T,[{key:"latency",get:function(){return this._latency||0}},{key:"maxLatency",get:function(){var h=this.config,m=this.levelDetails;return h.liveMaxLatencyDuration!==void 0?h.liveMaxLatencyDuration:m?h.liveMaxLatencyDurationCount*m.targetduration:0}},{key:"targetLatency",get:function(){var h=this.levelDetails;if(h===null)return null;var m=h.holdBack,v=h.partHoldBack,r=h.targetduration,d=this.config,n=d.liveSyncDuration,i=d.liveSyncDurationCount,y=d.lowLatencyMode,o=this.hls.userConfig,a=y&&v||m;(o.liveSyncDuration||o.liveSyncDurationCount||a===0)&&(a=n!==void 0?n:i*r);var g=r,f=1;return a+Math.min(this.stallCount*f,g)}},{key:"liveSyncPosition",get:function(){var h=this.estimateLiveEdge(),m=this.targetLatency,v=this.levelDetails;if(h===null||m===null||v===null)return null;var r=v.edge,d=h-m-this.edgeStalled,n=r-v.totalduration,i=r-(this.config.lowLatencyMode&&v.partTarget||v.targetduration);return Math.min(Math.max(n,d),i)}},{key:"drift",get:function(){var h=this.levelDetails;return h===null?1:h.drift}},{key:"edgeStalled",get:function(){var h=this.levelDetails;if(h===null)return 0;var m=(this.config.lowLatencyMode&&h.partTarget||h.targetduration)*3;return Math.max(h.age-m,0)}},{key:"forwardBufferLength",get:function(){var h=this.media,m=this.levelDetails;if(!h||!m)return 0;var v=h.buffered.length;return(v?h.buffered.end(v-1):m.edge)-this.currentTime}}]),T}()},"./src/controller/level-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>n});var F=S("./src/types/level.ts"),D=S("./src/events.ts"),P=S("./src/errors.ts"),I=S("./src/utils/codecs.ts"),_=S("./src/controller/level-helper.ts"),b=S("./src/controller/base-playlist-controller.ts"),k=S("./src/types/loader.ts");function A(){return A=Object.assign?Object.assign.bind():function(i){for(var y=1;y<arguments.length;y++){var o=arguments[y];for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(i[a]=o[a])}return i},A.apply(this,arguments)}function T(i,y){for(var o=0;o<y.length;o++){var a=y[o];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(i,h(a.key),a)}}function E(i,y,o){return y&&T(i.prototype,y),Object.defineProperty(i,"prototype",{writable:!1}),i}function h(i){var y=m(i,"string");return typeof y=="symbol"?y:String(y)}function m(i,y){if(typeof i!="object"||i===null)return i;var o=i[Symbol.toPrimitive];if(o!==void 0){var a=o.call(i,y);if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(i)}function v(i,y){i.prototype=Object.create(y.prototype),i.prototype.constructor=i,r(i,y)}function r(i,y){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,a){return o.__proto__=a,o},r(i,y)}var d=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),n=function(i){v(y,i);function y(a){var g;return g=i.call(this,a,"[level-controller]")||this,g._levels=[],g._firstLevel=-1,g._startLevel=void 0,g.currentLevelIndex=-1,g.manualLevelIndex=-1,g.onParsedComplete=void 0,g._registerListeners(),g}var o=y.prototype;return o._registerListeners=function(){var a=this.hls;a.on(D.Events.MANIFEST_LOADED,this.onManifestLoaded,this),a.on(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),a.on(D.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),a.on(D.Events.FRAG_LOADED,this.onFragLoaded,this),a.on(D.Events.ERROR,this.onError,this)},o._unregisterListeners=function(){var a=this.hls;a.off(D.Events.MANIFEST_LOADED,this.onManifestLoaded,this),a.off(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),a.off(D.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),a.off(D.Events.FRAG_LOADED,this.onFragLoaded,this),a.off(D.Events.ERROR,this.onError,this)},o.destroy=function(){this._unregisterListeners(),this.manualLevelIndex=-1,this._levels.length=0,i.prototype.destroy.call(this)},o.startLoad=function(){var a=this._levels;a.forEach(function(g){g.loadError=0}),i.prototype.startLoad.call(this)},o.onManifestLoaded=function(a,g){var f=[],s=[],e=[],u,t={},l,p=!1,c=!1,L=!1;if(g.levels.forEach(function(C){var M=C.attrs;p=p||!!(C.width&&C.height),c=c||!!C.videoCodec,L=L||!!C.audioCodec,d&&C.audioCodec&&C.audioCodec.indexOf("mp4a.40.34")!==-1&&(C.audioCodec=void 0);var N=C.bitrate+"-"+C.attrs.RESOLUTION+"-"+C.attrs.CODECS;l=t[N],l?l.url.push(C.url):(l=new F.Level(C),t[N]=l,f.push(l)),M&&(M.AUDIO&&(0,_.addGroupId)(l,"audio",M.AUDIO),M.SUBTITLES&&(0,_.addGroupId)(l,"text",M.SUBTITLES))}),(p||c)&&L&&(f=f.filter(function(C){var M=C.videoCodec,N=C.width,U=C.height;return!!M||!!(N&&U)})),f=f.filter(function(C){var M=C.audioCodec,N=C.videoCodec;return(!M||(0,I.isCodecSupportedInMp4)(M,"audio"))&&(!N||(0,I.isCodecSupportedInMp4)(N,"video"))}),g.audioTracks&&(s=g.audioTracks.filter(function(C){return!C.audioCodec||(0,I.isCodecSupportedInMp4)(C.audioCodec,"audio")}),(0,_.assignTrackIdsByGroup)(s)),g.subtitles&&(e=g.subtitles,(0,_.assignTrackIdsByGroup)(e)),f.length>0){u=f[0].bitrate,f.sort(function(C,M){return C.attrs["HDCP-LEVEL"]!==M.attrs["HDCP-LEVEL"]?(C.attrs["HDCP-LEVEL"]||"")>(M.attrs["HDCP-LEVEL"]||"")?1:-1:C.bitrate!==M.bitrate?C.bitrate-M.bitrate:C.attrs.SCORE!==M.attrs.SCORE?C.attrs.decimalFloatingPoint("SCORE")-M.attrs.decimalFloatingPoint("SCORE"):p&&C.height!==M.height?C.height-M.height:0}),this._levels=f;for(var R=0;R<f.length;R++)if(f[R].bitrate===u){this._firstLevel=R,this.log("manifest loaded, "+f.length+" level(s) found, first bitrate: "+u);break}var w=L&&!c,O={levels:f,audioTracks:s,subtitleTracks:e,sessionData:g.sessionData,sessionKeys:g.sessionKeys,firstLevel:this._firstLevel,stats:g.stats,audio:L,video:c,altAudio:!w&&s.some(function(C){return!!C.url})};this.hls.trigger(D.Events.MANIFEST_PARSED,O),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else this.hls.trigger(D.Events.ERROR,{type:P.ErrorTypes.MEDIA_ERROR,details:P.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:g.url,reason:"no level with compatible codecs found in manifest"})},o.onError=function(a,g){var f,s;if(i.prototype.onError.call(this,a,g),!g.fatal){var e=g.context,u=this._levels[this.currentLevelIndex];if(e&&(e.type===k.PlaylistContextType.AUDIO_TRACK&&u.audioGroupIds&&e.groupId===u.audioGroupIds[u.urlId]||e.type===k.PlaylistContextType.SUBTITLE_TRACK&&u.textGroupIds&&e.groupId===u.textGroupIds[u.urlId])){this.redundantFailover(this.currentLevelIndex);return}var t=!1,l=!0,p;switch(g.details){case P.ErrorDetails.FRAG_LOAD_ERROR:case P.ErrorDetails.FRAG_LOAD_TIMEOUT:case P.ErrorDetails.KEY_LOAD_ERROR:case P.ErrorDetails.KEY_LOAD_TIMEOUT:if(g.frag){var c=g.frag.type===k.PlaylistLevelType.MAIN?g.frag.level:this.currentLevelIndex,L=this._levels[c];L?(L.fragmentError++,L.fragmentError>this.hls.config.fragLoadingMaxRetry&&(p=c)):p=c}break;case P.ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{var R=u.attrs["HDCP-LEVEL"];R&&(this.hls.maxHdcpLevel=F.HdcpLevels[F.HdcpLevels.indexOf(R)-1],this.warn('Restricting playback to HDCP-LEVEL of "'+this.hls.maxHdcpLevel+'" or lower'))}case P.ErrorDetails.FRAG_PARSING_ERROR:case P.ErrorDetails.KEY_SYSTEM_NO_SESSION:p=((f=g.frag)===null||f===void 0?void 0:f.type)===k.PlaylistLevelType.MAIN?g.frag.level:this.currentLevelIndex,g.levelRetry=!1;break;case P.ErrorDetails.LEVEL_LOAD_ERROR:case P.ErrorDetails.LEVEL_LOAD_TIMEOUT:e&&(e.deliveryDirectives&&(l=!1),p=e.level),t=!0;break;case P.ErrorDetails.REMUX_ALLOC_ERROR:p=(s=g.level)!=null?s:this.currentLevelIndex,t=!0;break}p!==void 0&&this.recoverLevel(g,p,t,l)}},o.recoverLevel=function(a,g,f,s){var e=a.details,u=this._levels[g];if(u.loadError++,f){var t=this.retryLoadingOrFail(a);if(t)a.levelRetry=!0;else{this.currentLevelIndex=-1;return}}if(s){var l=u.url.length;if(l>1&&u.loadError<l)a.levelRetry=!0,this.redundantFailover(g);else if(this.manualLevelIndex===-1){for(var p=-1,c=this._levels,L=c.length;L--;){var R=(L+this.currentLevelIndex)%c.length;if(R!==this.currentLevelIndex&&c[R].loadError===0){p=R;break}}p>-1&&this.currentLevelIndex!==p?(this.warn(e+": switch to "+p),a.levelRetry=!0,this.hls.nextAutoLevel=p):a.levelRetry===!1&&(a.fatal=!0)}}},o.redundantFailover=function(a){var g=this._levels[a],f=g.url.length;if(f>1){var s=(g.urlId+1)%f;this.warn("Switching to redundant URL-id "+s),this._levels.forEach(function(e){e.urlId=s}),this.level=a}},o.onFragLoaded=function(a,g){var f=g.frag;if(f!==void 0&&f.type===k.PlaylistLevelType.MAIN){var s=this._levels[f.level];s!==void 0&&(s.fragmentError=0,s.loadError=0)}},o.onLevelLoaded=function(a,g){var f,s=g.level,e=g.details,u=this._levels[s];if(!u){var t;this.warn("Invalid level index "+s),(t=g.deliveryDirectives)!==null&&t!==void 0&&t.skip&&(e.deltaUpdateFailed=!0);return}s===this.currentLevelIndex?(u.fragmentError===0&&(u.loadError=0,this.retryCount=0),this.playlistLoaded(s,g,u.details)):(f=g.deliveryDirectives)!==null&&f!==void 0&&f.skip&&(e.deltaUpdateFailed=!0)},o.onAudioTrackSwitched=function(a,g){var f=this.hls.levels[this.currentLevelIndex];if(f&&f.audioGroupIds){for(var s=-1,e=this.hls.audioTracks[g.id].groupId,u=0;u<f.audioGroupIds.length;u++)if(f.audioGroupIds[u]===e){s=u;break}s!==f.urlId&&(f.urlId=s,this.startLoad())}},o.loadPlaylist=function(a){i.prototype.loadPlaylist.call(this);var g=this.currentLevelIndex,f=this._levels[g];if(this.canLoad&&f&&f.url.length>0){var s=f.urlId,e=f.url[s];if(a)try{e=a.addDirectives(e)}catch(u){this.warn("Could not construct new URL with HLS Delivery Directives: "+u)}this.log("Attempt loading level index "+g+((a==null?void 0:a.msn)!==void 0?" at sn "+a.msn+" part "+a.part:"")+" with URL-id "+s+" "+e),this.clearTimer(),this.hls.trigger(D.Events.LEVEL_LOADING,{url:e,level:g,id:s,deliveryDirectives:a||null})}},o.removeLevel=function(a,g){var f=function(e,u){return u!==g},s=this._levels.filter(function(e,u){return u!==a?!0:e.url.length>1&&g!==void 0?(e.url=e.url.filter(f),e.audioGroupIds&&(e.audioGroupIds=e.audioGroupIds.filter(f)),e.textGroupIds&&(e.textGroupIds=e.textGroupIds.filter(f)),e.urlId=0,!0):!1}).map(function(e,u){var t=e.details;return t!=null&&t.fragments&&t.fragments.forEach(function(l){l.level=u}),e});this._levels=s,this.hls.trigger(D.Events.LEVELS_UPDATED,{levels:s})},E(y,[{key:"levels",get:function(){return this._levels.length===0?null:this._levels}},{key:"level",get:function(){return this.currentLevelIndex},set:function(a){var g,f=this._levels;if(f.length!==0&&!(this.currentLevelIndex===a&&(g=f[a])!==null&&g!==void 0&&g.details)){if(a<0||a>=f.length){var s=a<0;if(this.hls.trigger(D.Events.ERROR,{type:P.ErrorTypes.OTHER_ERROR,details:P.ErrorDetails.LEVEL_SWITCH_ERROR,level:a,fatal:s,reason:"invalid level idx"}),s)return;a=Math.min(a,f.length-1)}this.clearTimer();var e=this.currentLevelIndex,u=f[e],t=f[a];this.log("switching to level "+a+" from "+e),this.currentLevelIndex=a;var l=A({},t,{level:a,maxBitrate:t.maxBitrate,uri:t.uri,urlId:t.urlId});delete l._urlId,this.hls.trigger(D.Events.LEVEL_SWITCHING,l);var p=t.details;if(!p||p.live){var c=this.switchParams(t.uri,u==null?void 0:u.details);this.loadPlaylist(c)}}}},{key:"manualLevel",get:function(){return this.manualLevelIndex},set:function(a){this.manualLevelIndex=a,this._startLevel===void 0&&(this._startLevel=a),a!==-1&&(this.level=a)}},{key:"firstLevel",get:function(){return this._firstLevel},set:function(a){this._firstLevel=a}},{key:"startLevel",get:function(){if(this._startLevel===void 0){var a=this.hls.config.startLevel;return a!==void 0?a:this._firstLevel}else return this._startLevel},set:function(a){this._startLevel=a}},{key:"nextLoadLevel",get:function(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel},set:function(a){this.level=a,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=a)}}]),y}(b.default)},"./src/controller/level-helper.ts":(j,x,S)=>{S.r(x),S.d(x,{addGroupId:()=>_,addSliding:()=>d,adjustSliding:()=>r,assignTrackIdsByGroup:()=>b,computeReloadInterval:()=>n,getFragmentWithSN:()=>i,getPartWith:()=>y,mapFragmentIntersection:()=>v,mapPartIntersection:()=>m,mergeDetails:()=>E,updateFragPTSDTS:()=>T,updatePTS:()=>k});var F=S("./src/polyfills/number.ts"),D=S("./src/utils/logger.ts"),P=S("./src/loader/date-range.ts");function I(){return I=Object.assign?Object.assign.bind():function(o){for(var a=1;a<arguments.length;a++){var g=arguments[a];for(var f in g)Object.prototype.hasOwnProperty.call(g,f)&&(o[f]=g[f])}return o},I.apply(this,arguments)}function _(o,a,g){switch(a){case"audio":o.audioGroupIds||(o.audioGroupIds=[]),o.audioGroupIds.push(g);break;case"text":o.textGroupIds||(o.textGroupIds=[]),o.textGroupIds.push(g);break}}function b(o){var a={};o.forEach(function(g){var f=g.groupId||"";g.id=a[f]=a[f]||0,a[f]++})}function k(o,a,g){var f=o[a],s=o[g];A(f,s)}function A(o,a){var g=a.startPTS;if((0,F.isFiniteNumber)(g)){var f=0,s;a.sn>o.sn?(f=g-o.start,s=o):(f=o.start-g,s=a),s.duration!==f&&(s.duration=f)}else if(a.sn>o.sn){var e=o.cc===a.cc;e&&o.minEndPTS?a.start=o.start+(o.minEndPTS-o.start):a.start=o.start+o.duration}else a.start=Math.max(o.start-a.duration,0)}function T(o,a,g,f,s,e){var u=f-g;u<=0&&(D.logger.warn("Fragment should have a positive duration",a),f=g+a.duration,e=s+a.duration);var t=g,l=f,p=a.startPTS,c=a.endPTS;if((0,F.isFiniteNumber)(p)){var L=Math.abs(p-g);(0,F.isFiniteNumber)(a.deltaPTS)?a.deltaPTS=Math.max(L,a.deltaPTS):a.deltaPTS=L,t=Math.max(g,p),g=Math.min(g,p),s=Math.min(s,a.startDTS),l=Math.min(f,c),f=Math.max(f,c),e=Math.max(e,a.endDTS)}a.duration=f-g;var R=g-a.start;a.start=a.startPTS=g,a.maxStartPTS=t,a.startDTS=s,a.endPTS=f,a.minEndPTS=l,a.endDTS=e;var w=a.sn;if(!o||w<o.startSN||w>o.endSN)return 0;var O,C=w-o.startSN,M=o.fragments;for(M[C]=a,O=C;O>0;O--)A(M[O],M[O-1]);for(O=C;O<M.length-1;O++)A(M[O],M[O+1]);return o.fragmentHint&&A(M[M.length-1],o.fragmentHint),o.PTSKnown=o.alignedSliding=!0,R}function E(o,a){for(var g=null,f=o.fragments,s=f.length-1;s>=0;s--){var e=f[s].initSegment;if(e){g=e;break}}o.fragmentHint&&delete o.fragmentHint.endPTS;var u=0,t;if(v(o,a,function(O,C){O.relurl&&(u=O.cc-C.cc),(0,F.isFiniteNumber)(O.startPTS)&&(0,F.isFiniteNumber)(O.endPTS)&&(C.start=C.startPTS=O.startPTS,C.startDTS=O.startDTS,C.appendedPTS=O.appendedPTS,C.maxStartPTS=O.maxStartPTS,C.endPTS=O.endPTS,C.endDTS=O.endDTS,C.minEndPTS=O.minEndPTS,C.duration=O.endPTS-O.startPTS,C.duration&&(t=C),a.PTSKnown=a.alignedSliding=!0),C.elementaryStreams=O.elementaryStreams,C.loader=O.loader,C.stats=O.stats,C.urlId=O.urlId,O.initSegment&&(C.initSegment=O.initSegment,g=O.initSegment)}),g){var l=a.fragmentHint?a.fragments.concat(a.fragmentHint):a.fragments;l.forEach(function(O){var C;(!O.initSegment||O.initSegment.relurl===((C=g)===null||C===void 0?void 0:C.relurl))&&(O.initSegment=g)})}if(a.skippedSegments)if(a.deltaUpdateFailed=a.fragments.some(function(O){return!O}),a.deltaUpdateFailed){D.logger.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var p=a.skippedSegments;p--;)a.fragments.shift();a.startSN=a.fragments[0].sn,a.startCC=a.fragments[0].cc}else a.canSkipDateRanges&&(a.dateRanges=h(o.dateRanges,a.dateRanges,a.recentlyRemovedDateranges));var c=a.fragments;if(u){D.logger.warn("discontinuity sliding from playlist, take drift into account");for(var L=0;L<c.length;L++)c[L].cc+=u}a.skippedSegments&&(a.startCC=a.fragments[0].cc),m(o.partList,a.partList,function(O,C){C.elementaryStreams=O.elementaryStreams,C.stats=O.stats}),t?T(a,t,t.startPTS,t.endPTS,t.startDTS,t.endDTS):r(o,a),c.length&&(a.totalduration=a.edge-c[0].start),a.driftStartTime=o.driftStartTime,a.driftStart=o.driftStart;var R=a.advancedDateTime;if(a.advanced&&R){var w=a.edge;a.driftStart||(a.driftStartTime=R,a.driftStart=w),a.driftEndTime=R,a.driftEnd=w}else a.driftEndTime=o.driftEndTime,a.driftEnd=o.driftEnd,a.advancedDateTime=o.advancedDateTime}function h(o,a,g){var f=I({},o);return g&&g.forEach(function(s){delete f[s]}),Object.keys(a).forEach(function(s){var e=new P.DateRange(a[s].attr,f[s]);e.isValid?f[s]=e:D.logger.warn('Ignoring invalid Playlist Delta Update DATERANGE tag: "'+JSON.stringify(a[s].attr)+'"')}),f}function m(o,a,g){if(o&&a)for(var f=0,s=0,e=o.length;s<=e;s++){var u=o[s],t=a[s+f];u&&t&&u.index===t.index&&u.fragment.sn===t.fragment.sn?g(u,t):f--}}function v(o,a,g){for(var f=a.skippedSegments,s=Math.max(o.startSN,a.startSN)-a.startSN,e=(o.fragmentHint?1:0)+(f?a.endSN:Math.min(o.endSN,a.endSN))-a.startSN,u=a.startSN-o.startSN,t=a.fragmentHint?a.fragments.concat(a.fragmentHint):a.fragments,l=o.fragmentHint?o.fragments.concat(o.fragmentHint):o.fragments,p=s;p<=e;p++){var c=l[u+p],L=t[p];f&&!L&&p<f&&(L=a.fragments[p]=c),c&&L&&g(c,L)}}function r(o,a){var g=a.startSN+a.skippedSegments-o.startSN,f=o.fragments;g<0||g>=f.length||d(a,f[g].start)}function d(o,a){if(a){for(var g=o.fragments,f=o.skippedSegments;f<g.length;f++)g[f].start+=a;o.fragmentHint&&(o.fragmentHint.start+=a)}}function n(o,a){a===void 0&&(a=1/0);var g=1e3*o.targetduration;if(o.updated){var f=o.fragments,s=4;if(f.length&&g*s>a){var e=f[f.length-1].duration*1e3;e<g&&(g=e)}}else g/=2;return Math.round(g)}function i(o,a,g){if(!o||!o.details)return null;var f=o.details,s=f.fragments[a-f.startSN];return s||(s=f.fragmentHint,s&&s.sn===a)?s:a<f.startSN&&g&&g.sn===a?g:null}function y(o,a,g){if(!o||!o.details)return null;var f=o.details.partList;if(f)for(var s=f.length;s--;){var e=f[s];if(e.index===g&&e.fragment.sn===a)return e}return null}},"./src/controller/stream-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>a});var F=S("./src/polyfills/number.ts"),D=S("./src/controller/base-stream-controller.ts"),P=S("./src/is-supported.ts"),I=S("./src/events.ts"),_=S("./src/utils/buffer-helper.ts"),b=S("./src/controller/fragment-tracker.ts"),k=S("./src/types/loader.ts"),A=S("./src/loader/fragment.ts"),T=S("./src/demux/transmuxer-interface.ts"),E=S("./src/types/transmuxer.ts"),h=S("./src/controller/gap-controller.ts"),m=S("./src/errors.ts");function v(g,f){for(var s=0;s<f.length;s++){var e=f[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(g,d(e.key),e)}}function r(g,f,s){return f&&v(g.prototype,f),Object.defineProperty(g,"prototype",{writable:!1}),g}function d(g){var f=n(g,"string");return typeof f=="symbol"?f:String(f)}function n(g,f){if(typeof g!="object"||g===null)return g;var s=g[Symbol.toPrimitive];if(s!==void 0){var e=s.call(g,f);if(typeof e!="object")return e;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(g)}function i(g,f){g.prototype=Object.create(f.prototype),g.prototype.constructor=g,y(g,f)}function y(g,f){return y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(s,e){return s.__proto__=e,s},y(g,f)}var o=100,a=function(g){i(f,g);function f(e,u,t){var l;return l=g.call(this,e,u,t,"[stream-controller]")||this,l.audioCodecSwap=!1,l.gapController=null,l.level=-1,l._forceStartLoad=!1,l.altAudio=!1,l.audioOnly=!1,l.fragPlaying=null,l.onvplaying=null,l.onvseeked=null,l.fragLastKbps=0,l.couldBacktrack=!1,l.backtrackFragment=null,l.audioCodecSwitch=!1,l.videoBuffer=null,l._registerListeners(),l}var s=f.prototype;return s._registerListeners=function(){var e=this.hls;e.on(I.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(I.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(I.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(I.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(I.Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(I.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(I.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(I.Events.ERROR,this.onError,this),e.on(I.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(I.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(I.Events.BUFFER_CREATED,this.onBufferCreated,this),e.on(I.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(I.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(I.Events.FRAG_BUFFERED,this.onFragBuffered,this)},s._unregisterListeners=function(){var e=this.hls;e.off(I.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(I.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(I.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(I.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(I.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(I.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(I.Events.ERROR,this.onError,this),e.off(I.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(I.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(I.Events.BUFFER_CREATED,this.onBufferCreated,this),e.off(I.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(I.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(I.Events.FRAG_BUFFERED,this.onFragBuffered,this)},s.onHandlerDestroying=function(){this._unregisterListeners(),this.onMediaDetaching()},s.startLoad=function(e){if(this.levels){var u=this.lastCurrentTime,t=this.hls;if(this.stopLoad(),this.setInterval(o),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var l=t.startLevel;l===-1&&(t.config.testBandwidth&&this.levels.length>1?(l=0,this.bitrateTest=!0):l=t.nextAutoLevel),this.level=t.nextLoadLevel=l,this.loadedmetadata=!1}u>0&&e===-1&&(this.log("Override startPosition with lastCurrentTime @"+u.toFixed(3)),e=u),this.state=D.State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=D.State.STOPPED},s.stopLoad=function(){this._forceStartLoad=!1,g.prototype.stopLoad.call(this)},s.doTick=function(){switch(this.state){case D.State.IDLE:this.doTickIdle();break;case D.State.WAITING_LEVEL:{var e,u=this.levels,t=this.level,l=u==null||(e=u[t])===null||e===void 0?void 0:e.details;if(l&&(!l.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(l))break;this.state=D.State.IDLE;break}break}case D.State.FRAG_LOADING_WAITING_RETRY:{var p,c=self.performance.now(),L=this.retryDate;(!L||c>=L||(p=this.media)!==null&&p!==void 0&&p.seeking)&&(this.log("retryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.level),this.state=D.State.IDLE)}break}this.onTickEnd()},s.onTickEnd=function(){g.prototype.onTickEnd.call(this),this.checkBuffer(),this.checkFragmentChanged()},s.doTickIdle=function(){var e=this.hls,u=this.levelLastLoaded,t=this.levels,l=this.media,p=e.config,c=e.nextLoadLevel;if(!(u===null||!l&&(this.startFragRequested||!p.startFragPrefetch))&&!(this.altAudio&&this.audioOnly)&&!(!t||!t[c])){var L=t[c],R=this.getMainFwdBufferInfo();if(R!==null){var w=this.getLevelDetails();if(w&&this._streamEnded(R,w)){var O={};this.altAudio&&(O.type="video"),this.hls.trigger(I.Events.BUFFER_EOS,O),this.state=D.State.ENDED;return}this.level=e.nextLoadLevel=c;var C=L.details;if(!C||this.state===D.State.WAITING_LEVEL||C.live&&this.levelLastLoaded!==c){this.level=c,this.state=D.State.WAITING_LEVEL;return}var M=R.len,N=this.getMaxBufferLength(L.maxBitrate);if(!(M>=N)){this.backtrackFragment&&this.backtrackFragment.start>R.end&&(this.backtrackFragment=null);var U=this.backtrackFragment?this.backtrackFragment.start:R.end,B=this.getNextFragment(U,C);if(this.couldBacktrack&&!this.fragPrevious&&B&&B.sn!=="initSegment"&&this.fragmentTracker.getState(B)!==b.FragmentState.OK){var G,K=((G=this.backtrackFragment)!=null?G:B).sn,Y=K-C.startSN,q=C.fragments[Y-1];q&&B.cc===q.cc&&(B=q,this.fragmentTracker.removeFragment(q))}else this.backtrackFragment&&R.len&&(this.backtrackFragment=null);if(B&&this.fragmentTracker.getState(B)===b.FragmentState.OK&&this.nextLoadPosition>U){var H=this.audioOnly&&!this.altAudio?A.ElementaryStreamTypes.AUDIO:A.ElementaryStreamTypes.VIDEO,V=(H===A.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;V&&this.afterBufferFlushed(V,H,k.PlaylistLevelType.MAIN),B=this.getNextFragment(this.nextLoadPosition,C)}B&&(B.initSegment&&!B.initSegment.data&&!this.bitrateTest&&(B=B.initSegment),this.loadFragment(B,C,U))}}}},s.loadFragment=function(e,u,t){var l,p=this.fragmentTracker.getState(e);this.fragCurrent=e,p===b.FragmentState.NOT_LOADED?e.sn==="initSegment"?this._loadInitSegment(e,u):this.bitrateTest?(this.log("Fragment "+e.sn+" of level "+e.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(e,u)):(this.startFragRequested=!0,g.prototype.loadFragment.call(this,e,u,t)):p===b.FragmentState.APPENDING?this.reduceMaxBufferLength(e.duration)&&this.fragmentTracker.removeFragment(e):((l=this.media)===null||l===void 0?void 0:l.buffered.length)===0&&this.fragmentTracker.removeAllFragments()},s.getAppendedFrag=function(e){var u=this.fragmentTracker.getAppendedFrag(e,k.PlaylistLevelType.MAIN);return u&&"fragment"in u?u.fragment:u},s.getBufferedFrag=function(e){return this.fragmentTracker.getBufferedFrag(e,k.PlaylistLevelType.MAIN)},s.followingBufferedFrag=function(e){return e?this.getBufferedFrag(e.end+.5):null},s.immediateLevelSwitch=function(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},s.nextLevelSwitch=function(){var e=this.levels,u=this.media;if(u!=null&&u.readyState){var t,l=this.getAppendedFrag(u.currentTime);if(l&&l.start>1&&this.flushMainBuffer(0,l.start-1),!u.paused&&e){var p=this.hls.nextLoadLevel,c=e[p],L=this.fragLastKbps;L&&this.fragCurrent?t=this.fragCurrent.duration*c.maxBitrate/(1e3*L)+1:t=0}else t=0;var R=this.getBufferedFrag(u.currentTime+t);if(R){var w=this.followingBufferedFrag(R);if(w){this.abortCurrentFrag();var O=w.maxStartPTS?w.maxStartPTS:w.start,C=w.duration,M=Math.max(R.end,O+Math.min(Math.max(C-this.config.maxFragLookUpTolerance,C*.5),C*.75));this.flushMainBuffer(M,Number.POSITIVE_INFINITY)}}}},s.abortCurrentFrag=function(){var e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&e.abortRequests(),this.state){case D.State.KEY_LOADING:case D.State.FRAG_LOADING:case D.State.FRAG_LOADING_WAITING_RETRY:case D.State.PARSING:case D.State.PARSED:this.state=D.State.IDLE;break}this.nextLoadPosition=this.getLoadPosition()},s.flushMainBuffer=function(e,u){g.prototype.flushMainBuffer.call(this,e,u,this.altAudio?"video":null)},s.onMediaAttached=function(e,u){g.prototype.onMediaAttached.call(this,e,u);var t=u.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),t.addEventListener("playing",this.onvplaying),t.addEventListener("seeked",this.onvseeked),this.gapController=new h.default(this.config,t,this.fragmentTracker,this.hls)},s.onMediaDetaching=function(){var e=this.media;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),g.prototype.onMediaDetaching.call(this)},s.onMediaPlaying=function(){this.tick()},s.onMediaSeeked=function(){var e=this.media,u=e?e.currentTime:null;(0,F.isFiniteNumber)(u)&&this.log("Media seeked to "+u.toFixed(3)),this.tick()},s.onManifestLoading=function(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(I.Events.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null,this.backtrackFragment=null},s.onManifestParsed=function(e,u){var t=!1,l=!1,p;u.levels.forEach(function(c){p=c.audioCodec,p&&(p.indexOf("mp4a.40.2")!==-1&&(t=!0),p.indexOf("mp4a.40.5")!==-1&&(l=!0))}),this.audioCodecSwitch=t&&l&&!(0,P.changeTypeSupported)(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=u.levels,this.startFragRequested=!1},s.onLevelLoading=function(e,u){var t=this.levels;if(!(!t||this.state!==D.State.IDLE)){var l=t[u.level];(!l.details||l.details.live&&this.levelLastLoaded!==u.level||this.waitForCdnTuneIn(l.details))&&(this.state=D.State.WAITING_LEVEL)}},s.onLevelLoaded=function(e,u){var t,l=this.levels,p=u.level,c=u.details,L=c.totalduration;if(!l){this.warn("Levels were reset while loading level "+p);return}this.log("Level "+p+" loaded ["+c.startSN+","+c.endSN+"], cc ["+c.startCC+", "+c.endCC+"] duration:"+L);var R=this.fragCurrent;R&&(this.state===D.State.FRAG_LOADING||this.state===D.State.FRAG_LOADING_WAITING_RETRY)&&R.level!==u.level&&R.loader&&(this.state=D.State.IDLE,this.backtrackFragment=null,R.abortRequests());var w=l[p],O=0;if(c.live||(t=w.details)!==null&&t!==void 0&&t.live){if(c.fragments[0]||(c.deltaUpdateFailed=!0),c.deltaUpdateFailed)return;O=this.alignPlaylists(c,w.details)}if(w.details=c,this.levelLastLoaded=p,this.hls.trigger(I.Events.LEVEL_UPDATED,{details:c,level:p}),this.state===D.State.WAITING_LEVEL){if(this.waitForCdnTuneIn(c))return;this.state=D.State.IDLE}this.startFragRequested?c.live&&this.synchronizeToLiveEdge(c):this.setStartPosition(c,O),this.tick()},s._handleFragmentLoadProgress=function(e){var u,t=e.frag,l=e.part,p=e.payload,c=this.levels;if(!c){this.warn("Levels were reset while fragment load was in progress. Fragment "+t.sn+" of level "+t.level+" will not be buffered");return}var L=c[t.level],R=L.details;if(!R){this.warn("Dropping fragment "+t.sn+" of level "+t.level+" after level details were reset");return}var w=L.videoCodec,O=R.PTSKnown||!R.live,C=(u=t.initSegment)===null||u===void 0?void 0:u.data,M=this._getAudioCodec(L),N=this.transmuxer=this.transmuxer||new T.default(this.hls,k.PlaylistLevelType.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),U=l?l.index:-1,B=U!==-1,G=new E.ChunkMetadata(t.level,t.sn,t.stats.chunkCount,p.byteLength,U,B),K=this.initPTS[t.cc];N.push(p,C,M,w,t,l,R.totalduration,O,G,K)},s.onAudioTrackSwitching=function(e,u){var t=this.altAudio,l=!!u.url,p=u.id;if(!l){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var c=this.fragCurrent;c&&(this.log("Switching to main audio track, cancel main fragment load"),c.abortRequests()),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var L=this.hls;t&&L.trigger(I.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),L.trigger(I.Events.AUDIO_TRACK_SWITCHED,{id:p})}},s.onAudioTrackSwitched=function(e,u){var t=u.id,l=!!this.hls.audioTracks[t].url;if(l){var p=this.videoBuffer;p&&this.mediaBuffer!==p&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=p)}this.altAudio=l,this.tick()},s.onBufferCreated=function(e,u){var t=u.tracks,l,p,c=!1;for(var L in t){var R=t[L];if(R.id==="main"){if(p=L,l=R,L==="video"){var w=t[L];w&&(this.videoBuffer=w.buffer)}}else c=!0}c&&l?(this.log("Alternate track found, use "+p+".buffered to schedule main fragment loading"),this.mediaBuffer=l.buffer):this.mediaBuffer=this.media},s.onFragBuffered=function(e,u){var t=u.frag,l=u.part;if(!(t&&t.type!==k.PlaylistLevelType.MAIN)){if(this.fragContextChanged(t)){this.warn("Fragment "+t.sn+(l?" p: "+l.index:"")+" of level "+t.level+" finished buffering, but was aborted. state: "+this.state),this.state===D.State.PARSED&&(this.state=D.State.IDLE);return}var p=l?l.stats:t.stats;this.fragLastKbps=Math.round(8*p.total/(p.buffering.end-p.loading.first)),t.sn!=="initSegment"&&(this.fragPrevious=t),this.fragBufferedComplete(t,l)}},s.onError=function(e,u){if(u.type===m.ErrorTypes.KEY_SYSTEM_ERROR){this.onFragmentOrKeyLoadError(k.PlaylistLevelType.MAIN,u);return}switch(u.details){case m.ErrorDetails.FRAG_LOAD_ERROR:case m.ErrorDetails.FRAG_LOAD_TIMEOUT:case m.ErrorDetails.FRAG_PARSING_ERROR:case m.ErrorDetails.KEY_LOAD_ERROR:case m.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(k.PlaylistLevelType.MAIN,u);break;case m.ErrorDetails.LEVEL_LOAD_ERROR:case m.ErrorDetails.LEVEL_LOAD_TIMEOUT:this.state!==D.State.ERROR&&(u.fatal?(this.warn(""+u.details),this.state=D.State.ERROR):!u.levelRetry&&this.state===D.State.WAITING_LEVEL&&(this.state=D.State.IDLE));break;case m.ErrorDetails.BUFFER_FULL_ERROR:if(u.parent==="main"&&(this.state===D.State.PARSING||this.state===D.State.PARSED)){var t=!0,l=this.getFwdBufferInfo(this.media,k.PlaylistLevelType.MAIN);l&&l.len>.5&&(t=!this.reduceMaxBufferLength(l.len)),t&&(this.warn("buffer full error also media.currentTime is not buffered, flush main"),this.immediateLevelSwitch()),this.resetLoadingState()}break}},s.checkBuffer=function(){var e=this.media,u=this.gapController;if(!(!e||!u||!e.readyState)){if(this.loadedmetadata||!_.BufferHelper.getBuffered(e).length){var t=this.state!==D.State.IDLE?this.fragCurrent:null;u.poll(this.lastCurrentTime,t)}this.lastCurrentTime=e.currentTime}},s.onFragLoadEmergencyAborted=function(){this.state=D.State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()},s.onBufferFlushed=function(e,u){var t=u.type;if(t!==A.ElementaryStreamTypes.AUDIO||this.audioOnly&&!this.altAudio){var l=(t===A.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(l,t,k.PlaylistLevelType.MAIN)}},s.onLevelsUpdated=function(e,u){this.levels=u.levels},s.swapAudioCodec=function(){this.audioCodecSwap=!this.audioCodecSwap},s.seekToStartPos=function(){var e=this.media;if(e){var u=e.currentTime,t=this.startPosition;if(t>=0&&u<t){if(e.seeking){this.log("could not seek to "+t+", already seeking at "+u);return}var l=_.BufferHelper.getBuffered(e),p=l.length?l.start(0):0,c=p-t;c>0&&(c<this.config.maxBufferHole||c<this.config.maxFragLookUpTolerance)&&(this.log("adjusting start position by "+c+" to match buffer start"),t+=c,this.startPosition=t),this.log("seek to target start position "+t+" from current time "+u),e.currentTime=t}}},s._getAudioCodec=function(e){var u=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&u&&(this.log("Swapping audio codec"),u.indexOf("mp4a.40.5")!==-1?u="mp4a.40.2":u="mp4a.40.5"),u},s._loadBitrateTestFrag=function(e,u){var t=this;e.bitrateTest=!0,this._doFragLoad(e,u).then(function(l){var p=t.hls;if(!(!l||t.fragContextChanged(e))){t.fragLoadError=0,t.state=D.State.IDLE,t.startFragRequested=!1,t.bitrateTest=!1;var c=e.stats;c.parsing.start=c.parsing.end=c.buffering.start=c.buffering.end=self.performance.now(),p.trigger(I.Events.FRAG_LOADED,l),e.bitrateTest=!1}})},s._handleTransmuxComplete=function(e){var u,t="main",l=this.hls,p=e.remuxResult,c=e.chunkMeta,L=this.getCurrentContext(c);if(!L){this.warn("The loading context changed while buffering fragment "+c.sn+" of level "+c.level+". This chunk will not be buffered."),this.resetStartWhenNotLoaded(c.level);return}var R=L.frag,w=L.part,O=L.level,C=p.video,M=p.text,N=p.id3,U=p.initSegment,B=O.details,G=this.altAudio?void 0:p.audio;if(!this.fragContextChanged(R)){if(this.state=D.State.PARSING,U){U.tracks&&(this._bufferInitSegment(O,U.tracks,R,c),l.trigger(I.Events.FRAG_PARSING_INIT_SEGMENT,{frag:R,id:t,tracks:U.tracks}));var K=U.initPTS,Y=U.timescale;(0,F.isFiniteNumber)(K)&&(this.initPTS[R.cc]=K,l.trigger(I.Events.INIT_PTS_FOUND,{frag:R,id:t,initPTS:K,timescale:Y}))}if(C&&p.independent!==!1){if(B){var q=C.startPTS,H=C.endPTS,V=C.startDTS,z=C.endDTS;if(w)w.elementaryStreams[C.type]={startPTS:q,endPTS:H,startDTS:V,endDTS:z};else if(C.firstKeyFrame&&C.independent&&c.id===1&&(this.couldBacktrack=!0),C.dropped&&C.independent){var X=this.getMainFwdBufferInfo(),W=(X?X.end:this.getLoadPosition())+this.config.maxBufferHole,Q=C.firstKeyFramePTS?C.firstKeyFramePTS:q;if(W<Q-this.config.maxBufferHole){this.backtrack(R);return}R.setElementaryStreamInfo(C.type,R.start,H,R.start,z,!0)}R.setElementaryStreamInfo(C.type,q,H,V,z),this.backtrackFragment&&(this.backtrackFragment=R),this.bufferFragmentData(C,R,w,c)}}else if(p.independent===!1){this.backtrack(R);return}if(G){var J=G.startPTS,$=G.endPTS,ot=G.startDTS,it=G.endDTS;w&&(w.elementaryStreams[A.ElementaryStreamTypes.AUDIO]={startPTS:J,endPTS:$,startDTS:ot,endDTS:it}),R.setElementaryStreamInfo(A.ElementaryStreamTypes.AUDIO,J,$,ot,it),this.bufferFragmentData(G,R,w,c)}if(B&&N!==null&&N!==void 0&&(u=N.samples)!==null&&u!==void 0&&u.length){var Z={id:t,frag:R,details:B,samples:N.samples};l.trigger(I.Events.FRAG_PARSING_METADATA,Z)}if(B&&M){var tt={id:t,frag:R,details:B,samples:M.samples};l.trigger(I.Events.FRAG_PARSING_USERDATA,tt)}}},s._bufferInitSegment=function(e,u,t,l){var p=this;if(this.state===D.State.PARSING){this.audioOnly=!!u.audio&&!u.video,this.altAudio&&!this.audioOnly&&delete u.audio;var c=u.audio,L=u.video,R=u.audiovideo;if(c){var w=e.audioCodec,O=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(w&&(w.indexOf("mp4a.40.5")!==-1?w="mp4a.40.2":w="mp4a.40.5"),c.metadata.channelCount!==1&&O.indexOf("firefox")===-1&&(w="mp4a.40.5")),O.indexOf("android")!==-1&&c.container!=="audio/mpeg"&&(w="mp4a.40.2",this.log("Android: force audio codec to "+w)),e.audioCodec&&e.audioCodec!==w&&this.log('Swapping manifest audio codec "'+e.audioCodec+'" for "'+w+'"'),c.levelCodec=w,c.id="main",this.log("Init audio buffer, container:"+c.container+", codecs[selected/level/parsed]=["+(w||"")+"/"+(e.audioCodec||"")+"/"+c.codec+"]")}L&&(L.levelCodec=e.videoCodec,L.id="main",this.log("Init video buffer, container:"+L.container+", codecs[level/parsed]=["+(e.videoCodec||"")+"/"+L.codec+"]")),R&&this.log("Init audiovideo buffer, container:"+R.container+", codecs[level/parsed]=["+(e.attrs.CODECS||"")+"/"+R.codec+"]"),this.hls.trigger(I.Events.BUFFER_CODECS,u),Object.keys(u).forEach(function(C){var M=u[C],N=M.initSegment;N!=null&&N.byteLength&&p.hls.trigger(I.Events.BUFFER_APPENDING,{type:C,data:N,frag:t,part:null,chunkMeta:l,parent:t.type})}),this.tick()}},s.getMainFwdBufferInfo=function(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,k.PlaylistLevelType.MAIN)},s.backtrack=function(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=D.State.IDLE},s.checkFragmentChanged=function(){var e=this.media,u=null;if(e&&e.readyState>1&&e.seeking===!1){var t=e.currentTime;if(_.BufferHelper.isBuffered(e,t)?u=this.getAppendedFrag(t):_.BufferHelper.isBuffered(e,t+.1)&&(u=this.getAppendedFrag(t+.1)),u){this.backtrackFragment=null;var l=this.fragPlaying,p=u.level;(!l||u.sn!==l.sn||l.level!==p||u.urlId!==l.urlId)&&(this.fragPlaying=u,this.hls.trigger(I.Events.FRAG_CHANGED,{frag:u}),(!l||l.level!==p)&&this.hls.trigger(I.Events.LEVEL_SWITCHED,{level:p}))}}},r(f,[{key:"nextLevel",get:function(){var e=this.nextBufferedFrag;return e?e.level:-1}},{key:"currentFrag",get:function(){var e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}},{key:"currentProgramDateTime",get:function(){var e=this.media;if(e){var u=e.currentTime,t=this.currentFrag;if(t&&(0,F.isFiniteNumber)(u)&&(0,F.isFiniteNumber)(t.programDateTime)){var l=t.programDateTime+(u-t.start)*1e3;return new Date(l)}}return null}},{key:"currentLevel",get:function(){var e=this.currentFrag;return e?e.level:-1}},{key:"nextBufferedFrag",get:function(){var e=this.currentFrag;return e?this.followingBufferedFrag(e):null}},{key:"forceStartLoad",get:function(){return this._forceStartLoad}}]),f}(D.default)},"./src/controller/subtitle-stream-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{SubtitleStreamController:()=>i});var F=S("./src/events.ts"),D=S("./src/utils/buffer-helper.ts"),P=S("./src/controller/fragment-finders.ts"),I=S("./src/utils/discontinuities.ts"),_=S("./src/controller/level-helper.ts"),b=S("./src/controller/fragment-tracker.ts"),k=S("./src/controller/base-stream-controller.ts"),A=S("./src/types/loader.ts"),T=S("./src/types/level.ts");function E(o,a){for(var g=0;g<a.length;g++){var f=a[g];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(o,m(f.key),f)}}function h(o,a,g){return a&&E(o.prototype,a),Object.defineProperty(o,"prototype",{writable:!1}),o}function m(o){var a=v(o,"string");return typeof a=="symbol"?a:String(a)}function v(o,a){if(typeof o!="object"||o===null)return o;var g=o[Symbol.toPrimitive];if(g!==void 0){var f=g.call(o,a);if(typeof f!="object")return f;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}function r(o,a){o.prototype=Object.create(a.prototype),o.prototype.constructor=o,d(o,a)}function d(o,a){return d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(g,f){return g.__proto__=f,g},d(o,a)}var n=500,i=function(o){r(a,o);function a(f,s,e){var u;return u=o.call(this,f,s,e,"[subtitle-stream-controller]")||this,u.levels=[],u.currentTrackId=-1,u.tracksBuffered=[],u.mainDetails=null,u._registerListeners(),u}var g=a.prototype;return g.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},g._registerListeners=function(){var f=this.hls;f.on(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),f.on(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this),f.on(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),f.on(F.Events.LEVEL_LOADED,this.onLevelLoaded,this),f.on(F.Events.ERROR,this.onError,this),f.on(F.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),f.on(F.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),f.on(F.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),f.on(F.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),f.on(F.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),f.on(F.Events.FRAG_BUFFERED,this.onFragBuffered,this)},g._unregisterListeners=function(){var f=this.hls;f.off(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),f.off(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this),f.off(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),f.off(F.Events.LEVEL_LOADED,this.onLevelLoaded,this),f.off(F.Events.ERROR,this.onError,this),f.off(F.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),f.off(F.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),f.off(F.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),f.off(F.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),f.off(F.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),f.off(F.Events.FRAG_BUFFERED,this.onFragBuffered,this)},g.startLoad=function(f){this.stopLoad(),this.state=k.State.IDLE,this.setInterval(n),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=f,this.tick()},g.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()},g.onLevelLoaded=function(f,s){this.mainDetails=s.details},g.onSubtitleFragProcessed=function(f,s){var e=s.frag,u=s.success;if(this.fragPrevious=e,this.state=k.State.IDLE,!!u){var t=this.tracksBuffered[this.currentTrackId];if(t){for(var l,p=e.start,c=0;c<t.length;c++)if(p>=t[c].start&&p<=t[c].end){l=t[c];break}var L=e.start+e.duration;l?l.end=L:(l={start:p,end:L},t.push(l)),this.fragmentTracker.fragBuffered(e)}}},g.onBufferFlushing=function(f,s){var e=s.startOffset,u=s.endOffset;if(e===0&&u!==Number.POSITIVE_INFINITY){var t=this.currentTrackId,l=this.levels;if(!l.length||!l[t]||!l[t].details)return;var p=l[t].details,c=p.targetduration,L=u-c;if(L<=0)return;s.endOffsetSubtitles=Math.max(0,L),this.tracksBuffered.forEach(function(R){for(var w=0;w<R.length;){if(R[w].end<=L){R.shift();continue}else if(R[w].start<L)R[w].start=L;else break;w++}}),this.fragmentTracker.removeFragmentsInRange(e,L,A.PlaylistLevelType.SUBTITLE)}},g.onFragBuffered=function(f,s){if(!this.loadedmetadata&&s.frag.type===A.PlaylistLevelType.MAIN){var e;(e=this.media)!==null&&e!==void 0&&e.buffered.length&&(this.loadedmetadata=!0)}},g.onError=function(f,s){var e=s.frag;!e||e.type!==A.PlaylistLevelType.SUBTITLE||(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state=k.State.IDLE)},g.onSubtitleTracksUpdated=function(f,s){var e=this,u=s.subtitleTracks;this.tracksBuffered=[],this.levels=u.map(function(t){return new T.Level(t)}),this.fragmentTracker.removeAllFragments(),this.fragPrevious=null,this.levels.forEach(function(t){e.tracksBuffered[t.id]=[]}),this.mediaBuffer=null},g.onSubtitleTrackSwitch=function(f,s){if(this.currentTrackId=s.id,!this.levels.length||this.currentTrackId===-1){this.clearInterval();return}var e=this.levels[this.currentTrackId];e!=null&&e.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,e&&this.setInterval(n)},g.onSubtitleTrackLoaded=function(f,s){var e,u=s.details,t=s.id,l=this.currentTrackId,p=this.levels;if(p.length){var c=p[l];if(!(t>=p.length||t!==l||!c)){this.mediaBuffer=this.mediaBufferTimeRanges;var L=0;if(u.live||(e=c.details)!==null&&e!==void 0&&e.live){var R=this.mainDetails;if(u.deltaUpdateFailed||!R)return;var w=R.fragments[0];c.details?(L=this.alignPlaylists(u,c.details),L===0&&w&&(L=w.start,(0,_.addSliding)(u,L))):u.hasProgramDateTime&&R.hasProgramDateTime?((0,I.alignMediaPlaylistByPDT)(u,R),L=u.fragments[0].start):w&&(L=w.start,(0,_.addSliding)(u,L))}if(c.details=u,this.levelLastLoaded=t,!this.startFragRequested&&(this.mainDetails||!u.live)&&this.setStartPosition(c.details,L),this.tick(),u.live&&!this.fragCurrent&&this.media&&this.state===k.State.IDLE){var O=(0,P.findFragmentByPTS)(null,u.fragments,this.media.currentTime,0);O||(this.warn("Subtitle playlist not aligned with playback"),c.details=void 0)}}}},g._handleFragmentLoadComplete=function(f){var s=this,e=f.frag,u=f.payload,t=e.decryptdata,l=this.hls;if(!this.fragContextChanged(e)&&u&&u.byteLength>0&&t&&t.key&&t.iv&&t.method==="AES-128"){var p=performance.now();this.decrypter.decrypt(new Uint8Array(u),t.key.buffer,t.iv.buffer).then(function(c){var L=performance.now();l.trigger(F.Events.FRAG_DECRYPTED,{frag:e,payload:c,stats:{tstart:p,tdecrypt:L}})}).catch(function(c){s.warn(c.name+": "+c.message),s.state=k.State.IDLE})}},g.doTick=function(){if(!this.media){this.state=k.State.IDLE;return}if(this.state===k.State.IDLE){var f=this.currentTrackId,s=this.levels;if(!s.length||!s[f]||!s[f].details)return;var e=s[f].details,u=e.targetduration,t=this.config,l=this.getLoadPosition(),p=D.BufferHelper.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],l-u,t.maxBufferHole),c=p.end,L=p.len,R=this.getFwdBufferInfo(this.media,A.PlaylistLevelType.MAIN),w=this.getMaxBufferLength(R==null?void 0:R.len)+u;if(L>w)return;console.assert(e,"Subtitle track details are defined on idle subtitle stream controller tick");var O=e.fragments,C=O.length,M=e.edge,N=null,U=this.fragPrevious;if(c<M){var B=t.maxFragLookUpTolerance;N=(0,P.findFragmentByPTS)(U,O,Math.max(O[0].start,c),B),!N&&U&&U.start<O[0].start&&(N=O[0])}else N=O[C-1];if(!N)return;N=this.mapToInitFragWhenRequired(N),this.fragmentTracker.getState(N)===b.FragmentState.NOT_LOADED&&this.loadFragment(N,e,c)}},g.getMaxBufferLength=function(f){var s=o.prototype.getMaxBufferLength.call(this);return f?Math.max(s,f):s},g.loadFragment=function(f,s,e){this.fragCurrent=f,f.sn==="initSegment"?this._loadInitSegment(f,s):(this.startFragRequested=!0,o.prototype.loadFragment.call(this,f,s,e))},h(a,[{key:"mediaBufferTimeRanges",get:function(){return new y(this.tracksBuffered[this.currentTrackId]||[])}}]),a}(k.default),y=function(o){this.buffered=void 0;var a=function(g,f,s){if(f=f>>>0,f>s-1)throw new DOMException("Failed to execute '"+g+"' on 'TimeRanges': The index provided ("+f+") is greater than the maximum bound ("+s+")");return o[f][g]};this.buffered={get length(){return o.length},end:function(g){return a("end",g,o.length)},start:function(g){return a("start",g,o.length)}}}},"./src/controller/subtitle-track-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>v});var F=S("./src/events.ts"),D=S("./src/utils/texttrack-utils.ts"),P=S("./src/controller/base-playlist-controller.ts"),I=S("./src/types/loader.ts");function _(r,d){for(var n=0;n<d.length;n++){var i=d[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,k(i.key),i)}}function b(r,d,n){return d&&_(r.prototype,d),Object.defineProperty(r,"prototype",{writable:!1}),r}function k(r){var d=A(r,"string");return typeof d=="symbol"?d:String(d)}function A(r,d){if(typeof r!="object"||r===null)return r;var n=r[Symbol.toPrimitive];if(n!==void 0){var i=n.call(r,d);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(r)}function T(r,d){r.prototype=Object.create(d.prototype),r.prototype.constructor=r,E(r,d)}function E(r,d){return E=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,i){return n.__proto__=i,n},E(r,d)}var h=function(r){T(d,r);function d(i){var y;return y=r.call(this,i,"[subtitle-track-controller]")||this,y.media=null,y.tracks=[],y.groupId=null,y.tracksInGroup=[],y.trackId=-1,y.selectDefaultTrack=!0,y.queuedDefaultTrack=-1,y.trackChangeListener=function(){return y.onTextTracksChanged()},y.asyncPollTrackChange=function(){return y.pollTrackChange(0)},y.useTextTrackPolling=!1,y.subtitlePollingInterval=-1,y._subtitleDisplay=!0,y.registerListeners(),y}var n=d.prototype;return n.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,r.prototype.destroy.call(this)},n.registerListeners=function(){var i=this.hls;i.on(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),i.on(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this),i.on(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),i.on(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),i.on(F.Events.LEVEL_LOADING,this.onLevelLoading,this),i.on(F.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),i.on(F.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),i.on(F.Events.ERROR,this.onError,this)},n.unregisterListeners=function(){var i=this.hls;i.off(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),i.off(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this),i.off(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),i.off(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),i.off(F.Events.LEVEL_LOADING,this.onLevelLoading,this),i.off(F.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),i.off(F.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),i.off(F.Events.ERROR,this.onError,this)},n.onMediaAttached=function(i,y){this.media=y.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))},n.pollTrackChange=function(i){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,i)},n.onMediaDetaching=function(){if(this.media){self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId);var i=m(this.media.textTracks);i.forEach(function(y){(0,D.clearCurrentCues)(y)}),this.subtitleTrack=-1,this.media=null}},n.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0},n.onManifestParsed=function(i,y){this.tracks=y.subtitleTracks},n.onSubtitleTrackLoaded=function(i,y){var o=y.id,a=y.details,g=this.trackId,f=this.tracksInGroup[g];if(!f){this.warn("Invalid subtitle track id "+o);return}var s=f.details;f.details=y.details,this.log("subtitle track "+o+" loaded ["+a.startSN+"-"+a.endSN+"]"),o===this.trackId&&(this.retryCount=0,this.playlistLoaded(o,y,s))},n.onLevelLoading=function(i,y){this.switchLevel(y.level)},n.onLevelSwitching=function(i,y){this.switchLevel(y.level)},n.switchLevel=function(i){var y=this.hls.levels[i];if(y!=null&&y.textGroupIds){var o=y.textGroupIds[y.urlId];if(this.groupId!==o){var a=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0,g=this.tracks.filter(function(e){return!o||e.groupId===o});this.tracksInGroup=g;var f=this.findTrackId(a==null?void 0:a.name)||this.findTrackId();this.groupId=o;var s={subtitleTracks:g};this.log("Updating subtitle tracks, "+g.length+' track(s) found in "'+o+'" group-id'),this.hls.trigger(F.Events.SUBTITLE_TRACKS_UPDATED,s),f!==-1&&this.setSubtitleTrack(f,a)}}},n.findTrackId=function(i){for(var y=this.tracksInGroup,o=0;o<y.length;o++){var a=y[o];if((!this.selectDefaultTrack||a.default)&&(!i||i===a.name))return a.id}return-1},n.onError=function(i,y){r.prototype.onError.call(this,i,y),!(y.fatal||!y.context)&&y.context.type===I.PlaylistContextType.SUBTITLE_TRACK&&y.context.id===this.trackId&&y.context.groupId===this.groupId&&this.retryLoadingOrFail(y)},n.loadPlaylist=function(i){r.prototype.loadPlaylist.call(this);var y=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(y)){var o=y.id,a=y.groupId,g=y.url;if(i)try{g=i.addDirectives(g)}catch(f){this.warn("Could not construct new URL with HLS Delivery Directives: "+f)}this.log("Loading subtitle playlist for id "+o),this.hls.trigger(F.Events.SUBTITLE_TRACK_LOADING,{url:g,id:o,groupId:a,deliveryDirectives:i||null})}},n.toggleTrackModes=function(i){var y=this,o=this.media,a=this.trackId;if(o){var g=m(o.textTracks),f=g.filter(function(u){return u.groupId===y.groupId});if(i===-1)[].slice.call(g).forEach(function(u){u.mode="disabled"});else{var s=f[a];s&&(s.mode="disabled")}var e=f[i];e&&(e.mode=this.subtitleDisplay?"showing":"hidden")}},n.setSubtitleTrack=function(i,y){var o,a=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=i;return}if(this.trackId!==i&&this.toggleTrackModes(i),!(this.trackId===i&&(i===-1||(o=a[i])!==null&&o!==void 0&&o.details)||i<-1||i>=a.length)){this.clearTimer();var g=a[i];if(this.log("Switching to subtitle track "+i),this.trackId=i,g){var f=g.id,s=g.groupId,e=s===void 0?"":s,u=g.name,t=g.type,l=g.url;this.hls.trigger(F.Events.SUBTITLE_TRACK_SWITCH,{id:f,groupId:e,name:u,type:t,url:l});var p=this.switchParams(g.url,y==null?void 0:y.details);this.loadPlaylist(p)}else this.hls.trigger(F.Events.SUBTITLE_TRACK_SWITCH,{id:i})}},n.onTextTracksChanged=function(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!(!this.media||!this.hls.config.renderTextTracksNatively)){for(var i=-1,y=m(this.media.textTracks),o=0;o<y.length;o++)if(y[o].mode==="hidden")i=o;else if(y[o].mode==="showing"){i=o;break}this.subtitleTrack!==i&&(this.subtitleTrack=i)}},b(d,[{key:"subtitleDisplay",get:function(){return this._subtitleDisplay},set:function(i){this._subtitleDisplay=i,this.trackId>-1&&this.toggleTrackModes(this.trackId)}},{key:"subtitleTracks",get:function(){return this.tracksInGroup}},{key:"subtitleTrack",get:function(){return this.trackId},set:function(i){this.selectDefaultTrack=!1;var y=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(i,y)}}]),d}(P.default);function m(r){for(var d=[],n=0;n<r.length;n++){var i=r[n];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&d.push(r[n])}return d}const v=h},"./src/controller/timeline-controller.ts":(j,x,S)=>{S.r(x),S.d(x,{TimelineController:()=>h});var F=S("./src/polyfills/number.ts"),D=S("./src/events.ts"),P=S("./src/utils/cea-608-parser.ts"),I=S("./src/utils/output-filter.ts"),_=S("./src/utils/webvtt-parser.ts"),b=S("./src/utils/texttrack-utils.ts"),k=S("./src/utils/imsc1-ttml-parser.ts"),A=S("./src/utils/mp4-tools.ts"),T=S("./src/types/loader.ts"),E=S("./src/utils/logger.ts"),h=function(){function d(i){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.timescale=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=r(),this.captionsProperties=void 0,this.hls=i,this.config=i.config,this.Cues=i.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){var y=new I.default(this,"textTrack1"),o=new I.default(this,"textTrack2"),a=new I.default(this,"textTrack3"),g=new I.default(this,"textTrack4");this.cea608Parser1=new P.default(1,y,o),this.cea608Parser2=new P.default(3,a,g)}i.on(D.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),i.on(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),i.on(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),i.on(D.Events.MANIFEST_LOADED,this.onManifestLoaded,this),i.on(D.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),i.on(D.Events.FRAG_LOADING,this.onFragLoading,this),i.on(D.Events.FRAG_LOADED,this.onFragLoaded,this),i.on(D.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),i.on(D.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),i.on(D.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),i.on(D.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),i.on(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)}var n=d.prototype;return n.destroy=function(){var i=this.hls;i.off(D.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),i.off(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),i.off(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),i.off(D.Events.MANIFEST_LOADED,this.onManifestLoaded,this),i.off(D.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),i.off(D.Events.FRAG_LOADING,this.onFragLoading,this),i.off(D.Events.FRAG_LOADED,this.onFragLoaded,this),i.off(D.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),i.off(D.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),i.off(D.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),i.off(D.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),i.off(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null},n.addCues=function(i,y,o,a,g){for(var f=!1,s=g.length;s--;){var e=g[s],u=v(e[0],e[1],y,o);if(u>=0&&(e[0]=Math.min(e[0],y),e[1]=Math.max(e[1],o),f=!0,u/(o-y)>.5))return}if(f||g.push([y,o]),this.config.renderTextTracksNatively){var t=this.captionsTracks[i];this.Cues.newCue(t,y,o,a)}else{var l=this.Cues.newCue(null,y,o,a);this.hls.trigger(D.Events.CUES_PARSED,{type:"captions",cues:l,track:i})}},n.onInitPtsFound=function(i,y){var o=this,a=y.frag,g=y.id,f=y.initPTS,s=y.timescale,e=this.unparsedVttFrags;g==="main"&&(this.initPTS[a.cc]=f,this.timescale[a.cc]=s),e.length&&(this.unparsedVttFrags=[],e.forEach(function(u){o.onFragLoaded(D.Events.FRAG_LOADED,u)}))},n.getExistingTrack=function(i){var y=this.media;if(y)for(var o=0;o<y.textTracks.length;o++){var a=y.textTracks[o];if(a[i])return a}return null},n.createCaptionsTrack=function(i){this.config.renderTextTracksNatively?this.createNativeTrack(i):this.createNonNativeTrack(i)},n.createNativeTrack=function(i){if(!this.captionsTracks[i]){var y=this.captionsProperties,o=this.captionsTracks,a=this.media,g=y[i],f=g.label,s=g.languageCode,e=this.getExistingTrack(i);if(e)o[i]=e,(0,b.clearCurrentCues)(o[i]),(0,b.sendAddTrackEvent)(o[i],a);else{var u=this.createTextTrack("captions",f,s);u&&(u[i]=!0,o[i]=u)}}},n.createNonNativeTrack=function(i){if(!this.nonNativeCaptionsTracks[i]){var y=this.captionsProperties[i];if(y){var o=y.label,a={_id:i,label:o,kind:"captions",default:y.media?!!y.media.default:!1,closedCaptions:y.media};this.nonNativeCaptionsTracks[i]=a,this.hls.trigger(D.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[a]})}}},n.createTextTrack=function(i,y,o){var a=this.media;if(a)return a.addTextTrack(i,y,o)},n.onMediaAttaching=function(i,y){this.media=y.media,this._cleanTracks()},n.onMediaDetaching=function(){var i=this.captionsTracks;Object.keys(i).forEach(function(y){(0,b.clearCurrentCues)(i[y]),delete i[y]}),this.nonNativeCaptionsTracks={}},n.onManifestLoading=function(){this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=r(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.timescale=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())},n._cleanTracks=function(){var i=this.media;if(i){var y=i.textTracks;if(y)for(var o=0;o<y.length;o++)(0,b.clearCurrentCues)(y[o])}},n.onSubtitleTracksUpdated=function(i,y){var o=this;this.textTracks=[];var a=y.subtitleTracks||[],g=a.some(function(u){return u.textCodec===k.IMSC1_CODEC});if(this.config.enableWebVTT||g&&this.config.enableIMSC1){var f=this.tracks&&a&&this.tracks.length===a.length;if(this.tracks=a||[],this.config.renderTextTracksNatively){var s=this.media?this.media.textTracks:[];this.tracks.forEach(function(u,t){var l;if(t<s.length){for(var p=null,c=0;c<s.length;c++)if(m(s[c],u)){p=s[c];break}p&&(l=p)}if(l)(0,b.clearCurrentCues)(l);else{var L=o._captionsOrSubtitlesFromCharacteristics(u);l=o.createTextTrack(L,u.name,u.lang),l&&(l.mode="disabled")}l&&(l.groupId=u.groupId,o.textTracks.push(l))})}else if(!f&&this.tracks&&this.tracks.length){var e=this.tracks.map(function(u){return{label:u.name,kind:u.type.toLowerCase(),default:u.default,subtitleTrack:u}});this.hls.trigger(D.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:e})}}},n._captionsOrSubtitlesFromCharacteristics=function(i){var y;if((y=i.attrs)!==null&&y!==void 0&&y.CHARACTERISTICS){var o=/transcribes-spoken-dialog/gi.test(i.attrs.CHARACTERISTICS),a=/describes-music-and-sound/gi.test(i.attrs.CHARACTERISTICS);if(o&&a)return"captions"}return"subtitles"},n.onManifestLoaded=function(i,y){var o=this;this.config.enableCEA708Captions&&y.captions&&y.captions.forEach(function(a){var g=/(?:CC|SERVICE)([1-4])/.exec(a.instreamId);if(g){var f="textTrack"+g[1],s=o.captionsProperties[f];s&&(s.label=a.name,a.lang&&(s.languageCode=a.lang),s.media=a)}})},n.closedCaptionsForLevel=function(i){var y=this.hls.levels[i.level];return y==null?void 0:y.attrs["CLOSED-CAPTIONS"]},n.onFragLoading=function(i,y){var o=this.cea608Parser1,a=this.cea608Parser2,g=this.lastSn,f=this.lastPartIndex;if(!(!this.enabled||!(o&&a))&&y.frag.type===T.PlaylistLevelType.MAIN){var s,e,u=y.frag.sn,t=(s=y==null||(e=y.part)===null||e===void 0?void 0:e.index)!=null?s:-1;u===g+1||u===g&&t===f+1||(o.reset(),a.reset()),this.lastSn=u,this.lastPartIndex=t}},n.onFragLoaded=function(i,y){var o=y.frag,a=y.payload,g=this.initPTS,f=this.unparsedVttFrags;if(o.type===T.PlaylistLevelType.SUBTITLE)if(a.byteLength){if(!(0,F.isFiniteNumber)(g[o.cc])){f.push(y),g.length&&this.hls.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:o,error:new Error("Missing initial subtitle PTS")});return}var s=o.decryptdata,e="stats"in y;if(s==null||!s.encrypted||e){var u=this.tracks[o.level],t=this.vttCCs;t[o.cc]||(t[o.cc]={start:o.start,prevCC:this.prevCC,new:!0},this.prevCC=o.cc),u&&u.textCodec===k.IMSC1_CODEC?this._parseIMSC1(o,a):this._parseVTTs(o,a,t)}}else this.hls.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:o,error:new Error("Empty subtitle payload")})},n._parseIMSC1=function(i,y){var o=this,a=this.hls;(0,k.parseIMSC1)(y,this.initPTS[i.cc],this.timescale[i.cc],function(g){o._appendCues(g,i.level),a.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},function(g){E.logger.log("Failed to parse IMSC1: "+g),a.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:g})})},n._parseVTTs=function(i,y,o){var a,g=this,f=this.hls,s=(a=i.initSegment)!==null&&a!==void 0&&a.data?(0,A.appendUint8Array)(i.initSegment.data,new Uint8Array(y)):y;(0,_.parseWebVTT)(s,this.initPTS[i.cc],this.timescale[i.cc],o,i.cc,i.start,function(e){g._appendCues(e,i.level),f.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},function(e){g._fallbackToIMSC1(i,y),E.logger.log("Failed to parse VTT cue: "+e),f.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:e})})},n._fallbackToIMSC1=function(i,y){var o=this,a=this.tracks[i.level];a.textCodec||(0,k.parseIMSC1)(y,this.initPTS[i.cc],this.timescale[i.cc],function(){a.textCodec=k.IMSC1_CODEC,o._parseIMSC1(i,y)},function(){a.textCodec="wvtt"})},n._appendCues=function(i,y){var o=this.hls;if(this.config.renderTextTracksNatively){var a=this.textTracks[y];if(!a||a.mode==="disabled")return;i.forEach(function(s){return(0,b.addCueToTrack)(a,s)})}else{var g=this.tracks[y];if(!g)return;var f=g.default?"default":"subtitles"+y;o.trigger(D.Events.CUES_PARSED,{type:"subtitles",cues:i,track:f})}},n.onFragDecrypted=function(i,y){var o=y.frag;if(o.type===T.PlaylistLevelType.SUBTITLE){if(!(0,F.isFiniteNumber)(this.initPTS[o.cc])){this.unparsedVttFrags.push(y);return}this.onFragLoaded(D.Events.FRAG_LOADED,y)}},n.onSubtitleTracksCleared=function(){this.tracks=[],this.captionsTracks={}},n.onFragParsingUserdata=function(i,y){var o=this.cea608Parser1,a=this.cea608Parser2;if(!(!this.enabled||!(o&&a))){var g=y.frag,f=y.samples;if(!(g.type===T.PlaylistLevelType.MAIN&&this.closedCaptionsForLevel(g)==="NONE"))for(var s=0;s<f.length;s++){var e=f[s].bytes;if(e){var u=this.extractCea608Data(e);o.addData(f[s].pts,u[0]),a.addData(f[s].pts,u[1])}}}},n.onBufferFlushing=function(i,y){var o=y.startOffset,a=y.endOffset,g=y.endOffsetSubtitles,f=y.type,s=this.media;if(!(!s||s.currentTime<a)){if(!f||f==="video"){var e=this.captionsTracks;Object.keys(e).forEach(function(t){return(0,b.removeCuesInRange)(e[t],o,a)})}if(this.config.renderTextTracksNatively&&o===0&&g!==void 0){var u=this.textTracks;Object.keys(u).forEach(function(t){return(0,b.removeCuesInRange)(u[t],o,g)})}}},n.extractCea608Data=function(i){for(var y=[[],[]],o=i[0]&31,a=2,g=0;g<o;g++){var f=i[a++],s=127&i[a++],e=127&i[a++];if(!(s===0&&e===0)){var u=(4&f)!==0;if(u){var t=3&f;(t===0||t===1)&&(y[t].push(s),y[t].push(e))}}}return y},d}();function m(d,n){return d&&d.label===n.name&&!(d.textTrack1||d.textTrack2)}function v(d,n,i,y){return Math.min(n,y)-Math.max(d,i)}function r(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}},"./src/crypt/aes-crypto.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>F});var F=function(){function D(I,_){this.subtle=void 0,this.aesIV=void 0,this.subtle=I,this.aesIV=_}var P=D.prototype;return P.decrypt=function(I,_){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},_,I)},D}()},"./src/crypt/aes-decryptor.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>P,removePadding:()=>D});var F=S("./src/utils/typed-array.ts");function D(I){var _=I.byteLength,b=_&&new DataView(I.buffer).getUint8(_-1);return b?(0,F.sliceUint8)(I,0,_-b):I}var P=function(){function I(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var _=I.prototype;return _.uint8ArrayToUint32Array_=function(b){for(var k=new DataView(b),A=new Uint32Array(4),T=0;T<4;T++)A[T]=k.getUint32(T*4);return A},_.initTable=function(){var b=this.sBox,k=this.invSBox,A=this.subMix,T=A[0],E=A[1],h=A[2],m=A[3],v=this.invSubMix,r=v[0],d=v[1],n=v[2],i=v[3],y=new Uint32Array(256),o=0,a=0,g=0;for(g=0;g<256;g++)g<128?y[g]=g<<1:y[g]=g<<1^283;for(g=0;g<256;g++){var f=a^a<<1^a<<2^a<<3^a<<4;f=f>>>8^f&255^99,b[o]=f,k[f]=o;var s=y[o],e=y[s],u=y[e],t=y[f]*257^f*16843008;T[o]=t<<24|t>>>8,E[o]=t<<16|t>>>16,h[o]=t<<8|t>>>24,m[o]=t,t=u*16843009^e*65537^s*257^o*16843008,r[f]=t<<24|t>>>8,d[f]=t<<16|t>>>16,n[f]=t<<8|t>>>24,i[f]=t,o?(o=s^y[y[y[u^s]]],a^=y[y[a]]):o=a=1}},_.expandKey=function(b){for(var k=this.uint8ArrayToUint32Array_(b),A=!0,T=0;T<k.length&&A;)A=k[T]===this.key[T],T++;if(!A){this.key=k;var E=this.keySize=k.length;if(E!==4&&E!==6&&E!==8)throw new Error("Invalid aes key size="+E);var h=this.ksRows=(E+6+1)*4,m,v,r=this.keySchedule=new Uint32Array(h),d=this.invKeySchedule=new Uint32Array(h),n=this.sBox,i=this.rcon,y=this.invSubMix,o=y[0],a=y[1],g=y[2],f=y[3],s,e;for(m=0;m<h;m++){if(m<E){s=r[m]=k[m];continue}e=s,m%E===0?(e=e<<8|e>>>24,e=n[e>>>24]<<24|n[e>>>16&255]<<16|n[e>>>8&255]<<8|n[e&255],e^=i[m/E|0]<<24):E>6&&m%E===4&&(e=n[e>>>24]<<24|n[e>>>16&255]<<16|n[e>>>8&255]<<8|n[e&255]),r[m]=s=(r[m-E]^e)>>>0}for(v=0;v<h;v++)m=h-v,v&3?e=r[m]:e=r[m-4],v<4||m<=4?d[v]=e:d[v]=o[n[e>>>24]]^a[n[e>>>16&255]]^g[n[e>>>8&255]]^f[n[e&255]],d[v]=d[v]>>>0}},_.networkToHostOrderSwap=function(b){return b<<24|(b&65280)<<8|(b&16711680)>>8|b>>>24},_.decrypt=function(b,k,A){for(var T=this.keySize+6,E=this.invKeySchedule,h=this.invSBox,m=this.invSubMix,v=m[0],r=m[1],d=m[2],n=m[3],i=this.uint8ArrayToUint32Array_(A),y=i[0],o=i[1],a=i[2],g=i[3],f=new Int32Array(b),s=new Int32Array(f.length),e,u,t,l,p,c,L,R,w,O,C,M,N,U,B=this.networkToHostOrderSwap;k<f.length;){for(w=B(f[k]),O=B(f[k+1]),C=B(f[k+2]),M=B(f[k+3]),p=w^E[0],c=M^E[1],L=C^E[2],R=O^E[3],N=4,U=1;U<T;U++)e=v[p>>>24]^r[c>>16&255]^d[L>>8&255]^n[R&255]^E[N],u=v[c>>>24]^r[L>>16&255]^d[R>>8&255]^n[p&255]^E[N+1],t=v[L>>>24]^r[R>>16&255]^d[p>>8&255]^n[c&255]^E[N+2],l=v[R>>>24]^r[p>>16&255]^d[c>>8&255]^n[L&255]^E[N+3],p=e,c=u,L=t,R=l,N=N+4;e=h[p>>>24]<<24^h[c>>16&255]<<16^h[L>>8&255]<<8^h[R&255]^E[N],u=h[c>>>24]<<24^h[L>>16&255]<<16^h[R>>8&255]<<8^h[p&255]^E[N+1],t=h[L>>>24]<<24^h[R>>16&255]<<16^h[p>>8&255]<<8^h[c&255]^E[N+2],l=h[R>>>24]<<24^h[p>>16&255]<<16^h[c>>8&255]<<8^h[L&255]^E[N+3],s[k]=B(e^y),s[k+1]=B(l^o),s[k+2]=B(t^a),s[k+3]=B(u^g),y=w,o=O,a=C,g=M,k=k+4}return s.buffer},I}()},"./src/crypt/decrypter.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>A});var F=S("./src/crypt/aes-crypto.ts"),D=S("./src/crypt/fast-aes-key.ts"),P=S("./src/crypt/aes-decryptor.ts"),I=S("./src/utils/logger.ts"),_=S("./src/utils/mp4-tools.ts"),b=S("./src/utils/typed-array.ts"),k=16,A=function(){function T(h,m){var v=m===void 0?{}:m,r=v.removePKCS7Padding,d=r===void 0?!0:r;if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=h.enableSoftwareAES,this.removePKCS7Padding=d,d)try{var n=self.crypto;n&&(this.subtle=n.subtle||n.webkitSubtle)}catch{}this.subtle===null&&(this.useSoftware=!0)}var E=T.prototype;return E.destroy=function(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null},E.isSync=function(){return this.useSoftware},E.flush=function(){var h=this.currentResult,m=this.remainderData;if(!h||m)return this.reset(),null;var v=new Uint8Array(h);return this.reset(),this.removePKCS7Padding?(0,P.removePadding)(v):v},E.reset=function(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)},E.decrypt=function(h,m,v){var r=this;return this.useSoftware?new Promise(function(d,n){r.softwareDecrypt(new Uint8Array(h),m,v);var i=r.flush();i?d(i.buffer):n(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(h),m,v)},E.softwareDecrypt=function(h,m,v){var r=this.currentIV,d=this.currentResult,n=this.remainderData;this.logOnce("JS AES decrypt"),n&&(h=(0,_.appendUint8Array)(n,h),this.remainderData=null);var i=this.getValidChunk(h);if(!i.length)return null;r&&(v=r);var y=this.softwareDecrypter;y||(y=this.softwareDecrypter=new P.default),y.expandKey(m);var o=d;return this.currentResult=y.decrypt(i.buffer,0,v),this.currentIV=(0,b.sliceUint8)(i,-16).buffer,o||null},E.webCryptoDecrypt=function(h,m,v){var r=this,d=this.subtle;return(this.key!==m||!this.fastAesKey)&&(this.key=m,this.fastAesKey=new D.default(d,m)),this.fastAesKey.expandKey().then(function(n){if(!d)return Promise.reject(new Error("web crypto not initialized"));r.logOnce("WebCrypto AES decrypt");var i=new F.default(d,new Uint8Array(v));return i.decrypt(h.buffer,n)}).catch(function(n){return I.logger.warn("[decrypter]: WebCrypto Error, disable WebCrypto API, "+n.name+": "+n.message),r.onWebCryptoError(h,m,v)})},E.onWebCryptoError=function(h,m,v){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(h,m,v);var r=this.flush();if(r)return r.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")},E.getValidChunk=function(h){var m=h,v=h.length-h.length%k;return v!==h.length&&(m=(0,b.sliceUint8)(h,0,v),this.remainderData=(0,b.sliceUint8)(h,v)),m},E.logOnce=function(h){this.logEnabled&&(I.logger.log("[decrypter]: "+h),this.logEnabled=!1)},T}()},"./src/crypt/fast-aes-key.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>F});var F=function(){function D(I,_){this.subtle=void 0,this.key=void 0,this.subtle=I,this.key=_}var P=D.prototype;return P.expandKey=function(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])},D}()},"./src/demux/aacdemuxer.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>A});var F=S("./src/demux/base-audio-demuxer.ts"),D=S("./src/demux/adts.ts"),P=S("./src/utils/logger.ts"),I=S("./src/demux/id3.ts");function _(T,E){T.prototype=Object.create(E.prototype),T.prototype.constructor=T,b(T,E)}function b(T,E){return b=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(h,m){return h.__proto__=m,h},b(T,E)}var k=function(T){_(E,T);function E(m,v){var r;return r=T.call(this)||this,r.observer=void 0,r.config=void 0,r.observer=m,r.config=v,r}var h=E.prototype;return h.resetInitSegment=function(m,v,r,d){T.prototype.resetInitSegment.call(this,m,v,r,d),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:v,duration:d,inputTimeScale:9e4,dropped:0}},E.probe=function(m){if(!m)return!1;for(var v=I.getID3Data(m,0)||[],r=v.length,d=m.length;r<d;r++)if(D.probe(m,r))return P.logger.log("ADTS sync word found !"),!0;return!1},h.canParse=function(m,v){return D.canParse(m,v)},h.appendFrame=function(m,v,r){D.initTrackConfig(m,this.observer,v,r,m.manifestCodec);var d=D.appendFrame(m,v,r,this.basePTS,this.frameIndex);if(d&&d.missing===0)return d},E}(F.default);const A=k},"./src/demux/adts.ts":(j,x,S)=>{S.r(x),S.d(x,{appendFrame:()=>d,canGetFrameLength:()=>A,canParse:()=>E,getAudioConfig:()=>I,getFrameDuration:()=>v,getFullFrameLength:()=>k,getHeaderLength:()=>b,initTrackConfig:()=>m,isHeader:()=>T,isHeaderPattern:()=>_,parseFrameHeader:()=>r,probe:()=>h});var F=S("./src/utils/logger.ts"),D=S("./src/errors.ts"),P=S("./src/events.ts");function I(n,i,y,o){var a,g,f,s,e=navigator.userAgent.toLowerCase(),u=o,t=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];a=((i[y+2]&192)>>>6)+1;var l=(i[y+2]&60)>>>2;if(l>t.length-1){n.trigger(P.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+l});return}return f=(i[y+2]&1)<<2,f|=(i[y+3]&192)>>>6,F.logger.log("manifest codec:"+o+", ADTS type:"+a+", samplingIndex:"+l),/firefox/i.test(e)?l>=6?(a=5,s=new Array(4),g=l-3):(a=2,s=new Array(2),g=l):e.indexOf("android")!==-1?(a=2,s=new Array(2),g=l):(a=5,s=new Array(4),o&&(o.indexOf("mp4a.40.29")!==-1||o.indexOf("mp4a.40.5")!==-1)||!o&&l>=6?g=l-3:((o&&o.indexOf("mp4a.40.2")!==-1&&(l>=6&&f===1||/vivaldi/i.test(e))||!o&&f===1)&&(a=2,s=new Array(2)),g=l)),s[0]=a<<3,s[0]|=(l&14)>>1,s[1]|=(l&1)<<7,s[1]|=f<<3,a===5&&(s[1]|=(g&14)>>1,s[2]=(g&1)<<7,s[2]|=8,s[3]=0),{config:s,samplerate:t[l],channelCount:f,codec:"mp4a.40."+a,manifestCodec:u}}function _(n,i){return n[i]===255&&(n[i+1]&246)===240}function b(n,i){return n[i+1]&1?7:9}function k(n,i){return(n[i+3]&3)<<11|n[i+4]<<3|(n[i+5]&224)>>>5}function A(n,i){return i+5<n.length}function T(n,i){return i+1<n.length&&_(n,i)}function E(n,i){return A(n,i)&&_(n,i)&&k(n,i)<=n.length-i}function h(n,i){if(T(n,i)){var y=b(n,i);if(i+y>=n.length)return!1;var o=k(n,i);if(o<=y)return!1;var a=i+o;return a===n.length||T(n,a)}return!1}function m(n,i,y,o,a){if(!n.samplerate){var g=I(i,y,o,a);if(!g)return;n.config=g.config,n.samplerate=g.samplerate,n.channelCount=g.channelCount,n.codec=g.codec,n.manifestCodec=g.manifestCodec,F.logger.log("parsed codec:"+n.codec+", rate:"+g.samplerate+", channels:"+g.channelCount)}}function v(n){return 9216e4/n}function r(n,i){var y=b(n,i);if(i+y<=n.length){var o=k(n,i)-y;if(o>0)return{headerLength:y,frameLength:o}}}function d(n,i,y,o,a){var g=v(n.samplerate),f=o+a*g,s=r(i,y),e;if(s){var u=s.frameLength,t=s.headerLength,l=t+u,p=Math.max(0,y+l-i.length);p?(e=new Uint8Array(l-t),e.set(i.subarray(y+t,i.length),0)):e=i.subarray(y+t,y+l);var c={unit:e,pts:f};return p||n.samples.push(c),{sample:c,length:l,missing:p}}var L=i.length-y;e=new Uint8Array(L),e.set(i.subarray(y,i.length),0);var R={unit:e,pts:f};return{sample:R,length:L,missing:-1}}},"./src/demux/base-audio-demuxer.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>T,initPTSFn:()=>A});var F=S("./src/polyfills/number.ts"),D=S("./src/demux/id3.ts"),P=S("./src/types/demuxer.ts"),I=S("./src/demux/dummy-demuxed-track.ts"),_=S("./src/utils/mp4-tools.ts"),b=S("./src/utils/typed-array.ts"),k=function(){function E(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}var h=E.prototype;return h.resetInitSegment=function(m,v,r,d){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},h.resetTimeStamp=function(m){this.initPTS=m,this.resetContiguity()},h.resetContiguity=function(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0},h.canParse=function(m,v){return!1},h.appendFrame=function(m,v,r){},h.demux=function(m,v){this.cachedData&&(m=(0,_.appendUint8Array)(this.cachedData,m),this.cachedData=null);var r=D.getID3Data(m,0),d=r?r.length:0,n,i=this._audioTrack,y=this._id3Track,o=r?D.getTimeStamp(r):void 0,a=m.length;for((this.basePTS===null||this.frameIndex===0&&(0,F.isFiniteNumber)(o))&&(this.basePTS=A(o,v,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),r&&r.length>0&&y.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:P.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});d<a;){if(this.canParse(m,d)){var g=this.appendFrame(i,m,d);g?(this.frameIndex++,this.lastPTS=g.sample.pts,d+=g.length,n=d):d=a}else D.canParse(m,d)?(r=D.getID3Data(m,d),y.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:P.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY}),d+=r.length,n=d):d++;if(d===a&&n!==a){var f=(0,b.sliceUint8)(m,n);this.cachedData?this.cachedData=(0,_.appendUint8Array)(this.cachedData,f):this.cachedData=f}}return{audioTrack:i,videoTrack:(0,I.dummyTrack)(),id3Track:y,textTrack:(0,I.dummyTrack)()}},h.demuxSampleAes=function(m,v,r){return Promise.reject(new Error("["+this+"] This demuxer does not support Sample-AES decryption"))},h.flush=function(m){var v=this.cachedData;return v&&(this.cachedData=null,this.demux(v,0)),{audioTrack:this._audioTrack,videoTrack:(0,I.dummyTrack)(),id3Track:this._id3Track,textTrack:(0,I.dummyTrack)()}},h.destroy=function(){},E}(),A=function(E,h,m){return(0,F.isFiniteNumber)(E)?E*90:h*9e4+(m||0)};const T=k},"./src/demux/chunk-cache.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>F});var F=function(){function P(){this.chunks=[],this.dataLength=0}var I=P.prototype;return I.push=function(_){this.chunks.push(_),this.dataLength+=_.length},I.flush=function(){var _=this.chunks,b=this.dataLength,k;if(_.length)_.length===1?k=_[0]:k=D(_,b);else return new Uint8Array(0);return this.reset(),k},I.reset=function(){this.chunks.length=0,this.dataLength=0},P}();function D(P,I){for(var _=new Uint8Array(I),b=0,k=0;k<P.length;k++){var A=P[k];_.set(A,b),b+=A.length}return _}},"./src/demux/dummy-demuxed-track.ts":(j,x,S)=>{S.r(x),S.d(x,{dummyTrack:()=>F});function F(D,P){return D===void 0&&(D=""),P===void 0&&(P=9e4),{type:D,id:-1,pid:-1,inputTimeScale:P,sequenceNumber:-1,samples:[],dropped:0}}},"./src/demux/exp-golomb.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>P});var F=S("./src/utils/logger.ts"),D=function(){function I(b){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=b,this.bytesAvailable=b.byteLength,this.word=0,this.bitsAvailable=0}var _=I.prototype;return _.loadWord=function(){var b=this.data,k=this.bytesAvailable,A=b.byteLength-k,T=new Uint8Array(4),E=Math.min(4,k);if(E===0)throw new Error("no bytes available");T.set(b.subarray(A,A+E)),this.word=new DataView(T.buffer).getUint32(0),this.bitsAvailable=E*8,this.bytesAvailable-=E},_.skipBits=function(b){var k;b=Math.min(b,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>b?(this.word<<=b,this.bitsAvailable-=b):(b-=this.bitsAvailable,k=b>>3,b-=k<<3,this.bytesAvailable-=k,this.loadWord(),this.word<<=b,this.bitsAvailable-=b)},_.readBits=function(b){var k=Math.min(this.bitsAvailable,b),A=this.word>>>32-k;if(b>32&&F.logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=k,this.bitsAvailable>0)this.word<<=k;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return k=b-k,k>0&&this.bitsAvailable?A<<k|this.readBits(k):A},_.skipLZ=function(){var b;for(b=0;b<this.bitsAvailable;++b)if(this.word&2147483648>>>b)return this.word<<=b,this.bitsAvailable-=b,b;return this.loadWord(),b+this.skipLZ()},_.skipUEG=function(){this.skipBits(1+this.skipLZ())},_.skipEG=function(){this.skipBits(1+this.skipLZ())},_.readUEG=function(){var b=this.skipLZ();return this.readBits(b+1)-1},_.readEG=function(){var b=this.readUEG();return 1&b?1+b>>>1:-1*(b>>>1)},_.readBoolean=function(){return this.readBits(1)===1},_.readUByte=function(){return this.readBits(8)},_.readUShort=function(){return this.readBits(16)},_.readUInt=function(){return this.readBits(32)},_.skipScalingList=function(b){for(var k=8,A=8,T,E=0;E<b;E++)A!==0&&(T=this.readEG(),A=(k+T+256)%256),k=A===0?k:A},_.readSPS=function(){var b=0,k=0,A=0,T=0,E,h,m,v=this.readUByte.bind(this),r=this.readBits.bind(this),d=this.readUEG.bind(this),n=this.readBoolean.bind(this),i=this.skipBits.bind(this),y=this.skipEG.bind(this),o=this.skipUEG.bind(this),a=this.skipScalingList.bind(this);v();var g=v();if(r(5),i(3),v(),o(),g===100||g===110||g===122||g===244||g===44||g===83||g===86||g===118||g===128){var f=d();if(f===3&&i(1),o(),o(),i(1),n())for(h=f!==3?8:12,m=0;m<h;m++)n()&&(m<6?a(16):a(64))}o();var s=d();if(s===0)d();else if(s===1)for(i(1),y(),y(),E=d(),m=0;m<E;m++)y();o(),i(1);var e=d(),u=d(),t=r(1);t===0&&i(1),i(1),n()&&(b=d(),k=d(),A=d(),T=d());var l=[1,1];if(n()&&n()){var p=v();switch(p){case 1:l=[1,1];break;case 2:l=[12,11];break;case 3:l=[10,11];break;case 4:l=[16,11];break;case 5:l=[40,33];break;case 6:l=[24,11];break;case 7:l=[20,11];break;case 8:l=[32,11];break;case 9:l=[80,33];break;case 10:l=[18,11];break;case 11:l=[15,11];break;case 12:l=[64,33];break;case 13:l=[160,99];break;case 14:l=[4,3];break;case 15:l=[3,2];break;case 16:l=[2,1];break;case 255:{l=[v()<<8|v(),v()<<8|v()];break}}}return{width:Math.ceil((e+1)*16-b*2-k*2),height:(2-t)*(u+1)*16-(t?2:4)*(A+T),pixelRatio:l}},_.readSliceType=function(){return this.readUByte(),this.readUEG(),this.readUEG()},I}();const P=D},"./src/demux/id3.ts":(j,x,S)=>{S.r(x),S.d(x,{canParse:()=>_,decodeFrame:()=>E,getID3Data:()=>P,getID3Frames:()=>T,getTimeStamp:()=>b,isFooter:()=>D,isHeader:()=>F,isTimeStampFrame:()=>k,testables:()=>n,utf8ArrayToStr:()=>d});var F=function(o,a){return a+10<=o.length&&o[a]===73&&o[a+1]===68&&o[a+2]===51&&o[a+3]<255&&o[a+4]<255&&o[a+6]<128&&o[a+7]<128&&o[a+8]<128&&o[a+9]<128},D=function(o,a){return a+10<=o.length&&o[a]===51&&o[a+1]===68&&o[a+2]===73&&o[a+3]<255&&o[a+4]<255&&o[a+6]<128&&o[a+7]<128&&o[a+8]<128&&o[a+9]<128},P=function(o,a){for(var g=a,f=0;F(o,a);){f+=10;var s=I(o,a+6);f+=s,D(o,a+10)&&(f+=10),a+=f}if(f>0)return o.subarray(g,g+f)},I=function(o,a){var g=0;return g=(o[a]&127)<<21,g|=(o[a+1]&127)<<14,g|=(o[a+2]&127)<<7,g|=o[a+3]&127,g},_=function(o,a){return F(o,a)&&I(o,a+6)+10<=o.length-a},b=function(o){for(var a=T(o),g=0;g<a.length;g++){var f=a[g];if(k(f))return r(f)}},k=function(o){return o&&o.key==="PRIV"&&o.info==="com.apple.streaming.transportStreamTimestamp"},A=function(o){var a=String.fromCharCode(o[0],o[1],o[2],o[3]),g=I(o,4),f=10;return{type:a,size:g,data:o.subarray(f,f+g)}},T=function(o){for(var a=0,g=[];F(o,a);){var f=I(o,a+6);a+=10;for(var s=a+f;a+8<s;){var e=A(o.subarray(a)),u=E(e);u&&g.push(u),a+=e.size+10}D(o,a)&&(a+=10)}return g},E=function(o){return o.type==="PRIV"?h(o):o.type[0]==="W"?v(o):m(o)},h=function(o){if(!(o.size<2)){var a=d(o.data,!0),g=new Uint8Array(o.data.subarray(a.length+1));return{key:o.type,info:a,data:g.buffer}}},m=function(o){if(!(o.size<2)){if(o.type==="TXXX"){var a=1,g=d(o.data.subarray(a),!0);a+=g.length+1;var f=d(o.data.subarray(a));return{key:o.type,info:g,data:f}}var s=d(o.data.subarray(1));return{key:o.type,data:s}}},v=function(o){if(o.type==="WXXX"){if(o.size<2)return;var a=1,g=d(o.data.subarray(a),!0);a+=g.length+1;var f=d(o.data.subarray(a));return{key:o.type,info:g,data:f}}var s=d(o.data);return{key:o.type,data:s}},r=function(o){if(o.data.byteLength===8){var a=new Uint8Array(o.data),g=a[3]&1,f=(a[4]<<23)+(a[5]<<15)+(a[6]<<7)+a[7];return f/=45,g&&(f+=4772185884e-2),Math.round(f)}},d=function(o,a){a===void 0&&(a=!1);var g=y();if(g){var f=g.decode(o);if(a){var s=f.indexOf("\0");return s!==-1?f.substring(0,s):f}return f.replace(/\0/g,"")}for(var e=o.length,u,t,l,p="",c=0;c<e;){if(u=o[c++],u===0&&a)return p;if(!(u===0||u===3))switch(u>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:p+=String.fromCharCode(u);break;case 12:case 13:t=o[c++],p+=String.fromCharCode((u&31)<<6|t&63);break;case 14:t=o[c++],l=o[c++],p+=String.fromCharCode((u&15)<<12|(t&63)<<6|(l&63)<<0);break}}return p},n={decodeTextFrame:m},i;function y(){return!i&&typeof self.TextDecoder<"u"&&(i=new self.TextDecoder("utf-8")),i}},"./src/demux/mp3demuxer.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>A});var F=S("./src/demux/base-audio-demuxer.ts"),D=S("./src/demux/id3.ts"),P=S("./src/utils/logger.ts"),I=S("./src/demux/mpegaudio.ts");function _(T,E){T.prototype=Object.create(E.prototype),T.prototype.constructor=T,b(T,E)}function b(T,E){return b=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(h,m){return h.__proto__=m,h},b(T,E)}var k=function(T){_(E,T);function E(){return T.apply(this,arguments)||this}var h=E.prototype;return h.resetInitSegment=function(m,v,r,d){T.prototype.resetInitSegment.call(this,m,v,r,d),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:v,duration:d,inputTimeScale:9e4,dropped:0}},E.probe=function(m){if(!m)return!1;for(var v=D.getID3Data(m,0)||[],r=v.length,d=m.length;r<d;r++)if(I.probe(m,r))return P.logger.log("MPEG Audio sync word found !"),!0;return!1},h.canParse=function(m,v){return I.canParse(m,v)},h.appendFrame=function(m,v,r){if(this.basePTS!==null)return I.appendFrame(m,v,r,this.basePTS,this.frameIndex)},E}(F.default);const A=k},"./src/demux/mp4demuxer.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>k});var F=S("./src/polyfills/number.ts"),D=S("./src/types/demuxer.ts"),P=S("./src/utils/mp4-tools.ts"),I=S("./src/demux/dummy-demuxed-track.ts"),_=/\/emsg[-/]ID3/i,b=function(){function A(E,h){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=h}var T=A.prototype;return T.resetTimeStamp=function(){},T.resetInitSegment=function(E,h,m,v){var r=this.videoTrack=(0,I.dummyTrack)("video",1),d=this.audioTrack=(0,I.dummyTrack)("audio",1),n=this.txtTrack=(0,I.dummyTrack)("text",1);if(this.id3Track=(0,I.dummyTrack)("id3",1),this.timeOffset=0,!(!E||!E.byteLength)){var i=(0,P.parseInitSegment)(E);if(i.video){var y=i.video,o=y.id,a=y.timescale,g=y.codec;r.id=o,r.timescale=n.timescale=a,r.codec=g}if(i.audio){var f=i.audio,s=f.id,e=f.timescale,u=f.codec;d.id=s,d.timescale=e,d.codec=u}n.id=P.RemuxerTrackIdConfig.text,r.sampleDuration=0,r.duration=d.duration=v}},T.resetContiguity=function(){},A.probe=function(E){return E=E.length>16384?E.subarray(0,16384):E,(0,P.findBox)(E,["moof"]).length>0},T.demux=function(E,h){this.timeOffset=h;var m=E,v=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(m=(0,P.appendUint8Array)(this.remainderData,E));var d=(0,P.segmentValidRange)(m);this.remainderData=d.remainder,v.samples=d.valid||new Uint8Array}else v.samples=m;var n=this.extractID3Track(v,h);return r.samples=(0,P.parseSamples)(h,v),{videoTrack:v,audioTrack:this.audioTrack,id3Track:n,textTrack:this.txtTrack}},T.flush=function(){var E=this.timeOffset,h=this.videoTrack,m=this.txtTrack;h.samples=this.remainderData||new Uint8Array,this.remainderData=null;var v=this.extractID3Track(h,this.timeOffset);return m.samples=(0,P.parseSamples)(E,h),{videoTrack:h,audioTrack:(0,I.dummyTrack)(),id3Track:v,textTrack:(0,I.dummyTrack)()}},T.extractID3Track=function(E,h){var m=this.id3Track;if(E.samples.length){var v=(0,P.findBox)(E.samples,["emsg"]);v&&v.forEach(function(r){var d=(0,P.parseEmsg)(r);if(_.test(d.schemeIdUri)){var n=(0,F.isFiniteNumber)(d.presentationTime)?d.presentationTime/d.timeScale:h+d.presentationTimeDelta/d.timeScale,i=d.eventDuration===4294967295?Number.POSITIVE_INFINITY:d.eventDuration/d.timeScale;i<=.001&&(i=Number.POSITIVE_INFINITY);var y=d.payload;m.samples.push({data:y,len:y.byteLength,dts:n,pts:n,type:D.MetadataSchema.emsg,duration:i})}})}return m},T.demuxSampleAes=function(E,h,m){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))},T.destroy=function(){},A}();const k=b},"./src/demux/mpegaudio.ts":(j,x,S)=>{S.r(x),S.d(x,{appendFrame:()=>b,canParse:()=>E,isHeader:()=>T,isHeaderPattern:()=>A,parseHeader:()=>k,probe:()=>h});var F=null,D=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],P=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],I=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],_=[0,1,1,4];function b(m,v,r,d,n){if(!(r+24>v.length)){var i=k(v,r);if(i&&r+i.frameLength<=v.length){var y=i.samplesPerFrame*9e4/i.sampleRate,o=d+n*y,a={unit:v.subarray(r,r+i.frameLength),pts:o,dts:o};return m.config=[],m.channelCount=i.channelCount,m.samplerate=i.sampleRate,m.samples.push(a),{sample:a,length:i.frameLength,missing:0}}}}function k(m,v){var r=m[v+1]>>3&3,d=m[v+1]>>1&3,n=m[v+2]>>4&15,i=m[v+2]>>2&3;if(r!==1&&n!==0&&n!==15&&i!==3){var y=m[v+2]>>1&1,o=m[v+3]>>6,a=r===3?3-d:d===3?3:4,g=D[a*14+n-1]*1e3,f=r===3?0:r===2?1:2,s=P[f*3+i],e=o===3?1:2,u=I[r][d],t=_[d],l=u*8*t,p=Math.floor(u*g/s+y)*t;if(F===null){var c=navigator.userAgent||"",L=c.match(/Chrome\/(\d+)/i);F=L?parseInt(L[1]):0}var R=!!F&&F<=87;return R&&d===2&&g>=224e3&&o===0&&(m[v+3]=m[v+3]|128),{sampleRate:s,channelCount:e,frameLength:p,samplesPerFrame:l}}}function A(m,v){return m[v]===255&&(m[v+1]&224)===224&&(m[v+1]&6)!==0}function T(m,v){return v+1<m.length&&A(m,v)}function E(m,v){var r=4;return A(m,v)&&r<=m.length-v}function h(m,v){if(v+1<m.length&&A(m,v)){var r=4,d=k(m,v),n=r;d!=null&&d.frameLength&&(n=d.frameLength);var i=v+n;return i===m.length||T(m,i)}return!1}},"./src/demux/sample-aes.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>I});var F=S("./src/crypt/decrypter.ts"),D=S("./src/utils/mp4-tools.ts"),P=function(){function _(k,A,T){this.keyData=void 0,this.decrypter=void 0,this.keyData=T,this.decrypter=new F.default(A,{removePKCS7Padding:!1})}var b=_.prototype;return b.decryptBuffer=function(k){return this.decrypter.decrypt(k,this.keyData.key.buffer,this.keyData.iv.buffer)},b.decryptAacSample=function(k,A,T){var E=this,h=k[A].unit;if(!(h.length<=16)){var m=h.subarray(16,h.length-h.length%16),v=m.buffer.slice(m.byteOffset,m.byteOffset+m.length);this.decryptBuffer(v).then(function(r){var d=new Uint8Array(r);h.set(d,16),E.decrypter.isSync()||E.decryptAacSamples(k,A+1,T)})}},b.decryptAacSamples=function(k,A,T){for(;;A++){if(A>=k.length){T();return}if(!(k[A].unit.length<32)&&(this.decryptAacSample(k,A,T),!this.decrypter.isSync()))return}},b.getAvcEncryptedData=function(k){for(var A=Math.floor((k.length-48)/160)*16+16,T=new Int8Array(A),E=0,h=32;h<k.length-16;h+=160,E+=16)T.set(k.subarray(h,h+16),E);return T},b.getAvcDecryptedUnit=function(k,A){for(var T=new Uint8Array(A),E=0,h=32;h<k.length-16;h+=160,E+=16)k.set(T.subarray(E,E+16),h);return k},b.decryptAvcSample=function(k,A,T,E,h){var m=this,v=(0,D.discardEPB)(h.data),r=this.getAvcEncryptedData(v);this.decryptBuffer(r.buffer).then(function(d){h.data=m.getAvcDecryptedUnit(v,d),m.decrypter.isSync()||m.decryptAvcSamples(k,A,T+1,E)})},b.decryptAvcSamples=function(k,A,T,E){if(k instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;A++,T=0){if(A>=k.length){E();return}for(var h=k[A].units;!(T>=h.length);T++){var m=h[T];if(!(m.data.length<=48||m.type!==1&&m.type!==5)&&(this.decryptAvcSample(k,A,T,E,m),!this.decrypter.isSync()))return}}},_}();const I=P},"./src/demux/transmuxer-interface.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>T});var F=S("./src/demux/webworkify-webpack.js"),D=S("./src/events.ts"),P=S("./src/demux/transmuxer.ts"),I=S("./src/utils/logger.ts"),_=S("./src/errors.ts"),b=S("./src/utils/mediasource-helper.ts"),k=S("./node_modules/eventemitter3/index.js"),A=(0,b.getMediaSource)()||{isTypeSupported:function(){return!1}},T=function(){function E(m,v,r,d){var n=this;this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.worker=void 0,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;var i=m.config;this.hls=m,this.id=v,this.useWorker=!!i.enableWorker,this.onTransmuxComplete=r,this.onFlush=d;var y=function(f,s){s=s||{},s.frag=n.frag,s.id=n.id,n.hls.trigger(f,s)};this.observer=new k.EventEmitter,this.observer.on(D.Events.FRAG_DECRYPTED,y),this.observer.on(D.Events.ERROR,y);var o={mp4:A.isTypeSupported("video/mp4"),mpeg:A.isTypeSupported("audio/mpeg"),mp3:A.isTypeSupported('audio/mp4; codecs="mp3"')},a=navigator.vendor;if(this.useWorker&&typeof Worker<"u"){I.logger.log("demuxing in webworker");var g;try{g=this.worker=(0,F.default)("./src/demux/transmuxer-worker.ts"),this.onwmsg=this.onWorkerMessage.bind(this),g.addEventListener("message",this.onwmsg),g.onerror=function(f){n.useWorker=!1,I.logger.warn("Exception in webworker, fallback to inline"),n.hls.trigger(D.Events.ERROR,{type:_.ErrorTypes.OTHER_ERROR,details:_.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:new Error(f.message+"  ("+f.filename+":"+f.lineno+")")})},g.postMessage({cmd:"init",typeSupported:o,vendor:a,id:v,config:JSON.stringify(i)})}catch(f){I.logger.warn("Error in worker:",f),I.logger.error("Error while initializing DemuxerWorker, fallback to inline"),g&&self.URL.revokeObjectURL(g.objectURL),this.transmuxer=new P.default(this.observer,o,i,a,v),this.worker=null}}else this.transmuxer=new P.default(this.observer,o,i,a,v)}var h=E.prototype;return h.destroy=function(){var m=this.worker;if(m)m.removeEventListener("message",this.onwmsg),m.terminate(),this.worker=null,this.onwmsg=void 0;else{var v=this.transmuxer;v&&(v.destroy(),this.transmuxer=null)}var r=this.observer;r&&r.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null},h.push=function(m,v,r,d,n,i,y,o,a,g){var f,s,e=this;a.transmuxing.start=self.performance.now();var u=this.transmuxer,t=this.worker,l=i?i.start:n.start,p=n.decryptdata,c=this.frag,L=!(c&&n.cc===c.cc),R=!(c&&a.level===c.level),w=c?a.sn-c.sn:-1,O=this.part?a.part-this.part.index:-1,C=w===0&&a.id>1&&a.id===(c==null?void 0:c.stats.chunkCount),M=!R&&(w===1||w===0&&(O===1||C&&O<=0)),N=self.performance.now();(R||w||n.stats.parsing.start===0)&&(n.stats.parsing.start=N),i&&(O||!M)&&(i.stats.parsing.start=N);var U=!(c&&((f=n.initSegment)===null||f===void 0?void 0:f.url)===((s=c.initSegment)===null||s===void 0?void 0:s.url)),B=new P.TransmuxState(L,M,o,R,l,U);if(!M||L||U){I.logger.log("[transmuxer-interface, "+n.type+"]: Starting new transmux session for sn: "+a.sn+" p: "+a.part+" level: "+a.level+" id: "+a.id+`
        discontinuity: `+L+`
        trackSwitch: `+R+`
        contiguous: `+M+`
        accurateTimeOffset: `+o+`
        timeOffset: `+l+`
        initSegmentChange: `+U);var G=new P.TransmuxConfig(r,d,v,y,g);this.configureTransmuxer(G)}if(this.frag=n,this.part=i,t)t.postMessage({cmd:"demux",data:m,decryptdata:p,chunkMeta:a,state:B},m instanceof ArrayBuffer?[m]:[]);else if(u){var K=u.push(m,p,a,B);(0,P.isPromise)(K)?(u.async=!0,K.then(function(Y){e.handleTransmuxComplete(Y)}).catch(function(Y){e.transmuxerError(Y,a,"transmuxer-interface push error")})):(u.async=!1,this.handleTransmuxComplete(K))}},h.flush=function(m){var v=this;m.transmuxing.start=self.performance.now();var r=this.transmuxer,d=this.worker;if(d)d.postMessage({cmd:"flush",chunkMeta:m});else if(r){var n=r.flush(m),i=(0,P.isPromise)(n);i||r.async?((0,P.isPromise)(n)||(n=Promise.resolve(n)),n.then(function(y){v.handleFlushResult(y,m)}).catch(function(y){v.transmuxerError(y,m,"transmuxer-interface flush error")})):this.handleFlushResult(n,m)}},h.transmuxerError=function(m,v,r){this.hls&&this.hls.trigger(D.Events.ERROR,{type:_.ErrorTypes.MEDIA_ERROR,details:_.ErrorDetails.FRAG_PARSING_ERROR,chunkMeta:v,fatal:!1,error:m,err:m,reason:r})},h.handleFlushResult=function(m,v){var r=this;m.forEach(function(d){r.handleTransmuxComplete(d)}),this.onFlush(v)},h.onWorkerMessage=function(m){var v=m.data,r=this.hls;switch(v.event){case"init":{self.URL.revokeObjectURL(this.worker.objectURL);break}case"transmuxComplete":{this.handleTransmuxComplete(v.data);break}case"flush":{this.onFlush(v.data);break}case"workerLog":I.logger[v.data.logType]&&I.logger[v.data.logType](v.data.message);break;default:{v.data=v.data||{},v.data.frag=this.frag,v.data.id=this.id,r.trigger(v.event,v.data);break}}},h.configureTransmuxer=function(m){var v=this.worker,r=this.transmuxer;v?v.postMessage({cmd:"configure",config:m}):r&&r.configure(m)},h.handleTransmuxComplete=function(m){m.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(m)},E}()},"./src/demux/transmuxer-worker.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>b});var F=S("./src/demux/transmuxer.ts"),D=S("./src/events.ts"),P=S("./src/utils/logger.ts"),I=S("./node_modules/eventemitter3/index.js"),_=S("./src/errors.ts");function b(h){var m=new I.EventEmitter,v=function(d,n){h.postMessage({event:d,data:n})};m.on(D.Events.FRAG_DECRYPTED,v),m.on(D.Events.ERROR,v);var r=function(){var d=function(i){var y=function(o){v("workerLog",{logType:i,message:o})};P.logger[i]=y};for(var n in P.logger)d(n)};h.addEventListener("message",function(d){var n=d.data;switch(n.cmd){case"init":{var i=JSON.parse(n.config);h.transmuxer=new F.default(m,n.typeSupported,i,n.vendor,n.id),(0,P.enableLogs)(i.debug,n.id),r(),v("init",null);break}case"configure":{h.transmuxer.configure(n.config);break}case"demux":{var y=h.transmuxer.push(n.data,n.decryptdata,n.chunkMeta,n.state);(0,F.isPromise)(y)?(h.transmuxer.async=!0,y.then(function(f){k(h,f)}).catch(function(f){v(D.Events.ERROR,{type:_.ErrorTypes.MEDIA_ERROR,details:_.ErrorDetails.FRAG_PARSING_ERROR,chunkMeta:n.chunkMeta,fatal:!1,error:f,err:f,reason:"transmuxer-worker push error"})})):(h.transmuxer.async=!1,k(h,y));break}case"flush":{var o=n.chunkMeta,a=h.transmuxer.flush(o),g=(0,F.isPromise)(a);g||h.transmuxer.async?((0,F.isPromise)(a)||(a=Promise.resolve(a)),a.then(function(f){T(h,f,o)}).catch(function(f){v(D.Events.ERROR,{type:_.ErrorTypes.MEDIA_ERROR,details:_.ErrorDetails.FRAG_PARSING_ERROR,chunkMeta:n.chunkMeta,fatal:!1,error:f,err:f,reason:"transmuxer-worker flush error"})})):T(h,a,o);break}}})}function k(h,m){if(E(m.remuxResult))return!1;var v=[],r=m.remuxResult,d=r.audio,n=r.video;return d&&A(v,d),n&&A(v,n),h.postMessage({event:"transmuxComplete",data:m},v),!0}function A(h,m){m.data1&&h.push(m.data1.buffer),m.data2&&h.push(m.data2.buffer)}function T(h,m,v){var r=m.reduce(function(d,n){return k(h,n)||d},!1);r||h.postMessage({event:"transmuxComplete",data:m[0]}),h.postMessage({event:"flush",data:v})}function E(h){return!h.audio&&!h.video&&!h.text&&!h.id3&&!h.initSegment}},"./src/demux/transmuxer.ts":(j,x,S)=>{S.r(x),S.d(x,{TransmuxConfig:()=>i,TransmuxState:()=>y,default:()=>v,isPromise:()=>n});var F=S("./src/events.ts"),D=S("./src/errors.ts"),P=S("./src/crypt/decrypter.ts"),I=S("./src/demux/aacdemuxer.ts"),_=S("./src/demux/mp4demuxer.ts"),b=S("./src/demux/tsdemuxer.ts"),k=S("./src/demux/mp3demuxer.ts"),A=S("./src/remux/mp4-remuxer.ts"),T=S("./src/remux/passthrough-remuxer.ts"),E=S("./src/utils/logger.ts"),h;try{h=self.performance.now.bind(self.performance)}catch{E.logger.debug("Unable to use Performance API on this environment"),h=self.Date.now}var m=[{demux:_.default,remux:T.default},{demux:b.default,remux:A.default},{demux:I.default,remux:A.default},{demux:k.default,remux:A.default}],v=function(){function o(g,f,s,e,u){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=g,this.typeSupported=f,this.config=s,this.vendor=e,this.id=u}var a=o.prototype;return a.configure=function(g){this.transmuxConfig=g,this.decrypter&&this.decrypter.reset()},a.push=function(g,f,s,e){var u=this,t=s.transmuxing;t.executeStart=h();var l=new Uint8Array(g),p=this.currentTransmuxState,c=this.transmuxConfig;e&&(this.currentTransmuxState=e);var L=e||p,R=L.contiguous,w=L.discontinuity,O=L.trackSwitch,C=L.accurateTimeOffset,M=L.timeOffset,N=L.initSegmentChange,U=c.audioCodec,B=c.videoCodec,G=c.defaultInitPts,K=c.duration,Y=c.initSegmentData,q=r(l,f);if(q&&q.method==="AES-128"){var H=this.getDecrypter();if(H.isSync()){var V=H.softwareDecrypt(l,q.key.buffer,q.iv.buffer),z=s.part>-1;if(z&&(V=H.flush()),!V)return t.executeEnd=h(),d(s);l=new Uint8Array(V)}else return this.decryptionPromise=H.webCryptoDecrypt(l,q.key.buffer,q.iv.buffer).then(function(J){var $=u.push(J,null,s);return u.decryptionPromise=null,$}),this.decryptionPromise}var X=this.needsProbing(w,O);X&&this.configureTransmuxer(l),(w||O||N||X)&&this.resetInitSegment(Y,U,B,K,f),(w||N||X)&&this.resetInitialTimestamp(G),R||this.resetContiguity();var W=this.transmux(l,q,M,C,s),Q=this.currentTransmuxState;return Q.contiguous=!0,Q.discontinuity=!1,Q.trackSwitch=!1,t.executeEnd=h(),W},a.flush=function(g){var f=this,s=g.transmuxing;s.executeStart=h();var e=this.decrypter,u=this.currentTransmuxState,t=this.decryptionPromise;if(t)return t.then(function(){return f.flush(g)});var l=[],p=u.timeOffset;if(e){var c=e.flush();c&&l.push(this.push(c,null,g))}var L=this.demuxer,R=this.remuxer;if(!L||!R)return this.observer.emit(F.Events.ERROR,F.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"}),s.executeEnd=h(),[d(g)];var w=L.flush(p);return n(w)?w.then(function(O){return f.flushRemux(l,O,g),l}):(this.flushRemux(l,w,g),l)},a.flushRemux=function(g,f,s){var e=f.audioTrack,u=f.videoTrack,t=f.id3Track,l=f.textTrack,p=this.currentTransmuxState,c=p.accurateTimeOffset,L=p.timeOffset;E.logger.log("[transmuxer.ts]: Flushed fragment "+s.sn+(s.part>-1?" p: "+s.part:"")+" of level "+s.level);var R=this.remuxer.remux(e,u,t,l,L,c,!0,this.id);g.push({remuxResult:R,chunkMeta:s}),s.transmuxing.executeEnd=h()},a.resetInitialTimestamp=function(g){var f=this.demuxer,s=this.remuxer;!f||!s||(f.resetTimeStamp(g),s.resetTimeStamp(g))},a.resetContiguity=function(){var g=this.demuxer,f=this.remuxer;!g||!f||(g.resetContiguity(),f.resetNextTimestamp())},a.resetInitSegment=function(g,f,s,e,u){var t=this.demuxer,l=this.remuxer;!t||!l||(t.resetInitSegment(g,f,s,e),l.resetInitSegment(g,f,s,u))},a.destroy=function(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)},a.transmux=function(g,f,s,e,u){var t;return f&&f.method==="SAMPLE-AES"?t=this.transmuxSampleAes(g,f,s,e,u):t=this.transmuxUnencrypted(g,s,e,u),t},a.transmuxUnencrypted=function(g,f,s,e){var u=this.demuxer.demux(g,f,!1,!this.config.progressive),t=u.audioTrack,l=u.videoTrack,p=u.id3Track,c=u.textTrack,L=this.remuxer.remux(t,l,p,c,f,s,!1,this.id);return{remuxResult:L,chunkMeta:e}},a.transmuxSampleAes=function(g,f,s,e,u){var t=this;return this.demuxer.demuxSampleAes(g,f,s).then(function(l){var p=t.remuxer.remux(l.audioTrack,l.videoTrack,l.id3Track,l.textTrack,s,e,!1,t.id);return{remuxResult:p,chunkMeta:u}})},a.configureTransmuxer=function(g){for(var f=this.config,s=this.observer,e=this.typeSupported,u=this.vendor,t,l=0,p=m.length;l<p;l++)if(m[l].demux.probe(g)){t=m[l];break}t||(E.logger.warn("Failed to find demuxer by probing frag, treating as mp4 passthrough"),t={demux:_.default,remux:T.default});var c=this.demuxer,L=this.remuxer,R=t.remux,w=t.demux;(!L||!(L instanceof R))&&(this.remuxer=new R(s,f,e,u)),(!c||!(c instanceof w))&&(this.demuxer=new w(s,f,e),this.probe=w.probe)},a.needsProbing=function(g,f){return!this.demuxer||!this.remuxer||g||f},a.getDecrypter=function(){var g=this.decrypter;return g||(g=this.decrypter=new P.default(this.config)),g},o}();function r(o,a){var g=null;return o.byteLength>0&&a!=null&&a.key!=null&&a.iv!==null&&a.method!=null&&(g=a),g}var d=function(o){return{remuxResult:{},chunkMeta:o}};function n(o){return"then"in o&&o.then instanceof Function}var i=function(o,a,g,f,s){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=o,this.videoCodec=a,this.initSegmentData=g,this.duration=f,this.defaultInitPts=s},y=function(o,a,g,f,s,e){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=o,this.contiguous=a,this.accurateTimeOffset=g,this.trackSwitch=f,this.timeOffset=s,this.initSegmentChange=e}},"./src/demux/tsdemuxer.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>o});var F=S("./src/demux/adts.ts"),D=S("./src/demux/mpegaudio.ts"),P=S("./src/demux/exp-golomb.ts"),I=S("./src/demux/sample-aes.ts"),_=S("./src/events.ts"),b=S("./src/utils/mp4-tools.ts"),k=S("./src/utils/logger.ts"),A=S("./src/errors.ts"),T=S("./src/types/demuxer.ts");function E(){return E=Object.assign?Object.assign.bind():function(a){for(var g=1;g<arguments.length;g++){var f=arguments[g];for(var s in f)Object.prototype.hasOwnProperty.call(f,s)&&(a[s]=f[s])}return a},E.apply(this,arguments)}var h=188,m=function(){function a(f,s,e){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=f,this.config=s,this.typeSupported=e}a.probe=function(f){var s=a.syncOffset(f);return s>0&&k.logger.warn("MPEG2-TS detected but first sync word found @ offset "+s),s!==-1},a.syncOffset=function(f){for(var s=f.length,e=Math.min(h*5,f.length-h)+1,u=0;u<e;){for(var t=!1,l=u;l<s&&f[l]===71;l+=h)if(!t&&r(f,l)===0&&(t=!0),t&&l+h>e)return u;u++}return-1},a.createTrack=function(f,s){return{container:f==="video"||f==="audio"?"video/mp2t":void 0,type:f,id:b.RemuxerTrackIdConfig[f],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:f==="audio"?s:void 0}};var g=a.prototype;return g.resetInitSegment=function(f,s,e,u){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=a.createTrack("video"),this._audioTrack=a.createTrack("audio",u),this._id3Track=a.createTrack("id3"),this._txtTrack=a.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.audioCodec=s,this.videoCodec=e,this._duration=u},g.resetTimeStamp=function(){},g.resetContiguity=function(){var f=this._audioTrack,s=this._avcTrack,e=this._id3Track;f&&(f.pesData=null),s&&(s.pesData=null),e&&(e.pesData=null),this.aacOverFlow=null,this.avcSample=null,this.remainderData=null},g.demux=function(f,s,e,u){e===void 0&&(e=!1),u===void 0&&(u=!1),e||(this.sampleAes=null);var t,l=this._avcTrack,p=this._audioTrack,c=this._id3Track,L=this._txtTrack,R=l.pid,w=l.pesData,O=p.pid,C=c.pid,M=p.pesData,N=c.pesData,U=null,B=this.pmtParsed,G=this._pmtId,K=f.length;if(this.remainderData&&(f=(0,b.appendUint8Array)(this.remainderData,f),K=f.length,this.remainderData=null),K<h&&!u)return this.remainderData=f,{audioTrack:p,videoTrack:l,id3Track:c,textTrack:L};var Y=Math.max(0,a.syncOffset(f));K-=(K-Y)%h,K<f.byteLength&&!u&&(this.remainderData=new Uint8Array(f.buffer,K,f.buffer.byteLength-K));for(var q=0,H=Y;H<K;H+=h)if(f[H]===71){var V=!!(f[H+1]&64),z=r(f,H),X=(f[H+3]&48)>>4,W=void 0;if(X>1){if(W=H+5+f[H+4],W===H+h)continue}else W=H+4;switch(z){case R:V&&(w&&(t=i(w))&&this.parseAVCPES(l,L,t,!1),w={data:[],size:0}),w&&(w.data.push(f.subarray(W,H+h)),w.size+=H+h-W);break;case O:if(V){if(M&&(t=i(M)))switch(p.segmentCodec){case"aac":this.parseAACPES(p,t);break;case"mp3":this.parseMPEGPES(p,t);break}M={data:[],size:0}}M&&(M.data.push(f.subarray(W,H+h)),M.size+=H+h-W);break;case C:V&&(N&&(t=i(N))&&this.parseID3PES(c,t),N={data:[],size:0}),N&&(N.data.push(f.subarray(W,H+h)),N.size+=H+h-W);break;case 0:V&&(W+=f[W]+1),G=this._pmtId=d(f,W);break;case G:{V&&(W+=f[W]+1);var Q=n(f,W,this.typeSupported,e);R=Q.avc,R>0&&(l.pid=R),O=Q.audio,O>0&&(p.pid=O,p.segmentCodec=Q.segmentCodec),C=Q.id3,C>0&&(c.pid=C),U!==null&&!B&&(k.logger.warn("MPEG-TS PMT found at "+H+" after unknown PID '"+U+"'. Backtracking to sync byte @"+Y+" to parse all TS packets."),U=null,H=Y-188),B=this.pmtParsed=!0;break}case 17:case 8191:break;default:U=z;break}}else q++;q>0&&this.observer.emit(_.Events.ERROR,_.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"Found "+q+" TS packet/s that do not start with 0x47"}),l.pesData=w,p.pesData=M,c.pesData=N;var J={audioTrack:p,videoTrack:l,id3Track:c,textTrack:L};return u&&this.extractRemainingSamples(J),J},g.flush=function(){var f=this.remainderData;this.remainderData=null;var s;return f?s=this.demux(f,-1,!1,!0):s={videoTrack:this._avcTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(s),this.sampleAes?this.decrypt(s,this.sampleAes):s},g.extractRemainingSamples=function(f){var s=f.audioTrack,e=f.videoTrack,u=f.id3Track,t=f.textTrack,l=e.pesData,p=s.pesData,c=u.pesData,L;if(l&&(L=i(l))?(this.parseAVCPES(e,t,L,!0),e.pesData=null):e.pesData=l,p&&(L=i(p))){switch(s.segmentCodec){case"aac":this.parseAACPES(s,L);break;case"mp3":this.parseMPEGPES(s,L);break}s.pesData=null}else p!=null&&p.size&&k.logger.log("last AAC PES packet truncated,might overlap between fragments"),s.pesData=p;c&&(L=i(c))?(this.parseID3PES(u,L),u.pesData=null):u.pesData=c},g.demuxSampleAes=function(f,s,e){var u=this.demux(f,e,!0,!this.config.progressive),t=this.sampleAes=new I.default(this.observer,this.config,s);return this.decrypt(u,t)},g.decrypt=function(f,s){return new Promise(function(e){var u=f.audioTrack,t=f.videoTrack;u.samples&&u.segmentCodec==="aac"?s.decryptAacSamples(u.samples,0,function(){t.samples?s.decryptAvcSamples(t.samples,0,0,function(){e(f)}):e(f)}):t.samples&&s.decryptAvcSamples(t.samples,0,0,function(){e(f)})})},g.destroy=function(){this._duration=0},g.parseAVCPES=function(f,s,e,u){var t=this,l=this.parseAVCNALu(f,e.data),p=this.avcSample,c,L=!1;e.data=null,p&&l.length&&!f.audFound&&(y(p,f),p=this.avcSample=v(!1,e.pts,e.dts,"")),l.forEach(function(R){switch(R.type){case 1:{c=!0,p||(p=t.avcSample=v(!0,e.pts,e.dts,"")),p.frame=!0;var w=R.data;if(L&&w.length>4){var O=new P.default(w).readSliceType();(O===2||O===4||O===7||O===9)&&(p.key=!0)}break}case 5:c=!0,p||(p=t.avcSample=v(!0,e.pts,e.dts,"")),p.key=!0,p.frame=!0;break;case 6:{c=!0,(0,b.parseSEIMessageFromNALu)(R.data,1,e.pts,s.samples);break}case 7:if(c=!0,L=!0,!f.sps){var C=new P.default(R.data),M=C.readSPS();f.width=M.width,f.height=M.height,f.pixelRatio=M.pixelRatio,f.sps=[R.data],f.duration=t._duration;for(var N=R.data.subarray(1,4),U="avc1.",B=0;B<3;B++){var G=N[B].toString(16);G.length<2&&(G="0"+G),U+=G}f.codec=U}break;case 8:c=!0,f.pps||(f.pps=[R.data]);break;case 9:c=!1,f.audFound=!0,p&&y(p,f),p=t.avcSample=v(!1,e.pts,e.dts,"");break;case 12:c=!0;break;default:c=!1,p&&(p.debug+="unknown NAL "+R.type+" ");break}if(p&&c){var K=p.units;K.push(R)}}),u&&p&&(y(p,f),this.avcSample=null)},g.getLastNalUnit=function(f){var s,e=this.avcSample,u;if((!e||e.units.length===0)&&(e=f[f.length-1]),(s=e)!==null&&s!==void 0&&s.units){var t=e.units;u=t[t.length-1]}return u},g.parseAVCNALu=function(f,s){var e=s.byteLength,u=f.naluState||0,t=u,l=[],p=0,c,L,R,w=-1,O=0;for(u===-1&&(w=0,O=s[0]&31,u=0,p=1);p<e;){if(c=s[p++],!u){u=c?0:1;continue}if(u===1){u=c?0:2;continue}if(!c)u=3;else if(c===1){if(w>=0){var C={data:s.subarray(w,p-u-1),type:O};l.push(C)}else{var M=this.getLastNalUnit(f.samples);if(M&&(t&&p<=4-t&&M.state&&(M.data=M.data.subarray(0,M.data.byteLength-t)),L=p-u-1,L>0)){var N=new Uint8Array(M.data.byteLength+L);N.set(M.data,0),N.set(s.subarray(0,L),M.data.byteLength),M.data=N,M.state=0}}p<e?(R=s[p]&31,w=p,O=R,u=0):u=-1}else u=0}if(w>=0&&u>=0){var U={data:s.subarray(w,e),type:O,state:u};l.push(U)}if(l.length===0){var B=this.getLastNalUnit(f.samples);if(B){var G=new Uint8Array(B.data.byteLength+s.byteLength);G.set(B.data,0),G.set(s,B.data.byteLength),B.data=G}}return f.naluState=u,l},g.parseAACPES=function(f,s){var e=0,u=this.aacOverFlow,t=s.data;if(u){this.aacOverFlow=null;var l=u.missing,p=u.sample.unit.byteLength;if(l===-1){var c=new Uint8Array(p+t.byteLength);c.set(u.sample.unit,0),c.set(t,p),t=c}else{var L=p-l;u.sample.unit.set(t.subarray(0,l),L),f.samples.push(u.sample),e=u.missing}}var R,w;for(R=e,w=t.length;R<w-1&&!F.isHeader(t,R);R++);if(R!==e){var O,C;if(R<w-1?(O="AAC PES did not start with ADTS header,offset:"+R,C=!1):(O="no ADTS header found in AAC PES",C=!0),k.logger.warn("parsing error:"+O),this.observer.emit(_.Events.ERROR,_.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.FRAG_PARSING_ERROR,fatal:C,reason:O}),C)return}F.initTrackConfig(f,this.observer,t,R,this.audioCodec);var M;if(s.pts!==void 0)M=s.pts;else if(u){var N=F.getFrameDuration(f.samplerate);M=u.sample.pts+N}else{k.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}for(var U=0,B;R<w;)if(B=F.appendFrame(f,t,R,M,U),R+=B.length,B.missing){this.aacOverFlow=B;break}else for(U++;R<w-1&&!F.isHeader(t,R);R++);},g.parseMPEGPES=function(f,s){var e=s.data,u=e.length,t=0,l=0,p=s.pts;if(p===void 0){k.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;l<u;)if(D.isHeader(e,l)){var c=D.appendFrame(f,e,l,p,t);if(c)l+=c.length,t++;else break}else l++},g.parseID3PES=function(f,s){if(s.pts===void 0){k.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}var e=E({},s,{type:this._avcTrack?T.MetadataSchema.emsg:T.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});f.samples.push(e)},a}();function v(a,g,f,s){return{key:a,frame:!1,pts:g,dts:f,units:[],debug:s,length:0}}function r(a,g){return((a[g+1]&31)<<8)+a[g+2]}function d(a,g){return(a[g+10]&31)<<8|a[g+11]}function n(a,g,f,s){var e={audio:-1,avc:-1,id3:-1,segmentCodec:"aac"},u=(a[g+1]&15)<<8|a[g+2],t=g+3+u-4,l=(a[g+10]&15)<<8|a[g+11];for(g+=12+l;g<t;){var p=r(a,g);switch(a[g]){case 207:if(!s){k.logger.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:e.audio===-1&&(e.audio=p);break;case 21:e.id3===-1&&(e.id3=p);break;case 219:if(!s){k.logger.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:e.avc===-1&&(e.avc=p);break;case 3:case 4:f.mpeg!==!0&&f.mp3!==!0?k.logger.log("MPEG audio found, not supported in this browser"):e.audio===-1&&(e.audio=p,e.segmentCodec="mp3");break;case 36:k.logger.warn("Unsupported HEVC stream type found");break}g+=((a[g+3]&15)<<8|a[g+4])+5}return e}function i(a){var g=0,f,s,e,u,t,l=a.data;if(!a||a.size===0)return null;for(;l[0].length<19&&l.length>1;){var p=new Uint8Array(l[0].length+l[1].length);p.set(l[0]),p.set(l[1],l[0].length),l[0]=p,l.splice(1,1)}f=l[0];var c=(f[0]<<16)+(f[1]<<8)+f[2];if(c===1){if(s=(f[4]<<8)+f[5],s&&s>a.size-6)return null;var L=f[7];L&192&&(u=(f[9]&14)*536870912+(f[10]&255)*4194304+(f[11]&254)*16384+(f[12]&255)*128+(f[13]&254)/2,L&64?(t=(f[14]&14)*536870912+(f[15]&255)*4194304+(f[16]&254)*16384+(f[17]&255)*128+(f[18]&254)/2,u-t>54e5&&(k.logger.warn(Math.round((u-t)/9e4)+"s delta between PTS and DTS, align them"),u=t)):t=u),e=f[8];var R=e+9;if(a.size<=R)return null;a.size-=R;for(var w=new Uint8Array(a.size),O=0,C=l.length;O<C;O++){f=l[O];var M=f.byteLength;if(R)if(R>M){R-=M;continue}else f=f.subarray(R),M-=R,R=0;w.set(f,g),g+=M}return s&&(s-=e+3),{data:w,pts:u,dts:t,len:s}}return null}function y(a,g){if(a.units.length&&a.frame){if(a.pts===void 0){var f=g.samples,s=f.length;if(s){var e=f[s-1];a.pts=e.pts,a.dts=e.dts}else{g.dropped++;return}}g.samples.push(a)}a.debug.length&&k.logger.log(a.pts+"/"+a.dts+":"+a.debug)}const o=m},"./src/demux/webworkify-webpack.js":(j,x,S)=>{S.r(x),S.d(x,{default:()=>h});var F=function(){var m=ENTRY_MODULE,v={},r=function n(i){var y=v[i];if(y!==void 0)return y.exports;var o=v[i]={exports:{}};return m[i].call(o.exports,o,o.exports,n),o.exports};r.m=m,function(){r.n=function(n){var i=n&&n.__esModule?function(){return n.default}:function(){return n};return r.d(i,{a:i}),i}}(),function(){r.d=function(n,i){for(var y in i)r.o(i,y)&&!r.o(n,y)&&Object.defineProperty(n,y,{enumerable:!0,get:i[y]})}}(),function(){r.o=function(n,i){return Object.prototype.hasOwnProperty.call(n,i)}}(),function(){r.r=function(n){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})}}();var d=r(ENTRY_MODULE);return d.default||d},D=F.toString().split("ENTRY_MODULE"),P="[\\.|\\-|\\+|\\w|/|@]+",I="\\(\\s*(/\\*.*?\\*/)?\\s*.*?("+P+").*?\\)";function _(m){return(m+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function b(m){return!isNaN(1*m)}function k(m,v,r){var d={};d[r]=[];var n=v.toString().replace(/^"[^"]+"/,"function"),i=n.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/)||n.match(/^\(\w+,\s*\w+,\s*(\w+)\)\s?\=\s?\>/);if(!i)return d;for(var y=i[1],o=new RegExp("(\\\\n|\\W)"+_(y)+I,"g"),a;a=o.exec(n);)a[3]!=="dll-reference"&&d[r].push(a[3]);for(o=new RegExp("\\("+_(y)+'\\("(dll-reference\\s('+P+'))"\\)\\)'+I,"g");a=o.exec(n);)m[a[2]]||(d[r].push(a[1]),m[a[2]]=S(a[1]).m),d[a[2]]=d[a[2]]||[],d[a[2]].push(a[4]);for(var g=Object.keys(d),f=0;f<g.length;f++)for(var s=0;s<d[g[f]].length;s++)b(d[g[f]][s])&&(d[g[f]][s]=1*d[g[f]][s]);return d}function A(m){var v=Object.keys(m);return v.reduce(function(r,d){return r||m[d].length>0},!1)}function T(m,v){for(var r={main:[v]},d={main:[]},n={main:{}};A(r);)for(var i=Object.keys(r),y=0;y<i.length;y++){var o=i[y],a=r[o],g=a.pop();if(n[o]=n[o]||{},!(n[o][g]||!m[o][g])){n[o][g]=!0,d[o]=d[o]||[],d[o].push(g);for(var f=k(m,m[o][g],o),s=Object.keys(f),e=0;e<s.length;e++)r[s[e]]=r[s[e]]||[],r[s[e]]=r[s[e]].concat(f[s[e]])}}return d}function E(m,v,r,d){var n=m[d].map(function(i){return'"'+i+'": '+v[d][i].toString().replace(/^"[^"]+"/,"function")}).join(",");return D[0]+"{"+n+"}"+D[1]+'"'+r+'"'+D[2]}function h(m,v){v=v||{};var r={main:S.m},d=v.all?{main:Object.keys(r.main)}:T(r,m),n="";Object.keys(d).filter(function(g){return g!=="main"}).forEach(function(g){for(var f=0;d[g][f];)f++;d[g].push(f),r[g][f]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",n=n+("var "+g+" = ("+E(d,r,f,modules)+`)();
`)}),n=n+("new (("+E(d,r,m,"main")+")())(self);");var i=new window.Blob([n],{type:"text/javascript"}),y=window.URL||window.webkitURL||window.mozURL||window.msURL,o=y.createObjectURL(i),a=new window.Worker(o);return a.objectURL=o,a}},"./src/errors.ts":(j,x,S)=>{S.r(x),S.d(x,{ErrorDetails:()=>D,ErrorTypes:()=>F});var F;(function(P){P.NETWORK_ERROR="networkError",P.MEDIA_ERROR="mediaError",P.KEY_SYSTEM_ERROR="keySystemError",P.MUX_ERROR="muxError",P.OTHER_ERROR="otherError"})(F||(F={}));var D;(function(P){P.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",P.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",P.KEY_SYSTEM_NO_SESSION="keySystemNoSession",P.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",P.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",P.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",P.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",P.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",P.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",P.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",P.MANIFEST_LOAD_ERROR="manifestLoadError",P.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",P.MANIFEST_PARSING_ERROR="manifestParsingError",P.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",P.LEVEL_EMPTY_ERROR="levelEmptyError",P.LEVEL_LOAD_ERROR="levelLoadError",P.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",P.LEVEL_SWITCH_ERROR="levelSwitchError",P.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",P.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",P.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",P.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",P.FRAG_LOAD_ERROR="fragLoadError",P.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",P.FRAG_DECRYPT_ERROR="fragDecryptError",P.FRAG_PARSING_ERROR="fragParsingError",P.REMUX_ALLOC_ERROR="remuxAllocError",P.KEY_LOAD_ERROR="keyLoadError",P.KEY_LOAD_TIMEOUT="keyLoadTimeOut",P.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",P.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",P.BUFFER_APPEND_ERROR="bufferAppendError",P.BUFFER_APPENDING_ERROR="bufferAppendingError",P.BUFFER_STALLED_ERROR="bufferStalledError",P.BUFFER_FULL_ERROR="bufferFullError",P.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",P.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",P.INTERNAL_EXCEPTION="internalException",P.INTERNAL_ABORTED="aborted",P.UNKNOWN="unknown"})(D||(D={}))},"./src/events.ts":(j,x,S)=>{S.r(x),S.d(x,{Events:()=>F});var F;(function(D){D.MEDIA_ATTACHING="hlsMediaAttaching",D.MEDIA_ATTACHED="hlsMediaAttached",D.MEDIA_DETACHING="hlsMediaDetaching",D.MEDIA_DETACHED="hlsMediaDetached",D.BUFFER_RESET="hlsBufferReset",D.BUFFER_CODECS="hlsBufferCodecs",D.BUFFER_CREATED="hlsBufferCreated",D.BUFFER_APPENDING="hlsBufferAppending",D.BUFFER_APPENDED="hlsBufferAppended",D.BUFFER_EOS="hlsBufferEos",D.BUFFER_FLUSHING="hlsBufferFlushing",D.BUFFER_FLUSHED="hlsBufferFlushed",D.MANIFEST_LOADING="hlsManifestLoading",D.MANIFEST_LOADED="hlsManifestLoaded",D.MANIFEST_PARSED="hlsManifestParsed",D.LEVEL_SWITCHING="hlsLevelSwitching",D.LEVEL_SWITCHED="hlsLevelSwitched",D.LEVEL_LOADING="hlsLevelLoading",D.LEVEL_LOADED="hlsLevelLoaded",D.LEVEL_UPDATED="hlsLevelUpdated",D.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",D.LEVELS_UPDATED="hlsLevelsUpdated",D.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",D.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",D.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",D.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",D.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",D.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",D.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",D.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",D.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",D.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",D.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",D.CUES_PARSED="hlsCuesParsed",D.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",D.INIT_PTS_FOUND="hlsInitPtsFound",D.FRAG_LOADING="hlsFragLoading",D.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",D.FRAG_LOADED="hlsFragLoaded",D.FRAG_DECRYPTED="hlsFragDecrypted",D.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",D.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",D.FRAG_PARSING_METADATA="hlsFragParsingMetadata",D.FRAG_PARSED="hlsFragParsed",D.FRAG_BUFFERED="hlsFragBuffered",D.FRAG_CHANGED="hlsFragChanged",D.FPS_DROP="hlsFpsDrop",D.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",D.ERROR="hlsError",D.DESTROYING="hlsDestroying",D.KEY_LOADING="hlsKeyLoading",D.KEY_LOADED="hlsKeyLoaded",D.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",D.BACK_BUFFER_REACHED="hlsBackBufferReached"})(F||(F={}))},"./src/hls.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>a});var F=S("./node_modules/url-toolkit/src/url-toolkit.js"),D=S("./src/loader/playlist-loader.ts"),P=S("./src/controller/id3-track-controller.ts"),I=S("./src/controller/latency-controller.ts"),_=S("./src/controller/level-controller.ts"),b=S("./src/controller/fragment-tracker.ts"),k=S("./src/loader/key-loader.ts"),A=S("./src/controller/stream-controller.ts"),T=S("./src/is-supported.ts"),E=S("./src/utils/logger.ts"),h=S("./src/config.ts"),m=S("./node_modules/eventemitter3/index.js"),v=S("./src/events.ts"),r=S("./src/errors.ts"),d=S("./src/types/level.ts");function n(g,f){for(var s=0;s<f.length;s++){var e=f[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(g,y(e.key),e)}}function i(g,f,s){return f&&n(g.prototype,f),s&&n(g,s),Object.defineProperty(g,"prototype",{writable:!1}),g}function y(g){var f=o(g,"string");return typeof f=="symbol"?f:String(f)}function o(g,f){if(typeof g!="object"||g===null)return g;var s=g[Symbol.toPrimitive];if(s!==void 0){var e=s.call(g,f);if(typeof e!="object")return e;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(g)}var a=function(){g.isSupported=function(){return(0,T.isSupported)()};function g(s){s===void 0&&(s={}),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new m.EventEmitter,this._autoLevelCapping=void 0,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null;var e=this.config=(0,h.mergeConfig)(g.DefaultConfig,s);this.userConfig=s,(0,E.enableLogs)(e.debug,"Hls instance"),this._autoLevelCapping=-1,e.progressive&&(0,h.enableStreamingMode)(e);var u=e.abrController,t=e.bufferController,l=e.capLevelController,p=e.fpsController,c=this.abrController=new u(this),L=this.bufferController=new t(this),R=this.capLevelController=new l(this),w=new p(this),O=new D.default(this),C=new P.default(this),M=this.levelController=new _.default(this),N=new b.FragmentTracker(this),U=new k.default(this.config),B=this.streamController=new A.default(this,N,U);R.setStreamController(B),w.setStreamController(B);var G=[O,M,B];this.networkControllers=G;var K=[c,L,R,w,C,N];this.audioTrackController=this.createController(e.audioTrackController,G);var Y=e.audioStreamController;Y&&G.push(new Y(this,N,U)),this.subtitleTrackController=this.createController(e.subtitleTrackController,G);var q=e.subtitleStreamController;q&&G.push(new q(this,N,U)),this.createController(e.timelineController,K),U.emeController=this.emeController=this.createController(e.emeController,K),this.cmcdController=this.createController(e.cmcdController,K),this.latencyController=this.createController(I.default,K),this.coreComponents=K}var f=g.prototype;return f.createController=function(s,e){if(s){var u=new s(this);return e&&e.push(u),u}return null},f.on=function(s,e,u){u===void 0&&(u=this),this._emitter.on(s,e,u)},f.once=function(s,e,u){u===void 0&&(u=this),this._emitter.once(s,e,u)},f.removeAllListeners=function(s){this._emitter.removeAllListeners(s)},f.off=function(s,e,u,t){u===void 0&&(u=this),this._emitter.off(s,e,u,t)},f.listeners=function(s){return this._emitter.listeners(s)},f.emit=function(s,e,u){return this._emitter.emit(s,e,u)},f.trigger=function(s,e){if(this.config.debug)return this.emit(s,s,e);try{return this.emit(s,s,e)}catch(u){E.logger.error("An internal error happened while handling event "+s+'. Error message: "'+u.message+'". Here is a stacktrace:',u),this.trigger(v.Events.ERROR,{type:r.ErrorTypes.OTHER_ERROR,details:r.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:s,error:u})}return!1},f.listenerCount=function(s){return this._emitter.listenerCount(s)},f.destroy=function(){E.logger.log("destroy"),this.trigger(v.Events.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(function(s){return s.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(s){return s.destroy()}),this.coreComponents.length=0},f.attachMedia=function(s){E.logger.log("attachMedia"),this._media=s,this.trigger(v.Events.MEDIA_ATTACHING,{media:s})},f.detachMedia=function(){E.logger.log("detachMedia"),this.trigger(v.Events.MEDIA_DETACHING,void 0),this._media=null},f.loadSource=function(s){this.stopLoad();var e=this.media,u=this.url,t=this.url=F.buildAbsoluteURL(self.location.href,s,{alwaysNormalize:!0});E.logger.log("loadSource:"+t),e&&u&&u!==t&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(e)),this.trigger(v.Events.MANIFEST_LOADING,{url:s})},f.startLoad=function(s){s===void 0&&(s=-1),E.logger.log("startLoad("+s+")"),this.networkControllers.forEach(function(e){e.startLoad(s)})},f.stopLoad=function(){E.logger.log("stopLoad"),this.networkControllers.forEach(function(s){s.stopLoad()})},f.swapAudioCodec=function(){E.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()},f.recoverMediaError=function(){E.logger.log("recoverMediaError");var s=this._media;this.detachMedia(),s&&this.attachMedia(s)},f.removeLevel=function(s,e){e===void 0&&(e=0),this.levelController.removeLevel(s,e)},i(g,[{key:"levels",get:function(){var s=this.levelController.levels;return s||[]}},{key:"currentLevel",get:function(){return this.streamController.currentLevel},set:function(s){E.logger.log("set currentLevel:"+s),this.loadLevel=s,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function(){return this.streamController.nextLevel},set:function(s){E.logger.log("set nextLevel:"+s),this.levelController.manualLevel=s,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function(){return this.levelController.level},set:function(s){E.logger.log("set loadLevel:"+s),this.levelController.manualLevel=s}},{key:"nextLoadLevel",get:function(){return this.levelController.nextLoadLevel},set:function(s){this.levelController.nextLoadLevel=s}},{key:"firstLevel",get:function(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function(s){E.logger.log("set firstLevel:"+s),this.levelController.firstLevel=s}},{key:"startLevel",get:function(){return this.levelController.startLevel},set:function(s){E.logger.log("set startLevel:"+s),s!==-1&&(s=Math.max(s,this.minAutoLevel)),this.levelController.startLevel=s}},{key:"capLevelToPlayerSize",get:function(){return this.config.capLevelToPlayerSize},set:function(s){var e=!!s;e!==this.config.capLevelToPlayerSize&&(e?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=e)}},{key:"autoLevelCapping",get:function(){return this._autoLevelCapping},set:function(s){this._autoLevelCapping!==s&&(E.logger.log("set autoLevelCapping:"+s),this._autoLevelCapping=s)}},{key:"bandwidthEstimate",get:function(){var s=this.abrController.bwEstimator;return s?s.getEstimate():NaN}},{key:"maxHdcpLevel",get:function(){return this._maxHdcpLevel},set:function(s){d.HdcpLevels.indexOf(s)>-1&&(this._maxHdcpLevel=s)}},{key:"autoLevelEnabled",get:function(){return this.levelController.manualLevel===-1}},{key:"manualLevel",get:function(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function(){var s=this.levels,e=this.config.minAutoBitrate;if(!s)return 0;for(var u=s.length,t=0;t<u;t++)if(s[t].maxBitrate>=e)return t;return 0}},{key:"maxAutoLevel",get:function(){var s=this.levels,e=this.autoLevelCapping,u=this.maxHdcpLevel,t;if(e===-1&&s&&s.length?t=s.length-1:t=e,u)for(var l=t;l--;){var p=s[l].attrs["HDCP-LEVEL"];if(p&&p<=u)return l}return t}},{key:"nextAutoLevel",get:function(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)},set:function(s){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,s)}},{key:"playingDate",get:function(){return this.streamController.currentProgramDateTime}},{key:"mainForwardBufferInfo",get:function(){return this.streamController.getMainFwdBufferInfo()}},{key:"audioTracks",get:function(){var s=this.audioTrackController;return s?s.audioTracks:[]}},{key:"audioTrack",get:function(){var s=this.audioTrackController;return s?s.audioTrack:-1},set:function(s){var e=this.audioTrackController;e&&(e.audioTrack=s)}},{key:"subtitleTracks",get:function(){var s=this.subtitleTrackController;return s?s.subtitleTracks:[]}},{key:"subtitleTrack",get:function(){var s=this.subtitleTrackController;return s?s.subtitleTrack:-1},set:function(s){var e=this.subtitleTrackController;e&&(e.subtitleTrack=s)}},{key:"media",get:function(){return this._media}},{key:"subtitleDisplay",get:function(){var s=this.subtitleTrackController;return s?s.subtitleDisplay:!1},set:function(s){var e=this.subtitleTrackController;e&&(e.subtitleDisplay=s)}},{key:"lowLatencyMode",get:function(){return this.config.lowLatencyMode},set:function(s){this.config.lowLatencyMode=s}},{key:"liveSyncPosition",get:function(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function(){return this.latencyController.latency}},{key:"maxLatency",get:function(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function(){return this.latencyController.targetLatency}},{key:"drift",get:function(){return this.latencyController.drift}},{key:"forceStartLoad",get:function(){return this.streamController.forceStartLoad}}],[{key:"version",get:function(){return"1.3.5"}},{key:"Events",get:function(){return v.Events}},{key:"ErrorTypes",get:function(){return r.ErrorTypes}},{key:"ErrorDetails",get:function(){return r.ErrorDetails}},{key:"DefaultConfig",get:function(){return g.defaultConfig?g.defaultConfig:h.hlsDefaultConfig},set:function(s){g.defaultConfig=s}}]),g}();a.defaultConfig=void 0},"./src/is-supported.ts":(j,x,S)=>{S.r(x),S.d(x,{changeTypeSupported:()=>I,isSupported:()=>P});var F=S("./src/utils/mediasource-helper.ts");function D(){return self.SourceBuffer||self.WebKitSourceBuffer}function P(){var _=(0,F.getMediaSource)();if(!_)return!1;var b=D(),k=_&&typeof _.isTypeSupported=="function"&&_.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),A=!b||b.prototype&&typeof b.prototype.appendBuffer=="function"&&typeof b.prototype.remove=="function";return!!k&&!!A}function I(){var _,b=D();return typeof(b==null||(_=b.prototype)===null||_===void 0?void 0:_.changeType)=="function"}},"./src/loader/date-range.ts":(j,x,S)=>{S.r(x),S.d(x,{DateRange:()=>E,DateRangeAttribute:()=>T});var F=S("./src/polyfills/number.ts"),D=S("./src/utils/attr-list.ts"),P=S("./src/utils/logger.ts");function I(){return I=Object.assign?Object.assign.bind():function(h){for(var m=1;m<arguments.length;m++){var v=arguments[m];for(var r in v)Object.prototype.hasOwnProperty.call(v,r)&&(h[r]=v[r])}return h},I.apply(this,arguments)}function _(h,m){for(var v=0;v<m.length;v++){var r=m[v];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(h,k(r.key),r)}}function b(h,m,v){return m&&_(h.prototype,m),Object.defineProperty(h,"prototype",{writable:!1}),h}function k(h){var m=A(h,"string");return typeof m=="symbol"?m:String(m)}function A(h,m){if(typeof h!="object"||h===null)return h;var v=h[Symbol.toPrimitive];if(v!==void 0){var r=v.call(h,m);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(h)}var T;(function(h){h.ID="ID",h.CLASS="CLASS",h.START_DATE="START-DATE",h.DURATION="DURATION",h.END_DATE="END-DATE",h.END_ON_NEXT="END-ON-NEXT",h.PLANNED_DURATION="PLANNED-DURATION",h.SCTE35_OUT="SCTE35-OUT",h.SCTE35_IN="SCTE35-IN"})(T||(T={}));var E=function(){function h(m,v){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,v){var r=v.attr;for(var d in r)if(Object.prototype.hasOwnProperty.call(m,d)&&m[d]!==r[d]){P.logger.warn('DATERANGE tag attribute: "'+d+'" does not match for tags with ID: "'+m.ID+'"'),this._badValueForSameId=d;break}m=I(new D.AttrList({}),r,m)}if(this.attr=m,this._startDate=new Date(m[T.START_DATE]),T.END_DATE in this.attr){var n=new Date(this.attr[T.END_DATE]);(0,F.isFiniteNumber)(n.getTime())&&(this._endDate=n)}}return b(h,[{key:"id",get:function(){return this.attr.ID}},{key:"class",get:function(){return this.attr.CLASS}},{key:"startDate",get:function(){return this._startDate}},{key:"endDate",get:function(){if(this._endDate)return this._endDate;var m=this.duration;return m!==null?new Date(this._startDate.getTime()+m*1e3):null}},{key:"duration",get:function(){if(T.DURATION in this.attr){var m=this.attr.decimalFloatingPoint(T.DURATION);if((0,F.isFiniteNumber)(m))return m}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}},{key:"plannedDuration",get:function(){return T.PLANNED_DURATION in this.attr?this.attr.decimalFloatingPoint(T.PLANNED_DURATION):null}},{key:"endOnNext",get:function(){return this.attr.bool(T.END_ON_NEXT)}},{key:"isValid",get:function(){return!!this.id&&!this._badValueForSameId&&(0,F.isFiniteNumber)(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}]),h}()},"./src/loader/fragment-loader.ts":(j,x,S)=>{S.r(x),S.d(x,{LoadError:()=>v,default:()=>h});var F=S("./src/polyfills/number.ts"),D=S("./src/errors.ts");function P(r,d){r.prototype=Object.create(d.prototype),r.prototype.constructor=r,A(r,d)}function I(r){var d=typeof Map=="function"?new Map:void 0;return I=function(n){if(n===null||!k(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(typeof d<"u"){if(d.has(n))return d.get(n);d.set(n,i)}function i(){return _(n,arguments,T(this).constructor)}return i.prototype=Object.create(n.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),A(i,n)},I(r)}function _(r,d,n){return b()?_=Reflect.construct.bind():_=function(i,y,o){var a=[null];a.push.apply(a,y);var g=Function.bind.apply(i,a),f=new g;return o&&A(f,o.prototype),f},_.apply(null,arguments)}function b(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function k(r){return Function.toString.call(r).indexOf("[native code]")!==-1}function A(r,d){return A=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,i){return n.__proto__=i,n},A(r,d)}function T(r){return T=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(d){return d.__proto__||Object.getPrototypeOf(d)},T(r)}var E=Math.pow(2,17),h=function(){function r(n){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=n}var d=r.prototype;return d.destroy=function(){this.loader&&(this.loader.destroy(),this.loader=null)},d.abort=function(){this.loader&&this.loader.abort()},d.load=function(n,i){var y=this,o=n.url;if(!o)return Promise.reject(new v({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:n,networkDetails:null},"Fragment does not have a "+(o?"part list":"url")));this.abort();var a=this.config,g=a.fLoader,f=a.loader;return new Promise(function(s,e){y.loader&&y.loader.destroy();var u=y.loader=n.loader=g?new g(a):new f(a),t=m(n),l={timeout:a.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:a.fragLoadingMaxRetryTimeout,highWaterMark:n.sn==="initSegment"?1/0:E};n.stats=u.stats,u.load(t,l,{onSuccess:function(p,c,L,R){y.resetLoader(n,u);var w=p.data;L.resetIV&&n.decryptdata&&(n.decryptdata.iv=new Uint8Array(w.slice(0,16)),w=w.slice(16)),s({frag:n,part:null,payload:w,networkDetails:R})},onError:function(p,c,L){y.resetLoader(n,u),e(new v({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:n,response:p,networkDetails:L}))},onAbort:function(p,c,L){y.resetLoader(n,u),e(new v({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:n,networkDetails:L}))},onTimeout:function(p,c,L){y.resetLoader(n,u),e(new v({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:n,networkDetails:L}))},onProgress:function(p,c,L,R){i&&i({frag:n,part:null,payload:L,networkDetails:R})}})})},d.loadPart=function(n,i,y){var o=this;this.abort();var a=this.config,g=a.fLoader,f=a.loader;return new Promise(function(s,e){o.loader&&o.loader.destroy();var u=o.loader=n.loader=g?new g(a):new f(a),t=m(n,i),l={timeout:a.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:a.fragLoadingMaxRetryTimeout,highWaterMark:E};i.stats=u.stats,u.load(t,l,{onSuccess:function(p,c,L,R){o.resetLoader(n,u),o.updateStatsFromPart(n,i);var w={frag:n,part:i,payload:p.data,networkDetails:R};y(w),s(w)},onError:function(p,c,L){o.resetLoader(n,u),e(new v({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:n,part:i,response:p,networkDetails:L}))},onAbort:function(p,c,L){n.stats.aborted=i.stats.aborted,o.resetLoader(n,u),e(new v({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:n,part:i,networkDetails:L}))},onTimeout:function(p,c,L){o.resetLoader(n,u),e(new v({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:n,part:i,networkDetails:L}))}})})},d.updateStatsFromPart=function(n,i){var y=n.stats,o=i.stats,a=o.total;if(y.loaded+=o.loaded,a){var g=Math.round(n.duration/i.duration),f=Math.min(Math.round(y.loaded/a),g),s=g-f,e=s*Math.round(y.loaded/f);y.total=y.loaded+e}else y.total=Math.max(y.loaded,y.total);var u=y.loading,t=o.loading;u.start?u.first+=t.first-t.start:(u.start=t.start,u.first=t.first),u.end=t.end},d.resetLoader=function(n,i){n.loader=null,this.loader===i&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),i.destroy()},r}();function m(r,d){d===void 0&&(d=null);var n=d||r,i={frag:r,part:d,responseType:"arraybuffer",url:n.url,headers:{},rangeStart:0,rangeEnd:0},y=n.byteRangeStartOffset,o=n.byteRangeEndOffset;if((0,F.isFiniteNumber)(y)&&(0,F.isFiniteNumber)(o)){var a,g=y,f=o;if(r.sn==="initSegment"&&((a=r.decryptdata)===null||a===void 0?void 0:a.method)==="AES-128"){var s=o-y;s%16&&(f=o+(16-s%16)),y!==0&&(i.resetIV=!0,g=y-16)}i.rangeStart=g,i.rangeEnd=f}return i}var v=function(r){P(d,r);function d(n){for(var i,y=arguments.length,o=new Array(y>1?y-1:0),a=1;a<y;a++)o[a-1]=arguments[a];return i=r.call.apply(r,[this].concat(o))||this,i.data=void 0,i.data=n,i}return d}(I(Error))},"./src/loader/fragment.ts":(j,x,S)=>{S.r(x),S.d(x,{BaseSegment:()=>h,ElementaryStreamTypes:()=>E,Fragment:()=>m,Part:()=>v});var F=S("./src/polyfills/number.ts"),D=S("./node_modules/url-toolkit/src/url-toolkit.js"),P=S("./src/loader/load-stats.ts");function I(r,d){r.prototype=Object.create(d.prototype),r.prototype.constructor=r,_(r,d)}function _(r,d){return _=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,i){return n.__proto__=i,n},_(r,d)}function b(r,d){for(var n=0;n<d.length;n++){var i=d[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,A(i.key),i)}}function k(r,d,n){return d&&b(r.prototype,d),Object.defineProperty(r,"prototype",{writable:!1}),r}function A(r){var d=T(r,"string");return typeof d=="symbol"?d:String(d)}function T(r,d){if(typeof r!="object"||r===null)return r;var n=r[Symbol.toPrimitive];if(n!==void 0){var i=n.call(r,d);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(r)}var E;(function(r){r.AUDIO="audio",r.VIDEO="video",r.AUDIOVIDEO="audiovideo"})(E||(E={}));var h=function(){function r(n){var i;this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams=(i={},i[E.AUDIO]=null,i[E.VIDEO]=null,i[E.AUDIOVIDEO]=null,i),this.baseurl=n}var d=r.prototype;return d.setByteRange=function(n,i){var y=n.split("@",2),o=[];y.length===1?o[0]=i?i.byteRangeEndOffset:0:o[0]=parseInt(y[1]),o[1]=parseInt(y[0])+o[0],this._byteRange=o},k(r,[{key:"byteRange",get:function(){return this._byteRange?this._byteRange:[]}},{key:"byteRangeStartOffset",get:function(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function(){return this.byteRange[1]}},{key:"url",get:function(){return!this._url&&this.baseurl&&this.relurl&&(this._url=(0,D.buildAbsoluteURL)(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function(n){this._url=n}}]),r}(),m=function(r){I(d,r);function d(i,y){var o;return o=r.call(this,y)||this,o._decryptdata=null,o.rawProgramDateTime=null,o.programDateTime=null,o.tagList=[],o.duration=0,o.sn=0,o.levelkeys=void 0,o.type=void 0,o.loader=null,o.keyLoader=null,o.level=-1,o.cc=0,o.startPTS=void 0,o.endPTS=void 0,o.appendedPTS=void 0,o.startDTS=void 0,o.endDTS=void 0,o.start=0,o.deltaPTS=void 0,o.maxStartPTS=void 0,o.minEndPTS=void 0,o.stats=new P.LoadStats,o.urlId=0,o.data=void 0,o.bitrateTest=!1,o.title=null,o.initSegment=null,o.endList=void 0,o.type=i,o}var n=d.prototype;return n.setKeyFormat=function(i){if(this.levelkeys){var y=this.levelkeys[i];y&&!this._decryptdata&&(this._decryptdata=y.getDecryptData(this.sn))}},n.abortRequests=function(){var i,y;(i=this.loader)===null||i===void 0||i.abort(),(y=this.keyLoader)===null||y===void 0||y.abort()},n.setElementaryStreamInfo=function(i,y,o,a,g,f){f===void 0&&(f=!1);var s=this.elementaryStreams,e=s[i];if(!e){s[i]={startPTS:y,endPTS:o,startDTS:a,endDTS:g,partial:f};return}e.startPTS=Math.min(e.startPTS,y),e.endPTS=Math.max(e.endPTS,o),e.startDTS=Math.min(e.startDTS,a),e.endDTS=Math.max(e.endDTS,g)},n.clearElementaryStreamInfo=function(){var i=this.elementaryStreams;i[E.AUDIO]=null,i[E.VIDEO]=null,i[E.AUDIOVIDEO]=null},k(d,[{key:"decryptdata",get:function(){var i=this.levelkeys;if(!i&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){var y=this.levelkeys.identity;if(y)this._decryptdata=y.getDecryptData(this.sn);else{var o=Object.keys(this.levelkeys);if(o.length===1)return this._decryptdata=this.levelkeys[o[0]].getDecryptData(this.sn)}}return this._decryptdata}},{key:"end",get:function(){return this.start+this.duration}},{key:"endProgramDateTime",get:function(){if(this.programDateTime===null||!(0,F.isFiniteNumber)(this.programDateTime))return null;var i=(0,F.isFiniteNumber)(this.duration)?this.duration:0;return this.programDateTime+i*1e3}},{key:"encrypted",get:function(){var i;if((i=this._decryptdata)!==null&&i!==void 0&&i.encrypted)return!0;if(this.levelkeys){var y=Object.keys(this.levelkeys),o=y.length;if(o>1||o===1&&this.levelkeys[y[0]].encrypted)return!0}return!1}}]),d}(h),v=function(r){I(d,r);function d(n,i,y,o,a){var g;g=r.call(this,y)||this,g.fragOffset=0,g.duration=0,g.gap=!1,g.independent=!1,g.relurl=void 0,g.fragment=void 0,g.index=void 0,g.stats=new P.LoadStats,g.duration=n.decimalFloatingPoint("DURATION"),g.gap=n.bool("GAP"),g.independent=n.bool("INDEPENDENT"),g.relurl=n.enumeratedString("URI"),g.fragment=i,g.index=o;var f=n.enumeratedString("BYTERANGE");return f&&g.setByteRange(f,a),a&&(g.fragOffset=a.fragOffset+a.duration),g}return k(d,[{key:"start",get:function(){return this.fragment.start+this.fragOffset}},{key:"end",get:function(){return this.start+this.duration}},{key:"loaded",get:function(){var n=this.elementaryStreams;return!!(n.audio||n.video||n.audiovideo)}}]),d}(h)},"./src/loader/key-loader.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>P});var F=S("./src/errors.ts"),D=S("./src/loader/fragment-loader.ts"),P=function(){function I(b){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=b}var _=I.prototype;return _.abort=function(){for(var b in this.keyUriToKeyInfo){var k=this.keyUriToKeyInfo[b].loader;k&&k.abort()}},_.detach=function(){for(var b in this.keyUriToKeyInfo){var k=this.keyUriToKeyInfo[b];(k.mediaKeySessionContext||k.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[b]}},_.destroy=function(){this.detach();for(var b in this.keyUriToKeyInfo){var k=this.keyUriToKeyInfo[b].loader;k&&k.destroy()}this.keyUriToKeyInfo={}},_.createKeyLoadError=function(b,k,A,T){return k===void 0&&(k=F.ErrorDetails.KEY_LOAD_ERROR),new D.LoadError({type:F.ErrorTypes.NETWORK_ERROR,details:k,fatal:!1,frag:b,networkDetails:A})},_.loadClear=function(b,k){var A=this;if(this.emeController&&this.config.emeEnabled)for(var T=b.sn,E=b.cc,h=function(r){var d=k[r];if(E<=d.cc&&(T==="initSegment"||T<d.sn))return A.emeController.selectKeySystemFormat(d).then(function(n){d.setKeyFormat(n)}),"break"},m=0;m<k.length;m++){var v=h(m);if(v==="break")break}},_.load=function(b){var k=this;return!b.decryptdata&&b.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(b).then(function(A){return k.loadInternal(b,A)}):this.loadInternal(b)},_.loadInternal=function(b,k){var A,T;k&&b.setKeyFormat(k);var E=b.decryptdata;if(!E){var h=k?"Expected frag.decryptdata to be defined after setting format "+k:"Missing decryption data on fragment in onKeyLoading";return Promise.reject(this.createKeyLoadError(b,F.ErrorDetails.KEY_LOAD_ERROR,null,h))}var m=E.uri;if(!m)return Promise.reject(this.createKeyLoadError(b,F.ErrorDetails.KEY_LOAD_ERROR,null,'Invalid key URI: "'+m+'"'));var v=this.keyUriToKeyInfo[m];if((A=v)!==null&&A!==void 0&&A.decryptdata.key)return E.key=v.decryptdata.key,Promise.resolve({frag:b,keyInfo:v});if((T=v)!==null&&T!==void 0&&T.keyLoadPromise){var r;switch((r=v.mediaKeySessionContext)===null||r===void 0?void 0:r.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return v.keyLoadPromise.then(function(d){return E.key=d.keyInfo.decryptdata.key,{frag:b,keyInfo:v}})}}switch(v=this.keyUriToKeyInfo[m]={decryptdata:E,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},E.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return E.keyFormat==="identity"?this.loadKeyHTTP(v,b):this.loadKeyEME(v,b);case"AES-128":return this.loadKeyHTTP(v,b);default:return Promise.reject(this.createKeyLoadError(b,F.ErrorDetails.KEY_LOAD_ERROR,null,'Key supplied with unsupported METHOD: "'+E.method+'"'))}},_.loadKeyEME=function(b,k){var A={frag:k,keyInfo:b};if(this.emeController&&this.config.emeEnabled){var T=this.emeController.loadKey(A);if(T)return(b.keyLoadPromise=T.then(function(E){return b.mediaKeySessionContext=E,A})).catch(function(E){throw b.keyLoadPromise=null,E})}return Promise.resolve(A)},_.loadKeyHTTP=function(b,k){var A=this,T=this.config,E=T.loader,h=new E(T);return k.keyLoader=b.loader=h,b.keyLoadPromise=new Promise(function(m,v){var r={keyInfo:b,frag:k,responseType:"arraybuffer",url:b.decryptdata.uri},d={timeout:T.fragLoadingTimeOut,maxRetry:0,retryDelay:T.fragLoadingRetryDelay,maxRetryDelay:T.fragLoadingMaxRetryTimeout,highWaterMark:0},n={onSuccess:function(i,y,o,a){var g=o.frag,f=o.keyInfo,s=o.url;if(!g.decryptdata||f!==A.keyUriToKeyInfo[s])return v(A.createKeyLoadError(g,F.ErrorDetails.KEY_LOAD_ERROR,a,"after key load, decryptdata unset or changed"));f.decryptdata.key=g.decryptdata.key=new Uint8Array(i.data),g.keyLoader=null,f.loader=null,m({frag:g,keyInfo:f})},onError:function(i,y,o){A.resetLoader(y),v(A.createKeyLoadError(k,F.ErrorDetails.KEY_LOAD_ERROR,o))},onTimeout:function(i,y,o){A.resetLoader(y),v(A.createKeyLoadError(k,F.ErrorDetails.KEY_LOAD_TIMEOUT,o))},onAbort:function(i,y,o){A.resetLoader(y),v(A.createKeyLoadError(k,F.ErrorDetails.INTERNAL_ABORTED,o))}};h.load(r,d,n)})},_.resetLoader=function(b){var k=b.frag,A=b.keyInfo,T=b.url,E=A.loader;k.keyLoader===E&&(k.keyLoader=null,A.loader=null),delete this.keyUriToKeyInfo[T],E&&E.destroy()},I}()},"./src/loader/level-details.ts":(j,x,S)=>{S.r(x),S.d(x,{LevelDetails:()=>k});var F=S("./src/polyfills/number.ts");function D(A,T){for(var E=0;E<T.length;E++){var h=T[E];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(A,I(h.key),h)}}function P(A,T,E){return T&&D(A.prototype,T),Object.defineProperty(A,"prototype",{writable:!1}),A}function I(A){var T=_(A,"string");return typeof T=="symbol"?T:String(T)}function _(A,T){if(typeof A!="object"||A===null)return A;var E=A[Symbol.toPrimitive];if(E!==void 0){var h=E.call(A,T);if(typeof h!="object")return h;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(A)}var b=10,k=function(){function A(E){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=E}var T=A.prototype;return T.reloaded=function(E){if(!E){this.advanced=!0,this.updated=!0;return}var h=this.lastPartSn-E.lastPartSn,m=this.lastPartIndex-E.lastPartIndex;this.updated=this.endSN!==E.endSN||!!m||!!h,this.advanced=this.endSN>E.endSN||h>0||h===0&&m>0,this.updated||this.advanced?this.misses=Math.floor(E.misses*.6):this.misses=E.misses+1,this.availabilityDelay=E.availabilityDelay},P(A,[{key:"hasProgramDateTime",get:function(){return this.fragments.length?(0,F.isFiniteNumber)(this.fragments[this.fragments.length-1].programDateTime):!1}},{key:"levelTargetDuration",get:function(){return this.averagetargetduration||this.targetduration||b}},{key:"drift",get:function(){var E=this.driftEndTime-this.driftStartTime;if(E>0){var h=this.driftEnd-this.driftStart;return h*1e3/E}return 1}},{key:"edge",get:function(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function(){var E;return(E=this.partList)!==null&&E!==void 0&&E.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function(){var E;return(E=this.fragments)!==null&&E!==void 0&&E.length?this.fragments[this.fragments.length-1].end:0}},{key:"age",get:function(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function(){var E;return(E=this.partList)!==null&&E!==void 0&&E.length?this.partList[this.partList.length-1].index:-1}},{key:"lastPartSn",get:function(){var E;return(E=this.partList)!==null&&E!==void 0&&E.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}]),A}()},"./src/loader/level-key.ts":(j,x,S)=>{S.r(x),S.d(x,{LevelKey:()=>k});var F=S("./src/utils/keysystem-util.ts"),D=S("./src/utils/mediakeys-helper.ts"),P=S("./src/utils/mp4-tools.ts"),I=S("./src/utils/logger.ts"),_=S("./src/utils/numeric-encoding-utils.ts"),b={},k=function(){T.clearKeyUriToKeyIdMap=function(){b={}};function T(h,m,v,r,d){r===void 0&&(r=[1]),d===void 0&&(d=null),this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=h,this.uri=m,this.keyFormat=v,this.keyFormatVersions=r,this.iv=d,this.encrypted=h?h!=="NONE":!1,this.isCommonEncryption=this.encrypted&&h!=="AES-128"}var E=T.prototype;return E.isSupported=function(){if(this.method){if(this.method==="AES-128"||this.method==="NONE")return!0;switch(this.keyFormat){case"identity":return this.method==="SAMPLE-AES";case D.KeySystemFormats.FAIRPLAY:case D.KeySystemFormats.WIDEVINE:case D.KeySystemFormats.PLAYREADY:case D.KeySystemFormats.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1},E.getDecryptData=function(h){if(!this.encrypted||!this.uri)return null;if(this.method==="AES-128"&&this.uri&&!this.iv){typeof h!="number"&&(this.method==="AES-128"&&!this.iv&&I.logger.warn('missing IV for initialization segment with method="'+this.method+'" - compliance issue'),h=0);var m=A(h),v=new T(this.method,this.uri,"identity",this.keyFormatVersions,m);return v}var r=(0,F.convertDataUriToArrayBytes)(this.uri);if(r)switch(this.keyFormat){case D.KeySystemFormats.WIDEVINE:this.pssh=r,r.length>=22&&(this.keyId=r.subarray(r.length-22,r.length-6));break;case D.KeySystemFormats.PLAYREADY:{var d=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=(0,P.mp4pssh)(d,null,r);var n=new Uint16Array(r.buffer,r.byteOffset,r.byteLength/2),i=String.fromCharCode.apply(null,Array.from(n)),y=i.substring(i.indexOf("<"),i.length),o=new DOMParser,a=o.parseFromString(y,"text/xml"),g=a.getElementsByTagName("KID")[0];if(g){var f=g.childNodes[0]?g.childNodes[0].nodeValue:g.getAttribute("VALUE");if(f){var s=(0,_.base64Decode)(f).subarray(0,16);(0,F.changeEndianness)(s),this.keyId=s}}break}default:{var e=r.subarray(0,16);if(e.length!==16){var u=new Uint8Array(16);u.set(e,16-e.length),e=u}this.keyId=e;break}}if(!this.keyId||this.keyId.byteLength!==16){var t=b[this.uri];if(!t){var l=Object.keys(b).length%Number.MAX_SAFE_INTEGER;t=new Uint8Array(16);var p=new DataView(t.buffer,12,4);p.setUint32(0,l),b[this.uri]=t}this.keyId=t}return this},T}();function A(T){for(var E=new Uint8Array(16),h=12;h<16;h++)E[h]=T>>8*(15-h)&255;return E}},"./src/loader/load-stats.ts":(j,x,S)=>{S.r(x),S.d(x,{LoadStats:()=>F});var F=function(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}},"./src/loader/m3u8-parser.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>d});var F=S("./src/polyfills/number.ts"),D=S("./node_modules/url-toolkit/src/url-toolkit.js"),P=S("./src/loader/date-range.ts"),I=S("./src/loader/fragment.ts"),_=S("./src/loader/level-details.ts"),b=S("./src/loader/level-key.ts"),k=S("./src/utils/attr-list.ts"),A=S("./src/utils/logger.ts"),T=S("./src/utils/codecs.ts");function E(){return E=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var u=arguments[e];for(var t in u)Object.prototype.hasOwnProperty.call(u,t)&&(s[t]=u[t])}return s},E.apply(this,arguments)}var h=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-SESSION-DATA:([^\r\n]*)[\r\n]+|#EXT-X-SESSION-KEY:([^\n\r]*)[\r\n]+/g,m=/#EXT-X-MEDIA:(.*)/g,v=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),r=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),d=function(){function s(){}return s.findGroup=function(e,u){for(var t=0;t<e.length;t++){var l=e[t];if(l.id===u)return l}},s.convertAVC1ToAVCOTI=function(e){var u=e.split(".");if(u.length>2){var t=u.shift()+".";return t+=parseInt(u.shift()).toString(16),t+=("000"+parseInt(u.shift()).toString(16)).slice(-4),t}return e},s.resolve=function(e,u){return(0,D.buildAbsoluteURL)(u,e,{alwaysNormalize:!0})},s.parseMasterPlaylist=function(e,u){var t=[],l=[],p={},c=[],L=!1;h.lastIndex=0;for(var R;(R=h.exec(e))!=null;)if(R[1]){var w,O=new k.AttrList(R[1]),C={attrs:O,bitrate:O.decimalInteger("AVERAGE-BANDWIDTH")||O.decimalInteger("BANDWIDTH"),name:O.NAME,url:s.resolve(R[2],u)},M=O.decimalResolution("RESOLUTION");M&&(C.width=M.width,C.height=M.height),i((O.CODECS||"").split(/[ ,]+/).filter(function(K){return K}),C),C.videoCodec&&C.videoCodec.indexOf("avc1")!==-1&&(C.videoCodec=s.convertAVC1ToAVCOTI(C.videoCodec)),(w=C.unknownCodecs)!==null&&w!==void 0&&w.length||l.push(C),t.push(C)}else if(R[3]){var N=new k.AttrList(R[3]);N["DATA-ID"]&&(L=!0,p[N["DATA-ID"]]=N)}else if(R[4]){var U=R[4],B=n(U,u);B.encrypted&&B.isSupported()?c.push(B):A.logger.warn('[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "'+U+'"')}var G=l.length>0&&l.length<t.length;return{levels:G?l:t,sessionData:L?p:null,sessionKeys:c.length?c:null}},s.parseMasterPlaylistMedia=function(e,u,t,l){l===void 0&&(l=[]);var p,c=[],L=0;for(m.lastIndex=0;(p=m.exec(e))!==null;){var R=new k.AttrList(p[1]);if(R.TYPE===t){var w={attrs:R,bitrate:0,id:L++,groupId:R["GROUP-ID"],instreamId:R["INSTREAM-ID"],name:R.NAME||R.LANGUAGE||"",type:t,default:R.bool("DEFAULT"),autoselect:R.bool("AUTOSELECT"),forced:R.bool("FORCED"),lang:R.LANGUAGE,url:R.URI?s.resolve(R.URI,u):""};if(l.length){var O=s.findGroup(l,w.groupId)||l[0];y(w,O,"audioCodec"),y(w,O,"textCodec")}c.push(w)}}return c},s.parseLevelPlaylist=function(e,u,t,l,p){var c=new _.LevelDetails(u),L=c.fragments,R=null,w=0,O=0,C=0,M=0,N=null,U=new I.Fragment(l,u),B,G,K,Y=-1,q=!1;for(v.lastIndex=0,c.m3u8=e;(B=v.exec(e))!==null;){q&&(q=!1,U=new I.Fragment(l,u),U.start=C,U.sn=w,U.cc=M,U.level=t,R&&(U.initSegment=R,U.rawProgramDateTime=R.rawProgramDateTime,R.rawProgramDateTime=null));var H=B[1];if(H){U.duration=parseFloat(H);var V=(" "+B[2]).slice(1);U.title=V||null,U.tagList.push(V?["INF",H,V]:["INF",H])}else if(B[3])(0,F.isFiniteNumber)(U.duration)&&(U.start=C,K&&f(U,K,c),U.sn=w,U.level=t,U.cc=M,U.urlId=p,L.push(U),U.relurl=(" "+B[3]).slice(1),a(U,N),N=U,C+=U.duration,w++,O=0,q=!0);else if(B[4]){var z=(" "+B[4]).slice(1);N?U.setByteRange(z,N):U.setByteRange(z)}else if(B[5])U.rawProgramDateTime=(" "+B[5]).slice(1),U.tagList.push(["PROGRAM-DATE-TIME",U.rawProgramDateTime]),Y===-1&&(Y=L.length);else{if(B=B[0].match(r),!B){A.logger.warn("No matches on slow regex match for level playlist!");continue}for(G=1;G<B.length&&!(typeof B[G]<"u");G++);var X=(" "+B[G]).slice(1),W=(" "+B[G+1]).slice(1),Q=B[G+2]?(" "+B[G+2]).slice(1):"";switch(X){case"PLAYLIST-TYPE":c.type=W.toUpperCase();break;case"MEDIA-SEQUENCE":w=c.startSN=parseInt(W);break;case"SKIP":{var J=new k.AttrList(W),$=J.decimalInteger("SKIPPED-SEGMENTS");if((0,F.isFiniteNumber)($)){c.skippedSegments=$;for(var ot=$;ot--;)L.unshift(null);w+=$}var it=J.enumeratedString("RECENTLY-REMOVED-DATERANGES");it&&(c.recentlyRemovedDateranges=it.split("	"));break}case"TARGETDURATION":c.targetduration=parseFloat(W);break;case"VERSION":c.version=parseInt(W);break;case"EXTM3U":break;case"ENDLIST":c.live=!1;break;case"#":(W||Q)&&U.tagList.push(Q?[W,Q]:[W]);break;case"DISCONTINUITY":M++,U.tagList.push(["DIS"]);break;case"GAP":U.tagList.push([X]);break;case"BITRATE":U.tagList.push([X,W]);break;case"DATERANGE":{var Z=new k.AttrList(W),tt=new P.DateRange(Z,c.dateRanges[Z.ID]);tt.isValid||c.skippedSegments?c.dateRanges[tt.id]=tt:A.logger.warn('Ignoring invalid DATERANGE tag: "'+W+'"'),U.tagList.push(["EXT-X-DATERANGE",W]);break}case"DISCONTINUITY-SEQUENCE":M=parseInt(W);break;case"KEY":{var et=n(W,u);if(et.isSupported()){if(et.method==="NONE"){K=void 0;break}K||(K={}),K[et.keyFormat]&&(K=E({},K)),K[et.keyFormat]=et}else A.logger.warn('[Keys] Ignoring invalid EXT-X-KEY tag: "'+W+'"');break}case"START":{var nt=new k.AttrList(W),at=nt.decimalFloatingPoint("TIME-OFFSET");(0,F.isFiniteNumber)(at)&&(c.startTimeOffset=at);break}case"MAP":{var st=new k.AttrList(W);if(U.duration){var ft=new I.Fragment(l,u);g(ft,st,t,K),R=ft,U.initSegment=R,R.rawProgramDateTime&&!U.rawProgramDateTime&&(U.rawProgramDateTime=R.rawProgramDateTime)}else g(U,st,t,K),R=U,q=!0;break}case"SERVER-CONTROL":{var rt=new k.AttrList(W);c.canBlockReload=rt.bool("CAN-BLOCK-RELOAD"),c.canSkipUntil=rt.optionalFloat("CAN-SKIP-UNTIL",0),c.canSkipDateRanges=c.canSkipUntil>0&&rt.bool("CAN-SKIP-DATERANGES"),c.partHoldBack=rt.optionalFloat("PART-HOLD-BACK",0),c.holdBack=rt.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{var bt=new k.AttrList(W);c.partTarget=bt.decimalFloatingPoint("PART-TARGET");break}case"PART":{var ct=c.partList;ct||(ct=c.partList=[]);var At=O>0?ct[ct.length-1]:void 0,Lt=O++,gt=new I.Part(new k.AttrList(W),U,u,Lt,At);ct.push(gt),U.duration+=gt.duration;break}case"PRELOAD-HINT":{var Et=new k.AttrList(W);c.preloadHint=Et;break}case"RENDITION-REPORT":{var lt=new k.AttrList(W);c.renditionReports=c.renditionReports||[],c.renditionReports.push(lt);break}default:A.logger.warn("line parsed but not handled: "+B);break}}}N&&!N.relurl?(L.pop(),C-=N.duration,c.partList&&(c.fragmentHint=N)):c.partList&&(a(U,N),U.cc=M,c.fragmentHint=U,K&&f(U,K,c));var ut=L.length,Tt=L[0],pt=L[ut-1];if(C+=c.skippedSegments*c.targetduration,C>0&&ut&&pt){c.averagetargetduration=C/ut;var St=pt.sn;c.endSN=St!=="initSegment"?St:0,c.live||(pt.endList=!0),Tt&&(c.startCC=Tt.cc)}else c.endSN=0,c.startCC=0;return c.fragmentHint&&(C+=c.fragmentHint.duration),c.totalduration=C,c.endCC=M,Y>0&&o(L,Y),c},s}();function n(s,e){var u,t,l=new k.AttrList(s),p=(u=l.enumeratedString("METHOD"))!=null?u:"",c=l.URI,L=l.hexadecimalInteger("IV"),R=l.enumeratedString("KEYFORMATVERSIONS"),w=(t=l.enumeratedString("KEYFORMAT"))!=null?t:"identity";c&&l.IV&&!L&&A.logger.error("Invalid IV: "+l.IV);var O=c?d.resolve(c,e):"",C=(R||"1").split("/").map(Number).filter(Number.isFinite);return new b.LevelKey(p,O,w,C,L)}function i(s,e){["video","audio","text"].forEach(function(u){var t=s.filter(function(p){return(0,T.isCodecType)(p,u)});if(t.length){var l=t.filter(function(p){return p.lastIndexOf("avc1",0)===0||p.lastIndexOf("mp4a",0)===0});e[u+"Codec"]=l.length>0?l[0]:t[0],s=s.filter(function(p){return t.indexOf(p)===-1})}}),e.unknownCodecs=s}function y(s,e,u){var t=e[u];t&&(s[u]=t)}function o(s,e){for(var u=s[e],t=e;t--;){var l=s[t];if(!l)return;l.programDateTime=u.programDateTime-l.duration*1e3,u=l}}function a(s,e){s.rawProgramDateTime?s.programDateTime=Date.parse(s.rawProgramDateTime):e!=null&&e.programDateTime&&(s.programDateTime=e.endProgramDateTime),(0,F.isFiniteNumber)(s.programDateTime)||(s.programDateTime=null,s.rawProgramDateTime=null)}function g(s,e,u,t){s.relurl=e.URI,e.BYTERANGE&&s.setByteRange(e.BYTERANGE),s.level=u,s.sn="initSegment",t&&(s.levelkeys=t),s.initSegment=null}function f(s,e,u){s.levelkeys=e;var t=u.encryptedFragments;(!t.length||t[t.length-1].levelkeys!==e)&&Object.keys(e).some(function(l){return e[l].isCommonEncryption})&&t.push(s)}},"./src/loader/playlist-loader.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>h});var F=S("./src/polyfills/number.ts"),D=S("./src/events.ts"),P=S("./src/errors.ts"),I=S("./src/utils/logger.ts"),_=S("./src/loader/m3u8-parser.ts"),b=S("./src/types/loader.ts"),k=S("./src/utils/attr-list.ts");function A(m){var v=m.type;switch(v){case b.PlaylistContextType.AUDIO_TRACK:return b.PlaylistLevelType.AUDIO;case b.PlaylistContextType.SUBTITLE_TRACK:return b.PlaylistLevelType.SUBTITLE;default:return b.PlaylistLevelType.MAIN}}function T(m,v){var r=m.url;return(r===void 0||r.indexOf("data:")===0)&&(r=v.url),r}var E=function(){function m(r){this.hls=void 0,this.loaders=Object.create(null),this.hls=r,this.registerListeners()}var v=m.prototype;return v.startLoad=function(r){},v.stopLoad=function(){this.destroyInternalLoaders()},v.registerListeners=function(){var r=this.hls;r.on(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),r.on(D.Events.LEVEL_LOADING,this.onLevelLoading,this),r.on(D.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),r.on(D.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},v.unregisterListeners=function(){var r=this.hls;r.off(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),r.off(D.Events.LEVEL_LOADING,this.onLevelLoading,this),r.off(D.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),r.off(D.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},v.createInternalLoader=function(r){var d=this.hls.config,n=d.pLoader,i=d.loader,y=n||i,o=new y(d);return r.loader=o,this.loaders[r.type]=o,o},v.getInternalLoader=function(r){return this.loaders[r.type]},v.resetInternalLoader=function(r){this.loaders[r]&&delete this.loaders[r]},v.destroyInternalLoaders=function(){for(var r in this.loaders){var d=this.loaders[r];d&&d.destroy(),this.resetInternalLoader(r)}},v.destroy=function(){this.unregisterListeners(),this.destroyInternalLoaders()},v.onManifestLoading=function(r,d){var n=d.url;this.load({id:null,groupId:null,level:0,responseType:"text",type:b.PlaylistContextType.MANIFEST,url:n,deliveryDirectives:null})},v.onLevelLoading=function(r,d){var n=d.id,i=d.level,y=d.url,o=d.deliveryDirectives;this.load({id:n,groupId:null,level:i,responseType:"text",type:b.PlaylistContextType.LEVEL,url:y,deliveryDirectives:o})},v.onAudioTrackLoading=function(r,d){var n=d.id,i=d.groupId,y=d.url,o=d.deliveryDirectives;this.load({id:n,groupId:i,level:null,responseType:"text",type:b.PlaylistContextType.AUDIO_TRACK,url:y,deliveryDirectives:o})},v.onSubtitleTrackLoading=function(r,d){var n=d.id,i=d.groupId,y=d.url,o=d.deliveryDirectives;this.load({id:n,groupId:i,level:null,responseType:"text",type:b.PlaylistContextType.SUBTITLE_TRACK,url:y,deliveryDirectives:o})},v.load=function(r){var d,n=this.hls.config,i=this.getInternalLoader(r);if(i){var y=i.context;if(y&&y.url===r.url){I.logger.trace("[playlist-loader]: playlist request ongoing");return}I.logger.log("[playlist-loader]: aborting previous loader for type: "+r.type),i.abort()}var o,a,g,f;switch(r.type){case b.PlaylistContextType.MANIFEST:o=n.manifestLoadingMaxRetry,a=n.manifestLoadingTimeOut,g=n.manifestLoadingRetryDelay,f=n.manifestLoadingMaxRetryTimeout;break;case b.PlaylistContextType.LEVEL:case b.PlaylistContextType.AUDIO_TRACK:case b.PlaylistContextType.SUBTITLE_TRACK:o=0,a=n.levelLoadingTimeOut;break;default:o=n.levelLoadingMaxRetry,a=n.levelLoadingTimeOut,g=n.levelLoadingRetryDelay,f=n.levelLoadingMaxRetryTimeout;break}if(i=this.createInternalLoader(r),(d=r.deliveryDirectives)!==null&&d!==void 0&&d.part){var s;if(r.type===b.PlaylistContextType.LEVEL&&r.level!==null?s=this.hls.levels[r.level].details:r.type===b.PlaylistContextType.AUDIO_TRACK&&r.id!==null?s=this.hls.audioTracks[r.id].details:r.type===b.PlaylistContextType.SUBTITLE_TRACK&&r.id!==null&&(s=this.hls.subtitleTracks[r.id].details),s){var e=s.partTarget,u=s.targetduration;e&&u&&(a=Math.min(Math.max(e*3,u*.8)*1e3,a))}}var t={timeout:a,maxRetry:o,retryDelay:g,maxRetryDelay:f,highWaterMark:0},l={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};i.load(r,t,l)},v.loadsuccess=function(r,d,n,i){i===void 0&&(i=null),this.resetInternalLoader(n.type);var y=r.data;if(y.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(r,n,"no EXTM3U delimiter",i);return}d.parsing.start=performance.now(),y.indexOf("#EXTINF:")>0||y.indexOf("#EXT-X-TARGETDURATION:")>0?this.handleTrackOrLevelPlaylist(r,d,n,i):this.handleMasterPlaylist(r,d,n,i)},v.loaderror=function(r,d,n){n===void 0&&(n=null),this.handleNetworkError(d,n,!1,r)},v.loadtimeout=function(r,d,n){n===void 0&&(n=null),this.handleNetworkError(d,n,!0)},v.handleMasterPlaylist=function(r,d,n,i){var y=this.hls,o=r.data,a=T(r,n),g=_.default.parseMasterPlaylist(o,a),f=g.levels,s=g.sessionData,e=g.sessionKeys;if(!f.length){this.handleManifestParsingError(r,n,"no level found in manifest",i);return}var u=f.map(function(R){return{id:R.attrs.AUDIO,audioCodec:R.audioCodec}}),t=f.map(function(R){return{id:R.attrs.SUBTITLES,textCodec:R.textCodec}}),l=_.default.parseMasterPlaylistMedia(o,a,"AUDIO",u),p=_.default.parseMasterPlaylistMedia(o,a,"SUBTITLES",t),c=_.default.parseMasterPlaylistMedia(o,a,"CLOSED-CAPTIONS");if(l.length){var L=l.some(function(R){return!R.url});!L&&f[0].audioCodec&&!f[0].attrs.AUDIO&&(I.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),l.unshift({type:"main",name:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new k.AttrList({}),bitrate:0,url:""}))}y.trigger(D.Events.MANIFEST_LOADED,{levels:f,audioTracks:l,subtitles:p,captions:c,url:a,stats:d,networkDetails:i,sessionData:s,sessionKeys:e})},v.handleTrackOrLevelPlaylist=function(r,d,n,i){var y=this.hls,o=n.id,a=n.level,g=n.type,f=T(r,n),s=(0,F.isFiniteNumber)(o)?o:0,e=(0,F.isFiniteNumber)(a)?a:s,u=A(n),t=_.default.parseLevelPlaylist(r.data,f,e,u,s);if(!t.fragments.length){y.trigger(D.Events.ERROR,{type:P.ErrorTypes.NETWORK_ERROR,details:P.ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url:f,reason:"no fragments found in level",level:typeof n.level=="number"?n.level:void 0});return}if(g===b.PlaylistContextType.MANIFEST){var l={attrs:new k.AttrList({}),bitrate:0,details:t,name:"",url:f};y.trigger(D.Events.MANIFEST_LOADED,{levels:[l],audioTracks:[],url:f,stats:d,networkDetails:i,sessionData:null,sessionKeys:null})}d.parsing.end=performance.now(),n.levelDetails=t,this.handlePlaylistLoaded(r,d,n,i)},v.handleManifestParsingError=function(r,d,n,i){this.hls.trigger(D.Events.ERROR,{type:P.ErrorTypes.NETWORK_ERROR,details:P.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:d.type===b.PlaylistContextType.MANIFEST,url:r.url,reason:n,response:r,context:d,networkDetails:i})},v.handleNetworkError=function(r,d,n,i){n===void 0&&(n=!1),I.logger.warn("[playlist-loader]: A network "+(n?"timeout":"error")+" occurred while loading "+r.type+" level: "+r.level+" id: "+r.id+' group-id: "'+r.groupId+'"');var y=P.ErrorDetails.UNKNOWN,o=!1,a=this.getInternalLoader(r);switch(r.type){case b.PlaylistContextType.MANIFEST:y=n?P.ErrorDetails.MANIFEST_LOAD_TIMEOUT:P.ErrorDetails.MANIFEST_LOAD_ERROR,o=!0;break;case b.PlaylistContextType.LEVEL:y=n?P.ErrorDetails.LEVEL_LOAD_TIMEOUT:P.ErrorDetails.LEVEL_LOAD_ERROR,o=!1;break;case b.PlaylistContextType.AUDIO_TRACK:y=n?P.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:P.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,o=!1;break;case b.PlaylistContextType.SUBTITLE_TRACK:y=n?P.ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:P.ErrorDetails.SUBTITLE_LOAD_ERROR,o=!1;break}a&&this.resetInternalLoader(r.type);var g={type:P.ErrorTypes.NETWORK_ERROR,details:y,fatal:o,url:r.url,loader:a,context:r,networkDetails:d};i&&(g.response=i),this.hls.trigger(D.Events.ERROR,g)},v.handlePlaylistLoaded=function(r,d,n,i){var y=n.type,o=n.level,a=n.id,g=n.groupId,f=n.loader,s=n.levelDetails,e=n.deliveryDirectives;if(!(s!=null&&s.targetduration)){this.handleManifestParsingError(r,n,"invalid target duration",i);return}if(f)switch(s.live&&(f.getCacheAge&&(s.ageHeader=f.getCacheAge()||0),(!f.getCacheAge||isNaN(s.ageHeader))&&(s.ageHeader=0)),y){case b.PlaylistContextType.MANIFEST:case b.PlaylistContextType.LEVEL:this.hls.trigger(D.Events.LEVEL_LOADED,{details:s,level:o||0,id:a||0,stats:d,networkDetails:i,deliveryDirectives:e});break;case b.PlaylistContextType.AUDIO_TRACK:this.hls.trigger(D.Events.AUDIO_TRACK_LOADED,{details:s,id:a||0,groupId:g||"",stats:d,networkDetails:i,deliveryDirectives:e});break;case b.PlaylistContextType.SUBTITLE_TRACK:this.hls.trigger(D.Events.SUBTITLE_TRACK_LOADED,{details:s,id:a||0,groupId:g||"",stats:d,networkDetails:i,deliveryDirectives:e});break}},m}();const h=E},"./src/polyfills/number.ts":(j,x,S)=>{S.r(x),S.d(x,{MAX_SAFE_INTEGER:()=>D,isFiniteNumber:()=>F});var F=Number.isFinite||function(P){return typeof P=="number"&&isFinite(P)},D=Number.MAX_SAFE_INTEGER||9007199254740991},"./src/remux/aac-helper.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>D});var F=function(){function P(){}return P.getSilentFrame=function(I,_){switch(I){case"mp4a.40.2":if(_===1)return new Uint8Array([0,200,0,128,35,128]);if(_===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(_===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(_===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(_===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(_===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(_===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(_===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(_===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}},P}();const D=F},"./src/remux/mp4-generator.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>P});var F=Math.pow(2,32)-1,D=function(){function I(){}return I.init=function(){I.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var _;for(_ in I.types)I.types.hasOwnProperty(_)&&(I.types[_]=[_.charCodeAt(0),_.charCodeAt(1),_.charCodeAt(2),_.charCodeAt(3)]);var b=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),k=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);I.HDLR_TYPES={video:b,audio:k};var A=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),T=new Uint8Array([0,0,0,0,0,0,0,0]);I.STTS=I.STSC=I.STCO=T,I.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),I.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),I.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),I.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var E=new Uint8Array([105,115,111,109]),h=new Uint8Array([97,118,99,49]),m=new Uint8Array([0,0,0,1]);I.FTYP=I.box(I.types.ftyp,E,m,E,h),I.DINF=I.box(I.types.dinf,I.box(I.types.dref,A))},I.box=function(_){for(var b=8,k=arguments.length,A=new Array(k>1?k-1:0),T=1;T<k;T++)A[T-1]=arguments[T];for(var E=A.length,h=E;E--;)b+=A[E].byteLength;var m=new Uint8Array(b);for(m[0]=b>>24&255,m[1]=b>>16&255,m[2]=b>>8&255,m[3]=b&255,m.set(_,4),E=0,b=8;E<h;E++)m.set(A[E],b),b+=A[E].byteLength;return m},I.hdlr=function(_){return I.box(I.types.hdlr,I.HDLR_TYPES[_])},I.mdat=function(_){return I.box(I.types.mdat,_)},I.mdhd=function(_,b){b*=_;var k=Math.floor(b/(F+1)),A=Math.floor(b%(F+1));return I.box(I.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,_>>24&255,_>>16&255,_>>8&255,_&255,k>>24,k>>16&255,k>>8&255,k&255,A>>24,A>>16&255,A>>8&255,A&255,85,196,0,0]))},I.mdia=function(_){return I.box(I.types.mdia,I.mdhd(_.timescale,_.duration),I.hdlr(_.type),I.minf(_))},I.mfhd=function(_){return I.box(I.types.mfhd,new Uint8Array([0,0,0,0,_>>24,_>>16&255,_>>8&255,_&255]))},I.minf=function(_){return _.type==="audio"?I.box(I.types.minf,I.box(I.types.smhd,I.SMHD),I.DINF,I.stbl(_)):I.box(I.types.minf,I.box(I.types.vmhd,I.VMHD),I.DINF,I.stbl(_))},I.moof=function(_,b,k){return I.box(I.types.moof,I.mfhd(_),I.traf(k,b))},I.moov=function(_){for(var b=_.length,k=[];b--;)k[b]=I.trak(_[b]);return I.box.apply(null,[I.types.moov,I.mvhd(_[0].timescale,_[0].duration)].concat(k).concat(I.mvex(_)))},I.mvex=function(_){for(var b=_.length,k=[];b--;)k[b]=I.trex(_[b]);return I.box.apply(null,[I.types.mvex].concat(k))},I.mvhd=function(_,b){b*=_;var k=Math.floor(b/(F+1)),A=Math.floor(b%(F+1)),T=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,_>>24&255,_>>16&255,_>>8&255,_&255,k>>24,k>>16&255,k>>8&255,k&255,A>>24,A>>16&255,A>>8&255,A&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return I.box(I.types.mvhd,T)},I.sdtp=function(_){var b=_.samples||[],k=new Uint8Array(4+b.length),A,T;for(A=0;A<b.length;A++)T=b[A].flags,k[A+4]=T.dependsOn<<4|T.isDependedOn<<2|T.hasRedundancy;return I.box(I.types.sdtp,k)},I.stbl=function(_){return I.box(I.types.stbl,I.stsd(_),I.box(I.types.stts,I.STTS),I.box(I.types.stsc,I.STSC),I.box(I.types.stsz,I.STSZ),I.box(I.types.stco,I.STCO))},I.avc1=function(_){var b=[],k=[],A,T,E;for(A=0;A<_.sps.length;A++)T=_.sps[A],E=T.byteLength,b.push(E>>>8&255),b.push(E&255),b=b.concat(Array.prototype.slice.call(T));for(A=0;A<_.pps.length;A++)T=_.pps[A],E=T.byteLength,k.push(E>>>8&255),k.push(E&255),k=k.concat(Array.prototype.slice.call(T));var h=I.box(I.types.avcC,new Uint8Array([1,b[3],b[4],b[5],255,224|_.sps.length].concat(b).concat([_.pps.length]).concat(k))),m=_.width,v=_.height,r=_.pixelRatio[0],d=_.pixelRatio[1];return I.box(I.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,m>>8&255,m&255,v>>8&255,v&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),h,I.box(I.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),I.box(I.types.pasp,new Uint8Array([r>>24,r>>16&255,r>>8&255,r&255,d>>24,d>>16&255,d>>8&255,d&255])))},I.esds=function(_){var b=_.config.length;return new Uint8Array([0,0,0,0,3,23+b,0,1,0,4,15+b,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([b]).concat(_.config).concat([6,1,2]))},I.mp4a=function(_){var b=_.samplerate;return I.box(I.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,_.channelCount,0,16,0,0,0,0,b>>8&255,b&255,0,0]),I.box(I.types.esds,I.esds(_)))},I.mp3=function(_){var b=_.samplerate;return I.box(I.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,_.channelCount,0,16,0,0,0,0,b>>8&255,b&255,0,0]))},I.stsd=function(_){return _.type==="audio"?_.segmentCodec==="mp3"&&_.codec==="mp3"?I.box(I.types.stsd,I.STSD,I.mp3(_)):I.box(I.types.stsd,I.STSD,I.mp4a(_)):I.box(I.types.stsd,I.STSD,I.avc1(_))},I.tkhd=function(_){var b=_.id,k=_.duration*_.timescale,A=_.width,T=_.height,E=Math.floor(k/(F+1)),h=Math.floor(k%(F+1));return I.box(I.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,b>>24&255,b>>16&255,b>>8&255,b&255,0,0,0,0,E>>24,E>>16&255,E>>8&255,E&255,h>>24,h>>16&255,h>>8&255,h&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,A>>8&255,A&255,0,0,T>>8&255,T&255,0,0]))},I.traf=function(_,b){var k=I.sdtp(_),A=_.id,T=Math.floor(b/(F+1)),E=Math.floor(b%(F+1));return I.box(I.types.traf,I.box(I.types.tfhd,new Uint8Array([0,0,0,0,A>>24,A>>16&255,A>>8&255,A&255])),I.box(I.types.tfdt,new Uint8Array([1,0,0,0,T>>24,T>>16&255,T>>8&255,T&255,E>>24,E>>16&255,E>>8&255,E&255])),I.trun(_,k.length+16+20+8+16+8+8),k)},I.trak=function(_){return _.duration=_.duration||4294967295,I.box(I.types.trak,I.tkhd(_),I.mdia(_))},I.trex=function(_){var b=_.id;return I.box(I.types.trex,new Uint8Array([0,0,0,0,b>>24,b>>16&255,b>>8&255,b&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},I.trun=function(_,b){var k=_.samples||[],A=k.length,T=12+16*A,E=new Uint8Array(T),h,m,v,r,d,n;for(b+=8+T,E.set([_.type==="video"?1:0,0,15,1,A>>>24&255,A>>>16&255,A>>>8&255,A&255,b>>>24&255,b>>>16&255,b>>>8&255,b&255],0),h=0;h<A;h++)m=k[h],v=m.duration,r=m.size,d=m.flags,n=m.cts,E.set([v>>>24&255,v>>>16&255,v>>>8&255,v&255,r>>>24&255,r>>>16&255,r>>>8&255,r&255,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,d.degradPrio&61440,d.degradPrio&15,n>>>24&255,n>>>16&255,n>>>8&255,n&255],12+16*h);return I.box(I.types.trun,E)},I.initSegment=function(_){I.types||I.init();var b=I.moov(_),k=new Uint8Array(I.FTYP.byteLength+b.byteLength);return k.set(I.FTYP),k.set(b,I.FTYP.byteLength),k},I}();D.types=void 0,D.HDLR_TYPES=void 0,D.STTS=void 0,D.STSC=void 0,D.STCO=void 0,D.STSZ=void 0,D.VMHD=void 0,D.SMHD=void 0,D.STSD=void 0,D.FTYP=void 0,D.DINF=void 0;const P=D},"./src/remux/mp4-remuxer.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>d,flushTextTrackMetadataCueSamples:()=>y,flushTextTrackUserdataCueSamples:()=>o,normalizePts:()=>n});var F=S("./src/polyfills/number.ts"),D=S("./src/remux/aac-helper.ts"),P=S("./src/remux/mp4-generator.ts"),I=S("./src/events.ts"),_=S("./src/errors.ts"),b=S("./src/utils/logger.ts"),k=S("./src/types/loader.ts"),A=S("./src/utils/timescale-conversion.ts");function T(){return T=Object.assign?Object.assign.bind():function(f){for(var s=1;s<arguments.length;s++){var e=arguments[s];for(var u in e)Object.prototype.hasOwnProperty.call(e,u)&&(f[u]=e[u])}return f},T.apply(this,arguments)}var E=10*1e3,h=1024,m=1152,v=null,r=null,d=function(){function f(e,u,t,l){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=void 0,this._initDTS=void 0,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=e,this.config=u,this.typeSupported=t,this.ISGenerated=!1,v===null){var p=navigator.userAgent||"",c=p.match(/Chrome\/(\d+)/i);v=c?parseInt(c[1]):0}if(r===null){var L=navigator.userAgent.match(/Safari\/(\d+)/i);r=L?parseInt(L[1]):0}}var s=f.prototype;return s.destroy=function(){},s.resetTimeStamp=function(e){b.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e},s.resetNextTimestamp=function(){b.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1},s.resetInitSegment=function(){b.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1},s.getVideoStartPts=function(e){var u=!1,t=e.reduce(function(l,p){var c=p.pts-l;return c<-4294967296?(u=!0,n(l,p.pts)):c>0?l:p.pts},e[0].pts);return u&&b.logger.debug("PTS rollover detected"),t},s.remux=function(e,u,t,l,p,c,L,R){var w,O,C,M,N,U,B=p,G=p,K=e.pid>-1,Y=u.pid>-1,q=u.samples.length,H=e.samples.length>0,V=L&&q>0||q>1,z=(!K||H)&&(!Y||V)||this.ISGenerated||L;if(z){this.ISGenerated||(C=this.generateIS(e,u,p));var X=this.isVideoContiguous,W=-1,Q;if(V&&(W=i(u.samples),!X&&this.config.forceKeyFrameOnDiscontinuity))if(U=!0,W>0){b.logger.warn("[mp4-remuxer]: Dropped "+W+" out of "+q+" video samples due to a missing keyframe");var J=this.getVideoStartPts(u.samples);u.samples=u.samples.slice(W),u.dropped+=W,G+=(u.samples[0].pts-J)/u.inputTimeScale,Q=G}else W===-1&&(b.logger.warn("[mp4-remuxer]: No keyframe found out of "+q+" video samples"),U=!1);if(this.ISGenerated){if(H&&V){var $=this.getVideoStartPts(u.samples),ot=n(e.samples[0].pts,$)-$,it=ot/u.inputTimeScale;B+=Math.max(0,it),G+=Math.max(0,-it)}if(H){if(e.samplerate||(b.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),C=this.generateIS(e,u,p)),O=this.remuxAudio(e,B,this.isAudioContiguous,c,Y||V||R===k.PlaylistLevelType.AUDIO?G:void 0),V){var Z=O?O.endPTS-O.startPTS:0;u.inputTimeScale||(b.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),C=this.generateIS(e,u,p)),w=this.remuxVideo(u,G,X,Z)}}else V&&(w=this.remuxVideo(u,G,X,0));w&&(w.firstKeyFrame=W,w.independent=W!==-1,w.firstKeyFramePTS=Q)}}return this.ISGenerated&&(t.samples.length&&(N=y(t,p,this._initPTS,this._initDTS)),l.samples.length&&(M=o(l,p,this._initPTS))),{audio:O,video:w,initSegment:C,independent:U,text:M,id3:N}},s.generateIS=function(e,u,t){var l=e.samples,p=u.samples,c=this.typeSupported,L={},R=!(0,F.isFiniteNumber)(this._initPTS),w="audio/mp4",O,C,M;if(R&&(O=C=1/0),e.config&&l.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":c.mpeg?(w="audio/mpeg",e.codec=""):c.mp3&&(e.codec="mp3");break}L.audio={id:"audio",container:w,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&c.mpeg?new Uint8Array(0):P.default.initSegment([e]),metadata:{channelCount:e.channelCount}},R&&(M=e.inputTimeScale,O=C=l[0].pts-Math.round(M*t))}if(u.sps&&u.pps&&p.length&&(u.timescale=u.inputTimeScale,L.video={id:"main",container:"video/mp4",codec:u.codec,initSegment:P.default.initSegment([u]),metadata:{width:u.width,height:u.height}},R)){M=u.inputTimeScale;var N=this.getVideoStartPts(p),U=Math.round(M*t);C=Math.min(C,n(p[0].dts,N)-U),O=Math.min(O,N-U)}if(Object.keys(L).length)return this.ISGenerated=!0,R&&(this._initPTS=O,this._initDTS=C),{tracks:L,initPTS:O,timescale:M}},s.remuxVideo=function(e,u,t,l){var p=e.inputTimeScale,c=e.samples,L=[],R=c.length,w=this._initPTS,O=this.nextAvcDts,C=8,M=this.videoSampleDuration,N,U,B=Number.POSITIVE_INFINITY,G=Number.NEGATIVE_INFINITY,K=!1;if(!t||O===null){var Y=u*p,q=c[0].pts-n(c[0].dts,c[0].pts);O=Y-q}for(var H=0;H<R;H++){var V=c[H];V.pts=n(V.pts-w,O),V.dts=n(V.dts-w,O),V.dts<c[H>0?H-1:H].dts&&(K=!0)}K&&c.sort(function(Bt,Gt){var Qt=Bt.dts-Gt.dts,Jt=Bt.pts-Gt.pts;return Qt||Jt}),N=c[0].dts,U=c[c.length-1].dts;var z=U-N,X=z?Math.round(z/(R-1)):M||e.inputTimeScale/30;if(t){var W=N-O,Q=W>X,J=W<-1;if((Q||J)&&(Q?b.logger.warn("AVC: "+(0,A.toMsFromMpegTsClock)(W,!0)+" ms ("+W+"dts) hole between fragments detected, filling it"):b.logger.warn("AVC: "+(0,A.toMsFromMpegTsClock)(-W,!0)+" ms ("+W+"dts) overlapping between fragments detected"),!J||O>c[0].pts)){N=O;var $=c[0].pts-W;c[0].dts=N,c[0].pts=$,b.logger.log("Video: First PTS/DTS adjusted: "+(0,A.toMsFromMpegTsClock)($,!0)+"/"+(0,A.toMsFromMpegTsClock)(N,!0)+", delta: "+(0,A.toMsFromMpegTsClock)(W,!0)+" ms")}}N=Math.max(0,N);for(var ot=0,it=0,Z=0;Z<R;Z++){for(var tt=c[Z],et=tt.units,nt=et.length,at=0,st=0;st<nt;st++)at+=et[st].data.length;it+=at,ot+=nt,tt.length=at,tt.dts=Math.max(tt.dts,N),B=Math.min(tt.pts,B),G=Math.max(tt.pts,G)}U=c[R-1].dts;var ft=it+4*ot+8,rt;try{rt=new Uint8Array(ft)}catch{this.observer.emit(I.Events.ERROR,I.Events.ERROR,{type:_.ErrorTypes.MUX_ERROR,details:_.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:ft,reason:"fail allocating video mdat "+ft});return}var bt=new DataView(rt.buffer);bt.setUint32(0,ft),rt.set(P.default.types.mdat,4);for(var ct=!1,At=Number.POSITIVE_INFINITY,Lt=Number.POSITIVE_INFINITY,gt=Number.NEGATIVE_INFINITY,Et=Number.NEGATIVE_INFINITY,lt=0;lt<R;lt++){for(var ut=c[lt],Tt=ut.units,pt=0,St=0,ht=Tt.length;St<ht;St++){var vt=Tt[St],Ct=vt.data,It=vt.data.byteLength;bt.setUint32(C,It),C+=4,rt.set(Ct,C),C+=It,pt+=4+It}var kt=void 0;if(lt<R-1)M=c[lt+1].dts-ut.dts,kt=c[lt+1].pts-ut.pts;else{var wt=this.config,Pt=lt>0?ut.dts-c[lt-1].dts:X;if(kt=lt>0?ut.pts-c[lt-1].pts:X,wt.stretchShortVideoTrack&&this.nextAudioPts!==null){var Yt=Math.floor(wt.maxBufferHole*p),Ot=(l?B+l*p:this.nextAudioPts)-ut.pts;Ot>Yt?(M=Ot-Pt,M<0?M=Pt:ct=!0,b.logger.log("[mp4-remuxer]: It is approximately "+Ot/90+" ms to the next segment; using duration "+M/90+" ms for the last video frame.")):M=Pt}else M=Pt}var jt=Math.round(ut.pts-ut.dts);At=Math.min(At,M),gt=Math.max(gt,M),Lt=Math.min(Lt,kt),Et=Math.max(Et,kt),L.push(new a(ut.key,M,pt,jt))}if(L.length){if(v){if(v<70){var Nt=L[0].flags;Nt.dependsOn=2,Nt.isNonSync=0}}else if(r&&Et-Lt<gt-At&&X/gt<.025&&L[0].cts===0){b.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");for(var Mt=N,mt=0,xt=L.length;mt<xt;mt++){var Ut=Mt+L[mt].duration,Vt=Mt+L[mt].cts;if(mt<xt-1){var Wt=Ut+L[mt+1].cts;L[mt].duration=Wt-Vt}else L[mt].duration=mt?L[mt-1].duration:X;L[mt].cts=0,Mt=Ut}}}console.assert(M!==null,"mp4SampleDuration must be computed"),M=ct||!M?X:M,this.nextAvcDts=O=U+M,this.videoSampleDuration=M,this.isVideoContiguous=!0;var qt=P.default.moof(e.sequenceNumber++,N,T({},e,{samples:L})),zt="video",Xt={data1:qt,data2:rt,startPTS:B/p,endPTS:(G+M)/p,startDTS:N/p,endDTS:O/p,type:zt,hasAudio:!1,hasVideo:!0,nb:L.length,dropped:e.dropped};return e.samples=[],e.dropped=0,console.assert(rt.length,"MDAT length must not be zero"),Xt},s.remuxAudio=function(e,u,t,l,p){var c=e.inputTimeScale,L=e.samplerate?e.samplerate:c,R=c/L,w=e.segmentCodec==="aac"?h:m,O=w*R,C=this._initPTS,M=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,N=[],U=p!==void 0,B=e.samples,G=M?0:8,K=this.nextAudioPts||-1,Y=u*c;if(this.isAudioContiguous=t=t||B.length&&K>0&&(l&&Math.abs(Y-K)<9e3||Math.abs(n(B[0].pts-C,Y)-K)<20*O),B.forEach(function(vt){vt.pts=n(vt.pts-C,Y)}),!t||K<0){if(B=B.filter(function(vt){return vt.pts>=0}),!B.length)return;p===0?K=0:l&&!U?K=Math.max(0,Y):K=B[0].pts}if(e.segmentCodec==="aac")for(var q=this.config.maxAudioFramesDrift,H=0,V=K;H<B.length;H++){var z=B[H],X=z.pts,W=X-V,Q=Math.abs(1e3*W/c);if(W<=-q*O&&U)H===0&&(b.logger.warn("Audio frame @ "+(X/c).toFixed(3)+"s overlaps nextAudioPts by "+Math.round(1e3*W/c)+" ms."),this.nextAudioPts=K=V=X);else if(W>=q*O&&Q<E&&U){var J=Math.round(W/O);V=X-J*O,V<0&&(J--,V+=O),H===0&&(this.nextAudioPts=K=V),b.logger.warn("[mp4-remuxer]: Injecting "+J+" audio frame @ "+(V/c).toFixed(3)+"s due to "+Math.round(1e3*W/c)+" ms gap.");for(var $=0;$<J;$++){var ot=Math.max(V,0),it=D.default.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);it||(b.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),it=z.unit.subarray()),B.splice(H,0,{unit:it,pts:ot}),V+=O,H++}}z.pts=V,V+=O}for(var Z=null,tt=null,et,nt=0,at=B.length;at--;)nt+=B[at].unit.byteLength;for(var st=0,ft=B.length;st<ft;st++){var rt=B[st],bt=rt.unit,ct=rt.pts;if(tt!==null){var At=N[st-1];At.duration=Math.round((ct-tt)/R)}else if(t&&e.segmentCodec==="aac"&&(ct=K),Z=ct,nt>0){nt+=G;try{et=new Uint8Array(nt)}catch{this.observer.emit(I.Events.ERROR,I.Events.ERROR,{type:_.ErrorTypes.MUX_ERROR,details:_.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:nt,reason:"fail allocating audio mdat "+nt});return}if(!M){var Lt=new DataView(et.buffer);Lt.setUint32(0,nt),et.set(P.default.types.mdat,4)}}else return;et.set(bt,G);var gt=bt.byteLength;G+=gt,N.push(new a(!0,w,gt,0)),tt=ct}var Et=N.length;if(Et){var lt=N[N.length-1];this.nextAudioPts=K=tt+R*lt.duration;var ut=M?new Uint8Array(0):P.default.moof(e.sequenceNumber++,Z/R,T({},e,{samples:N}));e.samples=[];var Tt=Z/c,pt=K/c,St="audio",ht={data1:ut,data2:et,startPTS:Tt,endPTS:pt,startDTS:Tt,endDTS:pt,type:St,hasAudio:!0,hasVideo:!1,nb:Et};return this.isAudioContiguous=!0,console.assert(et.length,"MDAT length must not be zero"),ht}},s.remuxEmptyAudio=function(e,u,t,l){var p=e.inputTimeScale,c=e.samplerate?e.samplerate:p,L=p/c,R=this.nextAudioPts,w=(R!==null?R:l.startDTS*p)+this._initDTS,O=l.endDTS*p+this._initDTS,C=L*h,M=Math.ceil((O-w)/C),N=D.default.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(b.logger.warn("[mp4-remuxer]: remux empty Audio"),!N){b.logger.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}for(var U=[],B=0;B<M;B++){var G=w+B*C;U.push({unit:N,pts:G,dts:G})}return e.samples=U,this.remuxAudio(e,u,t,!1)},f}();function n(f,s){var e;if(s===null)return f;for(s<f?e=-8589934592:e=8589934592;Math.abs(f-s)>4294967296;)f+=e;return f}function i(f){for(var s=0;s<f.length;s++)if(f[s].key)return s;return-1}function y(f,s,e,u){var t=f.samples.length;if(t){for(var l=f.inputTimeScale,p=0;p<t;p++){var c=f.samples[p];c.pts=n(c.pts-e,s*l)/l,c.dts=n(c.dts-u,s*l)/l}var L=f.samples;return f.samples=[],{samples:L}}}function o(f,s,e){var u=f.samples.length;if(u){for(var t=f.inputTimeScale,l=0;l<u;l++){var p=f.samples[l];p.pts=n(p.pts-e,s*t)/t}f.samples.sort(function(L,R){return L.pts-R.pts});var c=f.samples;return f.samples=[],{samples:c}}}var a=function(f,s,e,u){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=s,this.size=e,this.cts=u,this.flags=new g(f)},g=function(f){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=f?2:1,this.isNonSync=f?0:1}},"./src/remux/passthrough-remuxer.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>A});var F=S("./src/polyfills/number.ts"),D=S("./src/remux/mp4-remuxer.ts"),P=S("./src/utils/mp4-tools.ts"),I=S("./src/loader/fragment.ts"),_=S("./src/utils/logger.ts"),b=function(){function T(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=void 0,this.initTracks=void 0,this.lastEndTime=null}var E=T.prototype;return E.destroy=function(){},E.resetTimeStamp=function(h){this.initPTS=h,this.lastEndTime=null},E.resetNextTimestamp=function(){this.lastEndTime=null},E.resetInitSegment=function(h,m,v,r){this.audioCodec=m,this.videoCodec=v,this.generateInitSegment((0,P.patchEncyptionData)(h,r)),this.emitInitSegment=!0},E.generateInitSegment=function(h){var m=this.audioCodec,v=this.videoCodec;if(!h||!h.byteLength){this.initTracks=void 0,this.initData=void 0;return}var r=this.initData=(0,P.parseInitSegment)(h);m||(m=k(r.audio,I.ElementaryStreamTypes.AUDIO)),v||(v=k(r.video,I.ElementaryStreamTypes.VIDEO));var d={};r.audio&&r.video?d.audiovideo={container:"video/mp4",codec:m+","+v,initSegment:h,id:"main"}:r.audio?d.audio={container:"audio/mp4",codec:m,initSegment:h,id:"audio"}:r.video?d.video={container:"video/mp4",codec:v,initSegment:h,id:"main"}:_.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=d},E.remux=function(h,m,v,r,d){var n,i=this.initPTS,y=this.lastEndTime,o={audio:void 0,video:void 0,text:r,id3:v,initSegment:void 0};(0,F.isFiniteNumber)(y)||(y=this.lastEndTime=d||0);var a=m.samples;if(!a||!a.length)return o;var g={initPTS:void 0,timescale:1},f=this.initData;if((!f||!f.length)&&(this.generateInitSegment(a),f=this.initData),!f||!f.length)return _.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),o;this.emitInitSegment&&(g.tracks=this.initTracks,this.emitInitSegment=!1);var s=(0,P.getStartDTS)(f,a);(0,F.isFiniteNumber)(i)||(this.initPTS=g.initPTS=i=s-d);var e=(0,P.getDuration)(a,f),u=h?s-i:y,t=u+e;(0,P.offsetStartDTS)(f,a,i),e>0?this.lastEndTime=t:(_.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var l=!!f.audio,p=!!f.video,c="";l&&(c+="audio"),p&&(c+="video");var L={data1:a,startPTS:u,startDTS:u,endPTS:t,endDTS:t,type:c,hasAudio:l,hasVideo:p,nb:1,dropped:0};o.audio=L.type==="audio"?L:void 0,o.video=L.type!=="audio"?L:void 0,o.initSegment=g;var R=(n=this.initPTS)!=null?n:0;return o.id3=(0,D.flushTextTrackMetadataCueSamples)(v,d,R,R),r.samples.length&&(o.text=(0,D.flushTextTrackUserdataCueSamples)(r,d,R)),o},T}();function k(T,E){var h=T==null?void 0:T.codec;return h&&h.length>4?h:h==="hvc1"||h==="hev1"?"hvc1.1.c.L120.90":h==="av01"?"av01.0.04M.08":h==="avc1"||E===I.ElementaryStreamTypes.VIDEO?"avc1.42e01e":"mp4a.40.5"}const A=b},"./src/task-loop.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>F});var F=function(){function D(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}var P=D.prototype;return P.destroy=function(){this.onHandlerDestroying(),this.onHandlerDestroyed()},P.onHandlerDestroying=function(){this.clearNextTick(),this.clearInterval()},P.onHandlerDestroyed=function(){},P.hasInterval=function(){return!!this._tickInterval},P.hasNextTick=function(){return!!this._tickTimer},P.setInterval=function(I){return this._tickInterval?!1:(this._tickInterval=self.setInterval(this._boundTick,I),!0)},P.clearInterval=function(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1},P.clearNextTick=function(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1},P.tick=function(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)},P.tickImmediate=function(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},P.doTick=function(){},D}()},"./src/types/cmcd.ts":(j,x,S)=>{S.r(x),S.d(x,{CMCDObjectType:()=>D,CMCDStreamType:()=>I,CMCDStreamingFormat:()=>P,CMCDVersion:()=>F});var F=1,D;(function(_){_.MANIFEST="m",_.AUDIO="a",_.VIDEO="v",_.MUXED="av",_.INIT="i",_.CAPTION="c",_.TIMED_TEXT="tt",_.KEY="k",_.OTHER="o"})(D||(D={}));var P;(function(_){_.DASH="d",_.HLS="h",_.SMOOTH="s",_.OTHER="o"})(P||(P={}));var I;(function(_){_.VOD="v",_.LIVE="l"})(I||(I={}))},"./src/types/demuxer.ts":(j,x,S)=>{S.r(x),S.d(x,{MetadataSchema:()=>F});var F;(function(D){D.audioId3="org.id3",D.dateRange="com.apple.quicktime.HLS",D.emsg="https://aomedia.org/emsg/ID3"})(F||(F={}))},"./src/types/level.ts":(j,x,S)=>{S.r(x),S.d(x,{HdcpLevels:()=>_,HlsSkip:()=>b,HlsUrlParameters:()=>A,Level:()=>T,getSkipValue:()=>k});function F(E,h){for(var m=0;m<h.length;m++){var v=h[m];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(E,P(v.key),v)}}function D(E,h,m){return h&&F(E.prototype,h),Object.defineProperty(E,"prototype",{writable:!1}),E}function P(E){var h=I(E,"string");return typeof h=="symbol"?h:String(h)}function I(E,h){if(typeof E!="object"||E===null)return E;var m=E[Symbol.toPrimitive];if(m!==void 0){var v=m.call(E,h);if(typeof v!="object")return v;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(E)}var _=["NONE","TYPE-0","TYPE-1","TYPE-2",null],b;(function(E){E.No="",E.Yes="YES",E.v2="v2"})(b||(b={}));function k(E,h){var m=E.canSkipUntil,v=E.canSkipDateRanges,r=E.endSN,d=h!==void 0?h-r:0;return m&&d<m?v?b.v2:b.Yes:b.No}var A=function(){function E(m,v,r){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=m,this.part=v,this.skip=r}var h=E.prototype;return h.addDirectives=function(m){var v=new self.URL(m);return this.msn!==void 0&&v.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&v.searchParams.set("_HLS_part",this.part.toString()),this.skip&&v.searchParams.set("_HLS_skip",this.skip),v.href},E}(),T=function(){function E(h){this.attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[h.url],this.attrs=h.attrs,this.bitrate=h.bitrate,h.details&&(this.details=h.details),this.id=h.id||0,this.name=h.name,this.width=h.width||0,this.height=h.height||0,this.audioCodec=h.audioCodec,this.videoCodec=h.videoCodec,this.unknownCodecs=h.unknownCodecs,this.codecSet=[h.videoCodec,h.audioCodec].filter(function(m){return m}).join(",").replace(/\.[^.,]+/g,"")}return D(E,[{key:"maxBitrate",get:function(){return Math.max(this.realBitrate,this.bitrate)}},{key:"uri",get:function(){return this.url[this._urlId]||""}},{key:"urlId",get:function(){return this._urlId},set:function(h){var m=h%this.url.length;this._urlId!==m&&(this.details=void 0,this._urlId=m)}}]),E}()},"./src/types/loader.ts":(j,x,S)=>{S.r(x),S.d(x,{PlaylistContextType:()=>F,PlaylistLevelType:()=>D});var F;(function(P){P.MANIFEST="manifest",P.LEVEL="level",P.AUDIO_TRACK="audioTrack",P.SUBTITLE_TRACK="subtitleTrack"})(F||(F={}));var D;(function(P){P.MAIN="main",P.AUDIO="audio",P.SUBTITLE="subtitle"})(D||(D={}))},"./src/types/transmuxer.ts":(j,x,S)=>{S.r(x),S.d(x,{ChunkMetadata:()=>F});var F=function(P,I,_,b,k,A){b===void 0&&(b=0),k===void 0&&(k=-1),A===void 0&&(A=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=D(),this.buffering={audio:D(),video:D(),audiovideo:D()},this.level=P,this.sn=I,this.id=_,this.size=b,this.part=k,this.partial=A};function D(){return{start:0,executeStart:0,executeEnd:0,end:0}}},"./src/utils/attr-list.ts":(j,x,S)=>{S.r(x),S.d(x,{AttrList:()=>P});var F=/^(\d+)x(\d+)$/,D=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,P=function(){function I(b){typeof b=="string"&&(b=I.parseAttrList(b));for(var k in b)b.hasOwnProperty(k)&&(this[k]=b[k])}var _=I.prototype;return _.decimalInteger=function(b){var k=parseInt(this[b],10);return k>Number.MAX_SAFE_INTEGER?1/0:k},_.hexadecimalInteger=function(b){if(this[b]){var k=(this[b]||"0x").slice(2);k=(k.length&1?"0":"")+k;for(var A=new Uint8Array(k.length/2),T=0;T<k.length/2;T++)A[T]=parseInt(k.slice(T*2,T*2+2),16);return A}else return null},_.hexadecimalIntegerAsNumber=function(b){var k=parseInt(this[b],16);return k>Number.MAX_SAFE_INTEGER?1/0:k},_.decimalFloatingPoint=function(b){return parseFloat(this[b])},_.optionalFloat=function(b,k){var A=this[b];return A?parseFloat(A):k},_.enumeratedString=function(b){return this[b]},_.bool=function(b){return this[b]==="YES"},_.decimalResolution=function(b){var k=F.exec(this[b]);if(k!==null)return{width:parseInt(k[1],10),height:parseInt(k[2],10)}},I.parseAttrList=function(b){var k,A={},T='"';for(D.lastIndex=0;(k=D.exec(b))!==null;){var E=k[2];E.indexOf(T)===0&&E.lastIndexOf(T)===E.length-1&&(E=E.slice(1,-1)),A[k[1]]=E}return A},I}()},"./src/utils/binary-search.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>D});var F={search:function(P,I){for(var _=0,b=P.length-1,k=null,A=null;_<=b;){k=(_+b)/2|0,A=P[k];var T=I(A);if(T>0)_=k+1;else if(T<0)b=k-1;else return A}return null}};const D=F},"./src/utils/buffer-helper.ts":(j,x,S)=>{S.r(x),S.d(x,{BufferHelper:()=>P});var F=S("./src/utils/logger.ts"),D={length:0,start:function(){return 0},end:function(){return 0}},P=function(){function I(){}return I.isBuffered=function(_,b){try{if(_){for(var k=I.getBuffered(_),A=0;A<k.length;A++)if(b>=k.start(A)&&b<=k.end(A))return!0}}catch{}return!1},I.bufferInfo=function(_,b,k){try{if(_){var A=I.getBuffered(_),T=[],E;for(E=0;E<A.length;E++)T.push({start:A.start(E),end:A.end(E)});return this.bufferedInfo(T,b,k)}}catch{}return{len:0,start:b,end:b,nextStart:void 0}},I.bufferedInfo=function(_,b,k){b=Math.max(0,b),_.sort(function(o,a){var g=o.start-a.start;return g||a.end-o.end});var A=[];if(k)for(var T=0;T<_.length;T++){var E=A.length;if(E){var h=A[E-1].end;_[T].start-h<k?_[T].end>h&&(A[E-1].end=_[T].end):A.push(_[T])}else A.push(_[T])}else A=_;for(var m=0,v,r=b,d=b,n=0;n<A.length;n++){var i=A[n].start,y=A[n].end;if(b+k>=i&&b<y)r=i,d=y,m=d-b;else if(b+k<i){v=i;break}}return{len:m,start:r||0,end:d||0,nextStart:v}},I.getBuffered=function(_){try{return _.buffered}catch(b){return F.logger.log("failed to get media.buffered",b),D}},I}()},"./src/utils/cea-608-parser.ts":(j,x,S)=>{S.r(x),S.d(x,{CaptionScreen:()=>i,Row:()=>n,default:()=>s});var F=S("./src/utils/logger.ts"),D={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},P=function(e){var u=e;return D.hasOwnProperty(e)&&(u=D[e]),String.fromCharCode(u)},I=15,_=100,b={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},k={17:2,18:4,21:6,22:8,23:10,19:13,20:15},A={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},T={25:2,26:4,29:6,30:8,31:10,27:13,28:15},E=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],h;(function(e){e[e.ERROR=0]="ERROR",e[e.TEXT=1]="TEXT",e[e.WARNING=2]="WARNING",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG",e[e.DATA=3]="DATA"})(h||(h={}));var m=function(){function e(){this.time=null,this.verboseLevel=h.ERROR}var u=e.prototype;return u.log=function(t,l){if(this.verboseLevel>=t){var p=typeof l=="function"?l():l;F.logger.log(this.time+" ["+t+"] "+p)}},e}(),v=function(e){for(var u=[],t=0;t<e.length;t++)u.push(e[t].toString(16));return u},r=function(){function e(t,l,p,c,L){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=t||"white",this.underline=l||!1,this.italics=p||!1,this.background=c||"black",this.flash=L||!1}var u=e.prototype;return u.reset=function(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1},u.setStyles=function(t){for(var l=["foreground","underline","italics","background","flash"],p=0;p<l.length;p++){var c=l[p];t.hasOwnProperty(c)&&(this[c]=t[c])}},u.isDefault=function(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash},u.equals=function(t){return this.foreground===t.foreground&&this.underline===t.underline&&this.italics===t.italics&&this.background===t.background&&this.flash===t.flash},u.copy=function(t){this.foreground=t.foreground,this.underline=t.underline,this.italics=t.italics,this.background=t.background,this.flash=t.flash},u.toString=function(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash},e}(),d=function(){function e(t,l,p,c,L,R){this.uchar=void 0,this.penState=void 0,this.uchar=t||" ",this.penState=new r(l,p,c,L,R)}var u=e.prototype;return u.reset=function(){this.uchar=" ",this.penState.reset()},u.setChar=function(t,l){this.uchar=t,this.penState.copy(l)},u.setPenState=function(t){this.penState.copy(t)},u.equals=function(t){return this.uchar===t.uchar&&this.penState.equals(t.penState)},u.copy=function(t){this.uchar=t.uchar,this.penState.copy(t.penState)},u.isEmpty=function(){return this.uchar===" "&&this.penState.isDefault()},e}(),n=function(){function e(t){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(var l=0;l<_;l++)this.chars.push(new d);this.logger=t,this.pos=0,this.currPenState=new r}var u=e.prototype;return u.equals=function(t){for(var l=!0,p=0;p<_;p++)if(!this.chars[p].equals(t.chars[p])){l=!1;break}return l},u.copy=function(t){for(var l=0;l<_;l++)this.chars[l].copy(t.chars[l])},u.isEmpty=function(){for(var t=!0,l=0;l<_;l++)if(!this.chars[l].isEmpty()){t=!1;break}return t},u.setCursor=function(t){this.pos!==t&&(this.pos=t),this.pos<0?(this.logger.log(h.DEBUG,"Negative cursor position "+this.pos),this.pos=0):this.pos>_&&(this.logger.log(h.DEBUG,"Too large cursor position "+this.pos),this.pos=_)},u.moveCursor=function(t){var l=this.pos+t;if(t>1)for(var p=this.pos+1;p<l+1;p++)this.chars[p].setPenState(this.currPenState);this.setCursor(l)},u.backSpace=function(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)},u.insertChar=function(t){var l=this;t>=144&&this.backSpace();var p=P(t);if(this.pos>=_){this.logger.log(h.ERROR,function(){return"Cannot insert "+t.toString(16)+" ("+p+") at position "+l.pos+". Skipping it!"});return}this.chars[this.pos].setChar(p,this.currPenState),this.moveCursor(1)},u.clearFromPos=function(t){var l;for(l=t;l<_;l++)this.chars[l].reset()},u.clear=function(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},u.clearToEndOfRow=function(){this.clearFromPos(this.pos)},u.getTextString=function(){for(var t=[],l=!0,p=0;p<_;p++){var c=this.chars[p].uchar;c!==" "&&(l=!1),t.push(c)}return l?"":t.join("")},u.setPenStyles=function(t){this.currPenState.setStyles(t);var l=this.chars[this.pos];l.setPenState(this.currPenState)},e}(),i=function(){function e(t){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(var l=0;l<I;l++)this.rows.push(new n(t));this.logger=t,this.currRow=I-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}var u=e.prototype;return u.reset=function(){for(var t=0;t<I;t++)this.rows[t].clear();this.currRow=I-1},u.equals=function(t){for(var l=!0,p=0;p<I;p++)if(!this.rows[p].equals(t.rows[p])){l=!1;break}return l},u.copy=function(t){for(var l=0;l<I;l++)this.rows[l].copy(t.rows[l])},u.isEmpty=function(){for(var t=!0,l=0;l<I;l++)if(!this.rows[l].isEmpty()){t=!1;break}return t},u.backSpace=function(){var t=this.rows[this.currRow];t.backSpace()},u.clearToEndOfRow=function(){var t=this.rows[this.currRow];t.clearToEndOfRow()},u.insertChar=function(t){var l=this.rows[this.currRow];l.insertChar(t)},u.setPen=function(t){var l=this.rows[this.currRow];l.setPenStyles(t)},u.moveCursor=function(t){var l=this.rows[this.currRow];l.moveCursor(t)},u.setCursor=function(t){this.logger.log(h.INFO,"setCursor: "+t);var l=this.rows[this.currRow];l.setCursor(t)},u.setPAC=function(t){this.logger.log(h.INFO,function(){return"pacData = "+JSON.stringify(t)});var l=t.row-1;if(this.nrRollUpRows&&l<this.nrRollUpRows-1&&(l=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==l){for(var p=0;p<I;p++)this.rows[p].clear();var c=this.currRow+1-this.nrRollUpRows,L=this.lastOutputScreen;if(L){var R=L.rows[c].cueStartTime,w=this.logger.time;if(R&&w!==null&&R<w)for(var O=0;O<this.nrRollUpRows;O++)this.rows[l-this.nrRollUpRows+O+1].copy(L.rows[c+O])}}this.currRow=l;var C=this.rows[this.currRow];if(t.indent!==null){var M=t.indent,N=Math.max(M-1,0);C.setCursor(t.indent),t.color=C.chars[N].penState.foreground}var U={foreground:t.color,underline:t.underline,italics:t.italics,background:"black",flash:!1};this.setPen(U)},u.setBkgData=function(t){this.logger.log(h.INFO,function(){return"bkgData = "+JSON.stringify(t)}),this.backSpace(),this.setPen(t),this.insertChar(32)},u.setRollUpRows=function(t){this.nrRollUpRows=t},u.rollUp=function(){var t=this;if(this.nrRollUpRows===null){this.logger.log(h.DEBUG,"roll_up but nrRollUpRows not set yet");return}this.logger.log(h.TEXT,function(){return t.getDisplayText()});var l=this.currRow+1-this.nrRollUpRows,p=this.rows.splice(l,1)[0];p.clear(),this.rows.splice(this.currRow,0,p),this.logger.log(h.INFO,"Rolling up")},u.getDisplayText=function(t){t=t||!1;for(var l=[],p="",c=-1,L=0;L<I;L++){var R=this.rows[L].getTextString();R&&(c=L+1,t?l.push("Row "+c+": '"+R+"'"):l.push(R.trim()))}return l.length>0&&(t?p="["+l.join(" | ")+"]":p=l.join(`
`)),p},u.getTextAndFormat=function(){return this.rows},e}(),y=function(){function e(t,l,p){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=t,this.outputFilter=l,this.mode=null,this.verbose=0,this.displayedMemory=new i(p),this.nonDisplayedMemory=new i(p),this.lastOutputScreen=new i(p),this.currRollUpRow=this.displayedMemory.rows[I-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=p}var u=e.prototype;return u.reset=function(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[I-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},u.getHandler=function(){return this.outputFilter},u.setHandler=function(t){this.outputFilter=t},u.setPAC=function(t){this.writeScreen.setPAC(t)},u.setBkgData=function(t){this.writeScreen.setBkgData(t)},u.setMode=function(t){t!==this.mode&&(this.mode=t,this.logger.log(h.INFO,function(){return"MODE="+t}),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=t)},u.insertChars=function(t){for(var l=this,p=0;p<t.length;p++)this.writeScreen.insertChar(t[p]);var c=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(h.INFO,function(){return c+": "+l.writeScreen.getDisplayText(!0)}),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(h.TEXT,function(){return"DISPLAYED: "+l.displayedMemory.getDisplayText(!0)}),this.outputDataUpdate())},u.ccRCL=function(){this.logger.log(h.INFO,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")},u.ccBS=function(){this.logger.log(h.INFO,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},u.ccAOF=function(){},u.ccAON=function(){},u.ccDER=function(){this.logger.log(h.INFO,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},u.ccRU=function(t){this.logger.log(h.INFO,"RU("+t+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(t)},u.ccFON=function(){this.logger.log(h.INFO,"FON - Flash On"),this.writeScreen.setPen({flash:!0})},u.ccRDC=function(){this.logger.log(h.INFO,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")},u.ccTR=function(){this.logger.log(h.INFO,"TR"),this.setMode("MODE_TEXT")},u.ccRTD=function(){this.logger.log(h.INFO,"RTD"),this.setMode("MODE_TEXT")},u.ccEDM=function(){this.logger.log(h.INFO,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)},u.ccCR=function(){this.logger.log(h.INFO,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},u.ccENM=function(){this.logger.log(h.INFO,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()},u.ccEOC=function(){var t=this;if(this.logger.log(h.INFO,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){var l=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=l,this.writeScreen=this.nonDisplayedMemory,this.logger.log(h.TEXT,function(){return"DISP: "+t.displayedMemory.getDisplayText()})}this.outputDataUpdate(!0)},u.ccTO=function(t){this.logger.log(h.INFO,"TO("+t+") - Tab Offset"),this.writeScreen.moveCursor(t)},u.ccMIDROW=function(t){var l={flash:!1};if(l.underline=t%2===1,l.italics=t>=46,l.italics)l.foreground="white";else{var p=Math.floor(t/2)-16,c=["white","green","blue","cyan","red","yellow","magenta"];l.foreground=c[p]}this.logger.log(h.INFO,"MIDROW: "+JSON.stringify(l)),this.writeScreen.setPen(l)},u.outputDataUpdate=function(t){t===void 0&&(t=!1);var l=this.logger.time;l!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=l:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,l,this.lastOutputScreen),t&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:l),this.lastOutputScreen.copy(this.displayedMemory))},u.cueSplitAtTime=function(t){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory),this.cueStartTime=t))},e}(),o=function(){function e(t,l,p){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;var c=new m;this.channels=[null,new y(t,l,c),new y(t+1,p,c)],this.cmdHistory=f(),this.logger=c}var u=e.prototype;return u.getHandler=function(t){return this.channels[t].getHandler()},u.setHandler=function(t,l){this.channels[t].setHandler(l)},u.addData=function(t,l){var p,c,L,R=!1;this.logger.time=t;for(var w=0;w<l.length;w+=2)if(c=l[w]&127,L=l[w+1]&127,!(c===0&&L===0)){if(this.logger.log(h.DATA,"["+v([l[w],l[w+1]])+"] -> ("+v([c,L])+")"),p=this.parseCmd(c,L),p||(p=this.parseMidrow(c,L)),p||(p=this.parsePAC(c,L)),p||(p=this.parseBackgroundAttributes(c,L)),!p&&(R=this.parseChars(c,L),R)){var O=this.currentChannel;if(O&&O>0){var C=this.channels[O];C.insertChars(R)}else this.logger.log(h.WARNING,"No channel found yet. TEXT-MODE?")}!p&&!R&&this.logger.log(h.WARNING,"Couldn't parse cleaned data "+v([c,L])+" orig: "+v([l[w],l[w+1]]))}},u.parseCmd=function(t,l){var p=this.cmdHistory,c=(t===20||t===28||t===21||t===29)&&l>=32&&l<=47,L=(t===23||t===31)&&l>=33&&l<=35;if(!(c||L))return!1;if(g(t,l,p))return a(null,null,p),this.logger.log(h.DEBUG,"Repeated command ("+v([t,l])+") is dropped"),!0;var R=t===20||t===21||t===23?1:2,w=this.channels[R];return t===20||t===21||t===28||t===29?l===32?w.ccRCL():l===33?w.ccBS():l===34?w.ccAOF():l===35?w.ccAON():l===36?w.ccDER():l===37?w.ccRU(2):l===38?w.ccRU(3):l===39?w.ccRU(4):l===40?w.ccFON():l===41?w.ccRDC():l===42?w.ccTR():l===43?w.ccRTD():l===44?w.ccEDM():l===45?w.ccCR():l===46?w.ccENM():l===47&&w.ccEOC():w.ccTO(l-32),a(t,l,p),this.currentChannel=R,!0},u.parseMidrow=function(t,l){var p=0;if((t===17||t===25)&&l>=32&&l<=47){if(t===17?p=1:p=2,p!==this.currentChannel)return this.logger.log(h.ERROR,"Mismatch channel in midrow parsing"),!1;var c=this.channels[p];return c?(c.ccMIDROW(l),this.logger.log(h.DEBUG,"MIDROW ("+v([t,l])+")"),!0):!1}return!1},u.parsePAC=function(t,l){var p,c=this.cmdHistory,L=(t>=17&&t<=23||t>=25&&t<=31)&&l>=64&&l<=127,R=(t===16||t===24)&&l>=64&&l<=95;if(!(L||R))return!1;if(g(t,l,c))return a(null,null,c),!0;var w=t<=23?1:2;l>=64&&l<=95?p=w===1?b[t]:A[t]:p=w===1?k[t]:T[t];var O=this.channels[w];return O?(O.setPAC(this.interpretPAC(p,l)),a(t,l,c),this.currentChannel=w,!0):!1},u.interpretPAC=function(t,l){var p,c={color:null,italics:!1,indent:null,underline:!1,row:t};return l>95?p=l-96:p=l-64,c.underline=(p&1)===1,p<=13?c.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(p/2)]:p<=15?(c.italics=!0,c.color="white"):c.indent=Math.floor((p-16)/2)*4,c},u.parseChars=function(t,l){var p,c=null,L=null;if(t>=25?(p=2,L=t-8):(p=1,L=t),L>=17&&L<=19){var R;L===17?R=l+80:L===18?R=l+112:R=l+144,this.logger.log(h.INFO,"Special char '"+P(R)+"' in channel "+p),c=[R]}else t>=32&&t<=127&&(c=l===0?[t]:[t,l]);if(c){var w=v(c);this.logger.log(h.DEBUG,"Char codes =  "+w.join(",")),a(t,l,this.cmdHistory)}return c},u.parseBackgroundAttributes=function(t,l){var p=(t===16||t===24)&&l>=32&&l<=47,c=(t===23||t===31)&&l>=45&&l<=47;if(!(p||c))return!1;var L,R={};t===16||t===24?(L=Math.floor((l-32)/2),R.background=E[L],l%2===1&&(R.background=R.background+"_semi")):l===45?R.background="transparent":(R.foreground="black",l===47&&(R.underline=!0));var w=t<=23?1:2,O=this.channels[w];return O.setBkgData(R),a(t,l,this.cmdHistory),!0},u.reset=function(){for(var t=0;t<Object.keys(this.channels).length;t++){var l=this.channels[t];l&&l.reset()}this.cmdHistory=f()},u.cueSplitAtTime=function(t){for(var l=0;l<this.channels.length;l++){var p=this.channels[l];p&&p.cueSplitAtTime(t)}},e}();function a(e,u,t){t.a=e,t.b=u}function g(e,u,t){return t.a===e&&t.b===u}function f(){return{a:null,b:null}}const s=o},"./src/utils/codecs.ts":(j,x,S)=>{S.r(x),S.d(x,{isCodecSupportedInMp4:()=>P,isCodecType:()=>D});var F={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dva1:!0,dvav:!0,dvh1:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function D(I,_){var b=F[_];return!!b&&b[I.slice(0,4)]===!0}function P(I,_){return MediaSource.isTypeSupported((_||"video")+'/mp4;codecs="'+I+'"')}},"./src/utils/cues.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>b});var F=S("./src/utils/vttparser.ts"),D=S("./src/utils/webvtt-parser.ts"),P=S("./src/utils/texttrack-utils.ts"),I=/\s/,_={newCue:function(k,A,T,E){for(var h=[],m,v,r,d,n,i=self.VTTCue||self.TextTrackCue,y=0;y<E.rows.length;y++)if(m=E.rows[y],r=!0,d=0,n="",!m.isEmpty()){for(var o=0;o<m.chars.length;o++)I.test(m.chars[o].uchar)&&r?d++:(n+=m.chars[o].uchar,r=!1);m.cueStartTime=A,A===T&&(T+=1e-4),d>=16?d--:d++;var a=(0,F.fixLineBreaks)(n.trim()),g=(0,D.generateCueId)(A,T,a);(!k||!k.cues||!k.cues.getCueById(g))&&(v=new i(A,T,a),v.id=g,v.line=y+1,v.align="left",v.position=10+Math.min(80,Math.floor(d*8/32)*10),h.push(v))}return k&&h.length&&(h.sort(function(f,s){return f.line==="auto"||s.line==="auto"?0:f.line>8&&s.line>8?s.line-f.line:f.line-s.line}),h.forEach(function(f){return(0,P.addCueToTrack)(k,f)})),h}};const b=_},"./src/utils/discontinuities.ts":(j,x,S)=>{S.r(x),S.d(x,{adjustSlidingStart:()=>A,alignMediaPlaylistByPDT:()=>m,alignPDT:()=>h,alignStream:()=>T,findDiscontinuousReferenceFrag:()=>b,findFirstFragWithCC:()=>I,shouldAlignOnDiscontinuities:()=>_});var F=S("./src/polyfills/number.ts"),D=S("./src/utils/logger.ts"),P=S("./src/controller/level-helper.ts");function I(v,r){for(var d=null,n=0,i=v.length;n<i;n++){var y=v[n];if(y&&y.cc===r){d=y;break}}return d}function _(v,r,d){return!!(r.details&&(d.endCC>d.startCC||v&&v.cc<d.startCC))}function b(v,r,d){var n=v.fragments,i=r.fragments;if(!i.length||!n.length){D.logger.log("No fragments to align");return}var y=I(n,i[0].cc);if(!y||y&&!y.startPTS){D.logger.log("No frag in previous level to align on");return}return y}function k(v,r){if(v){var d=v.start+r;v.start=v.startPTS=d,v.endPTS=d+v.duration}}function A(v,r){for(var d=r.fragments,n=0,i=d.length;n<i;n++)k(d[n],v);r.fragmentHint&&k(r.fragmentHint,v),r.alignedSliding=!0}function T(v,r,d){r&&(E(v,d,r),!d.alignedSliding&&r.details&&h(d,r.details),!d.alignedSliding&&r.details&&!d.skippedSegments&&(0,P.adjustSliding)(r.details,d))}function E(v,r,d){if(_(v,d,r)){var n=b(d.details,r);n&&(0,F.isFiniteNumber)(n.start)&&(D.logger.log("Adjusting PTS using last level due to CC increase within current level "+r.url),A(n.start,r))}}function h(v,r){if(!(!r.fragments.length||!v.hasProgramDateTime||!r.hasProgramDateTime)){var d=r.fragments[0].programDateTime,n=v.fragments[0].programDateTime,i=(n-d)/1e3+r.fragments[0].start;i&&(0,F.isFiniteNumber)(i)&&(D.logger.log("Adjusting PTS using programDateTime delta "+(n-d)+"ms, sliding:"+i.toFixed(3)+" "+v.url+" "),A(i,v))}}function m(v,r){if(!(!v.hasProgramDateTime||!r.hasProgramDateTime)){var d=v.fragments,n=r.fragments;if(!(!d.length||!n.length)){var i=Math.round(n.length/2)-1,y=n[i],o=I(d,y.cc)||d[Math.round(d.length/2)-1],a=y.programDateTime,g=o.programDateTime;if(!(a===null||g===null)){var f=(g-a)/1e3-(o.start-y.start);A(f,v)}}}}},"./src/utils/ewma-bandwidth-estimator.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>P});var F=S("./src/utils/ewma.ts"),D=function(){function I(b,k,A){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultEstimate_=A,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new F.default(b),this.fast_=new F.default(k)}var _=I.prototype;return _.update=function(b,k){var A=this.slow_,T=this.fast_;this.slow_.halfLife!==b&&(this.slow_=new F.default(b,A.getEstimate(),A.getTotalWeight())),this.fast_.halfLife!==k&&(this.fast_=new F.default(k,T.getEstimate(),T.getTotalWeight()))},_.sample=function(b,k){b=Math.max(b,this.minDelayMs_);var A=8*k,T=b/1e3,E=A/T;this.fast_.sample(T,E),this.slow_.sample(T,E)},_.canEstimate=function(){var b=this.fast_;return b&&b.getTotalWeight()>=this.minWeight_},_.getEstimate=function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},_.destroy=function(){},I}();const P=D},"./src/utils/ewma.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>D});var F=function(){function P(_,b,k){b===void 0&&(b=0),k===void 0&&(k=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=_,this.alpha_=_?Math.exp(Math.log(.5)/_):0,this.estimate_=b,this.totalWeight_=k}var I=P.prototype;return I.sample=function(_,b){var k=Math.pow(this.alpha_,_);this.estimate_=b*(1-k)+k*this.estimate_,this.totalWeight_+=_},I.getTotalWeight=function(){return this.totalWeight_},I.getEstimate=function(){if(this.alpha_){var _=1-Math.pow(this.alpha_,this.totalWeight_);if(_)return this.estimate_/_}return this.estimate_},P}();const D=F},"./src/utils/fetch-loader.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>i,fetchSupported:()=>m});var F=S("./src/polyfills/number.ts"),D=S("./src/loader/load-stats.ts"),P=S("./src/demux/chunk-cache.ts");function I(y,o){y.prototype=Object.create(o.prototype),y.prototype.constructor=y,T(y,o)}function _(y){var o=typeof Map=="function"?new Map:void 0;return _=function(a){if(a===null||!A(a))return a;if(typeof a!="function")throw new TypeError("Super expression must either be null or a function");if(typeof o<"u"){if(o.has(a))return o.get(a);o.set(a,g)}function g(){return b(a,arguments,E(this).constructor)}return g.prototype=Object.create(a.prototype,{constructor:{value:g,enumerable:!1,writable:!0,configurable:!0}}),T(g,a)},_(y)}function b(y,o,a){return k()?b=Reflect.construct.bind():b=function(g,f,s){var e=[null];e.push.apply(e,f);var u=Function.bind.apply(g,e),t=new u;return s&&T(t,s.prototype),t},b.apply(null,arguments)}function k(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function A(y){return Function.toString.call(y).indexOf("[native code]")!==-1}function T(y,o){return T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(a,g){return a.__proto__=g,a},T(y,o)}function E(y){return E=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(o){return o.__proto__||Object.getPrototypeOf(o)},E(y)}function h(){return h=Object.assign?Object.assign.bind():function(y){for(var o=1;o<arguments.length;o++){var a=arguments[o];for(var g in a)Object.prototype.hasOwnProperty.call(a,g)&&(y[g]=a[g])}return y},h.apply(this,arguments)}function m(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}var v=function(){function y(a){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=a.fetchSetup||d,this.controller=new self.AbortController,this.stats=new D.LoadStats}var o=y.prototype;return o.destroy=function(){this.loader=this.callbacks=null,this.abortInternal()},o.abortInternal=function(){var a=this.response;(!a||!a.ok)&&(this.stats.aborted=!0,this.controller.abort())},o.abort=function(){var a;this.abortInternal(),(a=this.callbacks)!==null&&a!==void 0&&a.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},o.load=function(a,g,f){var s=this,e=this.stats;if(e.loading.start)throw new Error("Loader can only be used once.");e.loading.start=self.performance.now();var u=r(a,this.controller.signal),t=f.onProgress,l=a.responseType==="arraybuffer",p=l?"byteLength":"length";this.context=a,this.config=g,this.callbacks=f,this.request=this.fetchSetup(a,u),self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(function(){s.abortInternal(),f.onTimeout(e,a,s.response)},g.timeout),self.fetch(this.request).then(function(c){if(s.response=s.loader=c,!c.ok){var L=c.status,R=c.statusText;throw new n(R||"fetch, bad network response",L,c)}return e.loading.first=Math.max(self.performance.now(),e.loading.start),e.total=parseInt(c.headers.get("Content-Length")||"0"),t&&(0,F.isFiniteNumber)(g.highWaterMark)?s.loadProgressively(c,e,a,g.highWaterMark,t):l?c.arrayBuffer():c.text()}).then(function(c){var L=s.response;self.clearTimeout(s.requestTimeout),e.loading.end=Math.max(self.performance.now(),e.loading.first);var R=c[p];R&&(e.loaded=e.total=R);var w={url:L.url,data:c};t&&!(0,F.isFiniteNumber)(g.highWaterMark)&&t(e,a,c,L),f.onSuccess(w,e,a,L)}).catch(function(c){if(self.clearTimeout(s.requestTimeout),!e.aborted){var L=c&&c.code||0,R=c?c.message:null;f.onError({code:L,text:R},a,c?c.details:null)}})},o.getCacheAge=function(){var a=null;if(this.response){var g=this.response.headers.get("age");a=g?parseFloat(g):null}return a},o.loadProgressively=function(a,g,f,s,e){s===void 0&&(s=0);var u=new P.default,t=a.body.getReader(),l=function p(){return t.read().then(function(c){if(c.done)return u.dataLength&&e(g,f,u.flush(),a),Promise.resolve(new ArrayBuffer(0));var L=c.value,R=L.length;return g.loaded+=R,R<s||u.dataLength?(u.push(L),u.dataLength>=s&&e(g,f,u.flush(),a)):e(g,f,L,a),p()}).catch(function(){return Promise.reject()})};return l()},y}();function r(y,o){var a={method:"GET",mode:"cors",credentials:"same-origin",signal:o,headers:new self.Headers(h({},y.headers))};return y.rangeEnd&&a.headers.set("Range","bytes="+y.rangeStart+"-"+String(y.rangeEnd-1)),a}function d(y,o){return new self.Request(y.url,o)}var n=function(y){I(o,y);function o(a,g,f){var s;return s=y.call(this,a)||this,s.code=void 0,s.details=void 0,s.code=g,s.details=f,s}return o}(_(Error));const i=v},"./src/utils/hex.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>D});var F={hexDump:function(P){for(var I="",_=0;_<P.length;_++){var b=P[_].toString(16);b.length<2&&(b="0"+b),I+=b}return I}};const D=F},"./src/utils/imsc1-ttml-parser.ts":(j,x,S)=>{S.r(x),S.d(x,{IMSC1_CODEC:()=>A,parseIMSC1:()=>m});var F=S("./src/utils/mp4-tools.ts"),D=S("./src/utils/vttparser.ts"),P=S("./src/utils/vttcue.ts"),I=S("./src/demux/id3.ts"),_=S("./src/utils/timescale-conversion.ts"),b=S("./src/utils/webvtt-parser.ts");function k(){return k=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var u=arguments[e];for(var t in u)Object.prototype.hasOwnProperty.call(u,t)&&(s[t]=u[t])}return s},k.apply(this,arguments)}var A="stpp.ttml.im1t",T=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,E=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,h={left:"start",center:"center",right:"end",start:"start",end:"end"};function m(s,e,u,t,l){var p=(0,F.findBox)(new Uint8Array(s),["mdat"]);if(p.length===0){l(new Error("Could not parse IMSC1 mdat"));return}var c=p.map(function(R){return(0,I.utf8ArrayToStr)(R)}),L=(0,_.toTimescaleFromScale)(e,1,u);try{c.forEach(function(R){return t(v(R,L))})}catch(R){l(R)}}function v(s,e){var u=new DOMParser,t=u.parseFromString(s,"text/xml"),l=t.getElementsByTagName("tt")[0];if(!l)throw new Error("Invalid ttml");var p={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},c=Object.keys(p).reduce(function(C,M){return C[M]=l.getAttribute("ttp:"+M)||p[M],C},{}),L=l.getAttribute("xml:space")!=="preserve",R=d(r(l,"styling","style")),w=d(r(l,"layout","region")),O=r(l,"body","[begin]");return[].map.call(O,function(C){var M=n(C,L);if(!M||!C.hasAttribute("begin"))return null;var N=a(C.getAttribute("begin"),c),U=a(C.getAttribute("dur"),c),B=a(C.getAttribute("end"),c);if(N===null)throw o(C);if(B===null){if(U===null)throw o(C);B=N+U}var G=new P.default(N-e,B-e,M);G.id=(0,b.generateCueId)(G.startTime,G.endTime,G.text);var K=w[C.getAttribute("region")],Y=R[C.getAttribute("style")],q=i(K,Y,R),H=q.textAlign;if(H){var V=h[H];V&&(G.lineAlign=V),G.align=H}return k(G,q),G}).filter(function(C){return C!==null})}function r(s,e,u){var t=s.getElementsByTagName(e)[0];return t?[].slice.call(t.querySelectorAll(u)):[]}function d(s){return s.reduce(function(e,u){var t=u.getAttribute("xml:id");return t&&(e[t]=u),e},{})}function n(s,e){return[].slice.call(s.childNodes).reduce(function(u,t,l){var p;return t.nodeName==="br"&&l?u+`
`:(p=t.childNodes)!==null&&p!==void 0&&p.length?n(t,e):e?u+t.textContent.trim().replace(/\s+/g," "):u+t.textContent},"")}function i(s,e,u){var t="http://www.w3.org/ns/ttml#styling",l=null,p=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],c=s!=null&&s.hasAttribute("style")?s.getAttribute("style"):null;return c&&u.hasOwnProperty(c)&&(l=u[c]),p.reduce(function(L,R){var w=y(e,t,R)||y(s,t,R)||y(l,t,R);return w&&(L[R]=w),L},{})}function y(s,e,u){return s&&s.hasAttributeNS(e,u)?s.getAttributeNS(e,u):null}function o(s){return new Error("Could not parse ttml timestamp "+s)}function a(s,e){if(!s)return null;var u=(0,D.parseTimeStamp)(s);return u===null&&(T.test(s)?u=g(s,e):E.test(s)&&(u=f(s,e))),u}function g(s,e){var u=T.exec(s),t=(u[4]|0)+(u[5]|0)/e.subFrameRate;return(u[1]|0)*3600+(u[2]|0)*60+(u[3]|0)+t/e.frameRate}function f(s,e){var u=E.exec(s),t=Number(u[1]),l=u[2];switch(l){case"h":return t*3600;case"m":return t*60;case"ms":return t*1e3;case"f":return t/e.frameRate;case"t":return t/e.tickRate}return t}},"./src/utils/keysystem-util.ts":(j,x,S)=>{S.r(x),S.d(x,{changeEndianness:()=>P,convertDataUriToArrayBytes:()=>I,strToUtf8array:()=>_});var F=S("./src/utils/numeric-encoding-utils.ts");function D(b){var k=_(b).subarray(0,16),A=new Uint8Array(16);return A.set(k,16-k.length),A}function P(b){var k=function(A,T,E){var h=A[T];A[T]=A[E],A[E]=h};k(b,0,3),k(b,1,2),k(b,4,5),k(b,6,7)}function I(b){var k=b.split(":"),A=null;if(k[0]==="data"&&k.length===2){var T=k[1].split(";"),E=T[T.length-1].split(",");if(E.length===2){var h=E[0]==="base64",m=E[1];h?(T.splice(-1,1),A=(0,F.base64Decode)(m)):A=D(m)}}return A}function _(b){return Uint8Array.from(unescape(encodeURIComponent(b)),function(k){return k.charCodeAt(0)})}},"./src/utils/logger.ts":(j,x,S)=>{S.r(x),S.d(x,{enableLogs:()=>b,logger:()=>k});var F=function(){},D={trace:F,debug:F,log:F,warn:F,info:F,error:F},P=D;function I(A){var T=self.console[A];return T?T.bind(self.console,"["+A+"] >"):F}function _(A){for(var T=arguments.length,E=new Array(T>1?T-1:0),h=1;h<T;h++)E[h-1]=arguments[h];E.forEach(function(m){P[m]=A[m]?A[m].bind(A):I(m)})}function b(A,T){if(self.console&&A===!0||typeof A=="object"){_(A,"debug","log","info","warn","error");try{P.log('Debug logs enabled for "'+T+'"')}catch{P=D}}else P=D}var k=P},"./src/utils/mediakeys-helper.ts":(j,x,S)=>{S.r(x),S.d(x,{KeySystemFormats:()=>D,KeySystemIds:()=>I,KeySystems:()=>F,getKeySystemsForConfig:()=>k,getSupportedMediaKeySystemConfigurations:()=>T,keySystemDomainToKeySystemFormat:()=>b,keySystemFormatToKeySystemDomain:()=>P,keySystemIdToKeySystemDomain:()=>_,requestMediaKeySystemAccess:()=>A});var F;(function(h){h.CLEARKEY="org.w3.clearkey",h.FAIRPLAY="com.apple.fps",h.PLAYREADY="com.microsoft.playready",h.WIDEVINE="com.widevine.alpha"})(F||(F={}));var D;(function(h){h.CLEARKEY="org.w3.clearkey",h.FAIRPLAY="com.apple.streamingkeydelivery",h.PLAYREADY="com.microsoft.playready",h.WIDEVINE="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"})(D||(D={}));function P(h){switch(h){case D.FAIRPLAY:return F.FAIRPLAY;case D.PLAYREADY:return F.PLAYREADY;case D.WIDEVINE:return F.WIDEVINE;case D.CLEARKEY:return F.CLEARKEY}}var I;(function(h){h.WIDEVINE="edef8ba979d64acea3c827dcd51d21ed"})(I||(I={}));function _(h){if(h===I.WIDEVINE)return F.WIDEVINE}function b(h){switch(h){case F.FAIRPLAY:return D.FAIRPLAY;case F.PLAYREADY:return D.PLAYREADY;case F.WIDEVINE:return D.WIDEVINE;case F.CLEARKEY:return D.CLEARKEY}}function k(h){var m=h.drmSystems,v=h.widevineLicenseUrl,r=m?[F.FAIRPLAY,F.WIDEVINE,F.PLAYREADY,F.CLEARKEY].filter(function(d){return!!m[d]}):[];return!r[F.WIDEVINE]&&v&&r.push(F.WIDEVINE),r}var A=function(){return typeof self<"u"&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function T(h,m,v,r){var d;switch(h){case F.FAIRPLAY:d=["cenc","sinf"];break;case F.WIDEVINE:case F.PLAYREADY:d=["cenc"];break;case F.CLEARKEY:d=["cenc","keyids"];break;default:throw new Error("Unknown key-system: "+h)}return E(d,m,v,r)}function E(h,m,v,r){var d={initDataTypes:h,persistentState:r.persistentState||"not-allowed",distinctiveIdentifier:r.distinctiveIdentifier||"not-allowed",sessionTypes:r.sessionTypes||[r.sessionType||"temporary"],audioCapabilities:m.map(function(n){return{contentType:'audio/mp4; codecs="'+n+'"',robustness:r.audioRobustness||"",encryptionScheme:r.audioEncryptionScheme||null}}),videoCapabilities:v.map(function(n){return{contentType:'video/mp4; codecs="'+n+'"',robustness:r.videoRobustness||"",encryptionScheme:r.videoEncryptionScheme||null}})};return[d]}},"./src/utils/mediasource-helper.ts":(j,x,S)=>{S.r(x),S.d(x,{getMediaSource:()=>F});function F(){return self.MediaSource||self.WebKitMediaSource}},"./src/utils/mp4-tools.ts":(j,x,S)=>{S.r(x),S.d(x,{RemuxerTrackIdConfig:()=>A,appendUint8Array:()=>e,bin2str:()=>T,computeRawDurationFromSamples:()=>g,discardEPB:()=>c,findBox:()=>r,getDuration:()=>a,getStartDTS:()=>o,mp4Box:()=>R,mp4pssh:()=>w,offsetStartDTS:()=>f,parseEmsg:()=>L,parseInitSegment:()=>n,parsePssh:()=>O,parseSEIMessageFromNALu:()=>p,parseSamples:()=>u,parseSegmentIndex:()=>d,parseSinf:()=>y,patchEncyptionData:()=>i,readSint32:()=>m,readUint16:()=>E,readUint32:()=>h,segmentValidRange:()=>s,writeUint32:()=>v});var F=S("./src/loader/fragment.ts"),D=S("./src/utils/typed-array.ts"),P=S("./src/demux/id3.ts"),I=S("./src/utils/logger.ts"),_=S("./src/utils/hex.ts"),b=Math.pow(2,32)-1,k=[].push,A={video:1,audio:2,id3:3,text:4};function T(C){return String.fromCharCode.apply(null,C)}function E(C,M){var N=C[M]<<8|C[M+1];return N<0?65536+N:N}function h(C,M){var N=m(C,M);return N<0?4294967296+N:N}function m(C,M){return C[M]<<24|C[M+1]<<16|C[M+2]<<8|C[M+3]}function v(C,M,N){C[M]=N>>24,C[M+1]=N>>16&255,C[M+2]=N>>8&255,C[M+3]=N&255}function r(C,M){var N=[];if(!M.length)return N;for(var U=C.byteLength,B=0;B<U;){var G=h(C,B),K=T(C.subarray(B+4,B+8)),Y=G>1?B+G:U;if(K===M[0])if(M.length===1)N.push(C.subarray(B+8,Y));else{var q=r(C.subarray(B+8,Y),M.slice(1));q.length&&k.apply(N,q)}B=Y}return N}function d(C){var M=[],N=C[0],U=8,B=h(C,U);U+=4;var G=0,K=0;N===0?U+=8:U+=16,U+=2;var Y=C.length+K,q=E(C,U);U+=2;for(var H=0;H<q;H++){var V=U,z=h(C,V);V+=4;var X=z&2147483647,W=(z&2147483648)>>>31;if(W===1)return console.warn("SIDX has hierarchical references (not supported)"),null;var Q=h(C,V);V+=4,M.push({referenceSize:X,subsegmentDuration:Q,info:{duration:Q/B,start:Y,end:Y+X-1}}),Y+=X,V+=4,U=V}return{earliestPresentationTime:G,timescale:B,version:N,referencesCount:q,references:M}}function n(C){for(var M=[],N=r(C,["moov","trak"]),U=0;U<N.length;U++){var B=N[U],G=r(B,["tkhd"])[0];if(G){var K=G[0],Y=K===0?12:20,q=h(G,Y),H=r(B,["mdia","mdhd"])[0];if(H){K=H[0],Y=K===0?12:20;var V=h(H,Y),z=r(B,["mdia","hdlr"])[0];if(z){var X=T(z.subarray(8,12)),W={soun:F.ElementaryStreamTypes.AUDIO,vide:F.ElementaryStreamTypes.VIDEO}[X];if(W){var Q=r(B,["mdia","minf","stbl","stsd"])[0],J=void 0;Q&&(J=T(Q.subarray(12,16))),M[q]={timescale:V,type:W},M[W]={timescale:V,id:q,codec:J}}}}}}var $=r(C,["moov","mvex","trex"]);return $.forEach(function(ot){var it=h(ot,4),Z=M[it];Z&&(Z.default={duration:h(ot,12),flags:h(ot,20)})}),M}function i(C,M){if(!C||!M)return C;var N=M.keyId;if(N&&M.isCommonEncryption){var U=r(C,["moov","trak"]);U.forEach(function(B){var G=r(B,["mdia","minf","stbl","stsd"])[0],K=G.subarray(8),Y=r(K,["enca"]),q=Y.length>0;q||(Y=r(K,["encv"])),Y.forEach(function(H){var V=q?H.subarray(28):H.subarray(78),z=r(V,["sinf"]);z.forEach(function(X){var W=y(X);if(W){var Q=W.subarray(8,24);Q.some(function(J){return J!==0})||(I.logger.log("[eme] Patching keyId in 'enc"+(q?"a":"v")+">sinf>>tenc' box: "+_.default.hexDump(Q)+" -> "+_.default.hexDump(N)),W.set(N,8))}})})})}return C}function y(C){var M=r(C,["schm"])[0];if(M){var N=T(M.subarray(4,8));if(N==="cbcs"||N==="cenc")return r(C,["schi","tenc"])[0]}return I.logger.error("[eme] missing 'schm' box"),null}function o(C,M){return r(M,["moof","traf"]).reduce(function(N,U){var B=r(U,["tfdt"])[0],G=B[0],K=r(U,["tfhd"]).reduce(function(Y,q){var H=h(q,4),V=C[H];if(V){var z=h(B,4);G===1&&(z*=Math.pow(2,32),z+=h(B,8));var X=V.timescale||9e4,W=z/X;if(isFinite(W)&&(Y===null||W<Y))return W}return Y},null);return K!==null&&isFinite(K)&&(N===null||K<N)?K:N},null)||0}function a(C,M){for(var N=0,U=0,B=0,G=r(C,["moof","traf"]),K=0;K<G.length;K++){var Y=G[K],q=r(Y,["tfhd"])[0],H=h(q,4),V=M[H];if(V){var z=V.default,X=h(q,0)|(z==null?void 0:z.flags),W=z==null?void 0:z.duration;X&8&&(X&2?W=h(q,12):W=h(q,8));for(var Q=V.timescale||9e4,J=r(Y,["trun"]),$=0;$<J.length;$++){if(N=g(J[$]),!N&&W){var ot=h(J[$],4);N=W*ot}V.type===F.ElementaryStreamTypes.VIDEO?U+=N/Q:V.type===F.ElementaryStreamTypes.AUDIO&&(B+=N/Q)}}}if(U===0&&B===0){for(var it=0,Z=r(C,["sidx"]),tt=0;tt<Z.length;tt++){var et=d(Z[tt]);et!=null&&et.references&&(it+=et.references.reduce(function(nt,at){return nt+at.info.duration||0},0))}return it}return U||B}function g(C){var M=h(C,0),N=8;M&1&&(N+=4),M&4&&(N+=4);for(var U=0,B=h(C,4),G=0;G<B;G++){if(M&256){var K=h(C,N);U+=K,N+=4}M&512&&(N+=4),M&1024&&(N+=4),M&2048&&(N+=4)}return U}function f(C,M,N){r(M,["moof","traf"]).forEach(function(U){r(U,["tfhd"]).forEach(function(B){var G=h(B,4),K=C[G];if(K){var Y=K.timescale||9e4;r(U,["tfdt"]).forEach(function(q){var H=q[0],V=h(q,4);if(H===0)V-=N*Y,V=Math.max(V,0),v(q,4,V);else{V*=Math.pow(2,32),V+=h(q,8),V-=N*Y,V=Math.max(V,0);var z=Math.floor(V/(b+1)),X=Math.floor(V%(b+1));v(q,4,z),v(q,8,X)}})}})})}function s(C){var M={valid:null,remainder:null},N=r(C,["moof"]);if(N){if(N.length<2)return M.remainder=C,M}else return M;var U=N[N.length-1];return M.valid=(0,D.sliceUint8)(C,0,U.byteOffset-8),M.remainder=(0,D.sliceUint8)(C,U.byteOffset-8),M}function e(C,M){var N=new Uint8Array(C.length+M.length);return N.set(C),N.set(M,C.length),N}function u(C,M){var N=[],U=M.samples,B=M.timescale,G=M.id,K=!1,Y=r(U,["moof"]);return Y.map(function(q){var H=q.byteOffset-8,V=r(q,["traf"]);V.map(function(z){var X=r(z,["tfdt"]).map(function(W){var Q=W[0],J=h(W,4);return Q===1&&(J*=Math.pow(2,32),J+=h(W,8)),J/B})[0];return X!==void 0&&(C=X),r(z,["tfhd"]).map(function(W){var Q=h(W,4),J=h(W,0)&16777215,$=(J&1)!==0,ot=(J&2)!==0,it=(J&8)!==0,Z=0,tt=(J&16)!==0,et=0,nt=(J&32)!==0,at=8;Q===G&&($&&(at+=8),ot&&(at+=4),it&&(Z=h(W,at),at+=4),tt&&(et=h(W,at),at+=4),nt&&(at+=4),M.type==="video"&&(K=t(M.codec)),r(z,["trun"]).map(function(st){var ft=st[0],rt=h(st,0)&16777215,bt=(rt&1)!==0,ct=0,At=(rt&4)!==0,Lt=(rt&256)!==0,gt=0,Et=(rt&512)!==0,lt=0,ut=(rt&1024)!==0,Tt=(rt&2048)!==0,pt=0,St=h(st,4),ht=8;bt&&(ct=h(st,ht),ht+=4),At&&(ht+=4);for(var vt=ct+H,Ct=0;Ct<St;Ct++){if(Lt?(gt=h(st,ht),ht+=4):gt=Z,Et?(lt=h(st,ht),ht+=4):lt=et,ut&&(ht+=4),Tt&&(ft===0?pt=h(st,ht):pt=m(st,ht),ht+=4),M.type===F.ElementaryStreamTypes.VIDEO)for(var It=0;It<lt;){var kt=h(U,vt);if(vt+=4,l(K,U[vt])){var wt=U.subarray(vt,vt+kt);p(wt,K?2:1,C+pt/B,N)}vt+=kt,It+=kt+4}C+=gt/B}}))})})}),N}function t(C){if(!C)return!1;var M=C.indexOf("."),N=M<0?C:C.substring(0,M);return N==="hvc1"||N==="hev1"||N==="dvh1"||N==="dvhe"}function l(C,M){if(C){var N=M>>1&63;return N===39||N===40}else{var U=M&31;return U===6}}function p(C,M,N,U){var B=c(C),G=0;G+=M;for(var K=0,Y=0,q=!1,H=0;G<B.length;){K=0;do{if(G>=B.length)break;H=B[G++],K+=H}while(H===255);Y=0;do{if(G>=B.length)break;H=B[G++],Y+=H}while(H===255);var V=B.length-G;if(!q&&K===4&&G<B.length){q=!0;var z=B[G++];if(z===181){var X=E(B,G);if(G+=2,X===49){var W=h(B,G);if(G+=4,W===1195456820){var Q=B[G++];if(Q===3){var J=B[G++],$=31&J,ot=64&J,it=ot?2+$*3:0,Z=new Uint8Array(it);if(ot){Z[0]=J;for(var tt=1;tt<it;tt++)Z[tt]=B[G++]}U.push({type:Q,payloadType:K,pts:N,bytes:Z})}}}}}else if(K===5&&Y<V){if(q=!0,Y>16){for(var et=[],nt=0;nt<16;nt++){var at=B[G++].toString(16);et.push(at.length==1?"0"+at:at),(nt===3||nt===5||nt===7||nt===9)&&et.push("-")}for(var st=Y-16,ft=new Uint8Array(st),rt=0;rt<st;rt++)ft[rt]=B[G++];U.push({payloadType:K,pts:N,uuid:et.join(""),userData:(0,P.utf8ArrayToStr)(ft),userDataBytes:ft})}}else if(Y<V)G+=Y;else if(Y>V)break}}function c(C){for(var M=C.byteLength,N=[],U=1;U<M-2;)C[U]===0&&C[U+1]===0&&C[U+2]===3?(N.push(U+2),U+=2):U++;if(N.length===0)return C;var B=M-N.length,G=new Uint8Array(B),K=0;for(U=0;U<B;K++,U++)K===N[0]&&(K++,N.shift()),G[U]=C[K];return G}function L(C){var M=C[0],N="",U="",B=0,G=0,K=0,Y=0,q=0,H=0;if(M===0){for(;T(C.subarray(H,H+1))!=="\0";)N+=T(C.subarray(H,H+1)),H+=1;for(N+=T(C.subarray(H,H+1)),H+=1;T(C.subarray(H,H+1))!=="\0";)U+=T(C.subarray(H,H+1)),H+=1;U+=T(C.subarray(H,H+1)),H+=1,B=h(C,12),G=h(C,16),Y=h(C,20),q=h(C,24),H=28}else if(M===1){H+=4,B=h(C,H),H+=4;var V=h(C,H);H+=4;var z=h(C,H);for(H+=4,K=Math.pow(2,32)*V+z,Number.isSafeInteger(K)||(K=Number.MAX_SAFE_INTEGER,console.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),Y=h(C,H),H+=4,q=h(C,H),H+=4;T(C.subarray(H,H+1))!=="\0";)N+=T(C.subarray(H,H+1)),H+=1;for(N+=T(C.subarray(H,H+1)),H+=1;T(C.subarray(H,H+1))!=="\0";)U+=T(C.subarray(H,H+1)),H+=1;U+=T(C.subarray(H,H+1)),H+=1}var X=C.subarray(H,C.byteLength);return{schemeIdUri:N,value:U,timeScale:B,presentationTime:K,presentationTimeDelta:G,eventDuration:Y,id:q,payload:X}}function R(C){for(var M=arguments.length,N=new Array(M>1?M-1:0),U=1;U<M;U++)N[U-1]=arguments[U];for(var B=N.length,G=8,K=B;K--;)G+=N[K].byteLength;var Y=new Uint8Array(G);for(Y[0]=G>>24&255,Y[1]=G>>16&255,Y[2]=G>>8&255,Y[3]=G&255,Y.set(C,4),K=0,G=8;K<B;K++)Y.set(N[K],G),G+=N[K].byteLength;return Y}function w(C,M,N){if(C.byteLength!==16)throw new RangeError("Invalid system id");var U,B;if(M){U=1,B=new Uint8Array(M.length*16);for(var G=0;G<M.length;G++){var K=M[G];if(K.byteLength!==16)throw new RangeError("Invalid key");B.set(K,G*16)}}else U=0,B=new Uint8Array;var Y;U>0?(Y=new Uint8Array(4),M.length>0&&new DataView(Y.buffer).setUint32(0,M.length,!1)):Y=new Uint8Array;var q=new Uint8Array(4);return N&&N.byteLength>0&&new DataView(q.buffer).setUint32(0,N.byteLength,!1),R([112,115,115,104],new Uint8Array([U,0,0,0]),C,Y,B,q,N||new Uint8Array)}function O(C){if(!(C instanceof ArrayBuffer)||C.byteLength<32)return null;var M={version:0,systemId:"",kids:null,data:null},N=new DataView(C),U=N.getUint32(0);if(C.byteLength!==U&&U>44)return null;var B=N.getUint32(4);if(B!==1886614376||(M.version=N.getUint32(8)>>>24,M.version>1))return null;M.systemId=_.default.hexDump(new Uint8Array(C,12,16));var G=N.getUint32(28);if(M.version===0){if(U-32<G)return null;M.data=new Uint8Array(C,32,G)}else if(M.version===1){M.kids=[];for(var K=0;K<G;K++)M.kids.push(new Uint8Array(C,32+K*16,16))}return M}},"./src/utils/numeric-encoding-utils.ts":(j,x,S)=>{S.r(x),S.d(x,{base64Decode:()=>b,base64DecodeToStr:()=>P,base64Encode:()=>I,base64ToBase64Url:()=>F,base64UrlEncode:()=>_,strToBase64Encode:()=>D});function F(k){return k.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function D(k){return btoa(k)}function P(k){return atob(k)}function I(k){return btoa(String.fromCharCode.apply(String,k))}function _(k){return F(I(k))}function b(k){return Uint8Array.from(atob(k),function(A){return A.charCodeAt(0)})}},"./src/utils/output-filter.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>F});var F=function(){function D(I,_){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=I,this.trackName=_}var P=D.prototype;return P.dispatchCue=function(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},P.newCue=function(I,_,b){(this.startTime===null||this.startTime>I)&&(this.startTime=I),this.endTime=_,this.screen=b,this.timelineController.createCaptionsTrack(this.trackName)},P.reset=function(){this.cueRanges=[],this.startTime=null},D}()},"./src/utils/texttrack-utils.ts":(j,x,S)=>{S.r(x),S.d(x,{addCueToTrack:()=>P,clearCurrentCues:()=>I,getCuesInRange:()=>k,removeCuesInRange:()=>_,sendAddTrackEvent:()=>D});var F=S("./src/utils/logger.ts");function D(A,T){var E;try{E=new Event("addtrack")}catch{E=document.createEvent("Event"),E.initEvent("addtrack",!1,!1)}E.track=A,T.dispatchEvent(E)}function P(A,T){var E=A.mode;if(E==="disabled"&&(A.mode="hidden"),A.cues&&!A.cues.getCueById(T.id))try{if(A.addCue(T),!A.cues.getCueById(T.id))throw new Error("addCue is failed for: "+T)}catch(m){F.logger.debug("[texttrack-utils]: "+m);var h=new self.TextTrackCue(T.startTime,T.endTime,T.text);h.id=T.id,A.addCue(h)}E==="disabled"&&(A.mode=E)}function I(A){var T=A.mode;if(T==="disabled"&&(A.mode="hidden"),A.cues)for(var E=A.cues.length;E--;)A.removeCue(A.cues[E]);T==="disabled"&&(A.mode=T)}function _(A,T,E,h){var m=A.mode;if(m==="disabled"&&(A.mode="hidden"),A.cues&&A.cues.length>0)for(var v=k(A.cues,T,E),r=0;r<v.length;r++)(!h||h(v[r]))&&A.removeCue(v[r]);m==="disabled"&&(A.mode=m)}function b(A,T){if(T<A[0].startTime)return 0;var E=A.length-1;if(T>A[E].endTime)return-1;for(var h=0,m=E;h<=m;){var v=Math.floor((m+h)/2);if(T<A[v].startTime)m=v-1;else if(T>A[v].startTime&&h<E)h=v+1;else return v}return A[h].startTime-T<T-A[m].startTime?h:m}function k(A,T,E){var h=[],m=b(A,T);if(m>-1)for(var v=m,r=A.length;v<r;v++){var d=A[v];if(d.startTime>=T&&d.endTime<=E)h.push(d);else if(d.startTime>E)return h}return h}},"./src/utils/time-ranges.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>D});var F={toString:function(P){for(var I="",_=P.length,b=0;b<_;b++)I+="["+P.start(b).toFixed(3)+"-"+P.end(b).toFixed(3)+"]";return I}};const D=F},"./src/utils/timescale-conversion.ts":(j,x,S)=>{S.r(x),S.d(x,{toMpegTsClockFromTimescale:()=>_,toMsFromMpegTsClock:()=>I,toTimescaleFromBase:()=>D,toTimescaleFromScale:()=>P});var F=9e4;function D(b,k,A,T){A===void 0&&(A=1),T===void 0&&(T=!1);var E=b*k*A;return T?Math.round(E):E}function P(b,k,A,T){return A===void 0&&(A=1),T===void 0&&(T=!1),D(b,k,1/A,T)}function I(b,k){return k===void 0&&(k=!1),D(b,1e3,1/F,k)}function _(b,k){return k===void 0&&(k=1),D(b,F,1/k)}},"./src/utils/typed-array.ts":(j,x,S)=>{S.r(x),S.d(x,{sliceUint8:()=>F});function F(D,P,I){return Uint8Array.prototype.slice?D.slice(P,I):new Uint8Array(Array.prototype.slice.call(D,P,I))}},"./src/utils/vttcue.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>F});const F=function(){if(typeof self<"u"&&self.VTTCue)return self.VTTCue;var D=["","lr","rl"],P=["start","middle","end","left","right"];function I(T,E){if(typeof E!="string"||!Array.isArray(T))return!1;var h=E.toLowerCase();return~T.indexOf(h)?h:!1}function _(T){return I(D,T)}function b(T){return I(P,T)}function k(T){for(var E=arguments.length,h=new Array(E>1?E-1:0),m=1;m<E;m++)h[m-1]=arguments[m];for(var v=1;v<arguments.length;v++){var r=arguments[v];for(var d in r)T[d]=r[d]}return T}function A(T,E,h){var m=this,v={enumerable:!0};m.hasBeenReset=!1;var r="",d=!1,n=T,i=E,y=h,o=null,a="",g=!0,f="auto",s="start",e=50,u="middle",t=50,l="middle";Object.defineProperty(m,"id",k({},v,{get:function(){return r},set:function(p){r=""+p}})),Object.defineProperty(m,"pauseOnExit",k({},v,{get:function(){return d},set:function(p){d=!!p}})),Object.defineProperty(m,"startTime",k({},v,{get:function(){return n},set:function(p){if(typeof p!="number")throw new TypeError("Start time must be set to a number.");n=p,this.hasBeenReset=!0}})),Object.defineProperty(m,"endTime",k({},v,{get:function(){return i},set:function(p){if(typeof p!="number")throw new TypeError("End time must be set to a number.");i=p,this.hasBeenReset=!0}})),Object.defineProperty(m,"text",k({},v,{get:function(){return y},set:function(p){y=""+p,this.hasBeenReset=!0}})),Object.defineProperty(m,"region",k({},v,{get:function(){return o},set:function(p){o=p,this.hasBeenReset=!0}})),Object.defineProperty(m,"vertical",k({},v,{get:function(){return a},set:function(p){var c=_(p);if(c===!1)throw new SyntaxError("An invalid or illegal string was specified.");a=c,this.hasBeenReset=!0}})),Object.defineProperty(m,"snapToLines",k({},v,{get:function(){return g},set:function(p){g=!!p,this.hasBeenReset=!0}})),Object.defineProperty(m,"line",k({},v,{get:function(){return f},set:function(p){if(typeof p!="number"&&p!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");f=p,this.hasBeenReset=!0}})),Object.defineProperty(m,"lineAlign",k({},v,{get:function(){return s},set:function(p){var c=b(p);if(!c)throw new SyntaxError("An invalid or illegal string was specified.");s=c,this.hasBeenReset=!0}})),Object.defineProperty(m,"position",k({},v,{get:function(){return e},set:function(p){if(p<0||p>100)throw new Error("Position must be between 0 and 100.");e=p,this.hasBeenReset=!0}})),Object.defineProperty(m,"positionAlign",k({},v,{get:function(){return u},set:function(p){var c=b(p);if(!c)throw new SyntaxError("An invalid or illegal string was specified.");u=c,this.hasBeenReset=!0}})),Object.defineProperty(m,"size",k({},v,{get:function(){return t},set:function(p){if(p<0||p>100)throw new Error("Size must be between 0 and 100.");t=p,this.hasBeenReset=!0}})),Object.defineProperty(m,"align",k({},v,{get:function(){return l},set:function(p){var c=b(p);if(!c)throw new SyntaxError("An invalid or illegal string was specified.");l=c,this.hasBeenReset=!0}})),m.displayState=void 0}return A.prototype.getCueAsHTML=function(){var T=self.WebVTT;return T.convertCueToDOMTree(self,this.text)},A}()},"./src/utils/vttparser.ts":(j,x,S)=>{S.r(x),S.d(x,{VTTParser:()=>E,fixLineBreaks:()=>T,parseTimeStamp:()=>P});var F=S("./src/utils/vttcue.ts"),D=function(){function h(){}var m=h.prototype;return m.decode=function(v,r){if(!v)return"";if(typeof v!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(v))},h}();function P(h){function m(r,d,n,i){return(r|0)*3600+(d|0)*60+(n|0)+parseFloat(i||0)}var v=h.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return v?parseFloat(v[2])>59?m(v[2],v[3],0,v[4]):m(v[1],v[2],v[3],v[4]):null}var I=function(){function h(){this.values=Object.create(null)}var m=h.prototype;return m.set=function(v,r){!this.get(v)&&r!==""&&(this.values[v]=r)},m.get=function(v,r,d){return d?this.has(v)?this.values[v]:r[d]:this.has(v)?this.values[v]:r},m.has=function(v){return v in this.values},m.alt=function(v,r,d){for(var n=0;n<d.length;++n)if(r===d[n]){this.set(v,r);break}},m.integer=function(v,r){/^-?\d+$/.test(r)&&this.set(v,parseInt(r,10))},m.percent=function(v,r){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(r)){var d=parseFloat(r);if(d>=0&&d<=100)return this.set(v,d),!0}return!1},h}();function _(h,m,v,r){var d=r?h.split(r):[h];for(var n in d)if(typeof d[n]=="string"){var i=d[n].split(v);if(i.length===2){var y=i[0],o=i[1];m(y,o)}}}var b=new F.default(0,0,""),k=b.align==="middle"?"middle":"center";function A(h,m,v){var r=h;function d(){var y=P(h);if(y===null)throw new Error("Malformed timestamp: "+r);return h=h.replace(/^[^\sa-zA-Z-]+/,""),y}function n(y,o){var a=new I;_(y,function(s,e){var u;switch(s){case"region":for(var t=v.length-1;t>=0;t--)if(v[t].id===e){a.set(s,v[t].region);break}break;case"vertical":a.alt(s,e,["rl","lr"]);break;case"line":u=e.split(","),a.integer(s,u[0]),a.percent(s,u[0])&&a.set("snapToLines",!1),a.alt(s,u[0],["auto"]),u.length===2&&a.alt("lineAlign",u[1],["start",k,"end"]);break;case"position":u=e.split(","),a.percent(s,u[0]),u.length===2&&a.alt("positionAlign",u[1],["start",k,"end","line-left","line-right","auto"]);break;case"size":a.percent(s,e);break;case"align":a.alt(s,e,["start",k,"end","left","right"]);break}},/:/,/\s/),o.region=a.get("region",null),o.vertical=a.get("vertical","");var g=a.get("line","auto");g==="auto"&&b.line===-1&&(g=-1),o.line=g,o.lineAlign=a.get("lineAlign","start"),o.snapToLines=a.get("snapToLines",!0),o.size=a.get("size",100),o.align=a.get("align",k);var f=a.get("position","auto");f==="auto"&&b.position===50&&(f=o.align==="start"||o.align==="left"?0:o.align==="end"||o.align==="right"?100:50),o.position=f}function i(){h=h.replace(/^\s+/,"")}if(i(),m.startTime=d(),i(),h.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+r);h=h.slice(3),i(),m.endTime=d(),i(),n(h,m)}function T(h){return h.replace(/<br(?: \/)?>/gi,`
`)}var E=function(){function h(){this.state="INITIAL",this.buffer="",this.decoder=new D,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}var m=h.prototype;return m.parse=function(v){var r=this;v&&(r.buffer+=r.decoder.decode(v,{stream:!0}));function d(){var g=r.buffer,f=0;for(g=T(g);f<g.length&&g[f]!=="\r"&&g[f]!==`
`;)++f;var s=g.slice(0,f);return g[f]==="\r"&&++f,g[f]===`
`&&++f,r.buffer=g.slice(f),s}function n(g){_(g,function(f,s){},/:/)}try{var i="";if(r.state==="INITIAL"){if(!/\r\n|\n/.test(r.buffer))return this;i=d();var y=i.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!y||!y[0])throw new Error("Malformed WebVTT signature.");r.state="HEADER"}for(var o=!1;r.buffer;){if(!/\r\n|\n/.test(r.buffer))return this;switch(o?o=!1:i=d(),r.state){case"HEADER":/:/.test(i)?n(i):i||(r.state="ID");continue;case"NOTE":i||(r.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(i)){r.state="NOTE";break}if(!i)continue;if(r.cue=new F.default(0,0,""),r.state="CUE",i.indexOf("-->")===-1){r.cue.id=i;continue}case"CUE":if(!r.cue){r.state="BADCUE";continue}try{A(i,r.cue,r.regionList)}catch{r.cue=null,r.state="BADCUE";continue}r.state="CUETEXT";continue;case"CUETEXT":{var a=i.indexOf("-->")!==-1;if(!i||a&&(o=!0)){r.oncue&&r.cue&&r.oncue(r.cue),r.cue=null,r.state="ID";continue}if(r.cue===null)continue;r.cue.text&&(r.cue.text+=`
`),r.cue.text+=i}continue;case"BADCUE":i||(r.state="ID")}}}catch{r.state==="CUETEXT"&&r.cue&&r.oncue&&r.oncue(r.cue),r.cue=null,r.state=r.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this},m.flush=function(){var v=this;try{if((v.cue||v.state==="HEADER")&&(v.buffer+=`

`,v.parse()),v.state==="INITIAL"||v.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(r){v.onparsingerror&&v.onparsingerror(r)}return v.onflush&&v.onflush(),this},h}()},"./src/utils/webvtt-parser.ts":(j,x,S)=>{S.r(x),S.d(x,{generateCueId:()=>E,parseWebVTT:()=>m});var F=S("./src/polyfills/number.ts"),D=S("./src/utils/vttparser.ts"),P=S("./src/demux/id3.ts"),I=S("./src/utils/timescale-conversion.ts"),_=S("./src/remux/mp4-remuxer.ts"),b=/\r\n|\n\r|\n|\r/g,k=function(v,r,d){return d===void 0&&(d=0),v.slice(d,d+r.length)===r},A=function(v){var r=parseInt(v.slice(-3)),d=parseInt(v.slice(-6,-4)),n=parseInt(v.slice(-9,-7)),i=v.length>9?parseInt(v.substring(0,v.indexOf(":"))):0;if(!(0,F.isFiniteNumber)(r)||!(0,F.isFiniteNumber)(d)||!(0,F.isFiniteNumber)(n)||!(0,F.isFiniteNumber)(i))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+v);return r+=1e3*d,r+=60*1e3*n,r+=60*60*1e3*i,r},T=function(v){for(var r=5381,d=v.length;d;)r=r*33^v.charCodeAt(--d);return(r>>>0).toString()};function E(v,r,d){return T(v.toString())+T(r.toString())+T(d)}var h=function(v,r,d){var n=v[r],i=v[n.prevCC];if(!i||!i.new&&n.new){v.ccOffset=v.presentationOffset=n.start,n.new=!1;return}for(;(y=i)!==null&&y!==void 0&&y.new;){var y;v.ccOffset+=n.start-i.start,n.new=!1,n=i,i=v[n.prevCC]}v.presentationOffset=d};function m(v,r,d,n,i,y,o,a){var g=new D.VTTParser,f=(0,P.utf8ArrayToStr)(new Uint8Array(v)).trim().replace(b,`
`).split(`
`),s=[],e=(0,I.toMpegTsClockFromTimescale)(r,d),u="00:00.000",t=0,l=0,p,c=!0;g.oncue=function(L){var R=n[i],w=n.ccOffset,O=(t-e)/9e4;R!=null&&R.new&&(l!==void 0?w=n.ccOffset=R.start:h(n,i,O)),O&&(w=O-n.presentationOffset);var C=L.endTime-L.startTime,M=(0,_.normalizePts)((L.startTime+w-l)*9e4,y*9e4)/9e4;L.startTime=Math.max(M,0),L.endTime=Math.max(M+C,0);var N=L.text.trim();L.text=decodeURIComponent(encodeURIComponent(N)),L.id||(L.id=E(L.startTime,L.endTime,N)),L.endTime>0&&s.push(L)},g.onparsingerror=function(L){p=L},g.onflush=function(){if(p){a(p);return}o(s)},f.forEach(function(L){if(c)if(k(L,"X-TIMESTAMP-MAP=")){c=!1,L.slice(16).split(",").forEach(function(R){k(R,"LOCAL:")?u=R.slice(6):k(R,"MPEGTS:")&&(t=parseInt(R.slice(7)))});try{l=A(u)/1e3}catch(R){p=R}return}else L===""&&(c=!1);g.parse(L+`
`)}),g.flush()}},"./src/utils/xhr-loader.ts":(j,x,S)=>{S.r(x),S.d(x,{default:()=>_});var F=S("./src/utils/logger.ts"),D=S("./src/loader/load-stats.ts"),P=/^age:\s*[\d.]+\s*$/m,I=function(){function b(A){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=A?A.xhrSetup:null,this.stats=new D.LoadStats,this.retryDelay=0}var k=b.prototype;return k.destroy=function(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null},k.abortInternal=function(){var A=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),A&&(A.onreadystatechange=null,A.onprogress=null,A.readyState!==4&&(this.stats.aborted=!0,A.abort()))},k.abort=function(){var A;this.abortInternal(),(A=this.callbacks)!==null&&A!==void 0&&A.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},k.load=function(A,T,E){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=A,this.config=T,this.callbacks=E,this.retryDelay=T.retryDelay,this.loadInternal()},k.loadInternal=function(){var A=this.config,T=this.context;if(A){var E=this.loader=new self.XMLHttpRequest,h=this.stats;h.loading.first=0,h.loaded=0;var m=this.xhrSetup;try{if(m)try{m(E,T.url)}catch{E.open("GET",T.url,!0),m(E,T.url)}E.readyState||E.open("GET",T.url,!0);var v=this.context.headers;if(v)for(var r in v)E.setRequestHeader(r,v[r])}catch(d){this.callbacks.onError({code:E.status,text:d.message},T,E);return}T.rangeEnd&&E.setRequestHeader("Range","bytes="+T.rangeStart+"-"+(T.rangeEnd-1)),E.onreadystatechange=this.readystatechange.bind(this),E.onprogress=this.loadprogress.bind(this),E.responseType=T.responseType,self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),A.timeout),E.send()}},k.readystatechange=function(){var A=this.context,T=this.loader,E=this.stats;if(!(!A||!T)){var h=T.readyState,m=this.config;if(!E.aborted&&h>=2)if(self.clearTimeout(this.requestTimeout),E.loading.first===0&&(E.loading.first=Math.max(self.performance.now(),E.loading.start)),h===4){T.onreadystatechange=null,T.onprogress=null;var v=T.status,r=T.responseType==="arraybuffer";if(v>=200&&v<300&&(r&&T.response||T.responseText!==null)){E.loading.end=Math.max(self.performance.now(),E.loading.first);var d,n;if(r?(d=T.response,n=d.byteLength):(d=T.responseText,n=d.length),E.loaded=E.total=n,!this.callbacks)return;var i=this.callbacks.onProgress;if(i&&i(E,A,d,T),!this.callbacks)return;var y={url:T.responseURL,data:d};this.callbacks.onSuccess(y,E,A,T)}else E.retry>=m.maxRetry||v>=400&&v<499?(F.logger.error(v+" while loading "+A.url),this.callbacks.onError({code:v,text:T.statusText},A,T)):(F.logger.warn(v+" while loading "+A.url+", retrying in "+this.retryDelay+"..."),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,m.maxRetryDelay),E.retry++)}else self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),m.timeout)}},k.loadtimeout=function(){F.logger.warn("timeout while loading "+this.context.url);var A=this.callbacks;A&&(this.abortInternal(),A.onTimeout(this.stats,this.context,this.loader))},k.loadprogress=function(A){var T=this.stats;T.loaded=A.loaded,A.lengthComputable&&(T.total=A.total)},k.getCacheAge=function(){var A=null;if(this.loader&&P.test(this.loader.getAllResponseHeaders())){var T=this.loader.getResponseHeader("age");A=T?parseFloat(T):null}return A},b}();const _=I},"./node_modules/eventemitter3/index.js":j=>{var x=Object.prototype.hasOwnProperty,S="~";function F(){}Object.create&&(F.prototype=Object.create(null),new F().__proto__||(S=!1));function D(b,k,A){this.fn=b,this.context=k,this.once=A||!1}function P(b,k,A,T,E){if(typeof A!="function")throw new TypeError("The listener must be a function");var h=new D(A,T||b,E),m=S?S+k:k;return b._events[m]?b._events[m].fn?b._events[m]=[b._events[m],h]:b._events[m].push(h):(b._events[m]=h,b._eventsCount++),b}function I(b,k){--b._eventsCount===0?b._events=new F:delete b._events[k]}function _(){this._events=new F,this._eventsCount=0}_.prototype.eventNames=function(){var b=[],k,A;if(this._eventsCount===0)return b;for(A in k=this._events)x.call(k,A)&&b.push(S?A.slice(1):A);return Object.getOwnPropertySymbols?b.concat(Object.getOwnPropertySymbols(k)):b},_.prototype.listeners=function(b){var k=S?S+b:b,A=this._events[k];if(!A)return[];if(A.fn)return[A.fn];for(var T=0,E=A.length,h=new Array(E);T<E;T++)h[T]=A[T].fn;return h},_.prototype.listenerCount=function(b){var k=S?S+b:b,A=this._events[k];return A?A.fn?1:A.length:0},_.prototype.emit=function(b,k,A,T,E,h){var m=S?S+b:b;if(!this._events[m])return!1;var v=this._events[m],r=arguments.length,d,n;if(v.fn){switch(v.once&&this.removeListener(b,v.fn,void 0,!0),r){case 1:return v.fn.call(v.context),!0;case 2:return v.fn.call(v.context,k),!0;case 3:return v.fn.call(v.context,k,A),!0;case 4:return v.fn.call(v.context,k,A,T),!0;case 5:return v.fn.call(v.context,k,A,T,E),!0;case 6:return v.fn.call(v.context,k,A,T,E,h),!0}for(n=1,d=new Array(r-1);n<r;n++)d[n-1]=arguments[n];v.fn.apply(v.context,d)}else{var i=v.length,y;for(n=0;n<i;n++)switch(v[n].once&&this.removeListener(b,v[n].fn,void 0,!0),r){case 1:v[n].fn.call(v[n].context);break;case 2:v[n].fn.call(v[n].context,k);break;case 3:v[n].fn.call(v[n].context,k,A);break;case 4:v[n].fn.call(v[n].context,k,A,T);break;default:if(!d)for(y=1,d=new Array(r-1);y<r;y++)d[y-1]=arguments[y];v[n].fn.apply(v[n].context,d)}}return!0},_.prototype.on=function(b,k,A){return P(this,b,k,A,!1)},_.prototype.once=function(b,k,A){return P(this,b,k,A,!0)},_.prototype.removeListener=function(b,k,A,T){var E=S?S+b:b;if(!this._events[E])return this;if(!k)return I(this,E),this;var h=this._events[E];if(h.fn)h.fn===k&&(!T||h.once)&&(!A||h.context===A)&&I(this,E);else{for(var m=0,v=[],r=h.length;m<r;m++)(h[m].fn!==k||T&&!h[m].once||A&&h[m].context!==A)&&v.push(h[m]);v.length?this._events[E]=v.length===1?v[0]:v:I(this,E)}return this},_.prototype.removeAllListeners=function(b){var k;return b?(k=S?S+b:b,this._events[k]&&I(this,k)):(this._events=new F,this._eventsCount=0),this},_.prototype.off=_.prototype.removeListener,_.prototype.addListener=_.prototype.on,_.prefixed=S,_.EventEmitter=_,j.exports=_},"./node_modules/url-toolkit/src/url-toolkit.js":function(j){(function(x){var S=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,F=/^(?=([^\/?#]*))\1([^]*)$/,D=/(?:\/|^)\.(?=\/)/g,P=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,I={buildAbsoluteURL:function(_,b,k){if(k=k||{},_=_.trim(),b=b.trim(),!b){if(!k.alwaysNormalize)return _;var A=I.parseURL(_);if(!A)throw new Error("Error trying to parse base URL.");return A.path=I.normalizePath(A.path),I.buildURLFromParts(A)}var T=I.parseURL(b);if(!T)throw new Error("Error trying to parse relative URL.");if(T.scheme)return k.alwaysNormalize?(T.path=I.normalizePath(T.path),I.buildURLFromParts(T)):b;var E=I.parseURL(_);if(!E)throw new Error("Error trying to parse base URL.");if(!E.netLoc&&E.path&&E.path[0]!=="/"){var h=F.exec(E.path);E.netLoc=h[1],E.path=h[2]}E.netLoc&&!E.path&&(E.path="/");var m={scheme:E.scheme,netLoc:T.netLoc,path:null,params:T.params,query:T.query,fragment:T.fragment};if(!T.netLoc&&(m.netLoc=E.netLoc,T.path[0]!=="/"))if(!T.path)m.path=E.path,T.params||(m.params=E.params,T.query||(m.query=E.query));else{var v=E.path,r=v.substring(0,v.lastIndexOf("/")+1)+T.path;m.path=I.normalizePath(r)}return m.path===null&&(m.path=k.alwaysNormalize?I.normalizePath(T.path):T.path),I.buildURLFromParts(m)},parseURL:function(_){var b=S.exec(_);return b?{scheme:b[1]||"",netLoc:b[2]||"",path:b[3]||"",params:b[4]||"",query:b[5]||"",fragment:b[6]||""}:null},normalizePath:function(_){for(_=_.split("").reverse().join("").replace(D,"");_.length!==(_=_.replace(P,"")).length;);return _.split("").reverse().join("")},buildURLFromParts:function(_){return _.scheme+_.netLoc+_.path+_.params+_.query+_.fragment}};j.exports=I})()}},yt={};function dt(j){var x=yt[j];if(x!==void 0)return x.exports;var S=yt[j]={exports:{}};return Dt[j].call(S.exports,S,S.exports,dt),S.exports}dt.m=Dt,dt.n=j=>{var x=j&&j.__esModule?()=>j.default:()=>j;return dt.d(x,{a:x}),x},dt.d=(j,x)=>{for(var S in x)dt.o(x,S)&&!dt.o(j,S)&&Object.defineProperty(j,S,{enumerable:!0,get:x[S]})},dt.o=(j,x)=>Object.prototype.hasOwnProperty.call(j,x),dt.r=j=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(j,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(j,"__esModule",{value:!0})};var Rt=dt("./src/hls.ts");return Rt=Rt.default,Rt})())})(Kt);var Ht=Kt.exports;const ee=Zt(Ht),ie=te({__proto__:null,default:ee},[Ht]);export{ie as h};
